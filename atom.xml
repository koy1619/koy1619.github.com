<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title><![CDATA[linux48]]></title>
  
  <link href="/atom.xml" rel="self"/>
  <link href="http://linux48.com/"/>
  <updated>2016-04-09T09:39:04.000Z</updated>
  <id>http://linux48.com/</id>
  
  <author>
    <name><![CDATA[koy]]></name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title><![CDATA[centos7配置bond和bond跨网段改IP]]></title>
    <link href="http://linux48.com//archives/445/"/>
    <id>http://linux48.com//archives/445/</id>
    <published>2016-04-08T16:00:00.000Z</published>
    <updated>2016-04-09T09:39:04.000Z</updated>
    <content type="html"><![CDATA[<h2 id="一-_centos_7下查看网卡信息">一. centos 7下查看网卡信息</h2><p>命令 ip addr </p>
<p>最小化安装的Centos7系统并没有nano vim wget curl ifconfig lsof命令，这里首先安装一下</p>
<p><code>yum -y install nano vim wget curl net-tools lsof</code></p>
<p>安装后就可以使用ifconfig 等命令</p>
<p>配置bond</p>
<p>服务器有4个网卡分别为 ifcfg-em1 ifcfg-em2 ifcfg-em3 ifcfg-em4 网卡ifcfg-em1和ifcfg-em2配置bond0</p>
<a id="more"></a>
<p>翠花上配置</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> /etc/sysconfig/network-scripts</span><br><span class="line"><span class="keyword">cp</span> ifcfg-em1 ifcfg-bond0</span><br></pre></td></tr></table></figure>
<p>网卡配置<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysconfig/network-scripts/ifcfg-em1</span><br><span class="line"></span><br><span class="line"><span class="constant">DEVICE</span>=em1</span><br><span class="line"></span><br><span class="line"><span class="constant">NAME</span>=em1</span><br><span class="line"></span><br><span class="line"><span class="constant">TYPE</span>=Ethernet</span><br><span class="line"></span><br><span class="line"><span class="constant">BOOTPROTO</span>=none</span><br><span class="line"></span><br><span class="line"><span class="constant">ONBOOT</span>=yes</span><br><span class="line"></span><br><span class="line"><span class="constant">MASTER</span>=bond4</span><br><span class="line"></span><br><span class="line"><span class="constant">SLAVE</span>=yes</span><br></pre></td></tr></table></figure></p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysconfig/network-scripts/ifcfg-em2</span><br><span class="line"></span><br><span class="line"><span class="constant">DEVICE</span>=em2</span><br><span class="line"></span><br><span class="line"><span class="constant">NAME</span>=em2</span><br><span class="line"></span><br><span class="line"><span class="constant">TYPE</span>=Ethernet</span><br><span class="line"></span><br><span class="line"><span class="constant">BOOTPROTO</span>=none</span><br><span class="line"></span><br><span class="line"><span class="constant">ONBOOT</span>=yes</span><br><span class="line"></span><br><span class="line"><span class="constant">MASTER</span>=bond4</span><br><span class="line"></span><br><span class="line"><span class="constant">SLAVE</span>=yes</span><br></pre></td></tr></table></figure>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysconfig/network-scripts/ifcfg-bond0</span><br><span class="line"></span><br><span class="line">DEVICE=bond0</span><br><span class="line"></span><br><span class="line">NAME=bond0</span><br><span class="line"></span><br><span class="line">TYPE=Ethernet</span><br><span class="line"></span><br><span class="line">ONBOOT=yes</span><br><span class="line"></span><br><span class="line">BOOTPROTO=none</span><br><span class="line"></span><br><span class="line">BONDING_MASTER=yes  (centos7 下必须有这条命令，和centos6.5的区别)</span><br><span class="line"></span><br><span class="line">IPADDR=<span class="keyword">*</span>.<span class="keyword">*</span>.<span class="keyword">*</span>.<span class="keyword">*</span></span><br><span class="line"></span><br><span class="line">GATEWAY=<span class="keyword">*</span>.<span class="keyword">*</span>.<span class="keyword">*</span>.<span class="keyword">*</span></span><br><span class="line"></span><br><span class="line">NETMASK=<span class="keyword">*</span>.<span class="keyword">*</span>.<span class="keyword">*</span>.<span class="keyword">*</span></span><br><span class="line"></span><br><span class="line">DNS1=<span class="keyword">*</span>.<span class="keyword">*</span>.<span class="keyword">*</span>.<span class="keyword">*</span></span><br><span class="line"></span><br><span class="line">DNS2=<span class="keyword">*</span>.<span class="keyword">*</span>.<span class="keyword">*</span>.<span class="keyword">*</span></span><br><span class="line"></span><br><span class="line">USERCTL=no</span><br><span class="line"></span><br><span class="line">BONDING_OPTS=<span class="string">"mode=1 miimon=100"</span></span><br></pre></td></tr></table></figure>
<p>重启网卡（centos7下重启命令和centos6.5不同）</p>
<p><code>systemctl  restart network</code></p>
<p>bonding状态查看</p>
<p><code>cat /proc/net/bonding/bond0</code></p>
<h2 id="二-关于网卡配置bond后需要更改IP到不同网段简单步骤">二.关于网卡配置bond后需要更改IP到不同网段简单步骤</h2><p>实验说明<br>服务器网卡em1、em2配置bond，IP地址为10.10.10.5<br>网卡em1和em2分别接在交换机SW1和SW2的五号端口在vlan10<br>因网络调整现在需要把交换机5号端口改到vlan20（114.80.218.*段）<br>bond的IP地址改为114.80.218.5</p>
<p>配置思路<br>借助单网卡配置多IP的方法，增加一块虚拟网卡配置上需要更改的新网段IP114.80.218.6<br>重启网卡然后更改交换机配置 划分端口到新valn 20，变更完成后。就可以使用114.80.218.6远程服务器<br>然后在更改ifcfg-bond0的ip为114.80.218.5 随后删除ifcfg-bond0:0 变更完成。<br>配置ifcfg-bond0:0的这种情景，可以应用更改在服务器没有远程管理口，人又不在服务器旁边。<br>但是可以远程管理现有服务器和交换机。万一更改不成功还可以回退。通过原IP远程服务器。</p>
<p>翠花上配置<br><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/sysconfig/network-scripts</span><br><span class="line"></span><br><span class="line">cp ifcfg-bond0 ifcfg-bond0:<span class="number">0</span></span><br><span class="line"></span><br><span class="line">vi /etc/sysconfig/network-scripts/ifcfg-bond0:<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="variable">DEVICE=</span>bond0:<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="variable">NAME=</span>bond0:<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="variable">TYPE=</span>Ethernet</span><br><span class="line"></span><br><span class="line"><span class="variable">ONBOOT=</span>yes</span><br><span class="line"></span><br><span class="line"><span class="variable">BOOTPROTO=</span>none</span><br><span class="line"></span><br><span class="line"><span class="variable">BONDING_MASTER=</span>yes  (centos7 下必须有这条命令，和centos6.<span class="number">5</span>的区别)</span><br><span class="line"></span><br><span class="line"><span class="variable">IPADDR=</span><span class="number">114.80</span>.<span class="number">218.6</span></span><br><span class="line"></span><br><span class="line"><span class="variable">GATEWAY=</span><span class="number">114.80</span>.<span class="number">218.1</span></span><br><span class="line"></span><br><span class="line"><span class="variable">NETMASK=</span><span class="number">255.255</span>.<span class="number">255.0</span></span><br><span class="line"></span><br><span class="line"><span class="variable">DNS1=</span><span class="number">202.96</span>.<span class="number">209.5</span></span><br><span class="line"></span><br><span class="line"><span class="variable">DNS2=</span><span class="number">202.96</span>.<span class="number">209.133</span></span><br><span class="line"></span><br><span class="line"><span class="variable">USERCTL=</span>no</span><br><span class="line"></span><br><span class="line"><span class="variable">BONDING_OPTS=</span><span class="string">"mode=1 miimon=100"</span></span><br></pre></td></tr></table></figure></p>
<p>重启网卡（centos7下重启命令和centos6.5不同）</p>
<p><code>systemctl  restart network</code></p>
<p>更改交换机配置把5号端口划分到vlan 20</p>
<p>ping 114.80.218.6可以到达</p>
<p>ssh 114.80.218.6 然后更改ifcfg-bond0的ip为114.80.218.5</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysconfig/network-scripts/ifcfg-bond0</span><br><span class="line"></span><br><span class="line"><span class="variable">DEVICE=</span>bond0</span><br><span class="line"></span><br><span class="line"><span class="variable">NAME=</span>bond0</span><br><span class="line"></span><br><span class="line"><span class="variable">TYPE=</span>Ethernet</span><br><span class="line"></span><br><span class="line"><span class="variable">ONBOOT=</span>yes</span><br><span class="line"></span><br><span class="line"><span class="variable">BOOTPROTO=</span>none</span><br><span class="line"></span><br><span class="line"><span class="variable">BONDING_MASTER=</span>yes  (centos7 下必须由这条命令，和centos6.<span class="number">5</span>的区别)</span><br><span class="line"></span><br><span class="line"><span class="variable">IPADDR=</span><span class="number">114.80</span>.<span class="number">218.5</span></span><br><span class="line"></span><br><span class="line"><span class="variable">GATEWAY=</span><span class="number">114.80</span>.<span class="number">218.1</span></span><br><span class="line"></span><br><span class="line"><span class="variable">NETMASK=</span><span class="number">255.255</span>.<span class="number">255.0</span></span><br><span class="line"></span><br><span class="line"><span class="variable">DNS1=</span><span class="number">202.96</span>.<span class="number">209.5</span></span><br><span class="line"></span><br><span class="line"><span class="variable">DNS2=</span><span class="number">202.96</span>.<span class="number">209.133</span></span><br><span class="line"></span><br><span class="line"><span class="variable">USERCTL=</span>no</span><br><span class="line"></span><br><span class="line"><span class="variable">BONDING_OPTS=</span><span class="string">"mode=1 miimon=100"</span></span><br></pre></td></tr></table></figure>
<p>重启网卡（centos7下重启命令和centos6.5不同）</p>
<p><code>systemctl  restart network</code></p>
<p>ssh 114.80.218.5 删除ifcfg-bond0:0</p>
<p><code>cd /etc/sysconfig/network-scripts</code></p>
<p><code>rm -rf ifcfg-bond0:0</code></p>
<p>至此IP变更完成</p>
<p>关于测试<br>ping 114.80.218.5 </p>
<p>关闭交换机sw1的5号端口，没有掉包<br>开启交换机sw1的5号端口，等待端口起来</p>
<p>关闭交换机sw2的5号端口，没有掉包<br>开启交换机sw2的5号端口，等待端口起来<br>一切正常，收工</p>
]]></content>
    <summary type="html">
    <![CDATA[<h2 id="一-_centos_7下查看网卡信息">一. centos 7下查看网卡信息</h2><p>命令 ip addr </p>
<p>最小化安装的Centos7系统并没有nano vim wget curl ifconfig lsof命令，这里首先安装一下</p>
<p><code>yum -y install nano vim wget curl net-tools lsof</code></p>
<p>安装后就可以使用ifconfig 等命令</p>
<p>配置bond</p>
<p>服务器有4个网卡分别为 ifcfg-em1 ifcfg-em2 ifcfg-em3 ifcfg-em4 网卡ifcfg-em1和ifcfg-em2配置bond0</p>]]>
    
    </summary>
    
      <category term="bond" scheme="http://linux48.com/tags/bond/"/>
    
      <category term="centos" scheme="http://linux48.com/tags/centos/"/>
    
      <category term="centos7" scheme="http://linux48.com/tags/centos7/"/>
    
      <category term="网络" scheme="http://linux48.com/categories/%E7%BD%91%E7%BB%9C/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[CentOS下Nginx配置Perl运行Bugzilla]]></title>
    <link href="http://linux48.com//archives/444/"/>
    <id>http://linux48.com//archives/444/</id>
    <published>2016-02-02T16:00:00.000Z</published>
    <updated>2016-04-09T09:12:49.000Z</updated>
    <content type="html"><![CDATA[<h1 id="安装LNMP">安装LNMP</h1><p>此处省略。。。</p>
<h1 id="安装perl-fcgi模块">安装perl-fcgi模块</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">yum -y install perl-FCGI</span><br><span class="line"></span><br><span class="line"><span class="comment">#或者源码编译安装</span></span><br><span class="line"></span><br><span class="line">wget http://search.cpan.org/CPAN/authors/id/F/FL/FLORA/FCGI-<span class="number">0.74</span>.tar.gz</span><br><span class="line">tar zxvf FCGI-<span class="number">0.74</span>.tar.gz </span><br><span class="line"><span class="built_in">cd</span> FCGI-<span class="number">0.74</span></span><br><span class="line">perl Makefile.PL</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h1 id="新建perl脚本用做fastcgi进程管理，保存为/usr/bin/perl-fastcgi-pl">新建perl脚本用做fastcgi进程管理，保存为/usr/bin/perl-fastcgi.pl</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="shebang">#! /bin/sh</span></span><br><span class="line"><span class="comment">#!/usr/bin/perl</span></span><br><span class="line"> </span><br><span class="line">use FCGI;</span><br><span class="line">use Socket;</span><br><span class="line">use POSIX qw(setsid);</span><br><span class="line"> </span><br><span class="line">require <span class="string">'syscall.ph'</span>;</span><br><span class="line"> </span><br><span class="line">&amp;daemonize;</span><br><span class="line"> </span><br><span class="line"><span class="comment">#this keeps the program alive or something after exec'ing perl scripts</span></span><br><span class="line"><span class="function"><span class="title">END</span></span>() &#123; &#125; <span class="function"><span class="title">BEGIN</span></span>() &#123; &#125;</span><br><span class="line">*CORE::GLOBAL::<span class="built_in">exit</span> = sub &#123; die <span class="string">"fakeexit\nrc="</span>.shift().<span class="string">"\n"</span>; &#125;;</span><br><span class="line"><span class="built_in">eval</span> q&#123;<span class="built_in">exit</span>&#125;;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$@</span>) &#123;</span><br><span class="line">    <span class="built_in">exit</span> unless <span class="variable">$@</span> =~ /^fakeexit/;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line">&amp;main;</span><br><span class="line"> </span><br><span class="line">sub <span class="function"><span class="title">daemonize</span></span>() &#123;</span><br><span class="line">    <span class="built_in">chdir</span> <span class="string">'/'</span>                 or die <span class="string">"Can't chdir to /: $!"</span>;</span><br><span class="line">    defined(my <span class="variable">$pid</span> = fork)   or die <span class="string">"Can't fork: $!"</span>;</span><br><span class="line">    <span class="built_in">exit</span> <span class="keyword">if</span> <span class="variable">$pid</span>;</span><br><span class="line">    setsid                    or die <span class="string">"Can't start a new session: $!"</span>;</span><br><span class="line">    <span class="built_in">umask</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">sub main &#123;</span><br><span class="line">    <span class="comment">#$socket = FCGI::OpenSocket( "127.0.0.1:8999", 10 ); #use IP sockets</span></span><br><span class="line">        <span class="variable">$socket</span> = FCGI::OpenSocket( <span class="string">"/tmp/perl-fastcgi.sock"</span>, <span class="number">10</span> ); <span class="comment">#use IP sockets</span></span><br><span class="line">        <span class="variable">$request</span> = FCGI::Request( \*STDIN, \*STDOUT, \*STDERR, \%req_params, <span class="variable">$socket</span> );</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$request</span>) &#123; request_loop()&#125;;</span><br><span class="line">            FCGI::CloseSocket( <span class="variable">$socket</span> );</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">sub request_loop &#123;</span><br><span class="line">        <span class="keyword">while</span>( <span class="variable">$request</span>-&gt;Accept() &gt;= <span class="number">0</span> ) &#123;</span><br><span class="line"> </span><br><span class="line">           <span class="comment">#processing any STDIN input from WebServer (for CGI-POST actions)</span></span><br><span class="line">           <span class="variable">$stdin_passthrough</span> =<span class="string">''</span>;</span><br><span class="line">           <span class="variable">$req_len</span> = <span class="number">0</span> + <span class="variable">$req_params</span>&#123;<span class="string">'CONTENT_LENGTH'</span>&#125;;</span><br><span class="line">           <span class="keyword">if</span> ((<span class="variable">$req_params</span>&#123;<span class="string">'REQUEST_METHOD'</span>&#125; eq <span class="string">'POST'</span>) &amp;&amp; (<span class="variable">$req_len</span> != <span class="number">0</span>) )&#123;</span><br><span class="line">                my <span class="variable">$bytes_read</span> = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">while</span> (<span class="variable">$bytes_read</span> &lt; <span class="variable">$req_len</span>) &#123;</span><br><span class="line">                        my <span class="variable">$data</span> = <span class="string">''</span>;</span><br><span class="line">                        my <span class="variable">$bytes</span> = <span class="built_in">read</span>(STDIN, <span class="variable">$data</span>, (<span class="variable">$req_len</span> - <span class="variable">$bytes_read</span>));</span><br><span class="line">                        last <span class="keyword">if</span> (<span class="variable">$bytes</span> == <span class="number">0</span> || !defined(<span class="variable">$bytes</span>));</span><br><span class="line">                        <span class="variable">$stdin_passthrough</span> .= <span class="variable">$data</span>;</span><br><span class="line">                        <span class="variable">$bytes_read</span> += <span class="variable">$bytes</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">#running the cgi app</span></span><br><span class="line">            <span class="keyword">if</span> ( (-x <span class="variable">$req_params</span>&#123;SCRIPT_FILENAME&#125;) &amp;&amp;  <span class="comment">#can I execute this?</span></span><br><span class="line">                 (<span class="operator">-s</span> <span class="variable">$req_params</span>&#123;SCRIPT_FILENAME&#125;) &amp;&amp;  <span class="comment">#Is this file empty?</span></span><br><span class="line">                 (-r <span class="variable">$req_params</span>&#123;SCRIPT_FILENAME&#125;)     <span class="comment">#can I read this file?</span></span><br><span class="line">            )&#123;</span><br><span class="line">        pipe(CHILD_RD, PARENT_WR);</span><br><span class="line">        my <span class="variable">$pid</span> = open(KID_TO_READ, <span class="string">"-|"</span>);</span><br><span class="line">        unless(defined(<span class="variable">$pid</span>)) &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Content-type: text/plain\r\n\r\n"</span>);</span><br><span class="line">                        <span class="built_in">print</span> <span class="string">"Error: CGI app returned no output - "</span>;</span><br><span class="line">                        <span class="built_in">print</span> <span class="string">"Executing <span class="variable">$req_params</span>&#123;SCRIPT_FILENAME&#125; failed !\n"</span>;</span><br><span class="line">            next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$pid</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            close(CHILD_RD);</span><br><span class="line">            <span class="built_in">print</span> PARENT_WR <span class="variable">$stdin_passthrough</span>;</span><br><span class="line">            close(PARENT_WR);</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">while</span>(my <span class="variable">$s</span> = &lt;KID_TO_READ&gt;) &#123; <span class="built_in">print</span> <span class="variable">$s</span>; &#125;</span><br><span class="line">            close KID_TO_READ;</span><br><span class="line">            waitpid(<span class="variable">$pid</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    foreach <span class="variable">$key</span> ( keys %req_params)&#123;</span><br><span class="line">                       <span class="variable">$ENV</span>&#123;<span class="variable">$key</span>&#125; = <span class="variable">$req_params</span>&#123;<span class="variable">$key</span>&#125;;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment"># cd to the script's local directory</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="variable">$req_params</span>&#123;SCRIPT_FILENAME&#125; =~ /^(.*)\/[^\/]+$/) &#123;</span><br><span class="line">                            <span class="built_in">chdir</span> <span class="variable">$1</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"> </span><br><span class="line">            close(PARENT_WR);</span><br><span class="line">            close(STDIN);</span><br><span class="line">            <span class="comment">#fcntl(CHILD_RD, F_DUPFD, 0);</span></span><br><span class="line">            syscall(&amp;SYS_dup2, fileno(CHILD_RD), <span class="number">0</span>);</span><br><span class="line">            <span class="comment">#open(STDIN, "&lt;&amp;CHILD_RD");</span></span><br><span class="line">            <span class="built_in">exec</span>(<span class="variable">$req_params</span>&#123;SCRIPT_FILENAME&#125;);</span><br><span class="line">            die(<span class="string">"exec failed"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"Content-type: text/plain\r\n\r\n"</span>);</span><br><span class="line">                <span class="built_in">print</span> <span class="string">"Error: No such CGI app - <span class="variable">$req_params</span>&#123;SCRIPT_FILENAME&#125; may not "</span>;</span><br><span class="line">                <span class="built_in">print</span> <span class="string">"exist or is not executable by this process.\n"</span>;</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="新建init脚本，用于管理perl-fastcgi，保存为/etc/init-d/perl-fastcgi">新建init脚本，用于管理perl-fastcgi，保存为/etc/init.d/perl-fastcgi</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/sh</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># nginx – this script starts and stops the nginx daemon</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># chkconfig: - 85 15</span></span><br><span class="line"><span class="comment"># description: Nginx is an HTTP(S) server, HTTP(S) reverse \</span></span><br><span class="line"><span class="comment"># proxy and IMAP/POP3 proxy server</span></span><br><span class="line"><span class="comment"># processname: nginx</span></span><br><span class="line"><span class="comment"># config: /opt/nginx/conf/nginx.conf</span></span><br><span class="line"><span class="comment"># pidfile: /opt/nginx/logs/nginx.pid</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Source function library.</span></span><br><span class="line">. /etc/rc.d/init.d/<span class="built_in">functions</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Source networking configuration.</span></span><br><span class="line">. /etc/sysconfig/network</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Check that networking is up.</span></span><br><span class="line">[ <span class="string">"<span class="variable">$NETWORKING</span>"</span> = <span class="string">"no"</span> ] &amp;&amp; <span class="built_in">exit</span> <span class="number">0</span></span><br><span class="line"> </span><br><span class="line">perlfastcgi=<span class="string">"/usr/bin/perl-fastcgi.pl"</span></span><br><span class="line">prog=$(basename perl)</span><br><span class="line"> </span><br><span class="line">lockfile=/var/lock/subsys/perl-fastcgi</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="title">start</span></span>() &#123;</span><br><span class="line">    [ -x <span class="variable">$perlfastcgi</span> ] || <span class="built_in">exit</span> <span class="number">5</span></span><br><span class="line">    <span class="built_in">echo</span> -n $<span class="string">"Starting <span class="variable">$prog</span>: "</span></span><br><span class="line">    daemon <span class="variable">$perlfastcgi</span></span><br><span class="line">    retval=$?</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    [ <span class="variable">$retval</span> <span class="operator">-eq</span> <span class="number">0</span> ] &amp;&amp; touch <span class="variable">$lockfile</span></span><br><span class="line">    <span class="built_in">return</span> <span class="variable">$retval</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="title">stop</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -n $<span class="string">"Stopping <span class="variable">$prog</span>: "</span></span><br><span class="line">    killproc <span class="variable">$prog</span> -QUIT</span><br><span class="line">    retval=$?</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    [ <span class="variable">$retval</span> <span class="operator">-eq</span> <span class="number">0</span> ] &amp;&amp; rm <span class="operator">-f</span> <span class="variable">$lockfile</span></span><br><span class="line">    <span class="built_in">return</span> <span class="variable">$retval</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="title">restart</span></span>() &#123;</span><br><span class="line">    stop</span><br><span class="line">    start</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="title">reload</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -n $”Reloading <span class="variable">$prog</span>: ”</span><br><span class="line">    killproc <span class="variable">$nginx</span> -HUP</span><br><span class="line">    RETVAL=$?</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="title">force_reload</span></span>() &#123;</span><br><span class="line">    restart</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">rh_status</span></span>() &#123;</span><br><span class="line">    status <span class="variable">$prog</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="title">rh_status_q</span></span>() &#123;</span><br><span class="line">    rh_status &gt;/dev/null <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></span><br><span class="line">    start)</span><br><span class="line">        rh_status_q &amp;&amp; <span class="built_in">exit</span> <span class="number">0</span></span><br><span class="line">        <span class="variable">$1</span></span><br><span class="line">        ;;</span><br><span class="line">    stop)</span><br><span class="line">        rh_status_q || <span class="built_in">exit</span> <span class="number">0</span></span><br><span class="line">        <span class="variable">$1</span></span><br><span class="line">        ;;</span><br><span class="line">    restart)</span><br><span class="line">        <span class="variable">$1</span></span><br><span class="line">        ;;</span><br><span class="line">    reload)</span><br><span class="line">        rh_status_q || <span class="built_in">exit</span> <span class="number">7</span></span><br><span class="line">        <span class="variable">$1</span></span><br><span class="line">        ;;</span><br><span class="line">    force-reload)</span><br><span class="line">        force_reload</span><br><span class="line">        ;;</span><br><span class="line">    status)</span><br><span class="line">        rh_status</span><br><span class="line">        ;;</span><br><span class="line">    condrestart|try-restart)</span><br><span class="line">        rh_status_q || <span class="built_in">exit</span> <span class="number">0</span></span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        <span class="built_in">echo</span> $<span class="string">"Usage: <span class="variable">$0</span> &#123;start|stop|status|restart|condrestart|try-restart|reload|force-reload&#125;"</span></span><br><span class="line">        <span class="built_in">exit</span> <span class="number">2</span></span><br><span class="line">    <span class="keyword">esac</span></span><br></pre></td></tr></table></figure>
<h1 id="启动perl-fastcgi进程：">启动perl-fastcgi进程：</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /usr/bin/perl-fastcgi.pl </span><br><span class="line">chmod <span class="number">755</span> /etc/init.d/perl-fastcgi</span><br><span class="line">/etc/init.d/perl-fastcgi start</span><br><span class="line">chkconfig perl-fastcgi on</span><br></pre></td></tr></table></figure>
<h1 id="Nginx配置：">Nginx配置：</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat /usr/<span class="built_in">local</span>/nginx/conf/vhost/bugzilla.com.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  server &#123;</span><br><span class="line">        listen       <span class="number">80</span>;</span><br><span class="line">        server_name bugzilla.e-buychina.com.cn;</span><br><span class="line"></span><br><span class="line">        root   /app/www/bugzilla;</span><br><span class="line">        index  index.cgi index.pl index.html index.htm;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        location ~ .*\.(pl|cgi)$ &#123;</span><br><span class="line">        root /app/www/bugzilla;</span><br><span class="line">                gzip off;</span><br><span class="line">                include fastcgi_params;</span><br><span class="line">                fastcgi_pass  unix:/tmp/perl-fastcgi.sock;</span><br><span class="line">                fastcgi_index index.cgi;</span><br><span class="line">                fastcgi_param  SCRIPT_FILENAME  /<span class="variable">$document_root</span>/<span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h1 id="新建index-pl脚本测试，加x执行权限。">新建index.pl脚本测试，加x执行权限。</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/perl</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">"Content-type: text/html\n\n"</span>;</span><br><span class="line"><span class="built_in">print</span> <span class="string">"&lt;html&gt;&lt;body&gt;Hello, world.&lt;/body&gt;&lt;/html&gt;"</span>;</span><br></pre></td></tr></table></figure>
<p>如果正常就会显示Hello,world.</p>
<h1 id="安装bugzilla">安装bugzilla</h1><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tar xf bugzilla-<span class="number">5.0</span>.<span class="number">2</span><span class="class">.tar</span><span class="class">.gz</span></span><br><span class="line">cd bugzilla-<span class="number">5.0</span>.<span class="number">1</span></span><br><span class="line">./checksetup<span class="class">.pl</span> --check-modules</span><br><span class="line">perl install-module<span class="class">.pl</span> --all</span><br><span class="line">./checksetup<span class="class">.pl</span></span><br><span class="line">vim localconfig</span><br><span class="line">./checksetup<span class="class">.pl</span></span><br><span class="line">chmod <span class="number">755</span> -R *</span><br></pre></td></tr></table></figure>
<h1 id="bugzilla发邮件">bugzilla发邮件</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">需要的Perl模块</span><br><span class="line">Net::SMTP //perl自带，不用安装</span><br><span class="line">Socket //perl自带，不用安装</span><br><span class="line">Sys::Hostname //perl自带，不用安装</span><br><span class="line">Authen::SASL （用使来验证邮件用户名和密码） //需要安装</span><br><span class="line">使用root身份用如下命令来安装Authen::SASL模块：</span><br><span class="line">root@server ~]<span class="comment"># cpan Authen::SASL</span></span><br><span class="line"></span><br><span class="line">测试模块是否安装：</span><br><span class="line">[root@server1 ~]<span class="comment"># perl -e "use Authen::SASL"</span></span><br><span class="line"></span><br><span class="line">[root@server1 ~]<span class="comment"># //什么也不显示表明模块已经正确安装了。</span></span><br><span class="line"></span><br><span class="line">[root@server1 ~]<span class="comment"># perl -e "use Net::SMTP"</span></span><br><span class="line"></span><br><span class="line">[root@server1 ~]<span class="comment">#</span></span><br><span class="line"></span><br><span class="line">[root@server1 ~]<span class="comment"># perl -e "use Socket"</span></span><br><span class="line"></span><br><span class="line">[root@server1 ~]<span class="comment">#</span></span><br><span class="line"></span><br><span class="line">[root@server1 ~]<span class="comment"># perl -e "use Sys::Hostname"</span></span><br><span class="line"></span><br><span class="line">[root@server1 ~]<span class="comment">#</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vim  data/params.json </span><br><span class="line"></span><br><span class="line"><span class="string">'mailfrom'</span> =&gt; <span class="string">'xxx@163.com'</span>,</span><br><span class="line"><span class="string">'smtp_password'</span> =&gt; <span class="string">'***'</span>,</span><br><span class="line"><span class="string">'smtp_username'</span> =&gt; <span class="string">'xxx@163.com'</span>,</span><br><span class="line"><span class="string">'smtpserver'</span> =&gt; <span class="string">'smtp.163.com'</span>,</span><br><span class="line"><span class="string">'urlbase'</span> =&gt; <span class="string">'http://192.168.0.2/bugzilla/'</span>,</span><br></pre></td></tr></table></figure>
<h1 id="bugzilla忘记密码">bugzilla忘记密码</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">SELECT ENCRYPT(<span class="string">'123.com'</span>);</span><br><span class="line"></span><br><span class="line">使用sql 生成 crypt来加密密文,填入数据库密码(cryptpassword)字段  `bugzilladb`.`profiles`表</span><br></pre></td></tr></table></figure>
]]></content>
    <summary type="html">
    <![CDATA[<h1 id="安装LNMP">安装LNMP</h1><p>此处省略。。。</p>
<h1 id="安装perl-fcgi模块">安装perl-fcgi模块</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">yum -y install perl-FCGI</span><br><span class="line"></span><br><span class="line"><span class="comment">#或者源码编译安装</span></span><br><span class="line"></span><br><span class="line">wget http://search.cpan.org/CPAN/authors/id/F/FL/FLORA/FCGI-<span class="number">0.74</span>.tar.gz</span><br><span class="line">tar zxvf FCGI-<span class="number">0.74</span>.tar.gz </span><br><span class="line"><span class="built_in">cd</span> FCGI-<span class="number">0.74</span></span><br><span class="line">perl Makefile.PL</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>]]>
    
    </summary>
    
      <category term="bugzilla" scheme="http://linux48.com/tags/bugzilla/"/>
    
      <category term="cgi" scheme="http://linux48.com/tags/cgi/"/>
    
      <category term="perl" scheme="http://linux48.com/tags/perl/"/>
    
      <category term="devops" scheme="http://linux48.com/categories/devops/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[CentOS上搭建私有maven仓库]]></title>
    <link href="http://linux48.com//archives/443/"/>
    <id>http://linux48.com//archives/443/</id>
    <published>2015-11-11T16:00:00.000Z</published>
    <updated>2016-04-09T09:12:49.000Z</updated>
    <content type="html"><![CDATA[<h1 id="安装JDK">安装JDK</h1><p>此处省略。。。</p>
<h1 id="安装Sonatype_Nexus">安装Sonatype Nexus</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget http://download.sonatype.com/nexus/oss/nexus-<span class="number">2.11</span>.<span class="number">1</span>-<span class="number">01</span>-bundle.tar.gz</span><br><span class="line">tar zxvf nexus-<span class="number">2.11</span>.<span class="number">1</span>-<span class="number">01</span>-bundle.tar.gz </span><br><span class="line">mv nexus-<span class="number">2.11</span>.<span class="number">1</span>-<span class="number">01</span> /usr/<span class="built_in">local</span>/nexus</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h1 id="启动文件配置">启动文件配置</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/init.d/</span><br><span class="line">cp /usr/<span class="built_in">local</span>/nexus/bin/nexus nexus</span><br><span class="line">cat /etc/init.d/nexus</span><br><span class="line"></span><br><span class="line"><span class="shebang">#! /bin/sh</span><br><span class="line"></span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Copyright (c) 1999, 2006 Tanuki Software Inc.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Java Service Wrapper sh script.  Suitable for starting and stopping</span></span><br><span class="line"><span class="comment">#  wrapped Java applications on UNIX platforms.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#-----------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># These settings can be modified to fit the needs of your application</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set this to the root of the Nexus installation</span></span><br><span class="line">NEXUS_HOME=<span class="string">"/usr/local/nexus"</span></span><br><span class="line">PLATFORM=linux-x86-<span class="number">64</span></span><br><span class="line">PLATFORM_DIR=<span class="string">"<span class="variable">$&#123;NEXUS_HOME&#125;</span>/bin/jsw/<span class="variable">$&#123;PLATFORM&#125;</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># If specified, the Wrapper will be run as the specified user.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># IMPORTANT - Make sure that the user has the required privileges to write into the Nexus installation directory.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># <span class="doctag"><span class="keyword">NOTE</span></span> - This will set the user which is used to run the Wrapper as well as</span></span><br><span class="line"><span class="comment">#  the JVM and is not useful in situations where a privileged resource or</span></span><br><span class="line"><span class="comment">#  port needs to be allocated prior to the user being changed.</span></span><br><span class="line">RUN_AS_USER=root</span><br><span class="line"></span><br><span class="line"><span class="comment"># Application</span></span><br><span class="line">APP_NAME=<span class="string">"nexus"</span></span><br><span class="line">APP_LONG_NAME=<span class="string">"Nexus OSS"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Priority at which to run the wrapper.  See "man nice" for valid priorities.</span></span><br><span class="line"><span class="comment">#  nice is only used if a priority is specified.</span></span><br><span class="line">PRIORITY=</span><br><span class="line"></span><br><span class="line"><span class="comment"># Location of the pid file.</span></span><br><span class="line"><span class="comment">#PIDDIR="."</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># If uncommented, causes the Wrapper to be shutdown using an anchor file.</span></span><br><span class="line"><span class="comment">#  When launched with the 'start' command, it will also ignore all INT and</span></span><br><span class="line"><span class="comment">#  TERM signals.</span></span><br><span class="line"><span class="comment">#IGNORE_SIGNALS=true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The following two lines are used by the chkconfig command. Change as is</span></span><br><span class="line"><span class="comment">#  appropriate for your application.  They should remain commented.</span></span><br><span class="line"><span class="comment"># chkconfig: 2345 20 80</span></span><br><span class="line"><span class="comment"># description: Test Wrapper Sample Application</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Do not modify anything beyond this point</span></span><br><span class="line"><span class="comment">#-----------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Get the fully qualified path to the script</span></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$0</span> <span class="keyword">in</span></span><br><span class="line">    /*)</span><br><span class="line">        SCRIPT=<span class="string">"<span class="variable">$0</span>"</span></span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        PWD=`<span class="built_in">pwd</span>`</span><br><span class="line">        SCRIPT=<span class="string">"<span class="variable">$PWD</span>/<span class="variable">$0</span>"</span></span><br><span class="line">        ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Resolve the true real path without any sym links.</span></span><br><span class="line">CHANGED=<span class="literal">true</span></span><br><span class="line"><span class="keyword">while</span> [ <span class="string">"X<span class="variable">$CHANGED</span>"</span> != <span class="string">"X"</span> ]</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="comment"># Change spaces to ":" so the tokens can be parsed.</span></span><br><span class="line">    SAFESCRIPT=`<span class="built_in">echo</span> <span class="variable">$SCRIPT</span> | sed <span class="operator">-e</span> <span class="string">'s; ;:;g'</span>`</span><br><span class="line">    <span class="comment"># Get the real path to this script, resolving any symbolic links</span></span><br><span class="line">    TOKENS=`<span class="built_in">echo</span> <span class="variable">$SAFESCRIPT</span> | sed <span class="operator">-e</span> <span class="string">'s;/; ;g'</span>`</span><br><span class="line">    REALPATH=</span><br><span class="line">    <span class="keyword">for</span> C <span class="keyword">in</span> <span class="variable">$TOKENS</span>; <span class="keyword">do</span></span><br><span class="line">        <span class="comment"># Change any ":" in the token back to a space.</span></span><br><span class="line">        C=`<span class="built_in">echo</span> <span class="variable">$C</span> | sed <span class="operator">-e</span> <span class="string">'s;:; ;g'</span>`</span><br><span class="line">        REALPATH=<span class="string">"<span class="variable">$REALPATH</span>/<span class="variable">$C</span>"</span></span><br><span class="line">        <span class="comment"># If REALPATH is a sym link, resolve it.  Loop for nested links.</span></span><br><span class="line">        <span class="keyword">while</span> [ -h <span class="string">"<span class="variable">$REALPATH</span>"</span> ] ; <span class="keyword">do</span></span><br><span class="line">            LS=<span class="string">"`ls -ld "</span><span class="variable">$REALPATH</span><span class="string">"`"</span></span><br><span class="line">            LINK=<span class="string">"`expr "</span><span class="variable">$LS</span><span class="string">" : '.*-&gt; \(.*\)$'`"</span></span><br><span class="line">            <span class="keyword">if</span> expr <span class="string">"<span class="variable">$LINK</span>"</span> : <span class="string">'/.*'</span> &gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">                <span class="comment"># LINK is absolute.</span></span><br><span class="line">                REALPATH=<span class="string">"<span class="variable">$LINK</span>"</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="comment"># LINK is relative.</span></span><br><span class="line">                REALPATH=<span class="string">"`dirname "</span><span class="variable">$REALPATH</span><span class="string">"`"</span><span class="string">"/<span class="variable">$LINK</span>"</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"<span class="variable">$REALPATH</span>"</span> = <span class="string">"<span class="variable">$SCRIPT</span>"</span> ]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        CHANGED=<span class="string">""</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        SCRIPT=<span class="string">"<span class="variable">$REALPATH</span>"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Change the current directory to the location of the script</span></span><br><span class="line"><span class="built_in">cd</span> <span class="string">"`dirname "</span><span class="variable">$REALPATH</span><span class="string">"`"</span></span><br><span class="line">REALDIR=`<span class="built_in">pwd</span>`</span><br><span class="line"></span><br><span class="line"><span class="comment"># Resolve the location of the 'ps' command</span></span><br><span class="line">PSEXE=<span class="string">"/usr/bin/ps"</span></span><br><span class="line"><span class="keyword">if</span> [ ! -x <span class="string">"<span class="variable">$PSEXE</span>"</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    PSEXE=<span class="string">"/bin/ps"</span></span><br><span class="line">    <span class="keyword">if</span> [ ! -x <span class="string">"<span class="variable">$PSEXE</span>"</span> ]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Unable to locate 'ps'."</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Please report this message along with the location of the command on your system."</span></span><br><span class="line">        <span class="built_in">exit</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Resolve the os</span></span><br><span class="line">DIST_OS=`uname <span class="operator">-s</span> | tr [:upper:] [:lower:] | tr <span class="operator">-d</span> [:blank:]`</span><br><span class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$DIST_OS</span>"</span> <span class="keyword">in</span></span><br><span class="line">    <span class="string">'sunos'</span>)</span><br><span class="line">        DIST_OS=<span class="string">"solaris"</span></span><br><span class="line">        PSEXE=<span class="string">"/usr/ucb/ps"</span></span><br><span class="line">        ;;</span><br><span class="line">    <span class="string">'hp-ux'</span> | <span class="string">'hp-ux64'</span>)</span><br><span class="line">        DIST_OS=<span class="string">"hpux"</span></span><br><span class="line">        ;;</span><br><span class="line">    <span class="string">'darwin'</span>)</span><br><span class="line">        DIST_OS=<span class="string">"macosx"</span></span><br><span class="line">        ;;</span><br><span class="line">    <span class="string">'unix_sv'</span>)</span><br><span class="line">        DIST_OS=<span class="string">"unixware"</span></span><br><span class="line">        ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Resolve the architecture</span></span><br><span class="line">DIST_ARCH=`uname -p | tr [:upper:] [:lower:] | tr <span class="operator">-d</span> [:blank:]`</span><br><span class="line">DIST_BITS=<span class="number">32</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$DIST_ARCH</span>"</span> = <span class="string">"unknown"</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    DIST_ARCH=`uname -m | tr [:upper:] [:lower:] | tr <span class="operator">-d</span> [:blank:]`</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$DIST_ARCH</span>"</span> <span class="keyword">in</span></span><br><span class="line">    <span class="string">'athlon'</span> | <span class="string">'ia32'</span> | <span class="string">'i386'</span> | <span class="string">'i486'</span> | <span class="string">'i586'</span> | <span class="string">'i686'</span>)</span><br><span class="line">        DIST_ARCH=<span class="string">"x86"</span></span><br><span class="line">        ;;</span><br><span class="line">    <span class="string">'amd64'</span> | <span class="string">'x86_64'</span> | <span class="string">'ia64'</span>)</span><br><span class="line">        DIST_ARCH=<span class="string">"x86"</span></span><br><span class="line">        DIST_BITS=<span class="number">64</span></span><br><span class="line">        ;;</span><br><span class="line">    <span class="string">'ip27'</span>)</span><br><span class="line">        DIST_ARCH=<span class="string">"mips"</span></span><br><span class="line">        ;;</span><br><span class="line">    <span class="string">'power'</span> | <span class="string">'powerpc'</span> | <span class="string">'power_pc'</span>)</span><br><span class="line">        DIST_ARCH=<span class="string">"ppc"</span></span><br><span class="line">        ;;</span><br><span class="line">    <span class="string">'ppc64'</span>)</span><br><span class="line">        DIST_ARCH=<span class="string">"ppc"</span></span><br><span class="line">        DIST_BITS=<span class="number">64</span></span><br><span class="line">        ;;</span><br><span class="line">    <span class="string">'pa_risc'</span> | <span class="string">'pa-risc'</span>)</span><br><span class="line">        DIST_ARCH=<span class="string">"parisc"</span></span><br><span class="line">        ;;</span><br><span class="line">    <span class="string">'sun4u'</span> | <span class="string">'sparcv9'</span>)</span><br><span class="line">        DIST_ARCH=<span class="string">"sparc"</span></span><br><span class="line">        ;;</span><br><span class="line">    <span class="string">'9000/800'</span>)</span><br><span class="line">        DIST_ARCH=<span class="string">"parisc"</span></span><br><span class="line">        ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Extra architecture detection</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$DIST_OS</span>"</span> <span class="keyword">in</span></span><br><span class="line">    <span class="string">'macosx'</span>)</span><br><span class="line">        <span class="keyword">if</span> [ `sysctl hw.cpu64bit_capable | awk <span class="string">'&#123; print $2 &#125;'</span>` = <span class="string">'1'</span> ]; <span class="keyword">then</span></span><br><span class="line">            DIST_BITS=<span class="number">64</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        DIST_ARCH=<span class="string">'universal'</span></span><br><span class="line">        ;;</span><br><span class="line">    <span class="string">'aix'</span>)</span><br><span class="line">        DIST_BITS=`getconf KERNEL_BITMODE`</span><br><span class="line">        ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">outputFile</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> [ <span class="operator">-f</span> <span class="string">"<span class="variable">$1</span>"</span> ]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"  <span class="variable">$1</span> (Found but not executable.)"</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"  <span class="variable">$1</span>"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Test if NEXUS_HOME is relative (does not start with /). If relative it should be relative to this script location</span></span><br><span class="line">FIRST_CHAR=`<span class="built_in">echo</span> <span class="variable">$NEXUS_HOME</span> | cut -c1,<span class="number">1</span>`</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$FIRST_CHAR</span>"</span> != <span class="string">"/"</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    NEXUS_HOME=<span class="variable">$REALDIR</span>/<span class="variable">$NEXUS_HOME</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Default PIDDIR to os/arch/bits directory</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"X<span class="variable">$PIDDIR</span>"</span> = <span class="string">"X"</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    PIDDIR=<span class="string">"bin/jsw/<span class="variable">$DIST_OS</span>-<span class="variable">$DIST_ARCH</span>-<span class="variable">$DIST_BITS</span>"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># If the PIDDIR is relative, set its value relative to the full NEXUS_HOME to avoid problems if</span></span><br><span class="line"><span class="comment">#  the working directory is later changed.</span></span><br><span class="line">FIRST_CHAR=`<span class="built_in">echo</span> <span class="variable">$PIDDIR</span> | cut -c1,<span class="number">1</span>`</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$FIRST_CHAR</span>"</span> != <span class="string">"/"</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    PIDDIR=<span class="variable">$NEXUS_HOME</span>/<span class="variable">$PIDDIR</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Process ID</span></span><br><span class="line">ANCHORFILE=<span class="string">"<span class="variable">$PIDDIR</span>/<span class="variable">$APP_NAME</span>.anchor"</span></span><br><span class="line">PIDFILE=<span class="string">"<span class="variable">$PIDDIR</span>/<span class="variable">$APP_NAME</span>.pid"</span></span><br><span class="line">LOCKDIR=<span class="string">"/var/lock/subsys"</span></span><br><span class="line">LOCKFILE=<span class="string">"<span class="variable">$LOCKDIR</span>/<span class="variable">$APP_NAME</span>"</span></span><br><span class="line">pid=<span class="string">""</span></span><br><span class="line"></span><br><span class="line">WRAPPER_CMD=<span class="string">"<span class="variable">$&#123;PLATFORM_DIR&#125;</span>/wrapper"</span></span><br><span class="line"><span class="keyword">if</span> [ ! -x <span class="string">"<span class="variable">$WRAPPER_CMD</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Missing platform binary: <span class="variable">$WRAPPER_CMD</span>"</span></span><br><span class="line">    <span class="built_in">exit</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">WRAPPER_CONF=<span class="string">"<span class="variable">$&#123;PLATFORM_DIR&#125;</span>/../conf/wrapper.conf"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Build the nice clause</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"X<span class="variable">$PRIORITY</span>"</span> = <span class="string">"X"</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    CMDNICE=<span class="string">""</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    CMDNICE=<span class="string">"nice -<span class="variable">$PRIORITY</span>"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Build the anchor file clause.</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"X<span class="variable">$IGNORE_SIGNALS</span>"</span> = <span class="string">"X"</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">   ANCHORPROP=</span><br><span class="line">   IGNOREPROP=</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">   ANCHORPROP=wrapper.anchorfile=\<span class="string">"<span class="variable">$ANCHORFILE</span>\"</span><br><span class="line">   IGNOREPROP=wrapper.ignore_signals=TRUE</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># Build the lock file clause.  Only create a lock file if the lock directory exists on this platform.</span><br><span class="line">LOCKPROP=</span><br><span class="line">if [ -d <span class="variable">$LOCKDIR</span> ]</span><br><span class="line">then</span><br><span class="line">    if [ -w <span class="variable">$LOCKDIR</span> ]</span><br><span class="line">    then</span><br><span class="line">        LOCKPROP=wrapper.lockfile=\"<span class="variable">$LOCKFILE</span>\"</span><br><span class="line">    fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">checkUser() &#123;</span><br><span class="line">    # <span class="variable">$1</span> touchLock flag</span><br><span class="line">    # <span class="variable">$2</span> command</span><br><span class="line"></span><br><span class="line">    # Resolve the location of the 'id' command</span><br><span class="line">    IDEXE="</span>/usr/xpg4/bin/id<span class="string">"</span><br><span class="line">    if [ ! -x "</span><span class="variable">$IDEXE</span><span class="string">" ]</span><br><span class="line">    then</span><br><span class="line">        IDEXE="</span>/usr/bin/id<span class="string">"</span><br><span class="line">        if [ ! -x "</span><span class="variable">$IDEXE</span><span class="string">" ]</span><br><span class="line">        then</span><br><span class="line">            echo "</span>Unable to locate <span class="string">'id'</span>.<span class="string">"</span><br><span class="line">            echo "</span>Please report this message along with the location of the <span class="built_in">command</span> on your system.<span class="string">"</span><br><span class="line">            exit 1</span><br><span class="line">        fi</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # Check the configured user.  If necessary rerun this script as the desired user.</span><br><span class="line">    if [ "</span>X<span class="variable">$RUN_AS_USER</span><span class="string">" != "</span>X<span class="string">" ]</span><br><span class="line">    then</span><br><span class="line">        if [ "</span>`<span class="variable">$IDEXE</span> -u -n`<span class="string">" != "</span><span class="variable">$RUN_AS_USER</span><span class="string">" ]</span><br><span class="line">        then</span><br><span class="line">            # If LOCKPROP and <span class="variable">$RUN_AS_USER</span> are defined then the new user will most likely not be</span><br><span class="line">            # able to create the lock file.  The Wrapper will be able to update this file once it</span><br><span class="line">            # is created but will not be able to delete it on shutdown.  If <span class="variable">$2</span> is defined then</span><br><span class="line">            # the lock file should be created for the current command</span><br><span class="line">            if [ "</span>X<span class="variable">$LOCKPROP</span><span class="string">" != "</span>X<span class="string">" ]</span><br><span class="line">            then</span><br><span class="line">                if [ "</span>X<span class="variable">$1</span><span class="string">" != "</span>X<span class="string">" ]</span><br><span class="line">                then</span><br><span class="line">                    # Resolve the primary group </span><br><span class="line">                    RUN_AS_GROUP=`groups <span class="variable">$RUN_AS_USER</span> | awk '&#123;print <span class="variable">$3</span>&#125;' | tail -1`</span><br><span class="line">                    if [ "</span>X<span class="variable">$RUN_AS_GROUP</span><span class="string">" = "</span>X<span class="string">" ]</span><br><span class="line">                    then</span><br><span class="line">                        RUN_AS_GROUP=<span class="variable">$RUN_AS_USER</span></span><br><span class="line">                    fi</span><br><span class="line">                    touch <span class="variable">$LOCKFILE</span></span><br><span class="line">                    chown <span class="variable">$RUN_AS_USER</span>:<span class="variable">$RUN_AS_GROUP</span> <span class="variable">$LOCKFILE</span></span><br><span class="line">                fi</span><br><span class="line">            fi</span><br><span class="line">    </span><br><span class="line">            # Still want to change users, recurse.  This means that the user will only be</span><br><span class="line">            #  prompted for a password once. Variables shifted by 1</span><br><span class="line">            su - <span class="variable">$RUN_AS_USER</span> -c "</span>\<span class="string">"<span class="variable">$REALPATH</span>\" <span class="variable">$2</span>"</span></span><br><span class="line">    </span><br><span class="line">            <span class="comment"># Now that we are the original user again, we may need to clean up the lock file.</span></span><br><span class="line">            <span class="keyword">if</span> [ <span class="string">"X<span class="variable">$LOCKPROP</span>"</span> != <span class="string">"X"</span> ]</span><br><span class="line">            <span class="keyword">then</span></span><br><span class="line">                getpid</span><br><span class="line">                <span class="keyword">if</span> [ <span class="string">"X<span class="variable">$pid</span>"</span> = <span class="string">"X"</span> ]</span><br><span class="line">                <span class="keyword">then</span></span><br><span class="line">                    <span class="comment"># Wrapper is not running so make sure the lock file is deleted.</span></span><br><span class="line">                    <span class="keyword">if</span> [ <span class="operator">-f</span> <span class="string">"<span class="variable">$LOCKFILE</span>"</span> ]</span><br><span class="line">                    <span class="keyword">then</span></span><br><span class="line">                        rm <span class="string">"<span class="variable">$LOCKFILE</span>"</span></span><br><span class="line">                    <span class="keyword">fi</span></span><br><span class="line">                <span class="keyword">fi</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">            <span class="built_in">exit</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Check that script is not run as root</span></span><br><span class="line">    LUID=`<span class="variable">$IDEXE</span> -u`</span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$LUID</span> <span class="operator">-eq</span> <span class="number">0</span> ]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"****************************************"</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"WARNING - NOT RECOMMENDED TO RUN AS ROOT"</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"****************************************"</span></span><br><span class="line">        <span class="keyword">if</span> [ ! <span class="string">"`<span class="variable">$IDEXE</span> -u -n`"</span> = <span class="string">"<span class="variable">$RUN_AS_USER</span>"</span> ]</span><br><span class="line">        <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"If you insist running as root, then set the environment variable RUN_AS_USER=root before running this script."</span></span><br><span class="line">            <span class="built_in">exit</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">getpid</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> [ <span class="operator">-f</span> <span class="string">"<span class="variable">$PIDFILE</span>"</span> ]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> [ -r <span class="string">"<span class="variable">$PIDFILE</span>"</span> ]</span><br><span class="line">        <span class="keyword">then</span></span><br><span class="line">            pid=`cat <span class="string">"<span class="variable">$PIDFILE</span>"</span>`</span><br><span class="line">            <span class="keyword">if</span> [ <span class="string">"X<span class="variable">$pid</span>"</span> != <span class="string">"X"</span> ]</span><br><span class="line">            <span class="keyword">then</span></span><br><span class="line">                <span class="comment"># It is possible that 'a' process with the pid exists but that it is not the</span></span><br><span class="line">                <span class="comment">#  correct process.  This can happen in a number of cases, but the most</span></span><br><span class="line">                <span class="comment">#  common is during system startup after an unclean shutdown.</span></span><br><span class="line">                <span class="comment"># The ps statement below looks for the specific wrapper command running as</span></span><br><span class="line">                <span class="comment">#  the pid.  If it is not found then the pid file is considered to be stale.</span></span><br><span class="line">                <span class="keyword">case</span> <span class="string">"<span class="variable">$DIST_OS</span>"</span> <span class="keyword">in</span></span><br><span class="line">                    <span class="string">'macosx'</span>)</span><br><span class="line">                        pidtest=`<span class="variable">$PSEXE</span> -ww -p <span class="variable">$pid</span> -o <span class="built_in">command</span> | grep <span class="string">"wrapper.pidfile"</span> | tail -<span class="number">1</span>`</span><br><span class="line">                        ;;</span><br><span class="line">                    <span class="string">'solaris'</span>)</span><br><span class="line">                        pidtest=`<span class="variable">$PSEXE</span> ww <span class="variable">$pid</span> | grep <span class="string">"wrapper.pidfile"</span> | tail -<span class="number">1</span>`</span><br><span class="line">                        ;;</span><br><span class="line">                    *)</span><br><span class="line">                        pidtest=`<span class="variable">$PSEXE</span> -p <span class="variable">$pid</span> -o args | grep <span class="string">"wrapper.pidfile"</span> | tail -<span class="number">1</span>`</span><br><span class="line">                        ;;</span><br><span class="line">                <span class="keyword">esac</span></span><br><span class="line">                <span class="keyword">if</span> [ <span class="string">"X<span class="variable">$pidtest</span>"</span> = <span class="string">"X"</span> ]</span><br><span class="line">                <span class="keyword">then</span></span><br><span class="line">                    <span class="comment"># This is a stale pid file.</span></span><br><span class="line">                    rm <span class="operator">-f</span> <span class="string">"<span class="variable">$PIDFILE</span>"</span></span><br><span class="line">                    <span class="built_in">echo</span> <span class="string">"Removed stale pid file: <span class="variable">$PIDFILE</span>"</span></span><br><span class="line">                    pid=<span class="string">""</span></span><br><span class="line">                <span class="keyword">fi</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"Cannot read <span class="variable">$PIDFILE</span>."</span></span><br><span class="line">            <span class="built_in">exit</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">testpid</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"<span class="variable">$DIST_OS</span>"</span> = <span class="string">"solaris"</span> ]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        pid=`<span class="variable">$PSEXE</span> ww <span class="variable">$pid</span> | grep <span class="variable">$pid</span> | grep -v grep | awk <span class="string">'&#123;print $1&#125;'</span> | tail -<span class="number">1</span>`</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        pid=`<span class="variable">$PSEXE</span> -p <span class="variable">$pid</span> | grep <span class="variable">$pid</span> | grep -v grep | awk <span class="string">'&#123;print $1&#125;'</span> | tail -<span class="number">1</span>`</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"X<span class="variable">$pid</span>"</span> = <span class="string">"X"</span> ]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        <span class="comment"># Process is gone so remove the pid file.</span></span><br><span class="line">        rm <span class="operator">-f</span> <span class="string">"<span class="variable">$PIDFILE</span>"</span></span><br><span class="line">        pid=<span class="string">""</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">console</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Running <span class="variable">$APP_LONG_NAME</span>..."</span></span><br><span class="line">    getpid</span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"X<span class="variable">$pid</span>"</span> = <span class="string">"X"</span> ]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        <span class="comment"># The string passed to eval must handles spaces in paths correctly.</span></span><br><span class="line">        COMMAND_LINE=<span class="string">"<span class="variable">$CMDNICE</span> \"<span class="variable">$WRAPPER_CMD</span>\" \"<span class="variable">$WRAPPER_CONF</span>\" wrapper.syslog.ident=<span class="variable">$APP_NAME</span> wrapper.pidfile=\"<span class="variable">$PIDFILE</span>\" <span class="variable">$ANCHORPROP</span> <span class="variable">$LOCKPROP</span>"</span></span><br><span class="line">        <span class="built_in">eval</span> <span class="variable">$COMMAND_LINE</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$APP_LONG_NAME</span> is already running."</span></span><br><span class="line">        <span class="built_in">exit</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="title">start</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Starting <span class="variable">$APP_LONG_NAME</span>..."</span></span><br><span class="line">    getpid</span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"X<span class="variable">$pid</span>"</span> = <span class="string">"X"</span> ]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        <span class="comment"># The string passed to eval must handles spaces in paths correctly.</span></span><br><span class="line">        COMMAND_LINE=<span class="string">"<span class="variable">$CMDNICE</span> \"<span class="variable">$WRAPPER_CMD</span>\" \"<span class="variable">$WRAPPER_CONF</span>\" wrapper.syslog.ident=<span class="variable">$APP_NAME</span> wrapper.pidfile=\"<span class="variable">$PIDFILE</span>\" wrapper.daemonize=TRUE <span class="variable">$ANCHORPROP</span> <span class="variable">$IGNOREPROP</span> <span class="variable">$LOCKPROP</span>"</span></span><br><span class="line">        <span class="built_in">eval</span> <span class="variable">$COMMAND_LINE</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$APP_LONG_NAME</span> is already running."</span></span><br><span class="line">        <span class="built_in">exit</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    getpid</span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"X<span class="variable">$pid</span>"</span> != <span class="string">"X"</span> ]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Started <span class="variable">$APP_LONG_NAME</span>."</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Failed to start <span class="variable">$APP_LONG_NAME</span>."</span></span><br><span class="line">    <span class="keyword">fi</span>    </span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="title">stopit</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Stopping <span class="variable">$APP_LONG_NAME</span>..."</span></span><br><span class="line">    getpid</span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"X<span class="variable">$pid</span>"</span> = <span class="string">"X"</span> ]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$APP_LONG_NAME</span> was not running."</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">if</span> [ <span class="string">"X<span class="variable">$IGNORE_SIGNALS</span>"</span> = <span class="string">"X"</span> ]</span><br><span class="line">        <span class="keyword">then</span></span><br><span class="line">            <span class="comment"># Running so try to stop it.</span></span><br><span class="line">            <span class="built_in">kill</span> <span class="variable">$pid</span></span><br><span class="line">            <span class="keyword">if</span> [ $? <span class="operator">-ne</span> <span class="number">0</span> ]</span><br><span class="line">            <span class="keyword">then</span></span><br><span class="line">                <span class="comment"># An explanation for the failure should have been given</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">"Unable to stop <span class="variable">$APP_LONG_NAME</span>."</span></span><br><span class="line">                <span class="built_in">exit</span> <span class="number">1</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            rm <span class="operator">-f</span> <span class="string">"<span class="variable">$ANCHORFILE</span>"</span></span><br><span class="line">            <span class="keyword">if</span> [ <span class="operator">-f</span> <span class="string">"<span class="variable">$ANCHORFILE</span>"</span> ]</span><br><span class="line">            <span class="keyword">then</span></span><br><span class="line">                <span class="comment"># An explanation for the failure should have been given</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">"Unable to stop <span class="variable">$APP_LONG_NAME</span>."</span></span><br><span class="line">                <span class="built_in">exit</span> <span class="number">1</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># We can not predict how long it will take for the wrapper to</span></span><br><span class="line">        <span class="comment">#  actually stop as it depends on settings in wrapper.conf.</span></span><br><span class="line">        <span class="comment">#  Loop until it does.</span></span><br><span class="line">        savepid=<span class="variable">$pid</span></span><br><span class="line">        CNT=<span class="number">0</span></span><br><span class="line">        TOTCNT=<span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> [ <span class="string">"X<span class="variable">$pid</span>"</span> != <span class="string">"X"</span> ]</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">            <span class="comment"># Show a waiting message every 5 seconds.</span></span><br><span class="line">            <span class="keyword">if</span> [ <span class="string">"<span class="variable">$CNT</span>"</span> <span class="operator">-lt</span> <span class="string">"5"</span> ]</span><br><span class="line">            <span class="keyword">then</span></span><br><span class="line">                CNT=`expr <span class="variable">$CNT</span> + <span class="number">1</span>`</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">"Waiting for <span class="variable">$APP_LONG_NAME</span> to exit..."</span></span><br><span class="line">                CNT=<span class="number">0</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">            TOTCNT=`expr <span class="variable">$TOTCNT</span> + <span class="number">1</span>`</span><br><span class="line"></span><br><span class="line">            sleep <span class="number">1</span></span><br><span class="line"></span><br><span class="line">            testpid</span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">        pid=<span class="variable">$savepid</span></span><br><span class="line">        testpid</span><br><span class="line">        <span class="keyword">if</span> [ <span class="string">"X<span class="variable">$pid</span>"</span> != <span class="string">"X"</span> ]</span><br><span class="line">        <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"Failed to stop <span class="variable">$APP_LONG_NAME</span>."</span></span><br><span class="line">            <span class="built_in">exit</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"Stopped <span class="variable">$APP_LONG_NAME</span>."</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">status</span></span>() &#123;</span><br><span class="line">    getpid</span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"X<span class="variable">$pid</span>"</span> = <span class="string">"X"</span> ]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$APP_LONG_NAME</span> is not running."</span></span><br><span class="line">        <span class="built_in">exit</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$APP_LONG_NAME</span> is running (<span class="variable">$pid</span>)."</span></span><br><span class="line">        <span class="built_in">exit</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">dump</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Dumping <span class="variable">$APP_LONG_NAME</span>..."</span></span><br><span class="line">    getpid</span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"X<span class="variable">$pid</span>"</span> = <span class="string">"X"</span> ]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$APP_LONG_NAME</span> was not running."</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">kill</span> -<span class="number">3</span> <span class="variable">$pid</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> [ $? <span class="operator">-ne</span> <span class="number">0</span> ]</span><br><span class="line">        <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"Failed to dump <span class="variable">$APP_LONG_NAME</span>."</span></span><br><span class="line">            <span class="built_in">exit</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"Dumped <span class="variable">$APP_LONG_NAME</span>."</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></span><br><span class="line"></span><br><span class="line">    <span class="string">'console'</span>)</span><br><span class="line">        checkUser touchlock <span class="variable">$1</span></span><br><span class="line">        console</span><br><span class="line">        ;;</span><br><span class="line"></span><br><span class="line">    <span class="string">'start'</span>)</span><br><span class="line">        checkUser touchlock <span class="variable">$1</span></span><br><span class="line">        start</span><br><span class="line">        ;;</span><br><span class="line"></span><br><span class="line">    <span class="string">'stop'</span>)</span><br><span class="line">        checkUser <span class="string">""</span> <span class="variable">$1</span></span><br><span class="line">        stopit</span><br><span class="line">        ;;</span><br><span class="line"></span><br><span class="line">    <span class="string">'restart'</span>)</span><br><span class="line">        checkUser touchlock <span class="variable">$1</span></span><br><span class="line">        stopit</span><br><span class="line">        start</span><br><span class="line">        ;;</span><br><span class="line"></span><br><span class="line">    <span class="string">'status'</span>)</span><br><span class="line">        checkUser <span class="string">""</span> <span class="variable">$1</span></span><br><span class="line">        status</span><br><span class="line">        ;;</span><br><span class="line"></span><br><span class="line">    <span class="string">'dump'</span>)</span><br><span class="line">        checkUser <span class="string">""</span> <span class="variable">$1</span></span><br><span class="line">        dump</span><br><span class="line">        ;;</span><br><span class="line"></span><br><span class="line">    *)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Usage: <span class="variable">$0</span> &#123; console | start | stop | restart | status | dump &#125;"</span></span><br><span class="line">        <span class="built_in">exit</span> <span class="number">1</span></span><br><span class="line">        ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>
<h1 id="验证和配置Nexus">验证和配置Nexus</h1><p><code>/etc/init.d/nexus start</code></p>
<p>nexus安装完成以后，一般在路径： <a href="http://sever_ip:8081/nexus/" target="_blank" rel="external">http://sever_ip:8081/nexus/</a> </p>
<p>打开以后会出现配置管理页面，说明安装成功了。点击右上角“Log in”，输入用户名和密码（默认用户名：admin密码：admin123）登录。</p>
]]></content>
    <summary type="html">
    <![CDATA[<h1 id="安装JDK">安装JDK</h1><p>此处省略。。。</p>
<h1 id="安装Sonatype_Nexus">安装Sonatype Nexus</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget http://download.sonatype.com/nexus/oss/nexus-<span class="number">2.11</span>.<span class="number">1</span>-<span class="number">01</span>-bundle.tar.gz</span><br><span class="line">tar zxvf nexus-<span class="number">2.11</span>.<span class="number">1</span>-<span class="number">01</span>-bundle.tar.gz </span><br><span class="line">mv nexus-<span class="number">2.11</span>.<span class="number">1</span>-<span class="number">01</span> /usr/<span class="built_in">local</span>/nexus</span><br></pre></td></tr></table></figure>]]>
    
    </summary>
    
      <category term="maven" scheme="http://linux48.com/tags/maven/"/>
    
      <category term="devops" scheme="http://linux48.com/categories/devops/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[mysql中查看数据库中所有表的记录数]]></title>
    <link href="http://linux48.com//archives/442/"/>
    <id>http://linux48.com//archives/442/</id>
    <published>2015-10-29T16:00:00.000Z</published>
    <updated>2016-04-09T09:12:49.000Z</updated>
    <content type="html"><![CDATA[<p>如果想知道MySQL数据库中每个表占用的空间、表记录的行数的话，可以打开MySQL的 information_schema 数据库。在该库中有一个 TABLES 表，这个表主要字段分别是：</p>
<blockquote>
<ul>
<li>TABLE_SCHEMA : 数据库名</li>
<li>TABLE_NAME：表名</li>
<li>ENGINE：所使用的存储引擎</li>
<li>TABLES_ROWS：记录数</li>
<li>DATA_LENGTH：数据大小</li>
<li>INDEX_LENGTH：索引大小</li>
</ul>
</blockquote>
<p>其他字段请参考MySQL的手册，一下是利用这几个字段查询详情演示，可以根据具体业务来自定义sql监控mysql的磁盘使用状态和数据库各个表的具体条数。</p>
<a id="more"></a>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">select table_schema,table_name,table_rows from tables where TABLE_SCHEMA='ebuydb' order by table_rows desc ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--查询所有数据的大小</span><br><span class="line">use information_schema;</span><br><span class="line">select concat(round(sum(DATA_LENGTH/1024/1024), 2),'MB') as data from TABLES;</span><br><span class="line"></span><br><span class="line">--查询单个库占用空间</span><br><span class="line">select concat(round(sum(DATA_LENGTH/1024/1024), 2),'MB') as data from TABLES where TABLE_SCHEMA='ebuydb';</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--数据库总所占空间</span><br><span class="line"></span><br><span class="line">SELECT CONCAT(TRUNCATE(SUM(data_length)/1024/1024,2),'MB') AS data_size,</span><br><span class="line">CONCAT(TRUNCATE(SUM(max_data_length)/1024/1024,2),'MB') AS max_data_size,</span><br><span class="line">CONCAT(TRUNCATE(SUM(data_free)/1024/1024,2),'MB') AS data_free,</span><br><span class="line">CONCAT(TRUNCATE(SUM(index_length)/1024/1024,2),'MB') AS index_size，</span><br><span class="line">FROM information_schema.tables WHERE TABLE_SCHEMA = '数据库名';</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--数据库表占用空间明细</span><br><span class="line">SELECT TABLE_NAME, table_rows,</span><br><span class="line">CONCAT(TRUNCATE(SUM(data_length)/1024/1024,2),'MB') AS data_size,</span><br><span class="line">CONCAT(TRUNCATE(SUM(max_data_length)/1024/1024,2),'MB') AS max_data_size,</span><br><span class="line">CONCAT(TRUNCATE(SUM(data_free)/1024/1024,2),'MB') AS data_free,</span><br><span class="line">CONCAT(TRUNCATE(SUM(index_length)/1024/1024,2),'MB') AS index_size，</span><br><span class="line">FROM information_schema.tables WHERE TABLE_SCHEMA = '数据库名'</span><br><span class="line">group by TABLE_NAME   order by data_length desc;</span><br><span class="line"></span><br><span class="line">--表所占空间</span><br><span class="line"></span><br><span class="line">SELECT CONCAT(TRUNCATE(SUM(data_length)/1024/1024,2),'MB') AS data_size,</span><br><span class="line">CONCAT(TRUNCATE(SUM(max_data_length)/1024/1024,2),'MB') AS max_data_size,</span><br><span class="line">CONCAT(TRUNCATE(SUM(data_free)/1024/1024,2),'MB') AS data_free,</span><br><span class="line">CONCAT(TRUNCATE(SUM(index_length)/1024/1024,2),'MB') AS index_size</span><br><span class="line">FROM information_schema.tables WHERE TABLE_NAME = '表名';</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--查看指定数据库的表的大小，比如说数据库 forexpert 中的 member 表 </span><br><span class="line"></span><br><span class="line">select concat(round(sum(DATA_LENGTH/1024/1024),2),'MB')as data</span><br><span class="line">from TABLES where table_schema='test'</span><br><span class="line">and table_name='1023';</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; select TABLE_NAME, concat(truncate(data_length/1024/1024,2),' MB') as data_size,   concat(truncate(index_length/1024/1024,2),' MB') as index_size   from information_schema.tables where TABLE_SCHEMA = 'test'   group by TABLE_NAME   order by data_length desc;         </span><br><span class="line">+-------------------------+-----------+------------+</span><br><span class="line">| TABLE_NAME              | data_size | index_size |</span><br><span class="line">+-------------------------+-----------+------------+</span><br><span class="line">| 1023                    | 152.68 MB | 0.00 MB    |</span><br><span class="line">| gc1_3                   | 18.54 MB  | 9.54 MB    |</span><br><span class="line">| gc6_8                   | 14.51 MB  | 7.51 MB    |</span><br><span class="line">| gc4_5                   | 12.51 MB  | 6.51 MB    |</span><br><span class="line">| tongyi1_3               | 11.51 MB  | 5.51 MB    |</span><br><span class="line">| tongyi6_8               | 9.51 MB   | 4.51 MB    |</span><br><span class="line">| tongyi4_5               | 8.51 MB   | 4.51 MB    |</span><br><span class="line">| 1023_2                  | 1.51 MB   | 0.00 MB    |</span><br><span class="line">| code                    | 0.14 MB   | 0.09 MB    |</span><br><span class="line">| 1023_3                  | 0.06 MB   | 0.00 MB    |</span><br><span class="line">+-------------------------+-----------+------------+</span><br><span class="line">10 rows in set (0.01 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; select TABLE_SCHEMA, concat(truncate(sum(data_length)/1024/1024,2),' MB') as data_size,   concat(truncate(sum(index_length)/1024/1024,2),'MB') as index_size   from information_schema.tables  group by TABLE_SCHEMA  order by data_length desc;  </span><br><span class="line"></span><br><span class="line">+-------------------------+--------------+------------+</span><br><span class="line">| TABLE_SCHEMA            | data_size    | index_size |</span><br><span class="line">+-------------------------+--------------+------------+</span><br><span class="line">| test                    | 234.68 MB    | 39.42MB    |</span><br><span class="line">| zabbix                  | 1.78 MB      | 2.70MB     |</span><br><span class="line">| information_schema      | 0.00 MB      | 0.00MB     |</span><br><span class="line">| performance_schema      | 0.00 MB      | 0.00MB     |</span><br><span class="line">| mysql                   | 0.58 MB      | 0.10MB     |</span><br><span class="line">+-------------------------+--------------+------------+</span><br><span class="line">5 rows in set (0.54 sec)</span><br><span class="line"></span><br><span class="line">--查看更加明细</span><br><span class="line">mysql&gt; USE information_schema;</span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; SELECT TABLE_NAME, table_rows,</span><br><span class="line">    -&gt; CONCAT(TRUNCATE(SUM(data_length)/1024/1024,2),'MB') AS data_size,</span><br><span class="line">    -&gt; CONCAT(TRUNCATE(SUM(max_data_length)/1024/1024,2),'MB') AS max_data_size,</span><br><span class="line">    -&gt; CONCAT(TRUNCATE(SUM(data_free)/1024/1024,2),'MB') AS data_free,</span><br><span class="line">    -&gt; CONCAT(TRUNCATE(SUM(index_length)/1024/1024,2),'MB') AS index_size</span><br><span class="line">    -&gt; FROM information_schema.tables  WHERE TABLE_NAME NOT LIKE "%history"</span><br><span class="line">    -&gt; AND TABLE_SCHEMA = 'test'</span><br><span class="line">    -&gt; GROUP BY TABLE_NAME   ORDER BY data_length DESC;</span><br><span class="line">+-------------------------+------------+-----------+---------------+-----------+------------+</span><br><span class="line">| TABLE_NAME              | table_rows | data_size | max_data_size | data_free | index_size |</span><br><span class="line">+-------------------------+------------+-----------+---------------+-----------+------------+</span><br><span class="line">| 1023                    |    3351704 | 152.68MB  | 0.00MB        | 7.00MB    | 0.00MB     |</span><br><span class="line">| gc1_3                   |     323649 | 18.54MB   | 0.00MB        | 4.00MB    | 9.54MB     |</span><br><span class="line">| gc6_8                   |     256131 | 14.51MB   | 0.00MB        | 4.00MB    | 7.51MB     |</span><br><span class="line">| gc4_5                   |     219582 | 12.51MB   | 0.00MB        | 4.00MB    | 6.51MB     |</span><br><span class="line">| tongyi1_3               |     184609 | 11.51MB   | 0.00MB        | 4.00MB    | 5.51MB     |</span><br><span class="line">| tongyi6_8               |     150028 | 9.51MB    | 0.00MB        | 4.00MB    | 4.51MB     |</span><br><span class="line">| tongyi4_5               |     132087 | 8.51MB    | 0.00MB        | 4.00MB    | 4.51MB     |</span><br><span class="line">| 1023_2                  |      14619 | 1.51MB    | 0.00MB        | 4.00MB    | 0.00MB     |</span><br><span class="line">| code                    |       2241 | 0.14MB    | 0.00MB        | 0.00MB    | 0.09MB     |</span><br><span class="line">| 1023_3                  |        833 | 0.06MB    | 0.00MB        | 0.00MB    | 0.00MB     |</span><br><span class="line">+-------------------------+------------+-----------+---------------+-----------+------------+</span><br><span class="line">10 rows in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>
<p>参考：</p>
<p>BYTE(B):字节<br>1KB ，2 的 10 次方 ： 1024 BYTE.<br>1MB ，2 的 20 次方 ： 1024 KB.<br>1GB ，2 的 30 次方 ： 1024 MB.<br>1TB ，2 的 40 次方 ： 1024 GB.<br>1PB ，2 的 50 次方 ： 1024 TB.<br>1EB ，2 的 60 次方 ： 1024 PB.<br>1ZB ，2 的 70 次方 ： 1024 EB.<br>1YB ，2 的 80 次方 ： 1024 ZB.</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>如果想知道MySQL数据库中每个表占用的空间、表记录的行数的话，可以打开MySQL的 information_schema 数据库。在该库中有一个 TABLES 表，这个表主要字段分别是：</p>
<blockquote>
<ul>
<li>TABLE_SCHEMA : 数据库名</li>
<li>TABLE_NAME：表名</li>
<li>ENGINE：所使用的存储引擎</li>
<li>TABLES_ROWS：记录数</li>
<li>DATA_LENGTH：数据大小</li>
<li>INDEX_LENGTH：索引大小</li>
</ul>
</blockquote>
<p>其他字段请参考MySQL的手册，一下是利用这几个字段查询详情演示，可以根据具体业务来自定义sql监控mysql的磁盘使用状态和数据库各个表的具体条数。</p>]]>
    
    </summary>
    
      <category term="mysql" scheme="http://linux48.com/tags/mysql/"/>
    
      <category term="database" scheme="http://linux48.com/categories/database/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[zabbix的proxy端安装配置]]></title>
    <link href="http://linux48.com//archives/441/"/>
    <id>http://linux48.com//archives/441/</id>
    <published>2015-10-28T16:00:00.000Z</published>
    <updated>2016-04-09T09:12:49.000Z</updated>
    <content type="html"><![CDATA[<p>zabbix proxy可以代替zabbix server检索客户端的数据，然后把数据汇报给zabbix server，并且在一定程度上分担了zabbix server的压力。zabbix proxy可以非常简便的实现了集中式、分布式监控。</p>
<p>zabbix proxy使用场景:</p>
<blockquote>
<ul>
<li>监控远程区域设备</li>
<li>监控本地网络不稳定区域</li>
<li>当zabbix监控上千设备时，使用它来减轻server的压力</li>
<li>简化zabbix的维护</li>
</ul>
</blockquote>
<a id="more"></a>
<p>简易top如下</p>
<p><img src="http://r.loli.io/emamqy.png" alt=""></p>
<p>zabbix proxy仅仅需要一条tcp连接到zabbix server,所以防火墙上仅仅需要加上一条规则即可，zabbix proxy数据库必须和server分开，否则数据会被破坏，毕竟这两个数据库的表大部分都相同。总之记住，数据库分开即可。<br>proxy收集到数据之后，首先将数据缓存在本地，然后在一定得时间之后传递给zabbix server，这个时间由proxy配置文件中参数ProxyLocalBuffer and ProxyOfflineBuffer决定.<br>zabbix proxy是一个数据收集器，它不计算触发器、不处理事件、不发送报警。</p>
<h2 id="安装搭建zabbix_proxy">安装搭建zabbix proxy</h2><p>安装mysql此处省略</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum -y install curl curl-devel net-snmp net-snmp-devel perl-DBI</span><br><span class="line">tar zxvf zabbix-<span class="number">2.4</span>.<span class="number">5</span>.tar.gz </span><br><span class="line"><span class="built_in">cd</span> zabbix-<span class="number">2.4</span>.<span class="number">5</span></span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/zabbix_proxy --enable-proxy --enable-agent --with-mysql=/usr/<span class="built_in">local</span>/mysql/bin/mysql_config --with-net-snmp --with-libcurl</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<h2 id="建立数据库并授权">建立数据库并授权</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">create</span> <span class="keyword">database</span> zabbix <span class="built_in">character</span> <span class="keyword">set</span> utf8;</span></span><br><span class="line"><span class="operator"><span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> zabbix.* <span class="keyword">to</span> zabbix@localhost <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">'zabbix'</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">flush</span> <span class="keyword">privileges</span>;</span></span><br></pre></td></tr></table></figure>
<p>导入数据结构：</p>
<p><code>mysql -uzabbix -p&#39;zabbix&#39; zabbix &lt; database/mysql/schema.sql</code></p>
<p>需要注意的是proxy不需要导入data.sql 和 images.sql 这两份SQL，否则会有问题</p>
<h2 id="配置zabbix_proxy">配置zabbix proxy</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@server]<span class="comment"># cat /usr/local/zabbix_proxy/etc/zabbix_proxy.conf |grep -v "#"</span></span><br><span class="line">ProxyMode=<span class="number">1</span></span><br><span class="line">Server=<span class="number">10.10</span>.<span class="number">3.222</span></span><br><span class="line">Hostname=<span class="number">10.10</span>.<span class="number">3.225</span></span><br><span class="line">LogFile=/tmp/zabbix_proxy.log</span><br><span class="line">DBHost=<span class="number">10.10</span>.<span class="number">3.222</span></span><br><span class="line">DBName=zabbix</span><br><span class="line">DBUser=zabbix</span><br><span class="line">DBPassword=zabbix</span><br><span class="line">DBSocket=/data/mysql/mysql.sock </span><br><span class="line">DBPort=<span class="number">3306</span></span><br><span class="line">ConfigFrequency=<span class="number">60</span></span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>proxyMode 是代理模式，一会在zabbix server的web里面配置会有选择，0是主动模式，1是被动模式,我使1被动模式</li>
<li>Server 是指定zabbix Server 的地址</li>
<li>Hostname 是指定proxy的名称，一会在zabbix server的web配置里填的名称要和这个一样</li>
<li>ConfigFrequency 这个是server和proxy两端配置同步的时间间隔，server和proxy要设定同一个值才好，默认是3600，我想配置同步快一点，改成60</li>
</ul>
</blockquote>
<h2 id="启动zabbix_proxy">启动zabbix proxy</h2><p>启动守护进程agent</p>
<p><code>/usr/local/zabbix_proxy/sbin/zabbix_proxy</code></p>
<p>zabbix_proxy启动端口为10051</p>
<p>iptables放行zabbix_proxy的10051端口</p>
<p><code>iptables -A INPUT -p tcp --dport 10051 -j ACCEPT</code></p>
<p>注：重启服务可直接kill掉zabbix进程再重新按照以上方法启动</p>
<p>或配置开机启动脚本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> zabbix-<span class="number">2.4</span>.<span class="number">5</span></span><br><span class="line">cp misc/init.d/tru64/zabbix_proxy   /etc/init.d/zabbix_proxy</span><br><span class="line">chmod <span class="number">755</span> /etc/init.d/zabbix_proxy</span><br><span class="line">vi /etc/init.d/zabbix_proxy</span><br><span class="line">在文件头部的<span class="comment">#!/bin/sh行下分别添加如下两行：</span></span><br><span class="line">--------------</span><br><span class="line"><span class="comment">#chkconfig: 35 95 95</span></span><br><span class="line"><span class="comment">#description:zabbix_proxy</span></span><br><span class="line">--------------</span><br><span class="line">将DAEMON后面的参数改成你自定义的路径</span><br><span class="line">DAEMON=/usr/<span class="built_in">local</span>/zabbix_proxy/sbin/zabbix_proxy</span><br></pre></td></tr></table></figure>
<p>加入开机启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chkconfig --add zabbix_proxy</span><br><span class="line">chkconfig zabbix_proxy on</span><br></pre></td></tr></table></figure>
<p>重启服务：</p>
<p><code>service zabbix_proxy restart</code></p>
<h2 id="添加zabbix_proxy节点">添加zabbix proxy节点</h2><p><img src="http://r.loli.io/Uf2qau.png" alt=""></p>
<h2 id="添加被监控的主机">添加被监控的主机</h2><p>添加被监控的主机勾选<strong>由系统代理程式监控</strong></p>
<p><img src="http://r6.loli.io/iiENna.png" alt=""></p>
]]></content>
    <summary type="html">
    <![CDATA[<p>zabbix proxy可以代替zabbix server检索客户端的数据，然后把数据汇报给zabbix server，并且在一定程度上分担了zabbix server的压力。zabbix proxy可以非常简便的实现了集中式、分布式监控。</p>
<p>zabbix proxy使用场景:</p>
<blockquote>
<ul>
<li>监控远程区域设备</li>
<li>监控本地网络不稳定区域</li>
<li>当zabbix监控上千设备时，使用它来减轻server的压力</li>
<li>简化zabbix的维护</li>
</ul>
</blockquote>]]>
    
    </summary>
    
      <category term="zabbix" scheme="http://linux48.com/tags/zabbix/"/>
    
      <category term="监控" scheme="http://linux48.com/categories/%E7%9B%91%E6%8E%A7/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[zabbix的agent端安装配置]]></title>
    <link href="http://linux48.com//archives/440/"/>
    <id>http://linux48.com//archives/440/</id>
    <published>2015-10-27T16:00:00.000Z</published>
    <updated>2016-04-09T09:12:49.000Z</updated>
    <content type="html"><![CDATA[<h2 id="下载zabbix">下载zabbix</h2><h2 id="安装zabbix所需的组件">安装zabbix所需的组件</h2><p><code>yum -y install curl curl-devel net-snmp net-snmp-devel perl-DBI</code></p>
<h2 id="创建用户账号">创建用户账号</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">groupadd zabbix</span><br><span class="line">useradd -g zabbix zabbix</span><br><span class="line">usermod <span class="operator">-s</span> /sbin/nologin zabbix</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="编译安装(agent)">编译安装(agent)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf zabbix-<span class="number">2.4</span>.<span class="number">5</span>.tar.gz </span><br><span class="line"><span class="built_in">cd</span> zabbix-<span class="number">2.4</span>.<span class="number">5</span></span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/zabbix-agent --enable-agent  --enable-ipv6 --with-net-snmp --with-libcurl</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<h2 id="编辑agent端配置文件">编辑agent端配置文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@Server2 ~]<span class="comment"># cat /usr/local/zabbix-agent/etc/zabbix_agentd.conf |grep -v "#"</span></span><br><span class="line">LogFile=/tmp/zabbix_agentd.log</span><br><span class="line">Server=<span class="number">10.10</span>.<span class="number">3.225</span></span><br><span class="line">ServerActive=<span class="number">10.10</span>.<span class="number">3.225</span>:<span class="number">10051</span></span><br><span class="line">Hostname=<span class="number">10.128</span>.<span class="number">0.81</span></span><br></pre></td></tr></table></figure>
<h2 id="启动守护进程agent">启动守护进程agent</h2><p><code>/usr/local/zabbix-agent/sbin/zabbix_agentd</code></p>
<p>server启动端口为10051</p>
<p>iptables放行zabbix-agent的10051端口</p>
<p><code>iptables -A INPUT -p tcp  --dport 10051 -j ACCEPT</code></p>
<p>注：重启服务可直接kill掉zabbix进程再重新按照以上方法启动</p>
<p>或配置开机启动脚本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> zabbix-<span class="number">2.4</span>.<span class="number">5</span></span><br><span class="line">cp misc/init.d/tru64/zabbix_agentd   /etc/init.d/zabbix_agentd</span><br><span class="line">chmod <span class="number">755</span> /etc/init.d/zabbix_agentd</span><br><span class="line">vi /etc/init.d/zabbix_agentd</span><br><span class="line">在文件头部的<span class="comment">#!/bin/sh行下分别添加如下两行：</span></span><br><span class="line">--------------</span><br><span class="line"><span class="comment">#chkconfig: 35 95 95</span></span><br><span class="line"><span class="comment">#description:zabbix agent</span></span><br><span class="line">--------------</span><br><span class="line">将DAEMON后面的参数改成你自定义的路径</span><br><span class="line">DAEMON=/usr/<span class="built_in">local</span>/zabbix-agent/sbin/zabbix_agentd</span><br></pre></td></tr></table></figure>
<p>加入开机启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chkconfig --add zabbix_agentd  </span><br><span class="line">chkconfig zabbix_agentd on</span><br></pre></td></tr></table></figure>
<p>重启服务：</p>
<p><code>service zabbix_agentd restart</code></p>
]]></content>
    <summary type="html">
    <![CDATA[<h2 id="下载zabbix">下载zabbix</h2><h2 id="安装zabbix所需的组件">安装zabbix所需的组件</h2><p><code>yum -y install curl curl-devel net-snmp net-snmp-devel perl-DBI</code></p>
<h2 id="创建用户账号">创建用户账号</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">groupadd zabbix</span><br><span class="line">useradd -g zabbix zabbix</span><br><span class="line">usermod <span class="operator">-s</span> /sbin/nologin zabbix</span><br></pre></td></tr></table></figure>]]>
    
    </summary>
    
      <category term="zabbix" scheme="http://linux48.com/tags/zabbix/"/>
    
      <category term="监控" scheme="http://linux48.com/categories/%E7%9B%91%E6%8E%A7/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[mysql求平均值、最小和总值]]></title>
    <link href="http://linux48.com//archives/439/"/>
    <id>http://linux48.com//archives/439/</id>
    <published>2015-10-26T16:00:00.000Z</published>
    <updated>2016-04-09T09:12:49.000Z</updated>
    <content type="html"><![CDATA[<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE TABLE sales_rep(</span><br><span class="line">    -&gt;   employee_number INT,</span><br><span class="line">    -&gt;   surname VARCHAR(<span class="number">40</span>),</span><br><span class="line">    -&gt;   first_name VARCHAR(<span class="number">30</span>),</span><br><span class="line">    -&gt;   commission TINYINT</span><br><span class="line">    -&gt; );</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; INSERT INTO sales_rep values(<span class="number">4</span>,<span class="string">'Rive'</span>,<span class="string">'Mongane'</span>,<span class="number">10</span>);</span><br><span class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; INSERT INTO sales_rep values(<span class="number">5</span>,<span class="string">'Smith'</span>,<span class="string">'Mike'</span>,<span class="number">12</span>);</span><br><span class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT AVG(commission) FROM sales_rep;</span><br><span class="line">+-----------------+</span><br><span class="line">| AVG(commission) |</span><br><span class="line">+-----------------+</span><br><span class="line">|         <span class="number">11.0000</span> |</span><br><span class="line">+-----------------+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="built_in">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line">--//以上是AVG()函数的用法，可以换成MIN()、SUM()函数，用来求最小值，求和。</span><br></pre></td></tr></table></figure>
]]></content>
    <summary type="html">
    <![CDATA[<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class=]]>
    </summary>
    
      <category term="mysql" scheme="http://linux48.com/tags/mysql/"/>
    
      <category term="database" scheme="http://linux48.com/categories/database/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[mysql取每隔一小时数据]]></title>
    <link href="http://linux48.com//archives/438/"/>
    <id>http://linux48.com//archives/438/</id>
    <published>2015-10-20T16:00:00.000Z</published>
    <updated>2016-04-09T09:12:49.000Z</updated>
    <content type="html"><![CDATA[<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">SELECT</span> </span><br><span class="line">    <span class="keyword">HOUR</span>(<span class="string">`input_date`</span>) <span class="keyword">AS</span> <span class="keyword">HOUR</span>,</span><br><span class="line">    <span class="keyword">COUNT</span>(<span class="number">1</span>) <span class="keyword">AS</span> 交易笔数,</span><br><span class="line">    brand_name_cn <span class="keyword">AS</span> 品牌,</span><br><span class="line">    <span class="keyword">DATE_FORMAT</span>(<span class="string">`input_date`</span>, <span class="string">'%m%d'</span>) <span class="keyword">AS</span> 交易日期 </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    test.<span class="string">`1023`</span> </span><br><span class="line"><span class="keyword">WHERE</span> input_date &gt;= <span class="number">20150930000000</span> </span><br><span class="line">    <span class="keyword">AND</span> input_date &lt;= <span class="number">20150930235959</span> </span><br><span class="line">    <span class="keyword">AND</span> brand_name_cn = <span class="string">'统一星巴克'</span> </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">HOUR</span> ;</span></span><br></pre></td></tr></table></figure>
<p>格式化日期</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">SELECT</span> </span><br><span class="line">    <span class="keyword">HOUR</span>(<span class="string">`input_time`</span>) <span class="keyword">AS</span> <span class="keyword">HOUR</span>,</span><br><span class="line">    <span class="keyword">COUNT</span>(<span class="number">1</span>) <span class="keyword">AS</span> <span class="keyword">COUNT</span></span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    <span class="string">`table_name`</span> </span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">DATE_FORMAT</span>(<span class="string">`input_time`</span>, <span class="string">'%Y-%m-%d'</span>) = <span class="string">'2015-10-21'</span> </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">HOUR</span>(<span class="string">`input_time`</span>) ;</span></span><br></pre></td></tr></table></figure>
]]></content>
    <summary type="html">
    <![CDATA[<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="]]>
    </summary>
    
      <category term="mysql" scheme="http://linux48.com/tags/mysql/"/>
    
      <category term="database" scheme="http://linux48.com/categories/database/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[mysql You cant specify target table]]></title>
    <link href="http://linux48.com//archives/437/"/>
    <id>http://linux48.com//archives/437/</id>
    <published>2015-10-07T16:00:00.000Z</published>
    <updated>2016-04-09T09:12:49.000Z</updated>
    <content type="html"><![CDATA[<p>今天在写SQL语句的时候遇到一个比较特殊的问题。<br>mysql 语句如下:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">UPDATE</span> </span><br><span class="line">  pms_project_product </span><br><span class="line"><span class="keyword">SET</span></span><br><span class="line">  area_list = </span><br><span class="line">  (<span class="keyword">SELECT</span> </span><br><span class="line">    area_list </span><br><span class="line">  <span class="keyword">FROM</span></span><br><span class="line">    pms_project_product </span><br><span class="line">  <span class="keyword">WHERE</span> activity_product_id = <span class="number">48468</span>),</span><br><span class="line">  area_list_name = </span><br><span class="line">  (<span class="keyword">SELECT</span> </span><br><span class="line">    area_list_name </span><br><span class="line">  <span class="keyword">FROM</span></span><br><span class="line">    pms_project_product </span><br><span class="line">  <span class="keyword">WHERE</span> activity_product_id = <span class="number">48468</span>) </span><br><span class="line"><span class="keyword">WHERE</span> activity_product_id = <span class="number">47098</span> ;</span></span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>运行时提出如下提示： <strong> You can’t specify target table ‘pms_project_product’ for update in FROM clause </strong></p>
<p>运行 set 里面的 select 语句:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">SELECT</span></span><br><span class="line">         area_list</span><br><span class="line">       <span class="keyword">FROM</span></span><br><span class="line">         pms_project_product</span><br><span class="line">       <span class="keyword">WHERE</span> activity_product_id = <span class="number">48468</span></span></span><br></pre></td></tr></table></figure>
<p>可以正确 select 正确结果。再把结果直接写到 <strong> SET area_list = </strong>里面，改后语句如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">UPDATE</span> </span><br><span class="line">  pms_project_product </span><br><span class="line"><span class="keyword">SET</span></span><br><span class="line">  area_list = (***),</span><br><span class="line">  area_list_name = (***) </span><br><span class="line"><span class="keyword">WHERE</span> activity_product_id = <span class="number">47098</span></span></span><br></pre></td></tr></table></figure>
<p>再运行可以正确执行更新。</p>
<p>原因是：mysql中不能这么用。 （等待mysql升级吧）。那串英文错误提示就是说，不能先select出同一表中的某些值，</p>
<p>再update这个表(在同一语句中)。 于是我打算改用临时表的方案。</p>
<p>改写后的 sql 如下所示，大家仔细区别一下。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">UPDATE</span> </span><br><span class="line">  pms_project_product </span><br><span class="line"><span class="keyword">SET</span></span><br><span class="line">  area_list = </span><br><span class="line">  (<span class="keyword">SELECT</span> </span><br><span class="line">    tmp1.area_list </span><br><span class="line">  <span class="keyword">FROM</span></span><br><span class="line">    (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> pms_project_product) tmp1</span><br><span class="line">  <span class="keyword">WHERE</span> tmp1.activity_product_id = <span class="number">48468</span>),</span><br><span class="line">  area_list_name = </span><br><span class="line">  (<span class="keyword">SELECT</span> </span><br><span class="line">    tmp2.area_list_name </span><br><span class="line">  <span class="keyword">FROM</span></span><br><span class="line">    (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> pms_project_product) tmp2 </span><br><span class="line">  <span class="keyword">WHERE</span> tmp2.activity_product_id = <span class="number">48468</span>) </span><br><span class="line"><span class="keyword">WHERE</span> activity_product_id = <span class="number">47098</span></span></span><br></pre></td></tr></table></figure>
<p>也就是说将select出的结果再通过临时表在select一遍，这样就规避了错误。注意，这个问题只出现于mysql，mssql和oracle不会出现此问题。</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>今天在写SQL语句的时候遇到一个比较特殊的问题。<br>mysql 语句如下:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">UPDATE</span> </span><br><span class="line">  pms_project_product </span><br><span class="line"><span class="keyword">SET</span></span><br><span class="line">  area_list = </span><br><span class="line">  (<span class="keyword">SELECT</span> </span><br><span class="line">    area_list </span><br><span class="line">  <span class="keyword">FROM</span></span><br><span class="line">    pms_project_product </span><br><span class="line">  <span class="keyword">WHERE</span> activity_product_id = <span class="number">48468</span>),</span><br><span class="line">  area_list_name = </span><br><span class="line">  (<span class="keyword">SELECT</span> </span><br><span class="line">    area_list_name </span><br><span class="line">  <span class="keyword">FROM</span></span><br><span class="line">    pms_project_product </span><br><span class="line">  <span class="keyword">WHERE</span> activity_product_id = <span class="number">48468</span>) </span><br><span class="line"><span class="keyword">WHERE</span> activity_product_id = <span class="number">47098</span> ;</span></span><br></pre></td></tr></table></figure>]]>
    
    </summary>
    
      <category term="mysql" scheme="http://linux48.com/tags/mysql/"/>
    
      <category term="database" scheme="http://linux48.com/categories/database/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[阵列Cache写机制：Write-through与Write-back]]></title>
    <link href="http://linux48.com//archives/436/"/>
    <id>http://linux48.com//archives/436/</id>
    <published>2015-08-26T16:00:00.000Z</published>
    <updated>2016-04-09T09:12:49.000Z</updated>
    <content type="html"><![CDATA[<blockquote class="blockquote-center">Write Through和Write Back是阵列卡Cache的两种使用方式，也称为透写和回写。当选用write through方式时，系统的写磁盘操作并不利用阵列卡的Cache，而是直接与磁盘进行数据的交互。而write Back方式则利用阵列Cache作为系统与磁盘间的二传手，系统先将数据交给Cache，然后再由Cache将数据传给磁盘。</blockquote>

<a id="more"></a>
<p>最近在部署马来西亚DBServer的时候发现DB1的硬盘写入速度比DB2要慢好多</p>
<p><img src="http://r.loli.io/VnUZ7n.png" alt=""></p>
<p><img src="http://r.loli.io/Yj6Zbm.png" alt=""></p>
<p>两台服务器在导入数据的过程中对硬盘测速结果如下</p>
<p><img src="http://r.loli.io/vYj2ye.png" alt=""></p>
<p><img src="http://r.loli.io/BniYFf.png" alt=""></p>
<p>机房给出的解释也是一切正常</p>
<p>后来老大帮忙推荐MegaCli工具去排查问题所在</p>
<p>发现DB1的Cache写机制为Write-through而DB2为Write-back</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@DBServer1 MegaCli]<span class="comment"># ./MegaCli64 -Ldinfo -lall -aall</span></span><br><span class="line">                                     </span><br><span class="line"></span><br><span class="line">Adapter <span class="number">0</span> -- Virtual Drive Information:</span><br><span class="line">Virtual Drive: <span class="number">0</span> (Target Id: <span class="number">0</span>)</span><br><span class="line">Name                :</span><br><span class="line">RAID Level          : Primary-<span class="number">5</span>, Secondary-<span class="number">0</span>, RAID Level Qualifier-<span class="number">3</span></span><br><span class="line">Size                : <span class="number">557.75</span> GB</span><br><span class="line">Sector Size         : <span class="number">512</span></span><br><span class="line">Parity Size         : <span class="number">278.875</span> GB</span><br><span class="line">State               : Optimal</span><br><span class="line">Strip Size          : <span class="number">64</span> KB</span><br><span class="line">Number Of Drives    : <span class="number">3</span></span><br><span class="line">Span Depth          : <span class="number">1</span></span><br><span class="line">Default Cache Policy: WriteThrough, ReadAheadNone, Direct, No Write Cache <span class="keyword">if</span> Bad BBU</span><br><span class="line">Current Cache Policy: WriteThrough, ReadAheadNone, Direct, No Write Cache <span class="keyword">if</span> Bad BBU</span><br><span class="line">Default Access Policy: Read/Write</span><br><span class="line">Current Access Policy: Read/Write</span><br><span class="line">Disk Cache Policy   : Disk<span class="string">'s Default</span><br><span class="line">Encryption Type     : None</span><br><span class="line">Is VD Cached: No</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exit Code: 0x00</span><br><span class="line">[root@DBServer1 MegaCli]#</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@DBServer2 MegaCli]<span class="comment"># ./MegaCli64 -Ldinfo -lall -aall</span></span><br><span class="line">                                     </span><br><span class="line"></span><br><span class="line">Adapter <span class="number">0</span> -- Virtual Drive Information:</span><br><span class="line">Virtual Drive: <span class="number">0</span> (Target Id: <span class="number">0</span>)</span><br><span class="line">Name                :</span><br><span class="line">RAID Level          : Primary-<span class="number">5</span>, Secondary-<span class="number">0</span>, RAID Level Qualifier-<span class="number">3</span></span><br><span class="line">Size                : <span class="number">557.75</span> GB</span><br><span class="line">Sector Size         : <span class="number">512</span></span><br><span class="line">Parity Size         : <span class="number">278.875</span> GB</span><br><span class="line">State               : Optimal</span><br><span class="line">Strip Size          : <span class="number">64</span> KB</span><br><span class="line">Number Of Drives    : <span class="number">3</span></span><br><span class="line">Span Depth          : <span class="number">1</span></span><br><span class="line">Default Cache Policy: WriteBack, ReadAheadNone, Direct, No Write Cache <span class="keyword">if</span> Bad BBU</span><br><span class="line">Current Cache Policy: WriteBack, ReadAheadNone, Direct, No Write Cache <span class="keyword">if</span> Bad BBU</span><br><span class="line">Default Access Policy: Read/Write</span><br><span class="line">Current Access Policy: Read/Write</span><br><span class="line">Disk Cache Policy   : Disk<span class="string">'s Default</span><br><span class="line">Encryption Type     : None</span><br><span class="line">Is VD Cached: No</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exit Code: 0x00</span><br><span class="line">[root@DBServer2 MegaCli]#</span></span><br></pre></td></tr></table></figure>
<p><strong>以下为搜到的科普内容</strong></p>
<p>Cache写机制</p>
<p>参考 <a href="http://en.wikipedia.org/wiki/Cache#Writing_Policies" target="_blank" rel="external">http://en.wikipedia.org/wiki/Cache#Writing_Policies</a> 上的说明，<strong>Cache</strong>写机制分为<strong>write through</strong>和<strong>write back</strong>两种。</p>
<blockquote>
<ul>
<li><strong>Write-through</strong> Write is done synchronously both to the cache and to the backing store.</li>
<li><strong>Write-back</strong> (or Write-behind) – Writing is done only to the cache. A modified cache block is written back to the store, just before it is replaced.</li>
</ul>
</blockquote>
<p><strong>Write-through</strong>（直写模式）在数据更新时，同时写入缓存Cache和后端存储。此模式的优点是操作简单；缺点是因为数据修改需要同时写入存储，数据写入速度较慢。</p>
<p><strong>Write-back</strong>（回写模式）在数据更新时只写入缓存Cache。只在数据被替换出缓存时，被修改的缓存数据才会被写到后端存储。此模式的优点是数据写入速度快，因为不需要写存储；缺点是一旦更新后的数据未被写入存储时出现系统掉电的情况，数据将无法找回。</p>
<p><strong>Write-misses写缺失的处理方式</strong></p>
<p>对于写操作，存在写入缓存缺失数据的情况，这时有两种处理方式：</p>
<blockquote>
<ul>
<li><strong>Write allocate</strong> (aka Fetch on write) – Datum at the missed-write location is loaded to cache, followed by a write-hit operation. In this approach, write misses are similar to read-misses.</li>
<li><strong>No-write allocate</strong> (aka Write-no-allocate, Write around) – Datum at the missed-write location is not loaded to cache, and is written directly to the backing store. In this approach, actually only system reads are being cached.</li>
</ul>
</blockquote>
<p><strong>Write allocate</strong>方式将写入位置读入缓存，然后采用write-hit（缓存命中写入）操作。写缺失操作与读缺失操作类似。</p>
<p><strong>No-write allocate</strong>方式并不将写入位置读入缓存，而是直接将数据写入存储。这种方式下，只有读操作会被缓存。</p>
<p>无论是Write-through还是Write-back都可以使用写缺失的两种方式之一。只是通常Write-back采用Write allocate方式，而Write-through采用No-write allocate方式；因为多次写入同一缓存时，Write allocate配合Write-back可以提升性能；而对于Write-through则没有帮助。</p>
<p><strong>处理流程图</strong></p>
<p>Write-through模式处理流程：</p>
<p><img src="http://r.loli.io/y67vYf.png" alt=""></p>
<p>Write-back模式处理流程：</p>
<p><img src="http://r.loli.io/2mU3Yb.png" alt=""></p>
<p>在创建raid阵列可选择Write Policy的策略</p>
<p><img src="http://r.loli.io/BZRNRf.jpg" alt=""></p>
<p>在了解了原理之后可以通过<strong>MegaCli</strong>来设置DB1的<strong>Write Policy</strong>为<strong>WriteBack</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@DBServer1 MegaCli]<span class="comment"># ./MegaCli64 -LDSetProp WB -LAll -aAll</span></span><br><span class="line">                                     </span><br><span class="line">Set Write Policy to WriteBack on Adapter <span class="number">0</span>, VD <span class="number">0</span> (target id: <span class="number">0</span>) success</span><br><span class="line"></span><br><span class="line">Exit Code: <span class="number">0</span>x00</span><br><span class="line">[root@DBServer1 MegaCli]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p>此时在查看DB1的<strong>Write Policy</strong>已经成功设置为<strong>WriteBack</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@DBServer1 MegaCli]<span class="comment"># ./MegaCli64 -Ldinfo -lall -aall</span></span><br><span class="line">                                     </span><br><span class="line"></span><br><span class="line">Adapter <span class="number">0</span> -- Virtual Drive Information:</span><br><span class="line">Virtual Drive: <span class="number">0</span> (Target Id: <span class="number">0</span>)</span><br><span class="line">Name                :</span><br><span class="line">RAID Level          : Primary-<span class="number">5</span>, Secondary-<span class="number">0</span>, RAID Level Qualifier-<span class="number">3</span></span><br><span class="line">Size                : <span class="number">557.75</span> GB</span><br><span class="line">Sector Size         : <span class="number">512</span></span><br><span class="line">Parity Size         : <span class="number">278.875</span> GB</span><br><span class="line">State               : Optimal</span><br><span class="line">Strip Size          : <span class="number">64</span> KB</span><br><span class="line">Number Of Drives    : <span class="number">3</span></span><br><span class="line">Span Depth          : <span class="number">1</span></span><br><span class="line">Default Cache Policy: WriteBack, ReadAheadNone, Direct, No Write Cache <span class="keyword">if</span> Bad BBU</span><br><span class="line">Current Cache Policy: WriteBack, ReadAheadNone, Direct, No Write Cache <span class="keyword">if</span> Bad BBU</span><br><span class="line">Default Access Policy: Read/Write</span><br><span class="line">Current Access Policy: Read/Write</span><br><span class="line">Disk Cache Policy   : Disk<span class="string">'s Default</span><br><span class="line">Encryption Type     : None</span><br><span class="line">Is VD Cached: No</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exit Code: 0x00</span><br><span class="line">[root@DBServer1 MegaCli]#</span></span><br></pre></td></tr></table></figure>
<p>然后在测试DB1的写入速度，看以看到正常了<br><img src="http://r.loli.io/2uYfMf.png" alt=""></p>
<p>下一篇文章会着重记录一下<strong>MegaCli</strong>工具的安装与使用</p>
<hr>
<p>继续科普记录一下</p>
<p>Write Through和Write Back是阵列卡Cache的两种使用方式，也称为透写和回写。当选用write through方式时，系统的写磁盘操作并不利用阵列卡的Cache，而是直接与磁盘进行数据的交互。而write Back方式则利用阵列Cache作为系统与磁盘间的二传手，系统先将数据交给Cache，然后再由Cache将数据传给磁盘。 在配置阵列的时候，如果不是很清楚的话，默认就可以了，系统会根据磁盘类型进行默认设置。</p>
<p>生产环境中的配置要根据具体的业务类型及环境进行配置，比如：如果有外置UPS电源，选Write Back，如果没有外置电源，并且对数据安全性要求很高，不要求太高性能，就选Write Through。Write caching 或 write-through write-through意思是写操作根本不使用缓存。数据总是直接写入磁盘。关闭写缓存，可释放缓存用于读操作。（缓存被读写操作共用） Write caching可以提高写操作的性能。数据不是直接被写入磁盘；而是写入缓存。从应用程序的角度看，比等待完成磁盘写入操作要快的多。因此，可以提高写性能。由控制器将缓存内未写入磁盘的数据写入磁盘。表面上看，Write cache方式比write-through方式的读、写性能都要好，但是也要看磁盘访问方式和磁盘负荷了。 write-back（write cache）方式通常在磁盘负荷较轻时速度更快。负荷重时，每当数据被写入缓存后，就要马上再写入磁盘以释放缓存来保存将要写入的新数据，这时如果数据直接写入磁盘，控制器会以更快的速度运行。因此，负荷重时，将数据先写入缓存反而会降低吞吐量。 Starting and stopping cache flushing levels 这两个设置影响控制器如何处理未写入磁盘的缓存内数据，并且只在write-back cache方式下生效。缓存内数据写入磁盘称为flushing.你可以配置Starting and stopping cache flushing levels值，这个值表示占用整个缓存大小的百分比。当缓存内未写入磁盘的数据达到starting flushing value时，控制器开始flushing（由缓存写入磁盘）。当缓存内未写入磁盘数据量低于stop flush value时，flushing过程停止。控制器总是先flush旧的缓存数据。缓存内未写入数据停留超过20秒钟后被自动flushing. 典型的start flushing level是80%。通常情况下，stop flushing level也设置为80%。也就是说，控制器不允许超过80%的缓存用于write-back cache,但还是尽可能保持这一比例。如果你使用此设置，可以在缓存内存更多的未写入数据。这有利于提高写操作的性能，但是要牺牲数据保护。如果要得到数据保护，你可以使用较低的start and stop values。通过对这两个参数的设置，你可以调整缓存的读、写性能。经测试表明，使用接近的start and stop flushing levels时性能较好。如果stop level value远远低于start value，在flushing时会导致磁盘拥塞。 Cache block size 这个值指缓存分配单元大小，可以是4K或16K。选择合适的值，可以明显的改善缓存使用性能。 如果应用程序更多时候访问小于8K的数据，而将cache block size设置为16K，每次访问仅使用一部分cache block。在16K的cache block里总是存储8K或更小的数据，意味着只有50%的缓存容量被有效使用，使性能下降。对于随机I/O和小数据块的传送，4K比较合适。另一方面，如果是连续I/O 并使用大的segment size，最好选择16K。大的cache block size意味着cache block数量少并可缩短缓存消耗延时。另外，对于同样大小的数据，cache block size大一些，需要的缓存数据传送量更小。</p>
<p>其他相关说明：</p>
<p>保护内存里的数据</p>
<p>备援电池的功能是确保万一当主电源故障或突然断电时内存里的数据不流失，因此如何确保备援电池的正常运行就显得格外重要。备援电池在2种情况下，系统视为无法正常运行以保护内存里的数据。一是坏掉的时候，背板的LED灯将亮起红灯。一是电池充电的时候，背板的LED灯将亮起黄灯。备援电池的使用寿命是根据充电的次数及电力释放的周期而变化的，这取决于用户本身对盘阵的使用情况，一般而言我们建议最好在盘阵使用了12个月之后更换备援电池模块（BBU）。备援电池在正常情况下充满电的时候是3.5V，当其电力降至2.7V的时候将自动进入充电状态，此时系统因为保护内存数据不流失的电力消失，自动地将数据的写入切换成“Write-Through”模式；当充完电后，又自动切换回“Write-Back”模式。这个动作是在事件启动装置（Event Trigger）功能来执行的，在安装管理软件的时候，事件启动装置对备援电池的管理初始值是打开的（Enable）。如果你没有更改过初始设置，那么上述的动作就会正常的运行。如果备援电池已经坏掉，不能正常保护内存里的数据时，而事件启动装置对备援电池的管理是设定在关闭的状态下，我们建议你手动将数据写入模式更改为“Write-Through”模式，以免数据写入没有电力保护的内存中而主电源故障或突然断电时，这些正在写入的数据就遗失了。</p>
<p>减少延迟 当关闭内存“Write-Back”功能时就进入了“Write-Through”的模式，这时候主机数据是不会写入内存而直接写入硬盘的。在“Write-Through”模式下，所有的硬盘将与其相关的主机以适当的方式存取数据块，而大多数的时候硬盘处于接受写命令的状态。此时盘阵只要从主机接收到写入的命令，硬盘的读写头就会去寻找读写的位置，并等待硬盘处于可写入的状态，这个等待的现象就是所谓的延迟（Latency Time)，而硬盘经常处于等待写入的状态，增加了延迟的时间，不但缩短硬盘的使用寿命，并且系统也比较耗电。当打开内存的“Write-Back”功能时，从主机写入硬盘的数据先被写在内存里，在内存写满数据时盘阵控制器会将存在于内存的数据大量地写入硬盘。这个内存“Write-Back”的模式将主机写入的命令以写入内存来取代，可以大幅减少硬盘延迟的时间，并且相较于“Write-Through”模式，在大多数的时候提供更佳的写入政策。</p>
]]></content>
    <summary type="html">
    <![CDATA[<blockquote class="blockquote-center">Write Through和Write Back是阵列卡Cache的两种使用方式，也称为透写和回写。当选用write through方式时，系统的写磁盘操作并不利用阵列卡的Cache，而是直接与磁盘进行数据的交互。而write Back方式则利用阵列Cache作为系统与磁盘间的二传手，系统先将数据交给Cache，然后再由Cache将数据传给磁盘。</blockquote>]]>
    
    </summary>
    
      <category term="RAID" scheme="http://linux48.com/tags/RAID/"/>
    
      <category term="cache" scheme="http://linux48.com/tags/cache/"/>
    
      <category term="阵列卡" scheme="http://linux48.com/tags/%E9%98%B5%E5%88%97%E5%8D%A1/"/>
    
      <category term="windows" scheme="http://linux48.com/categories/windows/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Repair Cisco vpnclient on windows10]]></title>
    <link href="http://linux48.com//archives/435/"/>
    <id>http://linux48.com//archives/435/</id>
    <published>2015-08-02T16:00:00.000Z</published>
    <updated>2016-04-09T09:12:49.000Z</updated>
    <content type="html"><![CDATA[<p>由于此问题是windows10刚发布，但是cisco单方面并没有及时修复，并且就目前看来是全球的工程师都碰到的一个很紧急棘手的问题</p>
<p>在查找修复方案的时候;得到好多歪果仁的帮助，特地写了一片洋文，希望可以帮到更多的人，蹩脚的E文如有问题请留言或者邮件我及时勘误，不甚感激！</p>
<p>Microsoft released last week by the windows10, after the upgrade <code>vpnclient-winx64-msi-5.0.07.0440-k9.exe</code> found this installation as wrong.</p>
<p><img src="http://r.loli.io/eAVbii.png" alt=""></p>
<p>First we first fix, so that vpnclient-winx64-msi-5.0.07.0440-k9.exe is properly installed</p>
<a id="more"></a>
<hr>
<h1 id="Fix_Install_Error">Fix Install Error</h1><p>Download the 2 software <strong><code>winfix.exe</code></strong> and <strong><code>dneupdate64.msi</code></strong></p>
<p>first install <strong><code>winfix.exe</code></strong> </p>
<p>and then install <strong><code>dneupdate64.msi</code></strong></p>
<p>and finally extract the <strong><code>vpnclient-winx64-msi-5.0.07.0440-k9.exe</code></strong>, and execute the installation file <strong><code>vpnclient_setup.exe</code></strong></p>
<p>Now Cisco VPN clients has been successfully installed on windows10 ！</p>
<hr>
<h1 id="Fix_Dialing_Error">Fix Dialing Error</h1><p>But, the back of the account password when I dial the wrong</p>
<p><code>Secure VPN Connection terminated locally by the Client.</code><br><code>Reason 433: Reason not specified by peer.</code></p>
<p>Continue to search for information to fix this funking problem ！！！</p>
<p>The likely reason was apparently due to the DNE LightWeight Filter network client not being properly installed by the Cisco Systems VPN installer.</p>
<p>To solve this, please try to do the following in the exact order:</p>
<p>A) First, uninstall any Cisco VPN Client software you may have installed earlier;</p>
<p>B) Then uninstall any DNE updater software(s) you may have installed earlier;</p>
<p>C) Reboot your computer.</p>
<p>D) Run winfix.exe, to ensure the DNE is properly cleaned up. </p>
<p>E) Reboot your computer again.</p>
<p>F) Download Sonic VPN software from here: 32-bit here or 64-bit here.</p>
<p>G) Install the Sonic VPN software (which was able to install the right version of the DNE);</p>
<p>H) Reboot your computer.</p>
<p>I) Reinstall the Cisco VPN Client software again. (You do not need to uninstall the Sonic VPN software from step G). If you face a version check issue, run the msi file instead of the exe file</p>
<p>J) Reboot your computer.</p>
<p>K) Your Cisco VPN Client should now work in Windows 10!</p>
<p>Finally we dial again, what the funking！！ reporting error again ！！</p>
<p><code>vpn 422 failed to enable virtual adapter</code></p>
<hr>
<h1 id="Finally_Fix_this_problem">Finally Fix this problem</h1><p>Enter the registry regedit</p>
<p><code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\CVirtA</code> find <code>DisplayName</code>  key  </p>
<p>Value of X86 system change <strong><code>@oem16.inf,%CVirtA_Desc%;Cisco Systems VPN Adapter</code></strong> to <strong><code>Cisco Systems VPN Adapter</code></strong></p>
<p>Value of 64 system change <strong><code>@oem16.inf,%CVirtA_Desc%;Cisco Systems VPN Adapter for 64-bit Windows</code></strong> to <strong><code>Cisco Systems VPN Adapter for 64-bit Windows</code></strong></p>
<p>And then landed on the dial, success!!<br>Now the problem of the egg pain is completely solved!!!</p>
<hr>
<p>bove software download address</p>
<p>for 64bit<br><a href="ftp://files.citrix.com/winfix.exe" target="_blank" rel="external">ftp://files.citrix.com/winfix.exe</a><br><a href="ftp://files.citrix.com/dneupdate64.msi" target="_blank" rel="external">ftp://files.citrix.com/dneupdate64.msi</a><br><a href="http://www.gleescape.com/wp-content/uploads/2014/09/sonic64.zip" target="_blank" rel="external">http://www.gleescape.com/wp-content/uploads/2014/09/sonic64.zip</a></p>
<p>for 32bit<br><a href="ftp://files.citrix.com/winfix.exe" target="_blank" rel="external">ftp://files.citrix.com/winfix.exe</a><br><a href="ftp://ftpsupport.citrix.com/dneupdate.msi" target="_blank" rel="external">ftp://ftpsupport.citrix.com/dneupdate.msi</a><br><a href="http://www.gleescape.com/wp-content/uploads/2014/09/sonic32.zip" target="_blank" rel="external">http://www.gleescape.com/wp-content/uploads/2014/09/sonic32.zip</a></p>
<p>Chinese users may download speed will be very slow, I deliberately uploaded to Baidu cloud</p>
<p><a href="http://pan.baidu.com/s/1o6vcMz4" target="_blank" rel="external">http://pan.baidu.com/s/1o6vcMz4</a></p>
<p>Reference website:<br><a href="http://www.itsystemadmin.com/error-27850-unable-to-manage-networking-component/" target="_blank" rel="external">http://www.itsystemadmin.com/error-27850-unable-to-manage-networking-component/</a><br><a href="http://www.gleescape.com/posts/2917" target="_blank" rel="external">http://www.gleescape.com/posts/2917</a><br><a href="http://blog.itpub.net/9697/viewspace-1437036/" target="_blank" rel="external">http://blog.itpub.net/9697/viewspace-1437036/</a></p>
<p>Thanks them very much!!!</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>由于此问题是windows10刚发布，但是cisco单方面并没有及时修复，并且就目前看来是全球的工程师都碰到的一个很紧急棘手的问题</p>
<p>在查找修复方案的时候;得到好多歪果仁的帮助，特地写了一片洋文，希望可以帮到更多的人，蹩脚的E文如有问题请留言或者邮件我及时勘误，不甚感激！</p>
<p>Microsoft released last week by the windows10, after the upgrade <code>vpnclient-winx64-msi-5.0.07.0440-k9.exe</code> found this installation as wrong.</p>
<p><img src="http://r.loli.io/eAVbii.png" alt=""></p>
<p>First we first fix, so that vpnclient-winx64-msi-5.0.07.0440-k9.exe is properly installed</p>]]>
    
    </summary>
    
      <category term="cisco" scheme="http://linux48.com/tags/cisco/"/>
    
      <category term="vpn" scheme="http://linux48.com/tags/vpn/"/>
    
      <category term="windows10" scheme="http://linux48.com/tags/windows10/"/>
    
      <category term="windows" scheme="http://linux48.com/categories/windows/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[MYSQL在一个字段值前面加字符串]]></title>
    <link href="http://linux48.com//archives/434/"/>
    <id>http://linux48.com//archives/434/</id>
    <published>2015-07-29T16:00:00.000Z</published>
    <updated>2016-04-09T09:12:49.000Z</updated>
    <content type="html"><![CDATA[<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--在`menber`表的`name`字段前面按照条件批量加`jc100`这个字符串</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">UPDATE</span> </span><br><span class="line">    <span class="string">`usrdb`</span>.<span class="string">`menber`</span></span><br><span class="line">  <span class="keyword">SET</span></span><br><span class="line">    <span class="string">`name`</span> = <span class="keyword">CONCAT</span>(<span class="string">'jc100'</span>, <span class="string">`name`</span>) </span><br><span class="line">  <span class="keyword">WHERE</span> provice = <span class="string">'678'</span> </span><br><span class="line">    <span class="keyword">AND</span> input_time <span class="keyword">BETWEEN</span> <span class="string">'2015-07-30 00:00:00'</span> </span><br><span class="line">    <span class="keyword">AND</span> <span class="string">'2015-07-30 23:59:59'</span></span></span><br></pre></td></tr></table></figure>
<p>mysql的<strong><code>CONCAT()</code></strong>函数用于将多个字符串连接成一个字符串，是最重要的mysql函数之一。</p>
<a id="more"></a>
<p>如果要在字段后面添加字符串则是这样写</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">UPDATE</span></span><br><span class="line">    <span class="string">`usrdb`</span>.<span class="string">`menber`</span></span><br><span class="line">  <span class="keyword">SET</span></span><br><span class="line">    <span class="string">`name`</span> = <span class="keyword">CONCAT</span>(<span class="string">'name'</span>, <span class="string">`jc100`</span>)</span><br><span class="line">  <span class="keyword">WHERE</span> provice = <span class="string">'678'</span></span><br><span class="line">    <span class="keyword">AND</span> input_time <span class="keyword">BETWEEN</span> <span class="string">'2015-07-30 00:00:00'</span></span><br><span class="line">    <span class="keyword">AND</span> <span class="string">'2015-07-30 23:59:59'</span></span></span><br></pre></td></tr></table></figure>
]]></content>
    <summary type="html">
    <![CDATA[<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--在`menber`表的`name`字段前面按照条件批量加`jc100`这个字符串</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">UPDATE</span> </span><br><span class="line">    <span class="string">`usrdb`</span>.<span class="string">`menber`</span></span><br><span class="line">  <span class="keyword">SET</span></span><br><span class="line">    <span class="string">`name`</span> = <span class="keyword">CONCAT</span>(<span class="string">'jc100'</span>, <span class="string">`name`</span>) </span><br><span class="line">  <span class="keyword">WHERE</span> provice = <span class="string">'678'</span> </span><br><span class="line">    <span class="keyword">AND</span> input_time <span class="keyword">BETWEEN</span> <span class="string">'2015-07-30 00:00:00'</span> </span><br><span class="line">    <span class="keyword">AND</span> <span class="string">'2015-07-30 23:59:59'</span></span></span><br></pre></td></tr></table></figure>
<p>mysql的<strong><code>CONCAT()</code></strong>函数用于将多个字符串连接成一个字符串，是最重要的mysql函数之一。</p>]]>
    
    </summary>
    
      <category term="sql语句" scheme="http://linux48.com/tags/sql%E8%AF%AD%E5%8F%A5/"/>
    
      <category term="database" scheme="http://linux48.com/categories/database/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[mysql双主主键冲突排查修复]]></title>
    <link href="http://linux48.com//archives/433/"/>
    <id>http://linux48.com//archives/433/</id>
    <published>2015-07-21T16:00:00.000Z</published>
    <updated>2016-04-09T09:12:49.000Z</updated>
    <content type="html"><![CDATA[<h1 id="背景">背景</h1><p>线上A和B互为主主，A为业务写库，B为读库</p>
<p>19号下午收到短信报警A的slave delay，果断VPN上去数据库查看到</p>
<pre><code>Last_SQL_Error: Error <span class="string">'Duplicate entry '</span><span class="number">4960446</span><span class="string">' for key '</span>transaction_id<span class="string">''</span> <span class="keyword">on</span> query. <span class="keyword">Default</span> database
</code></pre><p>又是熟悉的主键冲突，但是这个时候不能让业务出现任何问题，就果断在A</p>
<a id="more"></a>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; STOP SLAVE;</span><br><span class="line">mysql&gt; SET GLOBAL sql_slave_skip_counter = <span class="number">1</span>;</span><br><span class="line">mysql&gt; START SLAVE;</span><br></pre></td></tr></table></figure>
<p>经过2次重复的上述操作，同步OK了，然后根据这两条报错的主键ID在两台数据库查询发现都不一样，<br>此时我清楚的知道已经有2条数据差异了，如果不及时处理早晚有一天被掩盖的问题会再次爆发出来。</p>
<p>后来经过一些列的排查之后知道问题所在了</p>
<p>因为7月2号晚上在B<code>alter</code>表的时候，导致B锁表，而A还在写入，并且正好在更新服务，导致数据的差异</p>
<p>查<code>general log</code>得知7月19号人为的在B上插入了两条<code>transaction_id=&quot;4960446&quot;</code>和<code>transaction_id=&quot;4960426&quot;</code>的记录和A的id冲突，导致A同步挂掉</p>
<p>因为A为业务写库，所以现在需要把A上这两条正确的数据插入到B，并在B上面删除错误的。</p>
<p>由于这个是自增的主键，所以还不好操作，下面大概就测试环境详细说明一下复现方案以及解决办法。</p>
<hr>
<h1 id="复现方案">复现方案</h1><blockquote>
<ul>
<li>192.168.1.52  模拟线上A 负责写入</li>
<li>192.168.1.42  模拟线上B 负责读取</li>
</ul>
</blockquote>
<h2 id="设置my-cnf，差开自增ID">设置my.cnf，差开自增ID</h2><p>52配置</p>
<pre><code><span class="keyword">auto</span>-increment-increment=<span class="number">10</span>
<span class="keyword">auto</span>-increment-offset=<span class="number">8</span>
</code></pre><p>42配置</p>
<pre><code><span class="keyword">auto</span>-increment-increment=<span class="number">10</span>
<span class="keyword">auto</span>-increment-offset=<span class="number">6</span>
</code></pre><h2 id="创建测试表">创建测试表</h2><p>随便在其中一台的test库中创建测试表，双主自动同步到另一台</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">use</span> test;</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`test`</span> (</span><br><span class="line">  <span class="string">`qrpay_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT COMMENT <span class="string">'主键'</span>,</span><br><span class="line">  <span class="string">`transaction_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (<span class="string">`qrpay_id`</span>),</span><br><span class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`transaction_id`</span> (<span class="string">`transaction_id`</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">896</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span></span><br></pre></td></tr></table></figure>
<h2 id="插入测试数据">插入测试数据</h2><p>在52插入测试数据，可以发现”qrpay_id”的值是依照 auto-increment-offset 格式的, 同步过去也是如此</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO `<span class="built_in">test</span>` VALUES (<span class="string">'null'</span>,<span class="string">'1'</span>);</span><br><span class="line">INSERT INTO `<span class="built_in">test</span>` VALUES (<span class="string">'null'</span>,<span class="string">'2'</span>);</span><br><span class="line">INSERT INTO `<span class="built_in">test</span>` VALUES (<span class="string">'null'</span>,<span class="string">'3'</span>);</span><br></pre></td></tr></table></figure>
<p>   在42插入测试数据，可以发现”qrpay_id”的值是依照 auto-increment-offset 格式的, 同步过去也是如此</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO `<span class="built_in">test</span>` VALUES (<span class="string">'null'</span>,<span class="string">'4'</span>);</span><br><span class="line">INSERT INTO `<span class="built_in">test</span>` VALUES (<span class="string">'null'</span>,<span class="string">'5'</span>);</span><br><span class="line">INSERT INTO `<span class="built_in">test</span>` VALUES (<span class="string">'null'</span>,<span class="string">'6'</span>);</span><br></pre></td></tr></table></figure>
<h2 id="模拟同步异常">模拟同步异常</h2><p>停掉42的同步</p>
<pre><code>slave <span class="operator"><span class="keyword">stop</span>;</span>
</code></pre><p>并在52上插入数据</p>
<pre><code><span class="operator"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span> <span class="keyword">VALUES</span> (<span class="string">'null'</span>,<span class="string">'7'</span>);</span>
</code></pre><p>在42上插入数据</p>
<pre><code><span class="operator"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span> <span class="keyword">VALUES</span> (<span class="string">'null'</span>,<span class="string">'7'</span>);</span>
</code></pre><p>开启42的同步</p>
<pre><code>slave <span class="operator"><span class="keyword">start</span>;</span>
</code></pre><p>在两边都show slave status \G; 可以发现都提示</p>
<pre><code>Error <span class="string">'Duplicate entry '</span><span class="number">7</span><span class="string">' for key '</span>transaction_id<span class="string">''</span> on query. Default <span class="string">database:</span> <span class="string">'test'</span>. <span class="string">Query:</span> <span class="string">'INSERT INTO `test` VALUES ('</span><span class="literal">null</span><span class="string">','</span><span class="number">7</span><span class="string">')'</span>
</code></pre><p>因为停掉了42的同步，所以插入到52的数据不会同步到42，并且也在42上面插入了相同值的transaction_id，同步到52的时候就导致了主键重复，最后开启42的同步，双方都互相冲突</p>
<p>这个时候两边主从都是挂掉的，然后两边都跳过这个错误</p>
<pre><code><span class="operator"><span class="keyword">stop</span> <span class="keyword">slave</span>;</span>
<span class="operator"><span class="keyword">set</span> <span class="keyword">global</span> sql_slave_skip_counter=<span class="number">1</span>;</span>
slave <span class="operator"><span class="keyword">start</span>;</span>
</code></pre><p>再show slave status \G;查看正常</p>
<h2 id="模拟数据差异1">模拟数据差异1</h2><p>在42上面删掉transaction_id刚才冲突的那条transaction_id=’7’的记录,按照qrpay_id找</p>
<pre><code><span class="operator"><span class="keyword">delete</span> <span class="keyword">from</span> test <span class="keyword">where</span> qrpay_id=<span class="string">'1166'</span>;</span>
</code></pre><p>继续在52写入测试数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO `<span class="built_in">test</span>` VALUES (<span class="string">'null'</span>,<span class="string">'8'</span>);</span><br><span class="line">INSERT INTO `<span class="built_in">test</span>` VALUES (<span class="string">'null'</span>,<span class="string">'9'</span>);</span><br><span class="line">INSERT INTO `<span class="built_in">test</span>` VALUES (<span class="string">'null'</span>,<span class="string">'10'</span>);</span><br></pre></td></tr></table></figure>
<p>这个时候52上面比42的多了一条transaction_id=’7’的记录</p>
<p>以上目地是模拟出真实数据库A比B多数据的场景</p>
<h2 id="修复同步">修复同步</h2><p>在42上插入数据</p>
<pre><code><span class="operator"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span> <span class="keyword">VALUES</span> (<span class="string">'null'</span>,<span class="string">'7'</span>);</span>
</code></pre><p>这时因为52上已有transaction_id=’7’的记录的值导致52同步挂掉</p>
<p>只有52报</p>
<pre><code>Error <span class="string">'Duplicate entry '</span><span class="number">7</span><span class="string">' for key '</span>transaction_id<span class="string">''</span> on query. Default <span class="string">database:</span> <span class="string">'test'</span>. <span class="string">Query:</span> <span class="string">'INSERT INTO `test` VALUES ('</span><span class="literal">null</span><span class="string">','</span><span class="number">7</span><span class="string">')'</span>
</code></pre><p>在52上跳过错误</p>
<pre><code><span class="operator"><span class="keyword">stop</span> <span class="keyword">slave</span>;</span>
<span class="operator"><span class="keyword">set</span> <span class="keyword">global</span> sql_slave_skip_counter=<span class="number">1</span>;</span>
slave <span class="operator"><span class="keyword">start</span>;</span>
</code></pre><p>再show slave status \G;查看正常</p>
<p>52继续插入数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO `<span class="built_in">test</span>` VALUES (<span class="string">'null'</span>,<span class="string">'11'</span>);</span><br><span class="line">INSERT INTO `<span class="built_in">test</span>` VALUES (<span class="string">'null'</span>,<span class="string">'12'</span>);</span><br><span class="line">INSERT INTO `<span class="built_in">test</span>` VALUES (<span class="string">'null'</span>,<span class="string">'13'</span>);</span><br></pre></td></tr></table></figure>
<p>发现42也健康的同步过来了</p>
<h2 id="复现完毕">复现完毕</h2><p> 数据差异为transaction_id=’7’这条记录,需要修复</p>
<hr>
<h1 id="线上解决方案">线上解决方案</h1><h2 id="备份线上数据表">备份线上数据表</h2><p>晚上12点过后备份A和B的<code>test</code>表（需要恢复的表，为了隐私这里用test代替）</p>
<p>还好这张表里只有100多万条数据，很快就备份出来了，要不然备份锁表就不能这样搞了</p>
<h2 id="导库到测试">导库到测试</h2><p>次日上班处理</p>
<p>停掉测试环境52，42双方的slave</p>
<p>线上A备份导入到52的test库，线上B备份导入到42的test库,两个库的input_date框在同一时间,并比对一下条数记录是否一致</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">delete from <span class="built_in">test</span> <span class="built_in">where</span> input_date &gt;= <span class="string">'2015-07-22 00:00:00'</span></span><br><span class="line">select count(*) from <span class="built_in">test</span></span><br></pre></td></tr></table></figure>
<p>双方重新 记录<strong><code>show master status</code></strong>的值  并<strong><code>change master</code></strong></p>
<p>开启双方<code>slave</code>,这个时候双方的数据就有差异，而不会双向同步问题数据咯</p>
<h2 id="修复数据">修复数据</h2><p>因为52和42是双主模式，具体正确数据以线上A导入到52的数据为准</p>
<p>在52上面执行下面命令，来检测数据的一致性</p>
<pre><code><span class="comment">pt</span><span class="literal">-</span><span class="comment">table</span><span class="literal">-</span><span class="comment">checksum</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">nocheck</span><span class="literal">-</span><span class="comment">replication</span><span class="literal">-</span><span class="comment">filters</span>  <span class="literal">-</span><span class="literal">-</span><span class="comment">no</span><span class="literal">-</span><span class="comment">check</span><span class="literal">-</span><span class="comment">binlog</span><span class="literal">-</span><span class="comment">format</span>  <span class="literal">-</span><span class="literal">-</span><span class="comment">replicate=test</span><span class="string">.</span><span class="comment">checksums</span>  <span class="literal">-</span><span class="literal">-</span><span class="comment">databases=test</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">tables=test</span>  <span class="literal">-</span><span class="literal">-</span><span class="comment">host=localhost</span>    <span class="literal">-</span><span class="literal">-</span><span class="comment">password=123456</span>
</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">tip:</span><br><span class="line">参数解释</span><br><span class="line">--nocheck-replication-filters ：不检查复制过滤器，建议启用。后面可以用--databases来指定需要检查的数据库。</span><br><span class="line">--no-check-binlog-format      : 不检查复制的binlog模式，要是binlog模式是ROW，则会报错。</span><br><span class="line">--replicate-check-only :只显示不同步的信息。</span><br><span class="line">--replicate=   ：把checksum的信息写入到指定表中，建议直接写到被检查的数据库当中。 </span><br><span class="line">--databases=   ：指定需要被检查的数据库，多个则用逗号隔开。</span><br><span class="line">--tables=      ：指定需要被检查的表，多个用逗号隔开</span><br><span class="line">h=<span class="number">127.0</span>.<span class="number">0.1</span>    ：Master的地址</span><br><span class="line">u=root         ：用户名</span><br><span class="line">p=<span class="number">123456</span>       ：密码</span><br><span class="line">P=<span class="number">3306</span>         ：端口</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">输出解释</span><br><span class="line">TS            ：完成检查的时间。</span><br><span class="line">ERRORS        ：检查时候发生错误和警告的数量。</span><br><span class="line">DIFFS         ：差异的条数。当指定--no-replicate-check时，会一直为<span class="number">0</span>，当指定--replicate-check-only会显示不同的信息。</span><br><span class="line">ROWS          ：表的行数。</span><br><span class="line">CHUNKS        ：被划分到表中的块的数目。</span><br><span class="line">SKIPPED       ：由于错误或警告或过大，则跳过块的数目。</span><br><span class="line">TIME          ：执行的时间。</span><br><span class="line">TABLE         ：被检查的表名。</span><br></pre></td></tr></table></figure>
<p>由于线上A和B已经存在差异，所以肯定DIFFS是一个非0的值</p>
<p>需要在42创建checksum用户供52使用</p>
<pre><code><span class="operator"><span class="keyword">grant</span> <span class="keyword">SELECT</span>, PROCESS, SUPER, REPLICATION <span class="keyword">SLAVE</span> <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="keyword">checksum</span> @<span class="string">'192.168.1.52'</span> <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">'123456'</span> ;</span>
<span class="operator"><span class="keyword">flush</span> <span class="keyword">privileges</span>;</span>
</code></pre><p>在52执行下面命令，通过（—print）打印出需要修复数据的sql语句，然后记录下来，然后经过处理，手动的拿去线上B去行执行，让他们数据保持一致性</p>
<pre><code>pt-table-sync <span class="variable">--replicate=</span>test.checksums <span class="variable">h=</span>localhost,<span class="variable">u=</span>root,<span class="variable">p=</span><span class="number">123456</span> <span class="variable">h=</span><span class="number">192.168</span>.<span class="number">1.42</span>,<span class="variable">u=</span>checksum,<span class="variable">p=</span><span class="number">123456</span> --print <span class="variable">--charset=</span>utf8
</code></pre><p>tip:为什么要print直接打印出来问题sql，这是因为pt-table-sync会重建数据，所以有一定的风险，最好提前备份好数据。如果仍然不放心，可以使用它提供的「print」选项，它会打印出相应的SQL，你可以审查一下到底执行了那些操作，然后通过手动执行来完成同步, <strong><code>--charset=utf8</code></strong>  这个参数是让打印出来的sql语句中的汉字正常显示，不然会是乱码。</p>
<pre><code>也可以通过(<span class="comment">--execute)直接修复，但是建议千万不要这么做。</span>
</code></pre><h1 id="附：">附：</h1><p>————————-Percona Toolkit INSTALL————————————-</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">yum install perl-ExtUtils-CBuilder perl-ExtUtils-MakeMaker -y</span><br><span class="line">yum perl-DBD-MySQL -y</span><br><span class="line">yum perl-Time-HiRes -y</span><br><span class="line">yum perl-TermReadKey -y</span><br><span class="line">yum perl-DBI</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">wget https://www.percona.com/downloads/percona-toolkit/<span class="number">2.2</span>.<span class="number">14</span>/tarball/percona-toolkit-<span class="number">2.2</span>.<span class="number">14</span>.tar.gz</span><br><span class="line"></span><br><span class="line">tar zxvf percona-toolkit-<span class="number">2.2</span>.<span class="number">14</span>.tar.gz </span><br><span class="line"><span class="built_in">cd</span> percona-toolkit-<span class="number">2.2</span>.<span class="number">14</span></span><br><span class="line">perl Makefile.PL PREFIX=/usr/<span class="built_in">local</span>/percona-toolkit</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"PATH=<span class="variable">$PATH</span>:/usr/local/percona-toolkit"</span> &gt;&gt; /etc/profile</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"export PATH"</span> &gt;&gt; /etc/profile</span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>
]]></content>
    <summary type="html">
    <![CDATA[<h1 id="背景">背景</h1><p>线上A和B互为主主，A为业务写库，B为读库</p>
<p>19号下午收到短信报警A的slave delay，果断VPN上去数据库查看到</p>
<pre><code>Last_SQL_Error: Error <span class="string">'Duplicate entry '</span><span class="number">4960446</span><span class="string">' for key '</span>transaction_id<span class="string">''</span> <span class="keyword">on</span> query. <span class="keyword">Default</span> database
</code></pre><p>又是熟悉的主键冲突，但是这个时候不能让业务出现任何问题，就果断在A</p>]]>
    
    </summary>
    
      <category term="mysql" scheme="http://linux48.com/tags/mysql/"/>
    
      <category term="主键冲突" scheme="http://linux48.com/tags/%E4%B8%BB%E9%94%AE%E5%86%B2%E7%AA%81/"/>
    
      <category term="双主" scheme="http://linux48.com/tags/%E5%8F%8C%E4%B8%BB/"/>
    
      <category term="数据恢复" scheme="http://linux48.com/tags/%E6%95%B0%E6%8D%AE%E6%81%A2%E5%A4%8D/"/>
    
      <category term="database" scheme="http://linux48.com/categories/database/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[mysql双主互备设计搭建]]></title>
    <link href="http://linux48.com//archives/432/"/>
    <id>http://linux48.com//archives/432/</id>
    <published>2015-07-14T16:00:00.000Z</published>
    <updated>2016-04-09T09:12:49.000Z</updated>
    <content type="html"><![CDATA[<p>Master-Master复制的两台服务器，既是master，又是另一台服务器的slave。这样，任何一方所做的变更，都会通过复制应用到另外一方的数据库中。<br>这样做的好很多，主要是下面几点:</p>
<blockquote>
<ul>
<li>可以做灾备，其中一个坏了可以切换到另一个。 </li>
<li>可以做负载均衡，可以将请求分摊到其中任何一台上，提高网站吞吐量。  </li>
<li>对于异地热备，尤其适合灾备。</li>
<li>…</li>
</ul>
</blockquote>
<p>今天在测试环境部署一套下来，简单总结一下过程以及经验<br><a id="more"></a></p>
<h1 id="mysql_复制工作原理">mysql 复制工作原理</h1>]]></content>
    <summary type="html">
    <![CDATA[<p>Master-Master复制的两台服务器，既是master，又是另一台服务器的slave。这样，任何一方所做的变更，都会通过复制应用到另外一方的数据库中。<br>这样做的好很多，主要是下面几点:</p>
<blockquote>
<ul>
<li>可以做灾备，其中一个坏了可以切换到另一个。 </li>
<li>可以做负载均衡，可以将请求分摊到其中任何一台上，提高网站吞吐量。  </li>
<li>对于异地热备，尤其适合灾备。</li>
<li>…</li>
</ul>
</blockquote>
<p>今天在测试环境部署一套下来，简单总结一下过程以及经验<br>]]>
    
    </summary>
    
      <category term="mysql" scheme="http://linux48.com/tags/mysql/"/>
    
      <category term="mysql高可用" scheme="http://linux48.com/tags/mysql%E9%AB%98%E5%8F%AF%E7%94%A8/"/>
    
      <category term="双主" scheme="http://linux48.com/tags/%E5%8F%8C%E4%B8%BB/"/>
    
      <category term="热备" scheme="http://linux48.com/tags/%E7%83%AD%E5%A4%87/"/>
    
      <category term="database" scheme="http://linux48.com/categories/database/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[CentOS6安装subversion 可视化管理工具iF.SVNAdmin]]></title>
    <link href="http://linux48.com//archives/431/"/>
    <id>http://linux48.com//archives/431/</id>
    <published>2015-07-06T16:00:00.000Z</published>
    <updated>2016-04-09T09:12:49.000Z</updated>
    <content type="html"><![CDATA[<p>windows下的TortoiseSVN服务端是相当好用的，界面管理方便，增删改查用户和库都比较好用，但是linux下的svn就比较折腾人。<br><a id="more"></a></p>
<p>之前安装过apache整合svn，虽然有web界面可以看，但是也不是那么好管理，昨天晚上受朋友所托，需要通过可视化工具来增删改查用户和库。</p>
<p>试了一圈以后最后找到了这个svnadmin。是使用php写的。他吸引我的主要是安装和配置都非常简单和人性化。而且也有强大的功能。</p>
<p>支持repo管理、用户管理、用户组管理、权限管理、LDAP等，界面可以算是中规中矩。</p>
<blockquote>
<ul>
<li>操作系统：CentOS-6.5-64bit</li>
<li>版本管理：Subversion-1.6.11</li>
<li>管理软件：F.SVNAdmin-stable-1.6.2</li>
<li>web引擎： Apache/2.2.3 (端口8888) &amp; nginx/1.4.4 (端口80) &amp; PHP 5.4.0</li>
<li>ip地址：  192.168.1.2</li>
</ul>
</blockquote>
<h1 id="源码编译安装lnmp">源码编译安装lnmp</h1><pre><code>git clone https:<span class="comment">//git.coding.net/svip/lnamp.git</span>
<span class="keyword">sh</span> lnmp/lnmp.<span class="keyword">sh</span>
</code></pre><p>这里使用源码编译lnmp环境主要是后面需要yum安装httpd和svn(这样子的好处是，默认会整合好apache和svn无需手动在整合配置)，apache只服务于svn，而nginx+php则是为了跑svnadmin</p>
<h1 id="yum安装apache+svn">yum安装apache+svn</h1><pre><code><span class="label">yum</span> -y install httpd <span class="keyword">subversion </span>mod_dav_svn
</code></pre><h1 id="配置apache的svn">配置apache的svn</h1><p>装完SVN后默认生成/etc/httpd/conf.d/subversion.conf文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ setup]<span class="comment"># cat /etc/httpd/conf.d/subversion.conf </span></span><br><span class="line"></span><br><span class="line">LoadModule dav_svn_module     modules/mod_dav_svn.so</span><br><span class="line">LoadModule authz_svn_module   modules/mod_authz_svn.so</span><br><span class="line"></span><br><span class="line">&lt;Location /project/&gt;</span><br><span class="line">            DAV svn</span><br><span class="line">            SVNListParentPath on</span><br><span class="line">            SVNParentPath /var/www/svn</span><br><span class="line">            AuthType Basic</span><br><span class="line">            AuthName <span class="string">"Subversion repository"</span></span><br><span class="line">            AuthUserFile /var/www/svnconfig/passwdfile</span><br><span class="line">            AuthzSVNAccessFile /var/www/svnconfig/accessfile</span><br><span class="line">            Require valid-user</span><br><span class="line">&lt;/Location&gt;</span><br></pre></td></tr></table></figure>
<h1 id="创建SVN_repo目录和权限信息目录">创建SVN repo目录和权限信息目录</h1><pre><code><span class="keyword">mkdir</span> /<span class="keyword">var</span>/www/svn
<span class="keyword">mkdir</span> /<span class="keyword">var</span>/www/svnconfig
</code></pre><h1 id="创建SVN权限文件和密码文件">创建SVN权限文件和密码文件</h1><p>创建权限控制文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ]<span class="comment"># cat /var/www/svnconfig/accessfile</span></span><br><span class="line"></span><br><span class="line">[aliases]</span><br><span class="line">[groups]</span><br><span class="line"></span><br><span class="line">[/]</span><br><span class="line">*=rw</span><br><span class="line"></span><br><span class="line">[qa_project:/]</span><br></pre></td></tr></table></figure></p>
<p>创建用户密码文件，注意这里的密码必须是加密的，需要使用 <code>htpasswd -c 123 user1</code>生成<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ]<span class="comment"># cat /var/www/svnconfig/passwdfile</span></span><br><span class="line"></span><br><span class="line">[users]</span><br><span class="line"><span class="comment"># harry = harryssecret</span></span><br><span class="line"><span class="comment"># sally = sallyssecret</span></span><br><span class="line">user1:aWW1oIsRihOHc</span><br></pre></td></tr></table></figure></p>
<h1 id="安装iF-SVnAdmin">安装iF.SVnAdmin</h1><pre><code>wget <span class="string">http:</span><span class="comment">//sourceforge.net/projects/ifsvnadmin/files/svnadmin-1.6.2.zip</span>
unzip svnadmin-<span class="number">1.6</span>.2.zip
mv iF.SVNAdmin-stable-<span class="number">1.6</span>.2 <span class="regexp">/home/</span>wwwroot/svnadmin
chmod <span class="number">777</span> -R <span class="regexp">/home/</span>wwwroot<span class="regexp">/svnadmin/</span>data
</code></pre><p>配置nginx,配置apache，注意2个web引擎的端口不要冲突，并开启相应端口到防火墙</p>
<h1 id="初始化iF-SVnAdmin">初始化iF.SVnAdmin</h1><p>浏览器输入<a href="http://192.168.1.2/svnadmin/index.php" target="_blank" rel="external">http://192.168.1.2/svnadmin/index.php</a></p>
<p>使用刚才生成的密码登陆进去可以看到下面的配置页面</p>
<p><img src="http://r.loli.io/meMjmi.png" alt=""><br>选择Test提示没有写入权限的话chmod一下，</p>
<p>登录后如下，可以看到软件版本信息、已有的仓库、用户、组、权限路径等</p>
<h1 id="投入使用">投入使用</h1><p>svn管理地址   <a href="http://192.168.1.2/svnadmin/index.php" target="_blank" rel="external">http://192.168.1.2/svnadmin/index.php</a><br>svn项目地址   <a href="http://192.168.1.2:8888/project/project_name/" target="_blank" rel="external">http://192.168.1.2:8888/project/project_name/</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<p>windows下的TortoiseSVN服务端是相当好用的，界面管理方便，增删改查用户和库都比较好用，但是linux下的svn就比较折腾人。<br>]]>
    
    </summary>
    
      <category term="svn" scheme="http://linux48.com/tags/svn/"/>
    
      <category term="工具" scheme="http://linux48.com/tags/%E5%B7%A5%E5%85%B7/"/>
    
      <category term="os" scheme="http://linux48.com/categories/os/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Red Hat Enterprise Linux Server YUM配置]]></title>
    <link href="http://linux48.com//archives/430/"/>
    <id>http://linux48.com//archives/430/</id>
    <published>2015-07-05T16:00:00.000Z</published>
    <updated>2016-04-09T09:12:49.000Z</updated>
    <content type="html"><![CDATA[<p>由于 redhat的yum在线更新是收费的，如果没有注册的话不能使用，如果要使用，需将redhat的yum卸载后，重启安装，再配置其他源.<br><a id="more"></a></p>
<h1 id="删除redhat原有的yum">删除redhat原有的yum</h1><pre><code>rpm -a<span class="string">q|grep yum|</span>xargs rpm -e --nodeps 
</code></pre><h1 id="下载yum安装文件">下载yum安装文件</h1><p>注意，由于官方不断更新版本，如果下载时找不到文件，就到：<a href="http://mirrors.163.com/centos/6/os/x86_64/Packages" target="_blank" rel="external">http://mirrors.163.com/centos/6/os/x86_64/Packages</a> 上查找相应的头文件。然后再下载。</p>
<pre><code>wget <span class="symbol">http:</span>/<span class="regexp">/mirrors.163.com/centos</span><span class="regexp">/6/os</span><span class="regexp">/x86_64/</span><span class="constant">Packages/</span>yum-<span class="number">3.2</span>.<span class="number">29</span>-<span class="number">60</span>.el6.centos.noarch.rpm
wget <span class="symbol">http:</span>/<span class="regexp">/mirrors.163.com/centos</span><span class="regexp">/6/os</span><span class="regexp">/x86_64/</span><span class="constant">Packages/</span>yum-metadata-parser-<span class="number">1.1</span>.<span class="number">2</span>-<span class="number">16</span>.el6.x86_64.rpm
wget <span class="symbol">http:</span>/<span class="regexp">/mirrors.163.com/centos</span><span class="regexp">/6/os</span><span class="regexp">/x86_64/</span><span class="constant">Packages/</span>yum-plugin-fastestmirror-<span class="number">1.1</span>.<span class="number">30</span>-<span class="number">30</span>.el6.noarch.rpm
wget <span class="symbol">http:</span>/<span class="regexp">/mirrors.163.com/centos</span><span class="regexp">/6/os</span><span class="regexp">/x86_64/</span><span class="constant">Packages/</span>python-iniparse-<span class="number">0</span>.<span class="number">3.1</span>-<span class="number">2.1</span>.el6.noarch.rpm
</code></pre><h1 id="进行安装yum">进行安装yum</h1><pre><code><span class="tag">rpm</span> <span class="tag">-ivh</span> <span class="tag">python-iniparse-0</span><span class="class">.3</span><span class="class">.1-2</span><span class="class">.1</span><span class="class">.el6</span><span class="class">.noarch</span><span class="class">.rpm</span>
<span class="tag">rpm</span> <span class="tag">-ivh</span> <span class="tag">yum-metadata-parser-1</span><span class="class">.1</span><span class="class">.2-16</span><span class="class">.el6</span><span class="class">.x86_64</span><span class="class">.rpm</span>
<span class="tag">rpm</span> <span class="tag">-ivh</span> <span class="tag">yum-3</span><span class="class">.2</span><span class="class">.29-40</span><span class="class">.el6</span><span class="class">.centos</span><span class="class">.noarch</span><span class="class">.rpm</span> <span class="tag">yum-plugin-fastestmirror-1</span><span class="class">.1</span><span class="class">.30-14</span><span class="class">.el6</span><span class="class">.noarch</span><span class="class">.rpm</span>
</code></pre><p>注意最后两个包必需同时安装，否则会相互依赖 </p>
<h1 id="配置源">配置源</h1><p>新建/etc/yum.repos.d/CentOS6-Base-163.repo<br>内容如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">[base]</span><br><span class="line"></span><br><span class="line">name=CentOS-<span class="number">6</span> - Base - <span class="number">163</span>.com</span><br><span class="line">baseurl=http://mirrors.<span class="number">163</span>.com/centos/<span class="number">6</span>/os/<span class="variable">$basearch</span>/</span><br><span class="line"><span class="comment">#mirrorlist=http://mirrorlist.centos.org/?release=6&amp;arch=$basearch&amp;repo=os</span></span><br><span class="line">gpgcheck=<span class="number">1</span></span><br><span class="line">gpgkey=http://mirror.centos.org/centos/RPM-GPG-KEY-CentOS-<span class="number">6</span></span><br><span class="line">priority=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#released updates</span></span><br><span class="line"></span><br><span class="line">[updates]</span><br><span class="line">name=CentOS-<span class="number">6</span> - Updates - <span class="number">163</span>.com</span><br><span class="line">baseurl=http://mirrors.<span class="number">163</span>.com/centos/<span class="number">6</span>/updates/<span class="variable">$basearch</span>/</span><br><span class="line"><span class="comment">#mirrorlist=http://mirrorlist.centos.org/?release=6&amp;arch=$basearch&amp;repo=updates</span></span><br><span class="line">gpgcheck=<span class="number">1</span></span><br><span class="line">gpgkey=http://mirror.centos.org/centos/RPM-GPG-KEY-CentOS-<span class="number">6</span></span><br><span class="line">priority=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#additional packages that may be useful</span></span><br><span class="line"></span><br><span class="line">[extras]</span><br><span class="line">name=CentOS-<span class="number">6</span> - Extras - <span class="number">163</span>.com</span><br><span class="line">baseurl=http://mirrors.<span class="number">163</span>.com/centos/<span class="number">6</span>/extras/<span class="variable">$basearch</span>/</span><br><span class="line"><span class="comment">#mirrorlist=http://mirrorlist.centos.org/?release=6&amp;arch=$basearch&amp;repo=extras</span></span><br><span class="line">gpgcheck=<span class="number">1</span></span><br><span class="line">gpgkey=http://mirror.centos.org/centos/RPM-GPG-KEY-CentOS-<span class="number">6</span></span><br><span class="line">priority=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#additional packages that extend functionality of existing packages</span></span><br><span class="line"></span><br><span class="line">[centosplus]</span><br><span class="line">name=CentOS-<span class="number">6</span> - Plus - <span class="number">163</span>.com</span><br><span class="line">baseurl=http://mirrors.<span class="number">163</span>.com/centos/<span class="number">6</span>/centosplus/<span class="variable">$basearch</span>/</span><br><span class="line"><span class="comment">#mirrorlist=http://mirrorlist.centos.org/?release=6&amp;arch=$basearch&amp;repo=centosplus</span></span><br><span class="line">gpgcheck=<span class="number">1</span></span><br><span class="line">enabled=<span class="number">0</span></span><br><span class="line">gpgkey=http://mirror.centos.org/centos/RPM-GPG-KEY-CentOS-<span class="number">6</span></span><br><span class="line">priority=<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#contrib - packages by Centos Users</span></span><br><span class="line"></span><br><span class="line">[contrib]</span><br><span class="line">name=CentOS-<span class="number">6</span> - Contrib - <span class="number">163</span>.com</span><br><span class="line">baseurl=http://mirrors.<span class="number">163</span>.com/centos/<span class="number">6</span>/contrib/<span class="variable">$basearch</span>/</span><br><span class="line"><span class="comment">#mirrorlist=http://mirrorlist.centos.org/?release=6&amp;arch=$basearch&amp;repo=contrib</span></span><br><span class="line">gpgcheck=<span class="number">1</span></span><br><span class="line">enabled=<span class="number">1</span></span><br><span class="line">gpgkey=http://mirror.centos.org/centos/RPM-GPG-KEY-CentOS-<span class="number">6</span></span><br><span class="line">priority=<span class="number">1</span></span><br></pre></td></tr></table></figure>
<h1 id="yum_clean_all">yum clean all</h1><h1 id="yum_install_vim">yum install vim</h1><p>测试一下可不可以用</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>由于 redhat的yum在线更新是收费的，如果没有注册的话不能使用，如果要使用，需将redhat的yum卸载后，重启安装，再配置其他源.<br>]]>
    
    </summary>
    
      <category term="RHEL" scheme="http://linux48.com/tags/RHEL/"/>
    
      <category term="yum" scheme="http://linux48.com/tags/yum/"/>
    
      <category term="os" scheme="http://linux48.com/categories/os/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[mysql全局日志开启]]></title>
    <link href="http://linux48.com//archives/429/"/>
    <id>http://linux48.com//archives/429/</id>
    <published>2015-06-25T06:30:42.000Z</published>
    <updated>2016-04-09T09:12:49.000Z</updated>
    <content type="html"><![CDATA[<p>之前有写过<a href="http://linux48.com/archives/74/">Mysql慢查询设置</a>，现在需要对Mysql进行深入的分析，发现mysql性能瓶颈和寻找优化策略，这就要对全部的sql执行语句进行查询，慢查询是满足不了的，binlog也只是记录了update语句，这个时候就需要设置mysql的全局log了。</p>
<a id="more"></a>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="built_in">test</span> mysql5.<span class="number">5</span>]<span class="comment"># cat /etc/my.cnf |grep -v "#" |grep "log"</span></span><br><span class="line"><span class="built_in">log</span>=/tmp/row.log</span><br><span class="line">slow-query-log = on</span><br><span class="line">slow_query_<span class="built_in">log</span>_file = /data/mysql/binlog/slowquery_3.log</span><br><span class="line"><span class="built_in">log</span>-queries-not-using-indexes = <span class="literal">true</span></span><br><span class="line"><span class="built_in">log</span>-bin=mysql-bin</span><br><span class="line">binlog_format=mixed</span><br><span class="line">innodb_<span class="built_in">log</span>_group_home_dir = /data/mysql/data</span><br></pre></td></tr></table></figure>
<p>指定一下log参数，重启mysql服务即可，如果不能重启mysql服务器可以使用<code>mysql&gt; set global log=1;</code>来开启</p>
<p>这样子就可以查看全局log了</p>
<p>此log记录了服务器接收到的每一个<code>查询</code>，<code>插入</code>，<code>更新</code>命令，无论这些是命令是否正确甚至是否包含语法错误，都会将其记录下来 ，记录的格式为 {Time ，Id ，Command，Argument }</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="built_in">test</span> mysql5.<span class="number">5</span>]<span class="comment"># tail -f /tmp/row.log</span></span><br><span class="line">/usr/<span class="built_in">local</span>/mysql/bin/mysqld, Version: <span class="number">5.5</span>.<span class="number">25</span>-log (Source distribution). started with:</span><br><span class="line">Tcp port: <span class="number">3306</span>  Unix socket: /data/mysql/mysql.sock</span><br><span class="line">Time                 Id Command    Argument</span><br><span class="line"><span class="number">150625</span> <span class="number">14</span>:<span class="number">08</span>:<span class="number">24</span>     <span class="number">1</span> Connect   xiaolei@<span class="number">10.10</span>.<span class="number">3.165</span> on</span><br><span class="line">                    <span class="number">1</span> Query     /*!<span class="number">40101</span> <span class="built_in">set</span> @@session.wait_timeout=<span class="number">28800</span> */</span><br><span class="line">                    <span class="number">1</span> Query     SET PROFILING = <span class="number">1</span></span><br><span class="line">                    <span class="number">1</span> Query     SET profiling_<span class="built_in">history</span>_size = <span class="number">0</span></span><br><span class="line">                    <span class="number">1</span> Query     SET profiling_<span class="built_in">history</span>_size = <span class="number">15</span></span><br><span class="line">                    <span class="number">1</span> Query     SHOW STATUS</span><br><span class="line">                    <span class="number">1</span> Query     SELECT COUNT(*) FROM `<span class="built_in">test</span>`.`<span class="number">2222</span>` LIMIT <span class="number">0</span>, <span class="number">1000</span></span><br><span class="line"><span class="number">150625</span> <span class="number">14</span>:<span class="number">08</span>:<span class="number">43</span>     <span class="number">1</span> Query     TRUNCATE TABLE test.<span class="number">1</span></span><br><span class="line"><span class="number">150625</span> <span class="number">14</span>:<span class="number">08</span>:<span class="number">49</span>     <span class="number">1</span> Query     INSERT INTO test.<span class="number">1</span> SELECT * FROM test.`gc_1_17500`</span><br><span class="line">                    <span class="number">1</span> Query     /*!<span class="number">40101</span> <span class="built_in">set</span> @@session.wait_timeout=<span class="number">28800</span> */</span><br><span class="line">                    <span class="number">1</span> Query     TRUNCATE TABLE test.<span class="number">1</span></span><br><span class="line"><span class="number">150625</span> <span class="number">14</span>:<span class="number">13</span>:<span class="number">26</span>     <span class="number">1</span> Query     INSERT INTO test.<span class="number">1</span> SELECT * FROM test.`gc_1_17500`</span><br><span class="line"><span class="number">150625</span> <span class="number">14</span>:<span class="number">13</span>:<span class="number">49</span>     <span class="number">1</span> Query     SET PROFILING = <span class="number">1</span></span><br><span class="line">                    <span class="number">1</span> Query     SET profiling_<span class="built_in">history</span>_size = <span class="number">0</span></span><br><span class="line">                    <span class="number">1</span> Query     SET profiling_<span class="built_in">history</span>_size = <span class="number">15</span></span><br><span class="line">                    <span class="number">1</span> Query     SHOW STATUS</span><br><span class="line">                    <span class="number">1</span> Query     SELECT COUNT(*) FROM `<span class="built_in">test</span>`.`<span class="number">1</span>` LIMIT <span class="number">0</span>, <span class="number">1000</span></span><br><span class="line">                    <span class="number">1</span> Query     SHOW STATUS</span><br><span class="line">                    <span class="number">1</span> Query     SHOW PROFILES</span><br><span class="line">                    <span class="number">1</span> Query     select state, round(sum(duration),<span class="number">5</span>) as `duration (summed) <span class="keyword">in</span> sec` from information_schema.profiling <span class="built_in">where</span> query_id = <span class="number">4</span> group by state order by `duration (summed) <span class="keyword">in</span> sec` desc</span><br><span class="line">                    <span class="number">1</span> Query     SET PROFILING = <span class="number">0</span></span><br><span class="line">                    <span class="number">1</span> Query     EXPLAIN SELECT COUNT(*) FROM `<span class="built_in">test</span>`.`<span class="number">1</span>` LIMIT <span class="number">0</span>, <span class="number">1000</span></span><br></pre></td></tr></table></figure>
<p>但是当我查看了一些mysql的err日志发现其中log参数是过时的，但是从日志输出效果看来也没什么问题,</p>
<pre><code><span class="number">150625</span> <span class="number">14</span>:<span class="number">35</span>:<span class="number">05</span> [Warning] The syntax <span class="string">'--log'</span> <span class="keyword">is</span> <span class="keyword">deprecated</span> <span class="keyword">and</span> will be removed <span class="keyword">in</span> a <span class="keyword">future</span> release. Please use <span class="string">'--general-log'</span>/<span class="string">'--general-log-file'</span> instead.
</code></pre><p>Warning提示“—log”已经过时，并将在以后的版本中删除。请使用’—general-log’</p>
<p>有强迫症的我还是遵从官方的说明,使用<code>general-log</code>吧</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="built_in">test</span> mysql5.<span class="number">5</span>]<span class="comment"># cat /etc/my.cnf |grep -v "#" |grep "log"</span></span><br><span class="line">general-log = on</span><br><span class="line">general_<span class="built_in">log</span>_file = /data/mysql/binlog/general.log</span><br><span class="line">slow-query-log = on</span><br><span class="line">slow_query_<span class="built_in">log</span>_file = /data/mysql/binlog/slowquery_3.log</span><br><span class="line"><span class="built_in">log</span>-queries-not-using-indexes = <span class="literal">true</span></span><br><span class="line"><span class="built_in">log</span>-bin=mysql-bin</span><br><span class="line">binlog_format=mixed</span><br><span class="line">innodb_<span class="built_in">log</span>_group_home_dir = /data/mysql/data</span><br></pre></td></tr></table></figure>
<p>通过分析全局log，我们可以得到诸如下信息：</p>
<blockquote>
<ul>
<li>1、Mysql访问得最多的数据</li>
<li>2、Mysql执行得最多的查询的种类</li>
<li>3、Mysql停留时间最长的状态</li>
<li>4、Mysql用来执行查询的使用得最频繁的子系统</li>
<li>5、Mysql查询过程中访问的数据种类</li>
<li>6、Mysql执行了多少种不同类型的活动，比如索引扫描。</li>
</ul>
</blockquote>
]]></content>
    <summary type="html">
    <![CDATA[<p>之前有写过<a href="http://linux48.com/archives/74/">Mysql慢查询设置</a>，现在需要对Mysql进行深入的分析，发现mysql性能瓶颈和寻找优化策略，这就要对全部的sql执行语句进行查询，慢查询是满足不了的，binlog也只是记录了update语句，这个时候就需要设置mysql的全局log了。</p>]]>
    
    </summary>
    
      <category term="log" scheme="http://linux48.com/tags/log/"/>
    
      <category term="mysql" scheme="http://linux48.com/tags/mysql/"/>
    
      <category term="database" scheme="http://linux48.com/categories/database/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[关于PHP-FPM的backlog]]></title>
    <link href="http://linux48.com//archives/428/"/>
    <id>http://linux48.com//archives/428/</id>
    <published>2015-06-08T06:30:42.000Z</published>
    <updated>2016-04-09T09:12:49.000Z</updated>
    <content type="html"><![CDATA[<p>php-fpm 必须注意<strong>backlog</strong>的设置，否则上压力就容易 无法连接、网关超时！</p>
<a id="more"></a>
<pre><code><span class="comment">;listen.backlog = -1</span>
</code></pre><p>backlog数，-1表示无限制，由操作系统决定</p>
<p>由于fpm是多个进程是监听同一个套接字的，通过一个套接字锁来保证同一时刻只有一个进程可以accept，多进程间抢锁是需要消耗时间的</p>
<p>在backlog被设置成-1的情况下，如果fpm没有及时accept，那么在并发量很大的情况下势必会出现SYN超时重连了。</p>
<p>安装php-fpm时backlog一定要重新设置，不能用fpm默认配置的-1 ，可以根据机器的并发量来设置，建议设置在1024以上，最好是2的幂值（因为内核会调整成2的n次幂）。</p>
<p>有高并发的业务，就必须要调整backlog。对于PHP而言，需要注意的有3方面：</p>
<blockquote>
<ul>
<li>1、操作系统 | sysctl</li>
<li>2、WEB前端 | 比如：Nginx</li>
<li>3、PHP后台 | 比如：php-fpm</li>
</ul>
</blockquote>
<p>操作系统以CentOS为例，可通过默认配置 /etc/sysctl.conf 文件进行调整。比如：</p>
<pre><code>net.core.<span class="variable">somaxconn =</span> <span class="number">1048576</span> <span class="comment"># 默认为128</span>
net.core.<span class="variable">netdev_max_backlog =</span> <span class="number">1048576</span> <span class="comment"># 默认为1000</span>
net.ipv4.<span class="variable">tcp_max_syn_backlog =</span> <span class="number">1048576</span> <span class="comment"># 默认为1024</span>
</code></pre><p>WEB前端以Nginx为例，可通过默认配置 /etc/nginx/nginx.conf 文件中的监听选项来调整。比如：</p>
<pre><code><span class="title">listen</span>       <span class="number">80</span> backlog=<span class="number">8192</span>; <span class="comment"># 默认为511</span>
</code></pre><p>PHP后台，以PHP-FPM为例，可以通过默认配置 /etc/php-fpm.d/www.conf 文件进行调整。比如：</p>
<pre><code>listen.<span class="variable">backlog =</span> <span class="number">8192</span> <span class="comment"># 默认为-1（由系统决定）</span>
</code></pre><p>大系统下，如上3处都应该进行调整。</p>
<p>值得注意的是：</p>
<pre><code>PHP-FPM的配置文件中，关于listen.backlog选项的注释有些误导人：

; <span class="operator"><span class="keyword">Set</span> listen(<span class="number">2</span>) backlog. A <span class="keyword">value</span> <span class="keyword">of</span> <span class="string">'-1'</span> means unlimited. 
;</span> Default Value: -1
</code></pre><p>实际上如果使用默认值，很容易出现后端无法连接的问题，按老文档上的解释这个默认是200。建议此处不要留空，务必设置一个合适的值。</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>php-fpm 必须注意<strong>backlog</strong>的设置，否则上压力就容易 无法连接、网关超时！</p>]]>
    
    </summary>
    
      <category term="php" scheme="http://linux48.com/tags/php/"/>
    
      <category term="devops" scheme="http://linux48.com/categories/devops/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[MySQL的Grant赋权命令详解]]></title>
    <link href="http://linux48.com//archives/427/"/>
    <id>http://linux48.com//archives/427/</id>
    <published>2015-06-05T08:30:42.000Z</published>
    <updated>2016-04-09T09:12:49.000Z</updated>
    <content type="html"><![CDATA[<p>本文实例，运行于 MySQL 5.0 及以上版本。</p>
<p>MySQL 赋予用户权限命令的简单格式可概括为：</p>
<pre><code>grant 权限 <span class="function_start"><span class="keyword">on</span></span> 数据库对象 <span class="keyword">to</span> 用户
</code></pre><a id="more"></a>
<h1 id="普通数据库用户权限">普通数据库用户权限</h1><p>一、grant 普通数据用户，查询、插入、更新、删除 数据库中所有表数据的权利。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">grant</span> <span class="keyword">select</span> <span class="keyword">on</span> testdb.* <span class="keyword">to</span> common_user@<span class="string">'%'</span></span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">insert</span> <span class="keyword">on</span> testdb.* <span class="keyword">to</span> common_user@<span class="string">'%'</span></span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">update</span> <span class="keyword">on</span> testdb.* <span class="keyword">to</span> common_user@<span class="string">'%'</span></span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">delete</span> <span class="keyword">on</span> testdb.* <span class="keyword">to</span> common_user@<span class="string">'%'</span></span></span><br></pre></td></tr></table></figure>
<p>或者，用一条 MySQL 命令来替代：</p>
<pre><code><span class="operator"><span class="keyword">grant</span> <span class="keyword">select</span>, <span class="keyword">insert</span>, <span class="keyword">update</span>, <span class="keyword">delete</span> <span class="keyword">on</span> testdb.* <span class="keyword">to</span> common_user@<span class="string">'%'</span></span>
</code></pre><h1 id="数据库开发人员权限">数据库开发人员权限</h1><p>二、grant 数据库开发人员，创建表、索引、视图、存储过程、函数。。。等权限。</p>
<p>grant 创建、修改、删除 MySQL 数据表结构权限。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">grant</span> <span class="keyword">create</span> <span class="keyword">on</span> testdb.* <span class="keyword">to</span> developer@<span class="string">'192.168.0.%'</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">grant</span> <span class="keyword">alter</span>  <span class="keyword">on</span> testdb.* <span class="keyword">to</span> developer@<span class="string">'192.168.0.%'</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">grant</span> <span class="keyword">drop</span>   <span class="keyword">on</span> testdb.* <span class="keyword">to</span> developer@<span class="string">'192.168.0.%'</span>;</span></span><br></pre></td></tr></table></figure>
<p>grant 操作 MySQL 外键权限。</p>
<pre><code><span class="operator"><span class="keyword">grant</span> <span class="keyword">references</span> <span class="keyword">on</span> testdb.* <span class="keyword">to</span> developer@<span class="string">'192.168.0.%'</span>;</span>
</code></pre><p>grant 操作 MySQL 临时表权限。</p>
<pre><code><span class="operator"><span class="keyword">grant</span> <span class="keyword">create</span> <span class="keyword">temporary</span> <span class="keyword">tables</span> <span class="keyword">on</span> testdb.* <span class="keyword">to</span> developer@<span class="string">'192.168.0.%'</span>;</span>
</code></pre><p>grant 操作 MySQL 索引权限。</p>
<pre><code><span class="operator"><span class="keyword">grant</span> <span class="keyword">index</span> <span class="keyword">on</span> testdb.* <span class="keyword">to</span> developer@<span class="string">'192.168.0.%'</span>;</span>
</code></pre><p>grant 操作 MySQL 视图、查看视图源代码 权限。</p>
<pre><code><span class="operator"><span class="keyword">grant</span> <span class="keyword">create</span> <span class="keyword">view</span> <span class="keyword">on</span> testdb.* <span class="keyword">to</span> developer@<span class="string">'192.168.0.%'</span>;</span>
<span class="operator"><span class="keyword">grant</span> <span class="keyword">show</span>   <span class="keyword">view</span> <span class="keyword">on</span> testdb.* <span class="keyword">to</span> developer@<span class="string">'192.168.0.%'</span>;</span>
</code></pre><p>grant 操作 MySQL 存储过程、函数 权限。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">grant</span> <span class="keyword">create</span> routine <span class="keyword">on</span> testdb.* <span class="keyword">to</span> developer@<span class="string">'192.168.0.%'</span>;</span> <span class="comment">-- now, can show procedure status</span></span><br><span class="line"><span class="operator"><span class="keyword">grant</span> <span class="keyword">alter</span>  routine <span class="keyword">on</span> testdb.* <span class="keyword">to</span> developer@<span class="string">'192.168.0.%'</span>;</span> <span class="comment">-- now, you can drop a procedure</span></span><br><span class="line"><span class="operator"><span class="keyword">grant</span> <span class="keyword">execute</span>        <span class="keyword">on</span> testdb.* <span class="keyword">to</span> developer@<span class="string">'192.168.0.%'</span>;</span></span><br></pre></td></tr></table></figure>
<h1 id="普通DBA权限">普通DBA权限</h1><p>三、grant 普通 DBA 管理某个 MySQL 数据库的权限。</p>
<pre><code><span class="operator"><span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">privileges</span> <span class="keyword">on</span> testdb <span class="keyword">to</span> dba@<span class="string">'localhost'</span></span>
</code></pre><p>其中，关键字 “privileges” 可以省略。</p>
<h1 id="高级DBA权限">高级DBA权限</h1><p>四、grant 高级 DBA 管理 MySQL 中所有数据库的权限。</p>
<pre><code><span class="operator"><span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> *.* <span class="keyword">to</span> dba@<span class="string">'localhost'</span></span>
</code></pre><h1 id="实际运用">实际运用</h1><p>五、MySQL grant 权限，分别可以作用在多个层次上。</p>
<h2 id="grant_作用在整个_MySQL_服务器上：">grant 作用在整个 MySQL 服务器上：</h2><pre><code><span class="operator"><span class="keyword">grant</span> <span class="keyword">select</span> <span class="keyword">on</span> *.* <span class="keyword">to</span> dba@localhost;</span> 
<span class="comment">-- dba 可以查询 MySQL 中所有数据库中的表。</span>

<span class="operator"><span class="keyword">grant</span> <span class="keyword">all</span>    <span class="keyword">on</span> *.* <span class="keyword">to</span> dba@localhost;</span> 
<span class="comment">-- dba 可以管理 MySQL 中的所有数据库</span>
</code></pre><h2 id="grant_作用在单个数据库上：">grant 作用在单个数据库上：</h2><pre><code><span class="operator"><span class="keyword">grant</span> <span class="keyword">select</span> <span class="keyword">on</span> testdb.* <span class="keyword">to</span> dba@localhost;</span> 
<span class="comment">-- dba 可以查询 testdb 中的表。</span>
</code></pre><h2 id="grant_作用在单个数据表上：">grant 作用在单个数据表上：</h2><pre><code><span class="operator"><span class="keyword">grant</span> <span class="keyword">select</span>, <span class="keyword">insert</span>, <span class="keyword">update</span>, <span class="keyword">delete</span> <span class="keyword">on</span> testdb.orders <span class="keyword">to</span> dba@localhost;</span>
</code></pre><p>这里在给一个用户授权多张表时，可以多次执行以上语句。例如：</p>
<pre><code><span class="operator"><span class="keyword">grant</span> <span class="keyword">select</span>(user_id,username) <span class="keyword">on</span> smp.users <span class="keyword">to</span> mo_user@<span class="string">'%'</span> <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">'123345'</span>;</span>
<span class="operator"><span class="keyword">grant</span> <span class="keyword">select</span> <span class="keyword">on</span> smp.mo_sms <span class="keyword">to</span> mo_user@<span class="string">'%'</span> <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">'123345'</span>;</span>
</code></pre><h2 id="grant_作用在表中的列上：">grant 作用在表中的列上：</h2><pre><code><span class="operator"><span class="keyword">grant</span> <span class="keyword">select</span>(id, se, rank) <span class="keyword">on</span> testdb.apache_log <span class="keyword">to</span> dba@localhost;</span>
</code></pre><h2 id="grant_作用在存储过程、函数上：">grant 作用在存储过程、函数上：</h2><pre><code>grant<span class="instruction"> execute </span>on procedure testdb.pr_add to 'dba'@'localhost'
grant<span class="instruction"> execute </span>on function testdb.fn_add to 'dba'@'localhost'
</code></pre><h1 id="查看权限">查看权限</h1><p>六、查看 MySQL 用户权限</p>
<p>查看当前用户（自己）权限：</p>
<pre><code><span class="operator"><span class="keyword">show</span> <span class="keyword">grants</span>;</span>
</code></pre><p>查看其他 MySQL 用户权限：</p>
<pre><code><span class="operator"><span class="keyword">show</span> <span class="keyword">grants</span> <span class="keyword">for</span> dba@localhost;</span>
</code></pre><h1 id="撤销权限">撤销权限</h1><p>七、撤销已经赋予给 MySQL 用户权限的权限。</p>
<p>revoke 跟 grant 的语法差不多，只需要把关键字 “to” 换成 “from” 即可：</p>
<pre><code><span class="operator"><span class="keyword">grant</span>  <span class="keyword">all</span> <span class="keyword">on</span> *.* <span class="keyword">to</span>   dba@localhost;</span>
<span class="operator"><span class="keyword">revoke</span> <span class="keyword">all</span> <span class="keyword">on</span> *.* <span class="keyword">from</span> dba@localhost;</span>
</code></pre><h1 id="注意事项">注意事项</h1><p>八、MySQL grant、revoke 用户权限注意事项</p>
<p>grant, revoke 用户权限后，该用户只有重新连接 MySQL 数据库，权限才能生效。</p>
<p>如果想让授权的用户，也可以将这些权限 grant 给其他用户，需要选项 “grant option“</p>
<pre><code><span class="operator"><span class="keyword">grant</span> <span class="keyword">select</span> <span class="keyword">on</span> testdb.* <span class="keyword">to</span> dba@localhost <span class="keyword">with</span> <span class="keyword">grant</span> <span class="keyword">option</span>;</span>
</code></pre><p>这个特性一般用不到。实际中，数据库权限最好由 DBA 来统一管理。</p>
<hr>
<p>遇到 SELECT command denied to user ‘用户名’@’主机名’ for table ‘表名’ 这种错误，解决方法是需要把吧后面的表名授权，即是要你授权核心数据库也要。</p>
<p>我遇到的是SELECT command denied to user ‘my’@’%’ for table ‘proc’，是调用存储过程的时候出现，原以为只要把指定的数据库授权就行了，什么存储过程、函数等都不用再管了，谁知道也要把数据库mysql的proc表授权</p>
<hr>
<p>参考：<a href="http://zhidao.baidu.com/question/19633785.html" target="_blank" rel="external">http://zhidao.baidu.com/question/19633785.html</a></p>
<hr>
<p>mysql授权表共有5个表：user、db、host、tables_priv和columns_priv。</p>
<p>授权表的内容有如下用途：<br>user表<br>user表列出可以连接服务器的用户及其口令，并且它指定他们有哪种全局（超级用户）权限。在user表启用的任何权限均是全局权限，并适用于所有数据库。例如，如果你启用了DELETE权限，在这里列出的用户可以从任何表中删除记录，所以在你这样做之前要认真考虑。</p>
<p>db表<br>db表列出数据库，而用户有权限访问它们。在这里指定的权限适用于一个数据库中的所有表。</p>
<p>host表<br>host表与db表结合使用在一个较好层次上控制特定主机对数据库的访问权限，这可能比单独使用db好些。这个表不受GRANT和REVOKE语句的影响，所以，你可能发觉你根本不是用它。</p>
<p>tables_priv表<br>tables_priv表指定表级权限，在这里指定的一个权限适用于一个表的所有列。</p>
<p>columns_priv表<br>columns_priv表指定列级权限。这里指定的权限适用于一个表的特定列。</p>
<hr>
]]></content>
    <summary type="html">
    <![CDATA[<p>本文实例，运行于 MySQL 5.0 及以上版本。</p>
<p>MySQL 赋予用户权限命令的简单格式可概括为：</p>
<pre><code>grant 权限 <span class="function_start"><span class="keyword">on</span></span> 数据库对象 <span class="keyword">to</span> 用户
</code></pre>]]>
    
    </summary>
    
      <category term="mysql" scheme="http://linux48.com/tags/mysql/"/>
    
      <category term="database" scheme="http://linux48.com/categories/database/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[bitnami版gitlab修改端口]]></title>
    <link href="http://linux48.com//archives/426/"/>
    <id>http://linux48.com//archives/426/</id>
    <published>2015-06-03T08:40:42.000Z</published>
    <updated>2016-04-09T09:12:49.000Z</updated>
    <content type="html"><![CDATA[<p>bitnami版gitlab默认安装好web端口为80</p>
<p>为了便于开放到外部访问，需要把端口改为其他的，比如8080<br><a id="more"></a></p>
<h1 id="修改apache主配置文件">修改apache主配置文件</h1><pre><code>[root@iZ23m1d4vwiZ ~]# <span class="keyword">vim</span> /<span class="keyword">opt</span>/gitlab-<span class="number">6.8</span>.<span class="number">1</span>-<span class="number">0</span>/apache2/<span class="keyword">conf</span>/httpd.<span class="keyword">conf</span>

Listen <span class="number">8080</span>
</code></pre><h1 id="修改apache的bitnami的配置文件">修改apache的bitnami的配置文件</h1><pre><code>[root@iZ23m1d4vwiZ ~]<span class="comment"># vim /opt/gitlab-6.8.1-0/apache2/conf/bitnami/bitnami.conf</span>
<span class="comment"># Default Virtual Host configuration.</span>

<span class="variable">&lt;IfVersion &lt; 2.3 &gt;</span>
  NameVirtualHost *:<span class="number">8080</span>
  NameVirtualHost *:<span class="number">443</span>
<span class="variable">&lt;/IfVersion&gt;</span>

<span class="variable">&lt;VirtualHost _default_:8080&gt;</span>
  DocumentRoot <span class="string">"/opt/gitlab-6.8.1-0/apache2/htdocs"</span>
  <span class="variable">&lt;Directory "/opt/gitlab-6.8.1-0/apache2/htdocs"&gt;</span>
    Options Indexes FollowSymLinks
    AllowOverride All
    <span class="variable">&lt;IfVersion &lt; 2.3 &gt;</span>
      Order allow,deny
      Allow <span class="keyword">from</span> <span class="literal">all</span>
    <span class="variable">&lt;/IfVersion&gt;</span>
    <span class="variable">&lt;IfVersion &gt;</span>= <span class="number">2.3</span> &gt;
      Require <span class="literal">all</span> granted
    <span class="variable">&lt;/IfVersion&gt;</span>
  <span class="variable">&lt;/Directory&gt;</span>
</code></pre><h1 id="修改gitlab-shell的配置文件">修改gitlab-shell的配置文件</h1><pre><code>[root<span class="annotation">@iZ</span>23m1d4vwiZ ~]# vim <span class="regexp">/opt/</span>gitlab-<span class="number">6.8</span>.1-<span class="number">0</span><span class="regexp">/apps/</span>gitlab<span class="regexp">/gitlab-shell/</span>config.yml
# GitLab user. git by <span class="keyword">default</span>
<span class="string">user:</span> git

# Url to gitlab instance. Used <span class="keyword">for</span> api calls. Should end with a slash.
<span class="string">gitlab_url:</span> <span class="string">"http://120.26.103.123:8080/"</span>
</code></pre><h1 id="修改gitlab的apache主目录配置文件">修改gitlab的apache主目录配置文件</h1><pre><code>[root@iZ23m1d4vwiZ ~]<span class="array"># vim </span>/opt/gitlab-<span class="number">6.8</span>.1-<span class="number">0</span>/apps/gitlab/htdocs/config/gitlab.yml
<span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span>#
<span class="array"># GitLab application config file  </span>#
<span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span>#
#
<span class="array"># How to use</span>:
<span class="array"># </span><span class="number">1.</span> copy file as gitlab.yml
<span class="array"># </span><span class="number">2.</span> Replace gitlab -&gt; host with your domain
<span class="array"># </span><span class="number">3.</span> Replace gitlab -&gt; email_from

production: &amp;base
  #
  <span class="array"># </span><span class="number">1.</span> GitLab app settings
  <span class="array"># </span>==========================

  #<span class="array"># GitLab settings</span>
  gitlab:
    #<span class="array"># Web server settings </span>(note: host is the FQDN, do not include http:<span class="comment">//)</span>
    host: <span class="number">120.26</span>.103.123
    port: <span class="number">8080</span>
    https: false
</code></pre><h1 id="重启服务">重启服务</h1><pre><code>[root@iZ23m1d4vwiZ ~]# <span class="keyword">sh</span> /<span class="keyword">opt</span>/gitlab-<span class="number">6.8</span>.<span class="number">1</span>-<span class="number">0</span>/ctlscript.<span class="keyword">sh</span>  restart
</code></pre>]]></content>
    <summary type="html">
    <![CDATA[<p>bitnami版gitlab默认安装好web端口为80</p>
<p>为了便于开放到外部访问，需要把端口改为其他的，比如8080<br>]]>
    
    </summary>
    
      <category term="git" scheme="http://linux48.com/tags/git/"/>
    
      <category term="gitlab" scheme="http://linux48.com/tags/gitlab/"/>
    
      <category term="devops" scheme="http://linux48.com/categories/devops/"/>
    
  </entry>
  
</feed>