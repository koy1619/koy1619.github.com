<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title><![CDATA[linux48]]></title>
  
  <link href="/atom.xml" rel="self"/>
  <link href="http://linux48.com/"/>
  <updated>2015-10-08T08:57:42.000Z</updated>
  <id>http://linux48.com/</id>
  
  <author>
    <name><![CDATA[koy]]></name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title><![CDATA[mysql You cant specify target table]]></title>
    <link href="http://linux48.com//archives/437/"/>
    <id>http://linux48.com//archives/437/</id>
    <published>2015-10-07T16:00:00.000Z</published>
    <updated>2015-10-08T08:57:42.000Z</updated>
    <content type="html"><![CDATA[<p>今天在写SQL语句的时候遇到一个比较特殊的问题。<br>mysql 语句如下:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">UPDATE</span> </span><br><span class="line">  pms_project_product </span><br><span class="line"><span class="keyword">SET</span></span><br><span class="line">  area_list = </span><br><span class="line">  (<span class="keyword">SELECT</span> </span><br><span class="line">    area_list </span><br><span class="line">  <span class="keyword">FROM</span></span><br><span class="line">    pms_project_product </span><br><span class="line">  <span class="keyword">WHERE</span> activity_product_id = <span class="number">48468</span>),</span><br><span class="line">  area_list_name = </span><br><span class="line">  (<span class="keyword">SELECT</span> </span><br><span class="line">    area_list_name </span><br><span class="line">  <span class="keyword">FROM</span></span><br><span class="line">    pms_project_product </span><br><span class="line">  <span class="keyword">WHERE</span> activity_product_id = <span class="number">48468</span>) </span><br><span class="line"><span class="keyword">WHERE</span> activity_product_id = <span class="number">47098</span> ;</span></span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>运行时提出如下提示： <strong> You can’t specify target table ‘pms_project_product’ for update in FROM clause </strong></p>
<p>运行 set 里面的 select 语句:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">SELECT</span></span><br><span class="line">         area_list</span><br><span class="line">       <span class="keyword">FROM</span></span><br><span class="line">         pms_project_product</span><br><span class="line">       <span class="keyword">WHERE</span> activity_product_id = <span class="number">48468</span></span></span><br></pre></td></tr></table></figure>
<p>可以正确 select 正确结果。再把结果直接写到 <strong> SET area_list = </strong>里面，改后语句如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">UPDATE</span> </span><br><span class="line">  pms_project_product </span><br><span class="line"><span class="keyword">SET</span></span><br><span class="line">  area_list = (***),</span><br><span class="line">  area_list_name = (***) </span><br><span class="line"><span class="keyword">WHERE</span> activity_product_id = <span class="number">47098</span></span></span><br></pre></td></tr></table></figure>
<p>再运行可以正确执行更新。</p>
<p>原因是：mysql中不能这么用。 （等待mysql升级吧）。那串英文错误提示就是说，不能先select出同一表中的某些值，</p>
<p>再update这个表(在同一语句中)。 于是我打算改用临时表的方案。</p>
<p>改写后的 sql 如下所示，大家仔细区别一下。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">UPDATE</span> </span><br><span class="line">  pms_project_product </span><br><span class="line"><span class="keyword">SET</span></span><br><span class="line">  area_list = </span><br><span class="line">  (<span class="keyword">SELECT</span> </span><br><span class="line">    tmp1.area_list </span><br><span class="line">  <span class="keyword">FROM</span></span><br><span class="line">    (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> pms_project_product) tmp1</span><br><span class="line">  <span class="keyword">WHERE</span> tmp1.activity_product_id = <span class="number">48468</span>),</span><br><span class="line">  area_list_name = </span><br><span class="line">  (<span class="keyword">SELECT</span> </span><br><span class="line">    tmp2.area_list_name </span><br><span class="line">  <span class="keyword">FROM</span></span><br><span class="line">    (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> pms_project_product) tmp2 </span><br><span class="line">  <span class="keyword">WHERE</span> tmp2.activity_product_id = <span class="number">48468</span>) </span><br><span class="line"><span class="keyword">WHERE</span> activity_product_id = <span class="number">47098</span></span></span><br></pre></td></tr></table></figure>
<p>也就是说将select出的结果再通过临时表在select一遍，这样就规避了错误。注意，这个问题只出现于mysql，mssql和oracle不会出现此问题。</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>今天在写SQL语句的时候遇到一个比较特殊的问题。<br>mysql 语句如下:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">UPDATE</span> </span><br><span class="line">  pms_project_product </span><br><span class="line"><span class="keyword">SET</span></span><br><span class="line">  area_list = </span><br><span class="line">  (<span class="keyword">SELECT</span> </span><br><span class="line">    area_list </span><br><span class="line">  <span class="keyword">FROM</span></span><br><span class="line">    pms_project_product </span><br><span class="line">  <span class="keyword">WHERE</span> activity_product_id = <span class="number">48468</span>),</span><br><span class="line">  area_list_name = </span><br><span class="line">  (<span class="keyword">SELECT</span> </span><br><span class="line">    area_list_name </span><br><span class="line">  <span class="keyword">FROM</span></span><br><span class="line">    pms_project_product </span><br><span class="line">  <span class="keyword">WHERE</span> activity_product_id = <span class="number">48468</span>) </span><br><span class="line"><span class="keyword">WHERE</span> activity_product_id = <span class="number">47098</span> ;</span></span><br></pre></td></tr></table></figure>]]>
    
    </summary>
    
      <category term="mysql" scheme="http://linux48.com/tags/mysql/"/>
    
      <category term="database" scheme="http://linux48.com/categories/database/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[阵列Cache写机制：Write-through与Write-back]]></title>
    <link href="http://linux48.com//archives/436/"/>
    <id>http://linux48.com//archives/436/</id>
    <published>2015-08-26T16:00:00.000Z</published>
    <updated>2015-08-27T03:47:51.000Z</updated>
    <content type="html"><![CDATA[<blockquote class="blockquote-center">Write Through和Write Back是阵列卡Cache的两种使用方式，也称为透写和回写。当选用write through方式时，系统的写磁盘操作并不利用阵列卡的Cache，而是直接与磁盘进行数据的交互。而write Back方式则利用阵列Cache作为系统与磁盘间的二传手，系统先将数据交给Cache，然后再由Cache将数据传给磁盘。</blockquote>

<a id="more"></a>
<p>最近在部署马来西亚DBServer的时候发现DB1的硬盘写入速度比DB2要慢好多</p>
<p><img src="http://r.loli.io/VnUZ7n.png" alt=""></p>
<p><img src="http://r.loli.io/Yj6Zbm.png" alt=""></p>
<p>两台服务器在导入数据的过程中对硬盘测速结果如下</p>
<p><img src="http://r.loli.io/vYj2ye.png" alt=""></p>
<p><img src="http://r.loli.io/BniYFf.png" alt=""></p>
<p>机房给出的解释也是一切正常</p>
<p>后来老大帮忙推荐MegaCli工具去排查问题所在</p>
<p>发现DB1的Cache写机制为Write-through而DB2为Write-back</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@DBServer1 MegaCli]<span class="comment"># ./MegaCli64 -Ldinfo -lall -aall</span></span><br><span class="line">                                     </span><br><span class="line"></span><br><span class="line">Adapter <span class="number">0</span> -- Virtual Drive Information:</span><br><span class="line">Virtual Drive: <span class="number">0</span> (Target Id: <span class="number">0</span>)</span><br><span class="line">Name                :</span><br><span class="line">RAID Level          : Primary-<span class="number">5</span>, Secondary-<span class="number">0</span>, RAID Level Qualifier-<span class="number">3</span></span><br><span class="line">Size                : <span class="number">557.75</span> GB</span><br><span class="line">Sector Size         : <span class="number">512</span></span><br><span class="line">Parity Size         : <span class="number">278.875</span> GB</span><br><span class="line">State               : Optimal</span><br><span class="line">Strip Size          : <span class="number">64</span> KB</span><br><span class="line">Number Of Drives    : <span class="number">3</span></span><br><span class="line">Span Depth          : <span class="number">1</span></span><br><span class="line">Default Cache Policy: WriteThrough, ReadAheadNone, Direct, No Write Cache <span class="keyword">if</span> Bad BBU</span><br><span class="line">Current Cache Policy: WriteThrough, ReadAheadNone, Direct, No Write Cache <span class="keyword">if</span> Bad BBU</span><br><span class="line">Default Access Policy: Read/Write</span><br><span class="line">Current Access Policy: Read/Write</span><br><span class="line">Disk Cache Policy   : Disk<span class="string">'s Default</span><br><span class="line">Encryption Type     : None</span><br><span class="line">Is VD Cached: No</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exit Code: 0x00</span><br><span class="line">[root@DBServer1 MegaCli]#</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@DBServer2 MegaCli]<span class="comment"># ./MegaCli64 -Ldinfo -lall -aall</span></span><br><span class="line">                                     </span><br><span class="line"></span><br><span class="line">Adapter <span class="number">0</span> -- Virtual Drive Information:</span><br><span class="line">Virtual Drive: <span class="number">0</span> (Target Id: <span class="number">0</span>)</span><br><span class="line">Name                :</span><br><span class="line">RAID Level          : Primary-<span class="number">5</span>, Secondary-<span class="number">0</span>, RAID Level Qualifier-<span class="number">3</span></span><br><span class="line">Size                : <span class="number">557.75</span> GB</span><br><span class="line">Sector Size         : <span class="number">512</span></span><br><span class="line">Parity Size         : <span class="number">278.875</span> GB</span><br><span class="line">State               : Optimal</span><br><span class="line">Strip Size          : <span class="number">64</span> KB</span><br><span class="line">Number Of Drives    : <span class="number">3</span></span><br><span class="line">Span Depth          : <span class="number">1</span></span><br><span class="line">Default Cache Policy: WriteBack, ReadAheadNone, Direct, No Write Cache <span class="keyword">if</span> Bad BBU</span><br><span class="line">Current Cache Policy: WriteBack, ReadAheadNone, Direct, No Write Cache <span class="keyword">if</span> Bad BBU</span><br><span class="line">Default Access Policy: Read/Write</span><br><span class="line">Current Access Policy: Read/Write</span><br><span class="line">Disk Cache Policy   : Disk<span class="string">'s Default</span><br><span class="line">Encryption Type     : None</span><br><span class="line">Is VD Cached: No</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exit Code: 0x00</span><br><span class="line">[root@DBServer2 MegaCli]#</span></span><br></pre></td></tr></table></figure>
<p><strong>以下为搜到的科普内容</strong></p>
<p>Cache写机制</p>
<p>参考 <a href="http://en.wikipedia.org/wiki/Cache#Writing_Policies" target="_blank" rel="external">http://en.wikipedia.org/wiki/Cache#Writing_Policies</a> 上的说明，<strong>Cache</strong>写机制分为<strong>write through</strong>和<strong>write back</strong>两种。</p>
<blockquote>
<ul>
<li><strong>Write-through</strong> Write is done synchronously both to the cache and to the backing store.</li>
<li><strong>Write-back</strong> (or Write-behind) – Writing is done only to the cache. A modified cache block is written back to the store, just before it is replaced.</li>
</ul>
</blockquote>
<p><strong>Write-through</strong>（直写模式）在数据更新时，同时写入缓存Cache和后端存储。此模式的优点是操作简单；缺点是因为数据修改需要同时写入存储，数据写入速度较慢。</p>
<p><strong>Write-back</strong>（回写模式）在数据更新时只写入缓存Cache。只在数据被替换出缓存时，被修改的缓存数据才会被写到后端存储。此模式的优点是数据写入速度快，因为不需要写存储；缺点是一旦更新后的数据未被写入存储时出现系统掉电的情况，数据将无法找回。</p>
<p><strong>Write-misses写缺失的处理方式</strong></p>
<p>对于写操作，存在写入缓存缺失数据的情况，这时有两种处理方式：</p>
<blockquote>
<ul>
<li><strong>Write allocate</strong> (aka Fetch on write) – Datum at the missed-write location is loaded to cache, followed by a write-hit operation. In this approach, write misses are similar to read-misses.</li>
<li><strong>No-write allocate</strong> (aka Write-no-allocate, Write around) – Datum at the missed-write location is not loaded to cache, and is written directly to the backing store. In this approach, actually only system reads are being cached.</li>
</ul>
</blockquote>
<p><strong>Write allocate</strong>方式将写入位置读入缓存，然后采用write-hit（缓存命中写入）操作。写缺失操作与读缺失操作类似。</p>
<p><strong>No-write allocate</strong>方式并不将写入位置读入缓存，而是直接将数据写入存储。这种方式下，只有读操作会被缓存。</p>
<p>无论是Write-through还是Write-back都可以使用写缺失的两种方式之一。只是通常Write-back采用Write allocate方式，而Write-through采用No-write allocate方式；因为多次写入同一缓存时，Write allocate配合Write-back可以提升性能；而对于Write-through则没有帮助。</p>
<p><strong>处理流程图</strong></p>
<p>Write-through模式处理流程：</p>
<p><img src="http://r.loli.io/y67vYf.png" alt=""></p>
<p>Write-back模式处理流程：</p>
<p><img src="http://r.loli.io/2mU3Yb.png" alt=""></p>
<p>在创建raid阵列可选择Write Policy的策略</p>
<p><img src="http://r.loli.io/BZRNRf.jpg" alt=""></p>
<p>在了解了原理之后可以通过<strong>MegaCli</strong>来设置DB1的<strong>Write Policy</strong>为<strong>WriteBack</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@DBServer1 MegaCli]<span class="comment"># ./MegaCli64 -LDSetProp WB -LAll -aAll</span></span><br><span class="line">                                     </span><br><span class="line">Set Write Policy to WriteBack on Adapter <span class="number">0</span>, VD <span class="number">0</span> (target id: <span class="number">0</span>) success</span><br><span class="line"></span><br><span class="line">Exit Code: <span class="number">0</span>x00</span><br><span class="line">[root@DBServer1 MegaCli]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p>此时在查看DB1的<strong>Write Policy</strong>已经成功设置为<strong>WriteBack</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@DBServer1 MegaCli]<span class="comment"># ./MegaCli64 -Ldinfo -lall -aall</span></span><br><span class="line">                                     </span><br><span class="line"></span><br><span class="line">Adapter <span class="number">0</span> -- Virtual Drive Information:</span><br><span class="line">Virtual Drive: <span class="number">0</span> (Target Id: <span class="number">0</span>)</span><br><span class="line">Name                :</span><br><span class="line">RAID Level          : Primary-<span class="number">5</span>, Secondary-<span class="number">0</span>, RAID Level Qualifier-<span class="number">3</span></span><br><span class="line">Size                : <span class="number">557.75</span> GB</span><br><span class="line">Sector Size         : <span class="number">512</span></span><br><span class="line">Parity Size         : <span class="number">278.875</span> GB</span><br><span class="line">State               : Optimal</span><br><span class="line">Strip Size          : <span class="number">64</span> KB</span><br><span class="line">Number Of Drives    : <span class="number">3</span></span><br><span class="line">Span Depth          : <span class="number">1</span></span><br><span class="line">Default Cache Policy: WriteBack, ReadAheadNone, Direct, No Write Cache <span class="keyword">if</span> Bad BBU</span><br><span class="line">Current Cache Policy: WriteBack, ReadAheadNone, Direct, No Write Cache <span class="keyword">if</span> Bad BBU</span><br><span class="line">Default Access Policy: Read/Write</span><br><span class="line">Current Access Policy: Read/Write</span><br><span class="line">Disk Cache Policy   : Disk<span class="string">'s Default</span><br><span class="line">Encryption Type     : None</span><br><span class="line">Is VD Cached: No</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exit Code: 0x00</span><br><span class="line">[root@DBServer1 MegaCli]#</span></span><br></pre></td></tr></table></figure>
<p>然后在测试DB1的写入速度，看以看到正常了<br><img src="http://r.loli.io/2uYfMf.png" alt=""></p>
<p>下一篇文章会着重记录一下<strong>MegaCli</strong>工具的安装与使用</p>
<hr>
<p>继续科普记录一下</p>
<p>Write Through和Write Back是阵列卡Cache的两种使用方式，也称为透写和回写。当选用write through方式时，系统的写磁盘操作并不利用阵列卡的Cache，而是直接与磁盘进行数据的交互。而write Back方式则利用阵列Cache作为系统与磁盘间的二传手，系统先将数据交给Cache，然后再由Cache将数据传给磁盘。 在配置阵列的时候，如果不是很清楚的话，默认就可以了，系统会根据磁盘类型进行默认设置。</p>
<p>生产环境中的配置要根据具体的业务类型及环境进行配置，比如：如果有外置UPS电源，选Write Back，如果没有外置电源，并且对数据安全性要求很高，不要求太高性能，就选Write Through。Write caching 或 write-through write-through意思是写操作根本不使用缓存。数据总是直接写入磁盘。关闭写缓存，可释放缓存用于读操作。（缓存被读写操作共用） Write caching可以提高写操作的性能。数据不是直接被写入磁盘；而是写入缓存。从应用程序的角度看，比等待完成磁盘写入操作要快的多。因此，可以提高写性能。由控制器将缓存内未写入磁盘的数据写入磁盘。表面上看，Write cache方式比write-through方式的读、写性能都要好，但是也要看磁盘访问方式和磁盘负荷了。 write-back（write cache）方式通常在磁盘负荷较轻时速度更快。负荷重时，每当数据被写入缓存后，就要马上再写入磁盘以释放缓存来保存将要写入的新数据，这时如果数据直接写入磁盘，控制器会以更快的速度运行。因此，负荷重时，将数据先写入缓存反而会降低吞吐量。 Starting and stopping cache flushing levels 这两个设置影响控制器如何处理未写入磁盘的缓存内数据，并且只在write-back cache方式下生效。缓存内数据写入磁盘称为flushing.你可以配置Starting and stopping cache flushing levels值，这个值表示占用整个缓存大小的百分比。当缓存内未写入磁盘的数据达到starting flushing value时，控制器开始flushing（由缓存写入磁盘）。当缓存内未写入磁盘数据量低于stop flush value时，flushing过程停止。控制器总是先flush旧的缓存数据。缓存内未写入数据停留超过20秒钟后被自动flushing. 典型的start flushing level是80%。通常情况下，stop flushing level也设置为80%。也就是说，控制器不允许超过80%的缓存用于write-back cache,但还是尽可能保持这一比例。如果你使用此设置，可以在缓存内存更多的未写入数据。这有利于提高写操作的性能，但是要牺牲数据保护。如果要得到数据保护，你可以使用较低的start and stop values。通过对这两个参数的设置，你可以调整缓存的读、写性能。经测试表明，使用接近的start and stop flushing levels时性能较好。如果stop level value远远低于start value，在flushing时会导致磁盘拥塞。 Cache block size 这个值指缓存分配单元大小，可以是4K或16K。选择合适的值，可以明显的改善缓存使用性能。 如果应用程序更多时候访问小于8K的数据，而将cache block size设置为16K，每次访问仅使用一部分cache block。在16K的cache block里总是存储8K或更小的数据，意味着只有50%的缓存容量被有效使用，使性能下降。对于随机I/O和小数据块的传送，4K比较合适。另一方面，如果是连续I/O 并使用大的segment size，最好选择16K。大的cache block size意味着cache block数量少并可缩短缓存消耗延时。另外，对于同样大小的数据，cache block size大一些，需要的缓存数据传送量更小。</p>
<p>其他相关说明：</p>
<p>保护内存里的数据</p>
<p>备援电池的功能是确保万一当主电源故障或突然断电时内存里的数据不流失，因此如何确保备援电池的正常运行就显得格外重要。备援电池在2种情况下，系统视为无法正常运行以保护内存里的数据。一是坏掉的时候，背板的LED灯将亮起红灯。一是电池充电的时候，背板的LED灯将亮起黄灯。备援电池的使用寿命是根据充电的次数及电力释放的周期而变化的，这取决于用户本身对盘阵的使用情况，一般而言我们建议最好在盘阵使用了12个月之后更换备援电池模块（BBU）。备援电池在正常情况下充满电的时候是3.5V，当其电力降至2.7V的时候将自动进入充电状态，此时系统因为保护内存数据不流失的电力消失，自动地将数据的写入切换成“Write-Through”模式；当充完电后，又自动切换回“Write-Back”模式。这个动作是在事件启动装置（Event Trigger）功能来执行的，在安装管理软件的时候，事件启动装置对备援电池的管理初始值是打开的（Enable）。如果你没有更改过初始设置，那么上述的动作就会正常的运行。如果备援电池已经坏掉，不能正常保护内存里的数据时，而事件启动装置对备援电池的管理是设定在关闭的状态下，我们建议你手动将数据写入模式更改为“Write-Through”模式，以免数据写入没有电力保护的内存中而主电源故障或突然断电时，这些正在写入的数据就遗失了。</p>
<p>减少延迟 当关闭内存“Write-Back”功能时就进入了“Write-Through”的模式，这时候主机数据是不会写入内存而直接写入硬盘的。在“Write-Through”模式下，所有的硬盘将与其相关的主机以适当的方式存取数据块，而大多数的时候硬盘处于接受写命令的状态。此时盘阵只要从主机接收到写入的命令，硬盘的读写头就会去寻找读写的位置，并等待硬盘处于可写入的状态，这个等待的现象就是所谓的延迟（Latency Time)，而硬盘经常处于等待写入的状态，增加了延迟的时间，不但缩短硬盘的使用寿命，并且系统也比较耗电。当打开内存的“Write-Back”功能时，从主机写入硬盘的数据先被写在内存里，在内存写满数据时盘阵控制器会将存在于内存的数据大量地写入硬盘。这个内存“Write-Back”的模式将主机写入的命令以写入内存来取代，可以大幅减少硬盘延迟的时间，并且相较于“Write-Through”模式，在大多数的时候提供更佳的写入政策。</p>
]]></content>
    <summary type="html">
    <![CDATA[<blockquote class="blockquote-center">Write Through和Write Back是阵列卡Cache的两种使用方式，也称为透写和回写。当选用write through方式时，系统的写磁盘操作并不利用阵列卡的Cache，而是直接与磁盘进行数据的交互。而write Back方式则利用阵列Cache作为系统与磁盘间的二传手，系统先将数据交给Cache，然后再由Cache将数据传给磁盘。</blockquote>]]>
    
    </summary>
    
      <category term="RAID" scheme="http://linux48.com/tags/RAID/"/>
    
      <category term="cache" scheme="http://linux48.com/tags/cache/"/>
    
      <category term="阵列卡" scheme="http://linux48.com/tags/%E9%98%B5%E5%88%97%E5%8D%A1/"/>
    
      <category term="windows" scheme="http://linux48.com/categories/windows/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Repair Cisco vpnclient on windows10]]></title>
    <link href="http://linux48.com//archives/435/"/>
    <id>http://linux48.com//archives/435/</id>
    <published>2015-08-02T16:00:00.000Z</published>
    <updated>2015-08-07T07:39:16.000Z</updated>
    <content type="html"><![CDATA[<p>由于此问题是windows10刚发布，但是cisco单方面并没有及时修复，并且就目前看来是全球的工程师都碰到的一个很紧急棘手的问题</p>
<p>在查找修复方案的时候;得到好多歪果仁的帮助，特地写了一片洋文，希望可以帮到更多的人，蹩脚的E文如有问题请留言或者邮件我及时勘误，不甚感激！</p>
<p>Microsoft released last week by the windows10, after the upgrade <code>vpnclient-winx64-msi-5.0.07.0440-k9.exe</code> found this installation as wrong.</p>
<p><img src="http://r.loli.io/eAVbii.png" alt=""></p>
<p>First we first fix, so that vpnclient-winx64-msi-5.0.07.0440-k9.exe is properly installed</p>
<a id="more"></a>
<hr>
<h1 id="Fix_Install_Error">Fix Install Error</h1><p>Download the 2 software <strong><code>winfix.exe</code></strong> and <strong><code>dneupdate64.msi</code></strong></p>
<p>first install <strong><code>winfix.exe</code></strong> </p>
<p>and then install <strong><code>dneupdate64.msi</code></strong></p>
<p>and finally extract the <strong><code>vpnclient-winx64-msi-5.0.07.0440-k9.exe</code></strong>, and execute the installation file <strong><code>vpnclient_setup.exe</code></strong></p>
<p>Now Cisco VPN clients has been successfully installed on windows10 ！</p>
<hr>
<h1 id="Fix_Dialing_Error">Fix Dialing Error</h1><p>But, the back of the account password when I dial the wrong</p>
<p><code>Secure VPN Connection terminated locally by the Client.</code><br><code>Reason 433: Reason not specified by peer.</code></p>
<p>Continue to search for information to fix this funking problem ！！！</p>
<p>The likely reason was apparently due to the DNE LightWeight Filter network client not being properly installed by the Cisco Systems VPN installer.</p>
<p>To solve this, please try to do the following in the exact order:</p>
<p>A) First, uninstall any Cisco VPN Client software you may have installed earlier;</p>
<p>B) Then uninstall any DNE updater software(s) you may have installed earlier;</p>
<p>C) Reboot your computer.</p>
<p>D) Run winfix.exe, to ensure the DNE is properly cleaned up. </p>
<p>E) Reboot your computer again.</p>
<p>F) Download Sonic VPN software from here: 32-bit here or 64-bit here.</p>
<p>G) Install the Sonic VPN software (which was able to install the right version of the DNE);</p>
<p>H) Reboot your computer.</p>
<p>I) Reinstall the Cisco VPN Client software again. (You do not need to uninstall the Sonic VPN software from step G). If you face a version check issue, run the msi file instead of the exe file</p>
<p>J) Reboot your computer.</p>
<p>K) Your Cisco VPN Client should now work in Windows 10!</p>
<p>Finally we dial again, what the funking！！ reporting error again ！！</p>
<p><code>vpn 422 failed to enable virtual adapter</code></p>
<hr>
<h1 id="Finally_Fix_this_problem">Finally Fix this problem</h1><p>Enter the registry regedit</p>
<p><code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\CVirtA</code> find <code>DisplayName</code>  key  </p>
<p>Value of X86 system change <strong><code>@oem16.inf,%CVirtA_Desc%;Cisco Systems VPN Adapter</code></strong> to <strong><code>Cisco Systems VPN Adapter</code></strong></p>
<p>Value of 64 system change <strong><code>@oem16.inf,%CVirtA_Desc%;Cisco Systems VPN Adapter for 64-bit Windows</code></strong> to <strong><code>Cisco Systems VPN Adapter for 64-bit Windows</code></strong></p>
<p>And then landed on the dial, success!!<br>Now the problem of the egg pain is completely solved!!!</p>
<hr>
<p>bove software download address</p>
<p>for 64bit<br><a href="ftp://files.citrix.com/winfix.exe" target="_blank" rel="external">ftp://files.citrix.com/winfix.exe</a><br><a href="ftp://files.citrix.com/dneupdate64.msi" target="_blank" rel="external">ftp://files.citrix.com/dneupdate64.msi</a><br><a href="http://www.gleescape.com/wp-content/uploads/2014/09/sonic64.zip" target="_blank" rel="external">http://www.gleescape.com/wp-content/uploads/2014/09/sonic64.zip</a></p>
<p>for 32bit<br><a href="ftp://files.citrix.com/winfix.exe" target="_blank" rel="external">ftp://files.citrix.com/winfix.exe</a><br><a href="ftp://ftpsupport.citrix.com/dneupdate.msi" target="_blank" rel="external">ftp://ftpsupport.citrix.com/dneupdate.msi</a><br><a href="http://www.gleescape.com/wp-content/uploads/2014/09/sonic32.zip" target="_blank" rel="external">http://www.gleescape.com/wp-content/uploads/2014/09/sonic32.zip</a></p>
<p>Chinese users may download speed will be very slow, I deliberately uploaded to Baidu cloud</p>
<p><a href="http://pan.baidu.com/s/1o6vcMz4" target="_blank" rel="external">http://pan.baidu.com/s/1o6vcMz4</a></p>
<p>Reference website:<br><a href="http://www.itsystemadmin.com/error-27850-unable-to-manage-networking-component/" target="_blank" rel="external">http://www.itsystemadmin.com/error-27850-unable-to-manage-networking-component/</a><br><a href="http://www.gleescape.com/posts/2917" target="_blank" rel="external">http://www.gleescape.com/posts/2917</a><br><a href="http://blog.itpub.net/9697/viewspace-1437036/" target="_blank" rel="external">http://blog.itpub.net/9697/viewspace-1437036/</a></p>
<p>Thanks them very much!!!</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>由于此问题是windows10刚发布，但是cisco单方面并没有及时修复，并且就目前看来是全球的工程师都碰到的一个很紧急棘手的问题</p>
<p>在查找修复方案的时候;得到好多歪果仁的帮助，特地写了一片洋文，希望可以帮到更多的人，蹩脚的E文如有问题请留言或者邮件我及时勘误，不甚感激！</p>
<p>Microsoft released last week by the windows10, after the upgrade <code>vpnclient-winx64-msi-5.0.07.0440-k9.exe</code> found this installation as wrong.</p>
<p><img src="http://r.loli.io/eAVbii.png" alt=""></p>
<p>First we first fix, so that vpnclient-winx64-msi-5.0.07.0440-k9.exe is properly installed</p>]]>
    
    </summary>
    
      <category term="cisco" scheme="http://linux48.com/tags/cisco/"/>
    
      <category term="vpn" scheme="http://linux48.com/tags/vpn/"/>
    
      <category term="windows10" scheme="http://linux48.com/tags/windows10/"/>
    
      <category term="windows" scheme="http://linux48.com/categories/windows/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[MYSQL在一个字段值前面加字符串]]></title>
    <link href="http://linux48.com//archives/434/"/>
    <id>http://linux48.com//archives/434/</id>
    <published>2015-07-29T16:00:00.000Z</published>
    <updated>2015-07-30T08:12:27.000Z</updated>
    <content type="html"><![CDATA[<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--在`menber`表的`name`字段前面按照条件批量加`jc100`这个字符串</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">UPDATE</span> </span><br><span class="line">    <span class="string">`usrdb`</span>.<span class="string">`menber`</span></span><br><span class="line">  <span class="keyword">SET</span></span><br><span class="line">    <span class="string">`name`</span> = <span class="keyword">CONCAT</span>(<span class="string">'jc100'</span>, <span class="string">`name`</span>) </span><br><span class="line">  <span class="keyword">WHERE</span> provice = <span class="string">'678'</span> </span><br><span class="line">    <span class="keyword">AND</span> input_time <span class="keyword">BETWEEN</span> <span class="string">'2015-07-30 00:00:00'</span> </span><br><span class="line">    <span class="keyword">AND</span> <span class="string">'2015-07-30 23:59:59'</span></span></span><br></pre></td></tr></table></figure>
<p>mysql的<strong><code>CONCAT()</code></strong>函数用于将多个字符串连接成一个字符串，是最重要的mysql函数之一。</p>
<a id="more"></a>
<p>如果要在字段后面添加字符串则是这样写</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">UPDATE</span></span><br><span class="line">    <span class="string">`usrdb`</span>.<span class="string">`menber`</span></span><br><span class="line">  <span class="keyword">SET</span></span><br><span class="line">    <span class="string">`name`</span> = <span class="keyword">CONCAT</span>(<span class="string">'name'</span>, <span class="string">`jc100`</span>)</span><br><span class="line">  <span class="keyword">WHERE</span> provice = <span class="string">'678'</span></span><br><span class="line">    <span class="keyword">AND</span> input_time <span class="keyword">BETWEEN</span> <span class="string">'2015-07-30 00:00:00'</span></span><br><span class="line">    <span class="keyword">AND</span> <span class="string">'2015-07-30 23:59:59'</span></span></span><br></pre></td></tr></table></figure>
]]></content>
    <summary type="html">
    <![CDATA[<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--在`menber`表的`name`字段前面按照条件批量加`jc100`这个字符串</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">UPDATE</span> </span><br><span class="line">    <span class="string">`usrdb`</span>.<span class="string">`menber`</span></span><br><span class="line">  <span class="keyword">SET</span></span><br><span class="line">    <span class="string">`name`</span> = <span class="keyword">CONCAT</span>(<span class="string">'jc100'</span>, <span class="string">`name`</span>) </span><br><span class="line">  <span class="keyword">WHERE</span> provice = <span class="string">'678'</span> </span><br><span class="line">    <span class="keyword">AND</span> input_time <span class="keyword">BETWEEN</span> <span class="string">'2015-07-30 00:00:00'</span> </span><br><span class="line">    <span class="keyword">AND</span> <span class="string">'2015-07-30 23:59:59'</span></span></span><br></pre></td></tr></table></figure>
<p>mysql的<strong><code>CONCAT()</code></strong>函数用于将多个字符串连接成一个字符串，是最重要的mysql函数之一。</p>]]>
    
    </summary>
    
      <category term="sql语句" scheme="http://linux48.com/tags/sql%E8%AF%AD%E5%8F%A5/"/>
    
      <category term="database" scheme="http://linux48.com/categories/database/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[mysql双主主键冲突排查修复]]></title>
    <link href="http://linux48.com//archives/433/"/>
    <id>http://linux48.com//archives/433/</id>
    <published>2015-07-21T16:00:00.000Z</published>
    <updated>2015-09-25T07:21:59.000Z</updated>
    <content type="html"><![CDATA[<h1 id="背景">背景</h1><p>线上A和B互为主主，A为业务写库，B为读库</p>
<p>19号下午收到短信报警A的slave delay，果断VPN上去数据库查看到</p>
<pre><code>Last_SQL_Error: Error <span class="string">'Duplicate entry '</span><span class="number">4960446</span><span class="string">' for key '</span>transaction_id<span class="string">''</span> <span class="keyword">on</span> query. <span class="keyword">Default</span> database
</code></pre><p>又是熟悉的主键冲突，但是这个时候不能让业务出现任何问题，就果断在A</p>
<a id="more"></a>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; STOP SLAVE;</span><br><span class="line">mysql&gt; SET GLOBAL sql_slave_skip_counter = <span class="number">1</span>;</span><br><span class="line">mysql&gt; START SLAVE;</span><br></pre></td></tr></table></figure>
<p>经过2次重复的上述操作，同步OK了，然后根据这两条报错的主键ID在两台数据库查询发现都不一样，<br>此时我清楚的知道已经有2条数据差异了，如果不及时处理早晚有一天被掩盖的问题会再次爆发出来。</p>
<p>后来经过一些列的排查之后知道问题所在了</p>
<p>因为7月2号晚上在B<code>alter</code>表的时候，导致B锁表，而A还在写入，并且正好在更新服务，导致数据的差异</p>
<p>查<code>general log</code>得知7月19号人为的在B上插入了两条<code>transaction_id=&quot;4960446&quot;</code>和<code>transaction_id=&quot;4960426&quot;</code>的记录和A的id冲突，导致A同步挂掉</p>
<p>因为A为业务写库，所以现在需要把A上这两条正确的数据插入到B，并在B上面删除错误的。</p>
<p>由于这个是自增的主键，所以还不好操作，下面大概就测试环境详细说明一下复现方案以及解决办法。</p>
<hr>
<h1 id="复现方案">复现方案</h1><blockquote>
<ul>
<li>192.168.1.52  模拟线上A 负责写入</li>
<li>192.168.1.42  模拟线上B 负责读取</li>
</ul>
</blockquote>
<h2 id="设置my-cnf，差开自增ID">设置my.cnf，差开自增ID</h2><p>52配置</p>
<pre><code><span class="keyword">auto</span>-increment-increment=<span class="number">10</span>
<span class="keyword">auto</span>-increment-offset=<span class="number">8</span>
</code></pre><p>42配置</p>
<pre><code><span class="keyword">auto</span>-increment-increment=<span class="number">10</span>
<span class="keyword">auto</span>-increment-offset=<span class="number">6</span>
</code></pre><h2 id="创建测试表">创建测试表</h2><p>随便在其中一台的test库中创建测试表，双主自动同步到另一台</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">use</span> test;</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`test`</span> (</span><br><span class="line">  <span class="string">`qrpay_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT COMMENT <span class="string">'主键'</span>,</span><br><span class="line">  <span class="string">`transaction_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (<span class="string">`qrpay_id`</span>),</span><br><span class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`transaction_id`</span> (<span class="string">`transaction_id`</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">896</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span></span><br></pre></td></tr></table></figure>
<h2 id="插入测试数据">插入测试数据</h2><p>在52插入测试数据，可以发现”qrpay_id”的值是依照 auto-increment-offset 格式的, 同步过去也是如此</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO `<span class="built_in">test</span>` VALUES (<span class="string">'null'</span>,<span class="string">'1'</span>);</span><br><span class="line">INSERT INTO `<span class="built_in">test</span>` VALUES (<span class="string">'null'</span>,<span class="string">'2'</span>);</span><br><span class="line">INSERT INTO `<span class="built_in">test</span>` VALUES (<span class="string">'null'</span>,<span class="string">'3'</span>);</span><br></pre></td></tr></table></figure>
<p>   在42插入测试数据，可以发现”qrpay_id”的值是依照 auto-increment-offset 格式的, 同步过去也是如此</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO `<span class="built_in">test</span>` VALUES (<span class="string">'null'</span>,<span class="string">'4'</span>);</span><br><span class="line">INSERT INTO `<span class="built_in">test</span>` VALUES (<span class="string">'null'</span>,<span class="string">'5'</span>);</span><br><span class="line">INSERT INTO `<span class="built_in">test</span>` VALUES (<span class="string">'null'</span>,<span class="string">'6'</span>);</span><br></pre></td></tr></table></figure>
<h2 id="模拟同步异常">模拟同步异常</h2><p>停掉42的同步</p>
<pre><code>slave <span class="operator"><span class="keyword">stop</span>;</span>
</code></pre><p>并在52上插入数据</p>
<pre><code><span class="operator"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span> <span class="keyword">VALUES</span> (<span class="string">'null'</span>,<span class="string">'7'</span>);</span>
</code></pre><p>在42上插入数据</p>
<pre><code><span class="operator"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span> <span class="keyword">VALUES</span> (<span class="string">'null'</span>,<span class="string">'7'</span>);</span>
</code></pre><p>开启42的同步</p>
<pre><code>slave <span class="operator"><span class="keyword">start</span>;</span>
</code></pre><p>在两边都show slave status \G; 可以发现都提示</p>
<pre><code>Error <span class="string">'Duplicate entry '</span><span class="number">7</span><span class="string">' for key '</span>transaction_id<span class="string">''</span> on query. Default <span class="string">database:</span> <span class="string">'test'</span>. <span class="string">Query:</span> <span class="string">'INSERT INTO `test` VALUES ('</span><span class="literal">null</span><span class="string">','</span><span class="number">7</span><span class="string">')'</span>
</code></pre><p>因为停掉了42的同步，所以插入到52的数据不会同步到42，并且也在42上面插入了相同值的transaction_id，同步到52的时候就导致了主键重复，最后开启42的同步，双方都互相冲突</p>
<p>这个时候两边主从都是挂掉的，然后两边都跳过这个错误</p>
<pre><code><span class="operator"><span class="keyword">stop</span> <span class="keyword">slave</span>;</span>
<span class="operator"><span class="keyword">set</span> <span class="keyword">global</span> sql_slave_skip_counter=<span class="number">1</span>;</span>
slave <span class="operator"><span class="keyword">start</span>;</span>
</code></pre><p>再show slave status \G;查看正常</p>
<h2 id="模拟数据差异1">模拟数据差异1</h2><p>在42上面删掉transaction_id刚才冲突的那条transaction_id=’7’的记录,按照qrpay_id找</p>
<pre><code><span class="operator"><span class="keyword">delete</span> <span class="keyword">from</span> test <span class="keyword">where</span> qrpay_id=<span class="string">'1166'</span>;</span>
</code></pre><p>继续在52写入测试数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO `<span class="built_in">test</span>` VALUES (<span class="string">'null'</span>,<span class="string">'8'</span>);</span><br><span class="line">INSERT INTO `<span class="built_in">test</span>` VALUES (<span class="string">'null'</span>,<span class="string">'9'</span>);</span><br><span class="line">INSERT INTO `<span class="built_in">test</span>` VALUES (<span class="string">'null'</span>,<span class="string">'10'</span>);</span><br></pre></td></tr></table></figure>
<p>这个时候52上面比42的多了一条transaction_id=’7’的记录</p>
<p>以上目地是模拟出真实数据库A比B多数据的场景</p>
<h2 id="修复同步">修复同步</h2><p>在42上插入数据</p>
<pre><code><span class="operator"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span> <span class="keyword">VALUES</span> (<span class="string">'null'</span>,<span class="string">'7'</span>);</span>
</code></pre><p>这时因为52上已有transaction_id=’7’的记录的值导致52同步挂掉</p>
<p>只有52报</p>
<pre><code>Error <span class="string">'Duplicate entry '</span><span class="number">7</span><span class="string">' for key '</span>transaction_id<span class="string">''</span> on query. Default <span class="string">database:</span> <span class="string">'test'</span>. <span class="string">Query:</span> <span class="string">'INSERT INTO `test` VALUES ('</span><span class="literal">null</span><span class="string">','</span><span class="number">7</span><span class="string">')'</span>
</code></pre><p>在52上跳过错误</p>
<pre><code><span class="operator"><span class="keyword">stop</span> <span class="keyword">slave</span>;</span>
<span class="operator"><span class="keyword">set</span> <span class="keyword">global</span> sql_slave_skip_counter=<span class="number">1</span>;</span>
slave <span class="operator"><span class="keyword">start</span>;</span>
</code></pre><p>再show slave status \G;查看正常</p>
<p>52继续插入数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO `<span class="built_in">test</span>` VALUES (<span class="string">'null'</span>,<span class="string">'11'</span>);</span><br><span class="line">INSERT INTO `<span class="built_in">test</span>` VALUES (<span class="string">'null'</span>,<span class="string">'12'</span>);</span><br><span class="line">INSERT INTO `<span class="built_in">test</span>` VALUES (<span class="string">'null'</span>,<span class="string">'13'</span>);</span><br></pre></td></tr></table></figure>
<p>发现42也健康的同步过来了</p>
<h2 id="复现完毕">复现完毕</h2><p> 数据差异为transaction_id=’7’这条记录,需要修复</p>
<hr>
<h1 id="线上解决方案">线上解决方案</h1><h2 id="备份线上数据表">备份线上数据表</h2><p>晚上12点过后备份A和B的<code>test</code>表（需要恢复的表，为了隐私这里用test代替）</p>
<p>还好这张表里只有100多万条数据，很快就备份出来了，要不然备份锁表就不能这样搞了</p>
<h2 id="导库到测试">导库到测试</h2><p>次日上班处理</p>
<p>停掉测试环境52，42双方的slave</p>
<p>线上A备份导入到52的test库，线上B备份导入到42的test库,两个库的input_date框在同一时间,并比对一下条数记录是否一致</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">delete from <span class="built_in">test</span> <span class="built_in">where</span> input_date &gt;= <span class="string">'2015-07-22 00:00:00'</span></span><br><span class="line">select count(*) from <span class="built_in">test</span></span><br></pre></td></tr></table></figure>
<p>双方重新 记录<strong><code>show master status</code></strong>的值  并<strong><code>change master</code></strong></p>
<p>开启双方<code>slave</code>,这个时候双方的数据就有差异，而不会双向同步问题数据咯</p>
<h2 id="修复数据">修复数据</h2><p>因为52和42是双主模式，具体正确数据以线上A导入到52的数据为准</p>
<p>在52上面执行下面命令，来检测数据的一致性</p>
<pre><code><span class="comment">pt</span><span class="literal">-</span><span class="comment">table</span><span class="literal">-</span><span class="comment">checksum</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">nocheck</span><span class="literal">-</span><span class="comment">replication</span><span class="literal">-</span><span class="comment">filters</span>  <span class="literal">-</span><span class="literal">-</span><span class="comment">no</span><span class="literal">-</span><span class="comment">check</span><span class="literal">-</span><span class="comment">binlog</span><span class="literal">-</span><span class="comment">format</span>  <span class="literal">-</span><span class="literal">-</span><span class="comment">replicate=test</span><span class="string">.</span><span class="comment">checksums</span>  <span class="literal">-</span><span class="literal">-</span><span class="comment">databases=test</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">tables=test</span>  <span class="literal">-</span><span class="literal">-</span><span class="comment">host=localhost</span>    <span class="literal">-</span><span class="literal">-</span><span class="comment">password=123456</span>
</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">tip:</span><br><span class="line">参数解释</span><br><span class="line">--nocheck-replication-filters ：不检查复制过滤器，建议启用。后面可以用--databases来指定需要检查的数据库。</span><br><span class="line">--no-check-binlog-format      : 不检查复制的binlog模式，要是binlog模式是ROW，则会报错。</span><br><span class="line">--replicate-check-only :只显示不同步的信息。</span><br><span class="line">--replicate=   ：把checksum的信息写入到指定表中，建议直接写到被检查的数据库当中。 </span><br><span class="line">--databases=   ：指定需要被检查的数据库，多个则用逗号隔开。</span><br><span class="line">--tables=      ：指定需要被检查的表，多个用逗号隔开</span><br><span class="line">h=<span class="number">127.0</span>.<span class="number">0.1</span>    ：Master的地址</span><br><span class="line">u=root         ：用户名</span><br><span class="line">p=<span class="number">123456</span>       ：密码</span><br><span class="line">P=<span class="number">3306</span>         ：端口</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">输出解释</span><br><span class="line">TS            ：完成检查的时间。</span><br><span class="line">ERRORS        ：检查时候发生错误和警告的数量。</span><br><span class="line">DIFFS         ：差异的条数。当指定--no-replicate-check时，会一直为<span class="number">0</span>，当指定--replicate-check-only会显示不同的信息。</span><br><span class="line">ROWS          ：表的行数。</span><br><span class="line">CHUNKS        ：被划分到表中的块的数目。</span><br><span class="line">SKIPPED       ：由于错误或警告或过大，则跳过块的数目。</span><br><span class="line">TIME          ：执行的时间。</span><br><span class="line">TABLE         ：被检查的表名。</span><br></pre></td></tr></table></figure>
<p>由于线上A和B已经存在差异，所以肯定DIFFS是一个非0的值</p>
<p>需要在42创建checksum用户供52使用</p>
<pre><code><span class="operator"><span class="keyword">grant</span> <span class="keyword">SELECT</span>, PROCESS, SUPER, REPLICATION <span class="keyword">SLAVE</span> <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="keyword">checksum</span> @<span class="string">'192.168.1.52'</span> <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">'123456'</span> ;</span>
<span class="operator"><span class="keyword">flush</span> <span class="keyword">privileges</span>;</span>
</code></pre><p>在52执行下面命令，通过（—print）打印出需要修复数据的sql语句，然后记录下来，然后经过处理，手动的拿去线上B去行执行，让他们数据保持一致性</p>
<pre><code>pt-table-sync <span class="variable">--replicate=</span>test.checksums <span class="variable">h=</span>localhost,<span class="variable">u=</span>root,<span class="variable">p=</span><span class="number">123456</span> <span class="variable">h=</span><span class="number">192.168</span>.<span class="number">1.42</span>,<span class="variable">u=</span>checksum,<span class="variable">p=</span><span class="number">123456</span> --print <span class="variable">--charset=</span>utf8
</code></pre><p>tip:为什么要print直接打印出来问题sql，这是因为pt-table-sync会重建数据，所以有一定的风险，最好提前备份好数据。如果仍然不放心，可以使用它提供的「print」选项，它会打印出相应的SQL，你可以审查一下到底执行了那些操作，然后通过手动执行来完成同步, <strong><code>--charset=utf8</code></strong>  这个参数是让打印出来的sql语句中的汉字正常显示，不然会是乱码。</p>
<pre><code>也可以通过(<span class="comment">--execute)直接修复，但是建议千万不要这么做。</span>
</code></pre><h1 id="附：">附：</h1><p>————————-Percona Toolkit INSTALL————————————-</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">yum install perl-ExtUtils-CBuilder perl-ExtUtils-MakeMaker -y</span><br><span class="line">yum perl-DBD-MySQL -y</span><br><span class="line">yum perl-Time-HiRes -y</span><br><span class="line">yum perl-TermReadKey -y</span><br><span class="line">yum perl-DBI</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">wget https://www.percona.com/downloads/percona-toolkit/<span class="number">2.2</span>.<span class="number">14</span>/tarball/percona-toolkit-<span class="number">2.2</span>.<span class="number">14</span>.tar.gz</span><br><span class="line"></span><br><span class="line">tar zxvf percona-toolkit-<span class="number">2.2</span>.<span class="number">14</span>.tar.gz </span><br><span class="line"><span class="built_in">cd</span> percona-toolkit-<span class="number">2.2</span>.<span class="number">14</span></span><br><span class="line">perl Makefile.PL PREFIX=/usr/<span class="built_in">local</span>/percona-toolkit</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"PATH=<span class="variable">$PATH</span>:/usr/local/percona-toolkit"</span> &gt;&gt; /etc/profile</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"export PATH"</span> &gt;&gt; /etc/profile</span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>
]]></content>
    <summary type="html">
    <![CDATA[<h1 id="背景">背景</h1><p>线上A和B互为主主，A为业务写库，B为读库</p>
<p>19号下午收到短信报警A的slave delay，果断VPN上去数据库查看到</p>
<pre><code>Last_SQL_Error: Error <span class="string">'Duplicate entry '</span><span class="number">4960446</span><span class="string">' for key '</span>transaction_id<span class="string">''</span> <span class="keyword">on</span> query. <span class="keyword">Default</span> database
</code></pre><p>又是熟悉的主键冲突，但是这个时候不能让业务出现任何问题，就果断在A</p>]]>
    
    </summary>
    
      <category term="mysql" scheme="http://linux48.com/tags/mysql/"/>
    
      <category term="主键冲突" scheme="http://linux48.com/tags/%E4%B8%BB%E9%94%AE%E5%86%B2%E7%AA%81/"/>
    
      <category term="双主" scheme="http://linux48.com/tags/%E5%8F%8C%E4%B8%BB/"/>
    
      <category term="数据恢复" scheme="http://linux48.com/tags/%E6%95%B0%E6%8D%AE%E6%81%A2%E5%A4%8D/"/>
    
      <category term="database" scheme="http://linux48.com/categories/database/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[mysql双主互备设计搭建]]></title>
    <link href="http://linux48.com//archives/432/"/>
    <id>http://linux48.com//archives/432/</id>
    <published>2015-07-14T16:00:00.000Z</published>
    <updated>2015-07-15T17:32:14.000Z</updated>
    <content type="html"><![CDATA[<p>Master-Master复制的两台服务器，既是master，又是另一台服务器的slave。这样，任何一方所做的变更，都会通过复制应用到另外一方的数据库中。<br>这样做的好很多，主要是下面几点:</p>
<blockquote>
<ul>
<li>可以做灾备，其中一个坏了可以切换到另一个。 </li>
<li>可以做负载均衡，可以将请求分摊到其中任何一台上，提高网站吞吐量。  </li>
<li>对于异地热备，尤其适合灾备。</li>
<li>…</li>
</ul>
</blockquote>
<p>今天在测试环境部署一套下来，简单总结一下过程以及经验<br><a id="more"></a></p>
<h1 id="mysql_复制工作原理">mysql 复制工作原理</h1>]]></content>
    <summary type="html">
    <![CDATA[<p>Master-Master复制的两台服务器，既是master，又是另一台服务器的slave。这样，任何一方所做的变更，都会通过复制应用到另外一方的数据库中。<br>这样做的好很多，主要是下面几点:</p>
<blockquote>
<ul>
<li>可以做灾备，其中一个坏了可以切换到另一个。 </li>
<li>可以做负载均衡，可以将请求分摊到其中任何一台上，提高网站吞吐量。  </li>
<li>对于异地热备，尤其适合灾备。</li>
<li>…</li>
</ul>
</blockquote>
<p>今天在测试环境部署一套下来，简单总结一下过程以及经验<br>]]>
    
    </summary>
    
      <category term="mysql" scheme="http://linux48.com/tags/mysql/"/>
    
      <category term="mysql高可用" scheme="http://linux48.com/tags/mysql%E9%AB%98%E5%8F%AF%E7%94%A8/"/>
    
      <category term="双主" scheme="http://linux48.com/tags/%E5%8F%8C%E4%B8%BB/"/>
    
      <category term="热备" scheme="http://linux48.com/tags/%E7%83%AD%E5%A4%87/"/>
    
      <category term="database" scheme="http://linux48.com/categories/database/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[CentOS6安装subversion 可视化管理工具iF.SVNAdmin]]></title>
    <link href="http://linux48.com//archives/431/"/>
    <id>http://linux48.com//archives/431/</id>
    <published>2015-07-06T16:00:00.000Z</published>
    <updated>2015-07-09T09:47:36.000Z</updated>
    <content type="html"><![CDATA[<p>windows下的TortoiseSVN服务端是相当好用的，界面管理方便，增删改查用户和库都比较好用，但是linux下的svn就比较折腾人。<br><a id="more"></a></p>
<p>之前安装过apache整合svn，虽然有web界面可以看，但是也不是那么好管理，昨天晚上受朋友所托，需要通过可视化工具来增删改查用户和库。</p>
<p>试了一圈以后最后找到了这个svnadmin。是使用php写的。他吸引我的主要是安装和配置都非常简单和人性化。而且也有强大的功能。</p>
<p>支持repo管理、用户管理、用户组管理、权限管理、LDAP等，界面可以算是中规中矩。</p>
<blockquote>
<ul>
<li>操作系统：CentOS-6.5-64bit</li>
<li>版本管理：Subversion-1.6.11</li>
<li>管理软件：F.SVNAdmin-stable-1.6.2</li>
<li>web引擎： Apache/2.2.3 (端口8888) &amp; nginx/1.4.4 (端口80) &amp; PHP 5.4.0</li>
<li>ip地址：  192.168.1.2</li>
</ul>
</blockquote>
<h1 id="源码编译安装lnmp">源码编译安装lnmp</h1><pre><code>git clone https:<span class="comment">//git.coding.net/svip/lnamp.git</span>
<span class="keyword">sh</span> lnmp/lnmp.<span class="keyword">sh</span>
</code></pre><p>这里使用源码编译lnmp环境主要是后面需要yum安装httpd和svn(这样子的好处是，默认会整合好apache和svn无需手动在整合配置)，apache只服务于svn，而nginx+php则是为了跑svnadmin</p>
<h1 id="yum安装apache+svn">yum安装apache+svn</h1><pre><code><span class="label">yum</span> -y install httpd <span class="keyword">subversion </span>mod_dav_svn
</code></pre><h1 id="配置apache的svn">配置apache的svn</h1><p>装完SVN后默认生成/etc/httpd/conf.d/subversion.conf文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ setup]<span class="comment"># cat /etc/httpd/conf.d/subversion.conf </span></span><br><span class="line"></span><br><span class="line">LoadModule dav_svn_module     modules/mod_dav_svn.so</span><br><span class="line">LoadModule authz_svn_module   modules/mod_authz_svn.so</span><br><span class="line"></span><br><span class="line">&lt;Location /project/&gt;</span><br><span class="line">            DAV svn</span><br><span class="line">            SVNListParentPath on</span><br><span class="line">            SVNParentPath /var/www/svn</span><br><span class="line">            AuthType Basic</span><br><span class="line">            AuthName <span class="string">"Subversion repository"</span></span><br><span class="line">            AuthUserFile /var/www/svnconfig/passwdfile</span><br><span class="line">            AuthzSVNAccessFile /var/www/svnconfig/accessfile</span><br><span class="line">            Require valid-user</span><br><span class="line">&lt;/Location&gt;</span><br></pre></td></tr></table></figure>
<h1 id="创建SVN_repo目录和权限信息目录">创建SVN repo目录和权限信息目录</h1><pre><code><span class="keyword">mkdir</span> /<span class="keyword">var</span>/www/svn
<span class="keyword">mkdir</span> /<span class="keyword">var</span>/www/svnconfig
</code></pre><h1 id="创建SVN权限文件和密码文件">创建SVN权限文件和密码文件</h1><p>创建权限控制文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ]<span class="comment"># cat /var/www/svnconfig/accessfile</span></span><br><span class="line"></span><br><span class="line">[aliases]</span><br><span class="line">[groups]</span><br><span class="line"></span><br><span class="line">[/]</span><br><span class="line">*=rw</span><br><span class="line"></span><br><span class="line">[qa_project:/]</span><br></pre></td></tr></table></figure></p>
<p>创建用户密码文件，注意这里的密码必须是加密的，需要使用 <code>htpasswd -c 123 user1</code>生成<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ]<span class="comment"># cat /var/www/svnconfig/passwdfile</span></span><br><span class="line"></span><br><span class="line">[users]</span><br><span class="line"><span class="comment"># harry = harryssecret</span></span><br><span class="line"><span class="comment"># sally = sallyssecret</span></span><br><span class="line">user1:aWW1oIsRihOHc</span><br></pre></td></tr></table></figure></p>
<h1 id="安装iF-SVnAdmin">安装iF.SVnAdmin</h1><pre><code>wget <span class="string">http:</span><span class="comment">//sourceforge.net/projects/ifsvnadmin/files/svnadmin-1.6.2.zip</span>
unzip svnadmin-<span class="number">1.6</span>.2.zip
mv iF.SVNAdmin-stable-<span class="number">1.6</span>.2 <span class="regexp">/home/</span>wwwroot/svnadmin
chmod <span class="number">777</span> -R <span class="regexp">/home/</span>wwwroot<span class="regexp">/svnadmin/</span>data
</code></pre><p>配置nginx,配置apache，注意2个web引擎的端口不要冲突，并开启相应端口到防火墙</p>
<h1 id="初始化iF-SVnAdmin">初始化iF.SVnAdmin</h1><p>浏览器输入<a href="http://192.168.1.2/svnadmin/index.php" target="_blank" rel="external">http://192.168.1.2/svnadmin/index.php</a></p>
<p>使用刚才生成的密码登陆进去可以看到下面的配置页面</p>
<p><img src="http://r.loli.io/meMjmi.png" alt=""><br>选择Test提示没有写入权限的话chmod一下，</p>
<p>登录后如下，可以看到软件版本信息、已有的仓库、用户、组、权限路径等</p>
<h1 id="投入使用">投入使用</h1><p>svn管理地址   <a href="http://192.168.1.2/svnadmin/index.php" target="_blank" rel="external">http://192.168.1.2/svnadmin/index.php</a><br>svn项目地址   <a href="http://192.168.1.2:8888/project/project_name/" target="_blank" rel="external">http://192.168.1.2:8888/project/project_name/</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<p>windows下的TortoiseSVN服务端是相当好用的，界面管理方便，增删改查用户和库都比较好用，但是linux下的svn就比较折腾人。<br>]]>
    
    </summary>
    
      <category term="svn" scheme="http://linux48.com/tags/svn/"/>
    
      <category term="工具" scheme="http://linux48.com/tags/%E5%B7%A5%E5%85%B7/"/>
    
      <category term="os" scheme="http://linux48.com/categories/os/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Red Hat Enterprise Linux Server YUM配置]]></title>
    <link href="http://linux48.com//archives/430/"/>
    <id>http://linux48.com//archives/430/</id>
    <published>2015-07-05T16:00:00.000Z</published>
    <updated>2015-07-07T07:42:17.000Z</updated>
    <content type="html"><![CDATA[<p>由于 redhat的yum在线更新是收费的，如果没有注册的话不能使用，如果要使用，需将redhat的yum卸载后，重启安装，再配置其他源.<br><a id="more"></a></p>
<h1 id="删除redhat原有的yum">删除redhat原有的yum</h1><pre><code>rpm -a<span class="string">q|grep yum|</span>xargs rpm -e --nodeps 
</code></pre><h1 id="下载yum安装文件">下载yum安装文件</h1><p>注意，由于官方不断更新版本，如果下载时找不到文件，就到：<a href="http://mirrors.163.com/centos/6/os/x86_64/Packages" target="_blank" rel="external">http://mirrors.163.com/centos/6/os/x86_64/Packages</a> 上查找相应的头文件。然后再下载。</p>
<pre><code>wget <span class="symbol">http:</span>/<span class="regexp">/mirrors.163.com/centos</span><span class="regexp">/6/os</span><span class="regexp">/x86_64/</span><span class="constant">Packages/</span>yum-<span class="number">3.2</span>.<span class="number">29</span>-<span class="number">60</span>.el6.centos.noarch.rpm
wget <span class="symbol">http:</span>/<span class="regexp">/mirrors.163.com/centos</span><span class="regexp">/6/os</span><span class="regexp">/x86_64/</span><span class="constant">Packages/</span>yum-metadata-parser-<span class="number">1.1</span>.<span class="number">2</span>-<span class="number">16</span>.el6.x86_64.rpm
wget <span class="symbol">http:</span>/<span class="regexp">/mirrors.163.com/centos</span><span class="regexp">/6/os</span><span class="regexp">/x86_64/</span><span class="constant">Packages/</span>yum-plugin-fastestmirror-<span class="number">1.1</span>.<span class="number">30</span>-<span class="number">30</span>.el6.noarch.rpm
wget <span class="symbol">http:</span>/<span class="regexp">/mirrors.163.com/centos</span><span class="regexp">/6/os</span><span class="regexp">/x86_64/</span><span class="constant">Packages/</span>python-iniparse-<span class="number">0</span>.<span class="number">3.1</span>-<span class="number">2.1</span>.el6.noarch.rpm
</code></pre><h1 id="进行安装yum">进行安装yum</h1><pre><code><span class="tag">rpm</span> <span class="tag">-ivh</span> <span class="tag">python-iniparse-0</span><span class="class">.3</span><span class="class">.1-2</span><span class="class">.1</span><span class="class">.el6</span><span class="class">.noarch</span><span class="class">.rpm</span>
<span class="tag">rpm</span> <span class="tag">-ivh</span> <span class="tag">yum-metadata-parser-1</span><span class="class">.1</span><span class="class">.2-16</span><span class="class">.el6</span><span class="class">.x86_64</span><span class="class">.rpm</span>
<span class="tag">rpm</span> <span class="tag">-ivh</span> <span class="tag">yum-3</span><span class="class">.2</span><span class="class">.29-40</span><span class="class">.el6</span><span class="class">.centos</span><span class="class">.noarch</span><span class="class">.rpm</span> <span class="tag">yum-plugin-fastestmirror-1</span><span class="class">.1</span><span class="class">.30-14</span><span class="class">.el6</span><span class="class">.noarch</span><span class="class">.rpm</span>
</code></pre><p>注意最后两个包必需同时安装，否则会相互依赖 </p>
<h1 id="配置源">配置源</h1><p>新建/etc/yum.repos.d/CentOS6-Base-163.repo<br>内容如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">[base]</span><br><span class="line"></span><br><span class="line">name=CentOS-<span class="number">6</span> - Base - <span class="number">163</span>.com</span><br><span class="line">baseurl=http://mirrors.<span class="number">163</span>.com/centos/<span class="number">6</span>/os/<span class="variable">$basearch</span>/</span><br><span class="line"><span class="comment">#mirrorlist=http://mirrorlist.centos.org/?release=6&amp;arch=$basearch&amp;repo=os</span></span><br><span class="line">gpgcheck=<span class="number">1</span></span><br><span class="line">gpgkey=http://mirror.centos.org/centos/RPM-GPG-KEY-CentOS-<span class="number">6</span></span><br><span class="line">priority=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#released updates</span></span><br><span class="line"></span><br><span class="line">[updates]</span><br><span class="line">name=CentOS-<span class="number">6</span> - Updates - <span class="number">163</span>.com</span><br><span class="line">baseurl=http://mirrors.<span class="number">163</span>.com/centos/<span class="number">6</span>/updates/<span class="variable">$basearch</span>/</span><br><span class="line"><span class="comment">#mirrorlist=http://mirrorlist.centos.org/?release=6&amp;arch=$basearch&amp;repo=updates</span></span><br><span class="line">gpgcheck=<span class="number">1</span></span><br><span class="line">gpgkey=http://mirror.centos.org/centos/RPM-GPG-KEY-CentOS-<span class="number">6</span></span><br><span class="line">priority=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#additional packages that may be useful</span></span><br><span class="line"></span><br><span class="line">[extras]</span><br><span class="line">name=CentOS-<span class="number">6</span> - Extras - <span class="number">163</span>.com</span><br><span class="line">baseurl=http://mirrors.<span class="number">163</span>.com/centos/<span class="number">6</span>/extras/<span class="variable">$basearch</span>/</span><br><span class="line"><span class="comment">#mirrorlist=http://mirrorlist.centos.org/?release=6&amp;arch=$basearch&amp;repo=extras</span></span><br><span class="line">gpgcheck=<span class="number">1</span></span><br><span class="line">gpgkey=http://mirror.centos.org/centos/RPM-GPG-KEY-CentOS-<span class="number">6</span></span><br><span class="line">priority=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#additional packages that extend functionality of existing packages</span></span><br><span class="line"></span><br><span class="line">[centosplus]</span><br><span class="line">name=CentOS-<span class="number">6</span> - Plus - <span class="number">163</span>.com</span><br><span class="line">baseurl=http://mirrors.<span class="number">163</span>.com/centos/<span class="number">6</span>/centosplus/<span class="variable">$basearch</span>/</span><br><span class="line"><span class="comment">#mirrorlist=http://mirrorlist.centos.org/?release=6&amp;arch=$basearch&amp;repo=centosplus</span></span><br><span class="line">gpgcheck=<span class="number">1</span></span><br><span class="line">enabled=<span class="number">0</span></span><br><span class="line">gpgkey=http://mirror.centos.org/centos/RPM-GPG-KEY-CentOS-<span class="number">6</span></span><br><span class="line">priority=<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#contrib - packages by Centos Users</span></span><br><span class="line"></span><br><span class="line">[contrib]</span><br><span class="line">name=CentOS-<span class="number">6</span> - Contrib - <span class="number">163</span>.com</span><br><span class="line">baseurl=http://mirrors.<span class="number">163</span>.com/centos/<span class="number">6</span>/contrib/<span class="variable">$basearch</span>/</span><br><span class="line"><span class="comment">#mirrorlist=http://mirrorlist.centos.org/?release=6&amp;arch=$basearch&amp;repo=contrib</span></span><br><span class="line">gpgcheck=<span class="number">1</span></span><br><span class="line">enabled=<span class="number">1</span></span><br><span class="line">gpgkey=http://mirror.centos.org/centos/RPM-GPG-KEY-CentOS-<span class="number">6</span></span><br><span class="line">priority=<span class="number">1</span></span><br></pre></td></tr></table></figure>
<h1 id="yum_clean_all">yum clean all</h1><h1 id="yum_install_vim">yum install vim</h1><p>测试一下可不可以用</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>由于 redhat的yum在线更新是收费的，如果没有注册的话不能使用，如果要使用，需将redhat的yum卸载后，重启安装，再配置其他源.<br>]]>
    
    </summary>
    
      <category term="RHEL" scheme="http://linux48.com/tags/RHEL/"/>
    
      <category term="yum" scheme="http://linux48.com/tags/yum/"/>
    
      <category term="os" scheme="http://linux48.com/categories/os/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[mysql全局日志开启]]></title>
    <link href="http://linux48.com//archives/429/"/>
    <id>http://linux48.com//archives/429/</id>
    <published>2015-06-25T06:30:42.000Z</published>
    <updated>2015-06-25T07:14:39.000Z</updated>
    <content type="html"><![CDATA[<p>之前有写过<a href="http://linux48.com/archives/74/">Mysql慢查询设置</a>，现在需要对Mysql进行深入的分析，发现mysql性能瓶颈和寻找优化策略，这就要对全部的sql执行语句进行查询，慢查询是满足不了的，binlog也只是记录了update语句，这个时候就需要设置mysql的全局log了。</p>
<a id="more"></a>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="built_in">test</span> mysql5.<span class="number">5</span>]<span class="comment"># cat /etc/my.cnf |grep -v "#" |grep "log"</span></span><br><span class="line"><span class="built_in">log</span>=/tmp/row.log</span><br><span class="line">slow-query-log = on</span><br><span class="line">slow_query_<span class="built_in">log</span>_file = /data/mysql/binlog/slowquery_3.log</span><br><span class="line"><span class="built_in">log</span>-queries-not-using-indexes = <span class="literal">true</span></span><br><span class="line"><span class="built_in">log</span>-bin=mysql-bin</span><br><span class="line">binlog_format=mixed</span><br><span class="line">innodb_<span class="built_in">log</span>_group_home_dir = /data/mysql/data</span><br></pre></td></tr></table></figure>
<p>指定一下log参数，重启mysql服务即可，如果不能重启mysql服务器可以使用<code>mysql&gt; set global log=1;</code>来开启</p>
<p>这样子就可以查看全局log了</p>
<p>此log记录了服务器接收到的每一个<code>查询</code>，<code>插入</code>，<code>更新</code>命令，无论这些是命令是否正确甚至是否包含语法错误，都会将其记录下来 ，记录的格式为 {Time ，Id ，Command，Argument }</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="built_in">test</span> mysql5.<span class="number">5</span>]<span class="comment"># tail -f /tmp/row.log</span></span><br><span class="line">/usr/<span class="built_in">local</span>/mysql/bin/mysqld, Version: <span class="number">5.5</span>.<span class="number">25</span>-log (Source distribution). started with:</span><br><span class="line">Tcp port: <span class="number">3306</span>  Unix socket: /data/mysql/mysql.sock</span><br><span class="line">Time                 Id Command    Argument</span><br><span class="line"><span class="number">150625</span> <span class="number">14</span>:<span class="number">08</span>:<span class="number">24</span>     <span class="number">1</span> Connect   xiaolei@<span class="number">10.10</span>.<span class="number">3.165</span> on</span><br><span class="line">                    <span class="number">1</span> Query     /*!<span class="number">40101</span> <span class="built_in">set</span> @@session.wait_timeout=<span class="number">28800</span> */</span><br><span class="line">                    <span class="number">1</span> Query     SET PROFILING = <span class="number">1</span></span><br><span class="line">                    <span class="number">1</span> Query     SET profiling_<span class="built_in">history</span>_size = <span class="number">0</span></span><br><span class="line">                    <span class="number">1</span> Query     SET profiling_<span class="built_in">history</span>_size = <span class="number">15</span></span><br><span class="line">                    <span class="number">1</span> Query     SHOW STATUS</span><br><span class="line">                    <span class="number">1</span> Query     SELECT COUNT(*) FROM `<span class="built_in">test</span>`.`<span class="number">2222</span>` LIMIT <span class="number">0</span>, <span class="number">1000</span></span><br><span class="line"><span class="number">150625</span> <span class="number">14</span>:<span class="number">08</span>:<span class="number">43</span>     <span class="number">1</span> Query     TRUNCATE TABLE test.<span class="number">1</span></span><br><span class="line"><span class="number">150625</span> <span class="number">14</span>:<span class="number">08</span>:<span class="number">49</span>     <span class="number">1</span> Query     INSERT INTO test.<span class="number">1</span> SELECT * FROM test.`gc_1_17500`</span><br><span class="line">                    <span class="number">1</span> Query     /*!<span class="number">40101</span> <span class="built_in">set</span> @@session.wait_timeout=<span class="number">28800</span> */</span><br><span class="line">                    <span class="number">1</span> Query     TRUNCATE TABLE test.<span class="number">1</span></span><br><span class="line"><span class="number">150625</span> <span class="number">14</span>:<span class="number">13</span>:<span class="number">26</span>     <span class="number">1</span> Query     INSERT INTO test.<span class="number">1</span> SELECT * FROM test.`gc_1_17500`</span><br><span class="line"><span class="number">150625</span> <span class="number">14</span>:<span class="number">13</span>:<span class="number">49</span>     <span class="number">1</span> Query     SET PROFILING = <span class="number">1</span></span><br><span class="line">                    <span class="number">1</span> Query     SET profiling_<span class="built_in">history</span>_size = <span class="number">0</span></span><br><span class="line">                    <span class="number">1</span> Query     SET profiling_<span class="built_in">history</span>_size = <span class="number">15</span></span><br><span class="line">                    <span class="number">1</span> Query     SHOW STATUS</span><br><span class="line">                    <span class="number">1</span> Query     SELECT COUNT(*) FROM `<span class="built_in">test</span>`.`<span class="number">1</span>` LIMIT <span class="number">0</span>, <span class="number">1000</span></span><br><span class="line">                    <span class="number">1</span> Query     SHOW STATUS</span><br><span class="line">                    <span class="number">1</span> Query     SHOW PROFILES</span><br><span class="line">                    <span class="number">1</span> Query     select state, round(sum(duration),<span class="number">5</span>) as `duration (summed) <span class="keyword">in</span> sec` from information_schema.profiling <span class="built_in">where</span> query_id = <span class="number">4</span> group by state order by `duration (summed) <span class="keyword">in</span> sec` desc</span><br><span class="line">                    <span class="number">1</span> Query     SET PROFILING = <span class="number">0</span></span><br><span class="line">                    <span class="number">1</span> Query     EXPLAIN SELECT COUNT(*) FROM `<span class="built_in">test</span>`.`<span class="number">1</span>` LIMIT <span class="number">0</span>, <span class="number">1000</span></span><br></pre></td></tr></table></figure>
<p>但是当我查看了一些mysql的err日志发现其中log参数是过时的，但是从日志输出效果看来也没什么问题,</p>
<pre><code><span class="number">150625</span> <span class="number">14</span>:<span class="number">35</span>:<span class="number">05</span> [Warning] The syntax <span class="string">'--log'</span> <span class="keyword">is</span> <span class="keyword">deprecated</span> <span class="keyword">and</span> will be removed <span class="keyword">in</span> a <span class="keyword">future</span> release. Please use <span class="string">'--general-log'</span>/<span class="string">'--general-log-file'</span> instead.
</code></pre><p>Warning提示“—log”已经过时，并将在以后的版本中删除。请使用’—general-log’</p>
<p>有强迫症的我还是遵从官方的说明,使用<code>general-log</code>吧</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="built_in">test</span> mysql5.<span class="number">5</span>]<span class="comment"># cat /etc/my.cnf |grep -v "#" |grep "log"</span></span><br><span class="line">general-log = on</span><br><span class="line">general_<span class="built_in">log</span>_file = /data/mysql/binlog/general.log</span><br><span class="line">slow-query-log = on</span><br><span class="line">slow_query_<span class="built_in">log</span>_file = /data/mysql/binlog/slowquery_3.log</span><br><span class="line"><span class="built_in">log</span>-queries-not-using-indexes = <span class="literal">true</span></span><br><span class="line"><span class="built_in">log</span>-bin=mysql-bin</span><br><span class="line">binlog_format=mixed</span><br><span class="line">innodb_<span class="built_in">log</span>_group_home_dir = /data/mysql/data</span><br></pre></td></tr></table></figure>
<p>通过分析全局log，我们可以得到诸如下信息：</p>
<blockquote>
<ul>
<li>1、Mysql访问得最多的数据</li>
<li>2、Mysql执行得最多的查询的种类</li>
<li>3、Mysql停留时间最长的状态</li>
<li>4、Mysql用来执行查询的使用得最频繁的子系统</li>
<li>5、Mysql查询过程中访问的数据种类</li>
<li>6、Mysql执行了多少种不同类型的活动，比如索引扫描。</li>
</ul>
</blockquote>
]]></content>
    <summary type="html">
    <![CDATA[<p>之前有写过<a href="http://linux48.com/archives/74/">Mysql慢查询设置</a>，现在需要对Mysql进行深入的分析，发现mysql性能瓶颈和寻找优化策略，这就要对全部的sql执行语句进行查询，慢查询是满足不了的，binlog也只是记录了update语句，这个时候就需要设置mysql的全局log了。</p>]]>
    
    </summary>
    
      <category term="log" scheme="http://linux48.com/tags/log/"/>
    
      <category term="mysql" scheme="http://linux48.com/tags/mysql/"/>
    
      <category term="database" scheme="http://linux48.com/categories/database/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[关于PHP-FPM的backlog]]></title>
    <link href="http://linux48.com//archives/428/"/>
    <id>http://linux48.com//archives/428/</id>
    <published>2015-06-08T06:30:42.000Z</published>
    <updated>2015-06-08T14:08:44.000Z</updated>
    <content type="html"><![CDATA[<p>php-fpm 必须注意<strong>backlog</strong>的设置，否则上压力就容易 无法连接、网关超时！</p>
<a id="more"></a>
<pre><code><span class="comment">;listen.backlog = -1</span>
</code></pre><p>backlog数，-1表示无限制，由操作系统决定</p>
<p>由于fpm是多个进程是监听同一个套接字的，通过一个套接字锁来保证同一时刻只有一个进程可以accept，多进程间抢锁是需要消耗时间的</p>
<p>在backlog被设置成-1的情况下，如果fpm没有及时accept，那么在并发量很大的情况下势必会出现SYN超时重连了。</p>
<p>安装php-fpm时backlog一定要重新设置，不能用fpm默认配置的-1 ，可以根据机器的并发量来设置，建议设置在1024以上，最好是2的幂值（因为内核会调整成2的n次幂）。</p>
<p>有高并发的业务，就必须要调整backlog。对于PHP而言，需要注意的有3方面：</p>
<blockquote>
<ul>
<li>1、操作系统 | sysctl</li>
<li>2、WEB前端 | 比如：Nginx</li>
<li>3、PHP后台 | 比如：php-fpm</li>
</ul>
</blockquote>
<p>操作系统以CentOS为例，可通过默认配置 /etc/sysctl.conf 文件进行调整。比如：</p>
<pre><code>net.core.<span class="variable">somaxconn =</span> <span class="number">1048576</span> <span class="comment"># 默认为128</span>
net.core.<span class="variable">netdev_max_backlog =</span> <span class="number">1048576</span> <span class="comment"># 默认为1000</span>
net.ipv4.<span class="variable">tcp_max_syn_backlog =</span> <span class="number">1048576</span> <span class="comment"># 默认为1024</span>
</code></pre><p>WEB前端以Nginx为例，可通过默认配置 /etc/nginx/nginx.conf 文件中的监听选项来调整。比如：</p>
<pre><code><span class="title">listen</span>       <span class="number">80</span> backlog=<span class="number">8192</span>; <span class="comment"># 默认为511</span>
</code></pre><p>PHP后台，以PHP-FPM为例，可以通过默认配置 /etc/php-fpm.d/www.conf 文件进行调整。比如：</p>
<pre><code>listen.<span class="variable">backlog =</span> <span class="number">8192</span> <span class="comment"># 默认为-1（由系统决定）</span>
</code></pre><p>大系统下，如上3处都应该进行调整。</p>
<p>值得注意的是：</p>
<pre><code>PHP-FPM的配置文件中，关于listen.backlog选项的注释有些误导人：

; <span class="operator"><span class="keyword">Set</span> listen(<span class="number">2</span>) backlog. A <span class="keyword">value</span> <span class="keyword">of</span> <span class="string">'-1'</span> means unlimited. 
;</span> Default Value: -1
</code></pre><p>实际上如果使用默认值，很容易出现后端无法连接的问题，按老文档上的解释这个默认是200。建议此处不要留空，务必设置一个合适的值。</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>php-fpm 必须注意<strong>backlog</strong>的设置，否则上压力就容易 无法连接、网关超时！</p>]]>
    
    </summary>
    
      <category term="php" scheme="http://linux48.com/tags/php/"/>
    
      <category term="devops" scheme="http://linux48.com/categories/devops/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[MySQL的Grant赋权命令详解]]></title>
    <link href="http://linux48.com//archives/427/"/>
    <id>http://linux48.com//archives/427/</id>
    <published>2015-06-05T08:30:42.000Z</published>
    <updated>2015-06-05T08:42:02.000Z</updated>
    <content type="html"><![CDATA[<p>本文实例，运行于 MySQL 5.0 及以上版本。</p>
<p>MySQL 赋予用户权限命令的简单格式可概括为：</p>
<pre><code>grant 权限 <span class="function_start"><span class="keyword">on</span></span> 数据库对象 <span class="keyword">to</span> 用户
</code></pre><a id="more"></a>
<h1 id="普通数据库用户权限">普通数据库用户权限</h1><p>一、grant 普通数据用户，查询、插入、更新、删除 数据库中所有表数据的权利。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">grant</span> <span class="keyword">select</span> <span class="keyword">on</span> testdb.* <span class="keyword">to</span> common_user@<span class="string">'%'</span></span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">insert</span> <span class="keyword">on</span> testdb.* <span class="keyword">to</span> common_user@<span class="string">'%'</span></span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">update</span> <span class="keyword">on</span> testdb.* <span class="keyword">to</span> common_user@<span class="string">'%'</span></span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">delete</span> <span class="keyword">on</span> testdb.* <span class="keyword">to</span> common_user@<span class="string">'%'</span></span></span><br></pre></td></tr></table></figure>
<p>或者，用一条 MySQL 命令来替代：</p>
<pre><code><span class="operator"><span class="keyword">grant</span> <span class="keyword">select</span>, <span class="keyword">insert</span>, <span class="keyword">update</span>, <span class="keyword">delete</span> <span class="keyword">on</span> testdb.* <span class="keyword">to</span> common_user@<span class="string">'%'</span></span>
</code></pre><h1 id="数据库开发人员权限">数据库开发人员权限</h1><p>二、grant 数据库开发人员，创建表、索引、视图、存储过程、函数。。。等权限。</p>
<p>grant 创建、修改、删除 MySQL 数据表结构权限。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">grant</span> <span class="keyword">create</span> <span class="keyword">on</span> testdb.* <span class="keyword">to</span> developer@<span class="string">'192.168.0.%'</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">grant</span> <span class="keyword">alter</span>  <span class="keyword">on</span> testdb.* <span class="keyword">to</span> developer@<span class="string">'192.168.0.%'</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">grant</span> <span class="keyword">drop</span>   <span class="keyword">on</span> testdb.* <span class="keyword">to</span> developer@<span class="string">'192.168.0.%'</span>;</span></span><br></pre></td></tr></table></figure>
<p>grant 操作 MySQL 外键权限。</p>
<pre><code><span class="operator"><span class="keyword">grant</span> <span class="keyword">references</span> <span class="keyword">on</span> testdb.* <span class="keyword">to</span> developer@<span class="string">'192.168.0.%'</span>;</span>
</code></pre><p>grant 操作 MySQL 临时表权限。</p>
<pre><code><span class="operator"><span class="keyword">grant</span> <span class="keyword">create</span> <span class="keyword">temporary</span> <span class="keyword">tables</span> <span class="keyword">on</span> testdb.* <span class="keyword">to</span> developer@<span class="string">'192.168.0.%'</span>;</span>
</code></pre><p>grant 操作 MySQL 索引权限。</p>
<pre><code><span class="operator"><span class="keyword">grant</span> <span class="keyword">index</span> <span class="keyword">on</span> testdb.* <span class="keyword">to</span> developer@<span class="string">'192.168.0.%'</span>;</span>
</code></pre><p>grant 操作 MySQL 视图、查看视图源代码 权限。</p>
<pre><code><span class="operator"><span class="keyword">grant</span> <span class="keyword">create</span> <span class="keyword">view</span> <span class="keyword">on</span> testdb.* <span class="keyword">to</span> developer@<span class="string">'192.168.0.%'</span>;</span>
<span class="operator"><span class="keyword">grant</span> <span class="keyword">show</span>   <span class="keyword">view</span> <span class="keyword">on</span> testdb.* <span class="keyword">to</span> developer@<span class="string">'192.168.0.%'</span>;</span>
</code></pre><p>grant 操作 MySQL 存储过程、函数 权限。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">grant</span> <span class="keyword">create</span> routine <span class="keyword">on</span> testdb.* <span class="keyword">to</span> developer@<span class="string">'192.168.0.%'</span>;</span> <span class="comment">-- now, can show procedure status</span></span><br><span class="line"><span class="operator"><span class="keyword">grant</span> <span class="keyword">alter</span>  routine <span class="keyword">on</span> testdb.* <span class="keyword">to</span> developer@<span class="string">'192.168.0.%'</span>;</span> <span class="comment">-- now, you can drop a procedure</span></span><br><span class="line"><span class="operator"><span class="keyword">grant</span> <span class="keyword">execute</span>        <span class="keyword">on</span> testdb.* <span class="keyword">to</span> developer@<span class="string">'192.168.0.%'</span>;</span></span><br></pre></td></tr></table></figure>
<h1 id="普通DBA权限">普通DBA权限</h1><p>三、grant 普通 DBA 管理某个 MySQL 数据库的权限。</p>
<pre><code><span class="operator"><span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">privileges</span> <span class="keyword">on</span> testdb <span class="keyword">to</span> dba@<span class="string">'localhost'</span></span>
</code></pre><p>其中，关键字 “privileges” 可以省略。</p>
<h1 id="高级DBA权限">高级DBA权限</h1><p>四、grant 高级 DBA 管理 MySQL 中所有数据库的权限。</p>
<pre><code><span class="operator"><span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> *.* <span class="keyword">to</span> dba@<span class="string">'localhost'</span></span>
</code></pre><h1 id="实际运用">实际运用</h1><p>五、MySQL grant 权限，分别可以作用在多个层次上。</p>
<h2 id="grant_作用在整个_MySQL_服务器上：">grant 作用在整个 MySQL 服务器上：</h2><pre><code><span class="operator"><span class="keyword">grant</span> <span class="keyword">select</span> <span class="keyword">on</span> *.* <span class="keyword">to</span> dba@localhost;</span> 
<span class="comment">-- dba 可以查询 MySQL 中所有数据库中的表。</span>

<span class="operator"><span class="keyword">grant</span> <span class="keyword">all</span>    <span class="keyword">on</span> *.* <span class="keyword">to</span> dba@localhost;</span> 
<span class="comment">-- dba 可以管理 MySQL 中的所有数据库</span>
</code></pre><h2 id="grant_作用在单个数据库上：">grant 作用在单个数据库上：</h2><pre><code><span class="operator"><span class="keyword">grant</span> <span class="keyword">select</span> <span class="keyword">on</span> testdb.* <span class="keyword">to</span> dba@localhost;</span> 
<span class="comment">-- dba 可以查询 testdb 中的表。</span>
</code></pre><h2 id="grant_作用在单个数据表上：">grant 作用在单个数据表上：</h2><pre><code><span class="operator"><span class="keyword">grant</span> <span class="keyword">select</span>, <span class="keyword">insert</span>, <span class="keyword">update</span>, <span class="keyword">delete</span> <span class="keyword">on</span> testdb.orders <span class="keyword">to</span> dba@localhost;</span>
</code></pre><p>这里在给一个用户授权多张表时，可以多次执行以上语句。例如：</p>
<pre><code><span class="operator"><span class="keyword">grant</span> <span class="keyword">select</span>(user_id,username) <span class="keyword">on</span> smp.users <span class="keyword">to</span> mo_user@<span class="string">'%'</span> <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">'123345'</span>;</span>
<span class="operator"><span class="keyword">grant</span> <span class="keyword">select</span> <span class="keyword">on</span> smp.mo_sms <span class="keyword">to</span> mo_user@<span class="string">'%'</span> <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">'123345'</span>;</span>
</code></pre><h2 id="grant_作用在表中的列上：">grant 作用在表中的列上：</h2><pre><code><span class="operator"><span class="keyword">grant</span> <span class="keyword">select</span>(id, se, rank) <span class="keyword">on</span> testdb.apache_log <span class="keyword">to</span> dba@localhost;</span>
</code></pre><h2 id="grant_作用在存储过程、函数上：">grant 作用在存储过程、函数上：</h2><pre><code>grant<span class="instruction"> execute </span>on procedure testdb.pr_add to 'dba'@'localhost'
grant<span class="instruction"> execute </span>on function testdb.fn_add to 'dba'@'localhost'
</code></pre><h1 id="查看权限">查看权限</h1><p>六、查看 MySQL 用户权限</p>
<p>查看当前用户（自己）权限：</p>
<pre><code><span class="operator"><span class="keyword">show</span> <span class="keyword">grants</span>;</span>
</code></pre><p>查看其他 MySQL 用户权限：</p>
<pre><code><span class="operator"><span class="keyword">show</span> <span class="keyword">grants</span> <span class="keyword">for</span> dba@localhost;</span>
</code></pre><h1 id="撤销权限">撤销权限</h1><p>七、撤销已经赋予给 MySQL 用户权限的权限。</p>
<p>revoke 跟 grant 的语法差不多，只需要把关键字 “to” 换成 “from” 即可：</p>
<pre><code><span class="operator"><span class="keyword">grant</span>  <span class="keyword">all</span> <span class="keyword">on</span> *.* <span class="keyword">to</span>   dba@localhost;</span>
<span class="operator"><span class="keyword">revoke</span> <span class="keyword">all</span> <span class="keyword">on</span> *.* <span class="keyword">from</span> dba@localhost;</span>
</code></pre><h1 id="注意事项">注意事项</h1><p>八、MySQL grant、revoke 用户权限注意事项</p>
<p>grant, revoke 用户权限后，该用户只有重新连接 MySQL 数据库，权限才能生效。</p>
<p>如果想让授权的用户，也可以将这些权限 grant 给其他用户，需要选项 “grant option“</p>
<pre><code><span class="operator"><span class="keyword">grant</span> <span class="keyword">select</span> <span class="keyword">on</span> testdb.* <span class="keyword">to</span> dba@localhost <span class="keyword">with</span> <span class="keyword">grant</span> <span class="keyword">option</span>;</span>
</code></pre><p>这个特性一般用不到。实际中，数据库权限最好由 DBA 来统一管理。</p>
<hr>
<p>遇到 SELECT command denied to user ‘用户名’@’主机名’ for table ‘表名’ 这种错误，解决方法是需要把吧后面的表名授权，即是要你授权核心数据库也要。</p>
<p>我遇到的是SELECT command denied to user ‘my’@’%’ for table ‘proc’，是调用存储过程的时候出现，原以为只要把指定的数据库授权就行了，什么存储过程、函数等都不用再管了，谁知道也要把数据库mysql的proc表授权</p>
<hr>
<p>参考：<a href="http://zhidao.baidu.com/question/19633785.html" target="_blank" rel="external">http://zhidao.baidu.com/question/19633785.html</a></p>
<hr>
<p>mysql授权表共有5个表：user、db、host、tables_priv和columns_priv。</p>
<p>授权表的内容有如下用途：<br>user表<br>user表列出可以连接服务器的用户及其口令，并且它指定他们有哪种全局（超级用户）权限。在user表启用的任何权限均是全局权限，并适用于所有数据库。例如，如果你启用了DELETE权限，在这里列出的用户可以从任何表中删除记录，所以在你这样做之前要认真考虑。</p>
<p>db表<br>db表列出数据库，而用户有权限访问它们。在这里指定的权限适用于一个数据库中的所有表。</p>
<p>host表<br>host表与db表结合使用在一个较好层次上控制特定主机对数据库的访问权限，这可能比单独使用db好些。这个表不受GRANT和REVOKE语句的影响，所以，你可能发觉你根本不是用它。</p>
<p>tables_priv表<br>tables_priv表指定表级权限，在这里指定的一个权限适用于一个表的所有列。</p>
<p>columns_priv表<br>columns_priv表指定列级权限。这里指定的权限适用于一个表的特定列。</p>
<hr>
]]></content>
    <summary type="html">
    <![CDATA[<p>本文实例，运行于 MySQL 5.0 及以上版本。</p>
<p>MySQL 赋予用户权限命令的简单格式可概括为：</p>
<pre><code>grant 权限 <span class="function_start"><span class="keyword">on</span></span> 数据库对象 <span class="keyword">to</span> 用户
</code></pre>]]>
    
    </summary>
    
      <category term="mysql" scheme="http://linux48.com/tags/mysql/"/>
    
      <category term="database" scheme="http://linux48.com/categories/database/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[bitnami版gitlab修改端口]]></title>
    <link href="http://linux48.com//archives/426/"/>
    <id>http://linux48.com//archives/426/</id>
    <published>2015-06-03T08:40:42.000Z</published>
    <updated>2015-06-03T08:56:17.000Z</updated>
    <content type="html"><![CDATA[<p>bitnami版gitlab默认安装好web端口为80</p>
<p>为了便于开放到外部访问，需要把端口改为其他的，比如8080<br><a id="more"></a></p>
<h1 id="修改apache主配置文件">修改apache主配置文件</h1><pre><code>[root@iZ23m1d4vwiZ ~]# <span class="keyword">vim</span> /<span class="keyword">opt</span>/gitlab-<span class="number">6.8</span>.<span class="number">1</span>-<span class="number">0</span>/apache2/<span class="keyword">conf</span>/httpd.<span class="keyword">conf</span>

Listen <span class="number">8080</span>
</code></pre><h1 id="修改apache的bitnami的配置文件">修改apache的bitnami的配置文件</h1><pre><code>[root@iZ23m1d4vwiZ ~]<span class="comment"># vim /opt/gitlab-6.8.1-0/apache2/conf/bitnami/bitnami.conf</span>
<span class="comment"># Default Virtual Host configuration.</span>

<span class="variable">&lt;IfVersion &lt; 2.3 &gt;</span>
  NameVirtualHost *:<span class="number">8080</span>
  NameVirtualHost *:<span class="number">443</span>
<span class="variable">&lt;/IfVersion&gt;</span>

<span class="variable">&lt;VirtualHost _default_:8080&gt;</span>
  DocumentRoot <span class="string">"/opt/gitlab-6.8.1-0/apache2/htdocs"</span>
  <span class="variable">&lt;Directory "/opt/gitlab-6.8.1-0/apache2/htdocs"&gt;</span>
    Options Indexes FollowSymLinks
    AllowOverride All
    <span class="variable">&lt;IfVersion &lt; 2.3 &gt;</span>
      Order allow,deny
      Allow <span class="keyword">from</span> <span class="literal">all</span>
    <span class="variable">&lt;/IfVersion&gt;</span>
    <span class="variable">&lt;IfVersion &gt;</span>= <span class="number">2.3</span> &gt;
      Require <span class="literal">all</span> granted
    <span class="variable">&lt;/IfVersion&gt;</span>
  <span class="variable">&lt;/Directory&gt;</span>
</code></pre><h1 id="修改gitlab-shell的配置文件">修改gitlab-shell的配置文件</h1><pre><code>[root<span class="annotation">@iZ</span>23m1d4vwiZ ~]# vim <span class="regexp">/opt/</span>gitlab-<span class="number">6.8</span>.1-<span class="number">0</span><span class="regexp">/apps/</span>gitlab<span class="regexp">/gitlab-shell/</span>config.yml
# GitLab user. git by <span class="keyword">default</span>
<span class="string">user:</span> git

# Url to gitlab instance. Used <span class="keyword">for</span> api calls. Should end with a slash.
<span class="string">gitlab_url:</span> <span class="string">"http://120.26.103.123:8080/"</span>
</code></pre><h1 id="修改gitlab的apache主目录配置文件">修改gitlab的apache主目录配置文件</h1><pre><code>[root@iZ23m1d4vwiZ ~]<span class="array"># vim </span>/opt/gitlab-<span class="number">6.8</span>.1-<span class="number">0</span>/apps/gitlab/htdocs/config/gitlab.yml
<span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span>#
<span class="array"># GitLab application config file  </span>#
<span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span><span class="array"># </span>#
#
<span class="array"># How to use</span>:
<span class="array"># </span><span class="number">1.</span> copy file as gitlab.yml
<span class="array"># </span><span class="number">2.</span> Replace gitlab -&gt; host with your domain
<span class="array"># </span><span class="number">3.</span> Replace gitlab -&gt; email_from

production: &amp;base
  #
  <span class="array"># </span><span class="number">1.</span> GitLab app settings
  <span class="array"># </span>==========================

  #<span class="array"># GitLab settings</span>
  gitlab:
    #<span class="array"># Web server settings </span>(note: host is the FQDN, do not include http:<span class="comment">//)</span>
    host: <span class="number">120.26</span>.103.123
    port: <span class="number">8080</span>
    https: false
</code></pre><h1 id="重启服务">重启服务</h1><pre><code>[root@iZ23m1d4vwiZ ~]# <span class="keyword">sh</span> /<span class="keyword">opt</span>/gitlab-<span class="number">6.8</span>.<span class="number">1</span>-<span class="number">0</span>/ctlscript.<span class="keyword">sh</span>  restart
</code></pre>]]></content>
    <summary type="html">
    <![CDATA[<p>bitnami版gitlab默认安装好web端口为80</p>
<p>为了便于开放到外部访问，需要把端口改为其他的，比如8080<br>]]>
    
    </summary>
    
      <category term="git" scheme="http://linux48.com/tags/git/"/>
    
      <category term="gitlab" scheme="http://linux48.com/tags/gitlab/"/>
    
      <category term="devops" scheme="http://linux48.com/categories/devops/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Hello World]]></title>
    <link href="http://linux48.com//archives/425/"/>
    <id>http://linux48.com//archives/425/</id>
    <published>2015-05-27T16:00:00.000Z</published>
    <updated>2015-05-29T02:16:23.000Z</updated>
    <content type="html"><![CDATA[<p>Welcome to <a href="http://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="http://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="http://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<a id="more"></a>
<h2 id="Quick_Start">Quick Start</h2><h3 id="Create_a_new_post">Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run_server">Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate_static_files">Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy_to_remote_sites">Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<p>Welcome to <a href="http://hexo.io/">Hexo</a>! This is your very first post. Check <a href="http://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="http://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>]]>
    
    </summary>
    
      <category term="Hello World" scheme="http://linux48.com/categories/Hello-World/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[awstats日志分析安装]]></title>
    <link href="http://linux48.com//archives/424/"/>
    <id>http://linux48.com//archives/424/</id>
    <published>2015-03-12T16:00:00.000Z</published>
    <updated>2015-05-29T03:23:50.000Z</updated>
    <content type="html"><![CDATA[<p>Awstats是一个免费非常简洁而且强大有个性的网站日志分析工具。它可以统计您站点的如下信息：<br>一：访问量，访问次数，页面浏览量，点击数，数据流量等<br>二：精确到每月、每日、每小时的数据<br>三：访问者国家<br>四：访问者IP<br>五：Robots/Spiders的统计<br>六：访客持续时间<br>七：对不同Files type 的统计信息<br>八：Pages-URL的统计<br>九：访客操作系统浏览器等信息<br>十：其它信息（搜索关键字等等）<br><a id="more"></a></p>
<h3 id="install_awstats">install awstats</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget http://sourceforge.net/projects/awstats/files/AWStats/<span class="number">7.3</span>/awstats-<span class="number">7.3</span>.zip</span><br><span class="line">unzip awstats-<span class="number">7.3</span>.zip</span><br><span class="line">cp -R awstats-<span class="number">7.3</span> /usr/<span class="built_in">local</span>/awstats/</span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/awstats/tools/</span><br><span class="line">perl awstats_configure.pl</span><br></pre></td></tr></table></figure>
<h3 id="Set_webserver">Set webserver</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> awstats-<span class="number">7.3</span>/wwwroot</span><br><span class="line">cp -R * /home/wwwroot/awstats</span><br><span class="line"></span><br><span class="line">vim /etc/awstats/awstats.hero.conf</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       <span class="number">81</span>;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">        root   /home/wwwroot/awstats;</span><br><span class="line">        index  index.html;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">allow <span class="number">192.168</span>.<span class="number">1.3</span>;</span><br><span class="line">deny all;</span><br><span class="line"></span><br><span class="line"><span class="comment">#auth_basic            "Restricted";</span></span><br><span class="line"><span class="comment">#auth_basic_user_file  /usr/local/senginx/conf/vhosts/hero.passwd;</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="GeoIP_install">GeoIP install</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">mkdir GeoIP</span><br><span class="line"><span class="built_in">cd</span> GeoIP</span><br><span class="line"></span><br><span class="line">wget http://geolite.maxmind.com/download/geoip/database/GeoLiteCountry/GeoIP.dat.gz</span><br><span class="line">wget http://geolite.maxmind.com/download/geoip/database/GeoLiteCity.dat.gz</span><br><span class="line">wget http://geolite.maxmind.com/download/geoip/database/asnum/GeoIPASNum.dat.gz</span><br><span class="line">gunzip GeoIP.dat.gz</span><br><span class="line">gunzip GeoIPASNum.dat.gz</span><br><span class="line">gunzip GeoLiteCity.dat.gz</span><br><span class="line"></span><br><span class="line">wget http://geolite.maxmind.com/download/geoip/api/c/GeoIP-<span class="number">1.4</span>.<span class="number">8</span>.tar.gz</span><br><span class="line">tar zxvf GeoIP-<span class="number">1.4</span>.<span class="number">8</span>.tar.gz</span><br><span class="line"><span class="built_in">cd</span> GeoIP-<span class="number">1.4</span>.<span class="number">8</span>/</span><br><span class="line">libtoolize <span class="operator">-f</span></span><br><span class="line">./configure</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">wget http://geolite.maxmind.com/download/geoip/api/perl/Geo-IP-<span class="number">1.39</span>.tar.gz</span><br><span class="line">tar zxvf Geo-IP-<span class="number">1.39</span>.tar.gz</span><br><span class="line"><span class="built_in">cd</span> Geo-IP-<span class="number">1.39</span></span><br><span class="line">perl Makefile.PL LIBS=<span class="string">'-L/usr/local/lib'</span></span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">vim /etc/awstats/awstats.hero.conf</span><br><span class="line"></span><br><span class="line">LoadPlugin=<span class="string">"geoip GEOIP_STANDARD /opt/GeoIP/GeoIP.dat"</span></span><br><span class="line">LoadPlugin=<span class="string">"geoip_city_maxmind GEOIP_STANDARD /opt/GeoIP/GeoLiteCity.dat"</span></span><br><span class="line">LoadPlugin=<span class="string">"geoip_org_maxmind GEOIP_STANDARD /opt/GeoIP/GeoIPASNum.dat"</span></span><br></pre></td></tr></table></figure>
<h3 id="Set_the_log_format">Set the log format</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/<span class="built_in">local</span>/senginx/conf/vhosts/default.conf </span><br><span class="line"></span><br><span class="line"><span class="built_in">log</span>_format  awstats  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line"><span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line"><span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       <span class="number">80</span>;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /data/<span class="built_in">source</span>/;</span><br><span class="line">        index  index.php;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        root           /data/<span class="built_in">source</span>/;</span><br><span class="line">        <span class="comment">#fastcgi_pass  127.0.0.1:9000;</span></span><br><span class="line">        fastcgi_pass   unix:/usr/<span class="built_in">local</span>/php/run/php.scoket;</span><br><span class="line">        fastcgi_index  index.php;</span><br><span class="line">        fastcgi_param  SCRIPT_FILENAME  fastcgi_script_name;</span><br><span class="line">        fastcgi_buffer_size <span class="number">128</span>k;</span><br><span class="line">        fastcgi_buffers <span class="number">4</span> <span class="number">128</span>k;</span><br><span class="line">        fastcgi_busy_buffers_size <span class="number">256</span>k;</span><br><span class="line">        fastcgi_temp_file_write_size <span class="number">256</span>k;</span><br><span class="line">        include      fastcgi.conf;</span><br><span class="line">        <span class="comment">#include        fastcgi_params;</span></span><br><span class="line">    &#125;</span><br><span class="line">        access_<span class="built_in">log</span> logs/access.log awstats;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vim /etc/awstats/awstats.hero.conf </span><br><span class="line">LogFile=<span class="string">"/app/local/senginx/logs/access_%YYYY-24%MM-24%DD-24.log"</span></span><br></pre></td></tr></table></figure>
<h3 id="Set_crontab">Set crontab</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat /opt/scripts/cut_nginx_logs.sh</span><br><span class="line"><span class="shebang">#!/bin/bash</span></span><br><span class="line">logs_path=<span class="string">"/app/local/senginx/logs/"</span></span><br><span class="line">mv <span class="variable">$&#123;logs_path&#125;</span>access.log <span class="variable">$&#123;logs_path&#125;</span>access_$(date <span class="operator">-d</span> <span class="string">"yesterday"</span> +<span class="string">"%Y%m%d"</span>).log</span><br><span class="line">/app/<span class="built_in">local</span>/senginx/sbin/nginx <span class="operator">-s</span> reload</span><br><span class="line"></span><br><span class="line">cat /opt/scripts/awstats.sh</span><br><span class="line"><span class="shebang">#!/bin/bash</span></span><br><span class="line">perl /usr/<span class="built_in">local</span>/awstats/tools/awstats_buildstaticpages.pl -update -config=hero -lang=cn -dir=/app/data/site/awstats/ -awstatsprog=/usr/<span class="built_in">local</span>/awstats/wwwroot/cgi-bin/awstats.pl</span><br><span class="line"></span><br><span class="line"><span class="number">01</span> <span class="number">00</span> * * * sh /opt/scripts/cut_nginx_logs.sh</span><br><span class="line"><span class="number">10</span> <span class="number">00</span> * * * sh /opt/scripts/awstats.sh</span><br></pre></td></tr></table></figure>]]></content>
    <summary type="html">
    <![CDATA[<p>Awstats是一个免费非常简洁而且强大有个性的网站日志分析工具。它可以统计您站点的如下信息：<br>一：访问量，访问次数，页面浏览量，点击数，数据流量等<br>二：精确到每月、每日、每小时的数据<br>三：访问者国家<br>四：访问者IP<br>五：Robots/Spiders的统计<br>六：访客持续时间<br>七：对不同Files type 的统计信息<br>八：Pages-URL的统计<br>九：访客操作系统浏览器等信息<br>十：其它信息（搜索关键字等等）<br>]]>
    
    </summary>
    
      <category term="awstats" scheme="http://linux48.com/tags/awstats/"/>
    
      <category term="log" scheme="http://linux48.com/tags/log/"/>
    
      <category term="monitor" scheme="http://linux48.com/categories/monitor/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[H3C划分VLAN命令]]></title>
    <link href="http://linux48.com//archives/423/"/>
    <id>http://linux48.com//archives/423/</id>
    <published>2015-03-06T16:00:00.000Z</published>
    <updated>2015-05-29T03:23:50.000Z</updated>
    <content type="html"><![CDATA[<h3 id="H3C命令">H3C命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">华为默认不是access，先修改为access，在把接口加入到vlan中，</span><br><span class="line">批量修改</span><br><span class="line">[sw1]port-group <span class="number">1</span> </span><br><span class="line">[sw1-port-group-<span class="number">1</span>]group-member GigabitEthernet <span class="number">0</span>/<span class="number">0</span>/<span class="number">1</span> to GigabitEthernet <span class="number">0</span>/<span class="number">0</span>/<span class="number">48</span> 将端口加入到组</span><br><span class="line">[sw1-port-group-<span class="number">1</span>]port link-type access</span><br><span class="line"></span><br><span class="line">vlan <span class="number">1</span></span><br><span class="line">port GigabitEthernet <span class="number">0</span>/<span class="number">0</span>/<span class="number">1</span></span><br><span class="line"></span><br><span class="line">&lt;h3c&gt;reset save  删除搜索配置文件（需重启生效）</span><br><span class="line">&lt;h3c&gt;save        保存配置文件</span><br><span class="line">&lt;h3c&gt;reboot      重启</span><br></pre></td></tr></table></figure>
<p>参考 <a href="http://skypegnu1.blog.51cto.com/8991766/1586778" target="_blank" rel="external">http://skypegnu1.blog.51cto.com/8991766/1586778</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<h3 id="H3C命令">H3C命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line"]]>
    </summary>
    
      <category term="h3c" scheme="http://linux48.com/tags/h3c/"/>
    
      <category term="vlan" scheme="http://linux48.com/tags/vlan/"/>
    
      <category term="路由交换" scheme="http://linux48.com/categories/%E8%B7%AF%E7%94%B1%E4%BA%A4%E6%8D%A2/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[redis简易安装]]></title>
    <link href="http://linux48.com//archives/422/"/>
    <id>http://linux48.com//archives/422/</id>
    <published>2015-03-04T16:00:00.000Z</published>
    <updated>2015-05-29T03:23:50.000Z</updated>
    <content type="html"><![CDATA[<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">yum -y install make gcc gcc-c++ tcl</span><br><span class="line">wget http://download.redis.io/releases/redis-<span class="number">2.8</span>.<span class="number">19</span>.tar.gz</span><br><span class="line">tar zxvf redis-<span class="number">2.8</span>.<span class="number">19</span>.tar.gz</span><br><span class="line"><span class="built_in">cd</span> redis-<span class="number">2.8</span>.<span class="number">19</span></span><br><span class="line">chmod <span class="number">777</span> -R *</span><br><span class="line">make PREFIX=/usr/<span class="built_in">local</span>/redis-<span class="number">2.8</span>.<span class="number">19</span>  MALLOC=libc install</span><br><span class="line">cp ./redis.conf /usr/<span class="built_in">local</span>/redis-<span class="number">2.8</span>.<span class="number">19</span>/</span><br><span class="line">mkdir -p  /data/redisdb</span><br><span class="line">vim /usr/<span class="built_in">local</span>/redis-<span class="number">2.8</span>.<span class="number">19</span>/redis.conf</span><br><span class="line">nohup /usr/<span class="built_in">local</span>/redis-<span class="number">2.8</span>.<span class="number">19</span>/bin/redis-server /usr/<span class="built_in">local</span>/redis-<span class="number">2.8</span>.<span class="number">19</span>/redis.conf &amp;</span><br><span class="line">/usr/<span class="built_in">local</span>/redis-<span class="number">2.8</span>.<span class="number">19</span>/bin/redis-cli</span><br></pre></td></tr></table></figure>]]></content>
    <summary type="html">
    <![CDATA[<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class=]]>
    </summary>
    
      <category term="nosql" scheme="http://linux48.com/tags/nosql/"/>
    
      <category term="redis" scheme="http://linux48.com/tags/redis/"/>
    
      <category term="database" scheme="http://linux48.com/categories/database/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[多版本php共存搭建]]></title>
    <link href="http://linux48.com//archives/421/"/>
    <id>http://linux48.com//archives/421/</id>
    <published>2015-01-29T16:00:00.000Z</published>
    <updated>2015-05-29T03:56:36.000Z</updated>
    <content type="html"><![CDATA[<h1 id="应用环境">应用环境</h1><p>LNMP的环境，当前PHP版本5.3.28，遇到一个应用需求只支持PHP 5.5.21，又希望保持现有应用还是用PHP 5.3.28。也就是说需要两个版本的PHP同时存在，供nginx根据需要调用不同版本。</p>
<h1 id="思路">思路</h1><p>Nginx是通过PHP-FastCGI与PHP交互的。而PHP-FastCGI运行后会通过文件、或本地端口两种方式进行监听，<a id="more"></a>在Nginx中配置相应的FastCGI监听端口或文件即实现Nginx请求对PHP的解释。</p>
<p>既然PHP-FastCGI是监听端口和文件的，那就可以让不同版本的PHP-FastCGI同时运行，监听不同的端口或文件，Nginx中根据需求配置调用不同的PHP-FastCGI端口或文件，即可实现不同版本PHP共存了。</p>
<h1 id="配置记录">配置记录</h1><p>下面记录简单的配置流程，基于已经安装了lnmp的centos环境。当前版本的PHP是5.3.28，位于/app/local/php5.3.28,下面安装php5.5.21</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./configure  --with-openssl --prefix=/app/<span class="built_in">local</span>/php5.<span class="number">5.21</span> --with-config-file-path=/app/<span class="built_in">local</span>/php5.<span class="number">5.21</span>/etc --with-jpeg-dir --with-png-dir --with-zlib --enable-xml --disable-rpath --enable-safe-mode --enable-bcmath --enable-shmop --enable-sysvsem --enable-inline-optimization --with-curl --with-curlwrappers --enable-mbregex --enable-fpm --enable-mbstring --with-mcrypt --with-gd --enable-gd-native-ttf --with-mhash --enable-pcntl --enable-ftp --enable-zip --with-pdo-mysql=mysqlnd --enable-fpm --with-mysql=mysqlnd --with-mysqli=mysqlnd --with-freetype-dir</span><br><span class="line"></span><br><span class="line">make</span><br><span class="line"></span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<p>设置php的监听socket或者端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost <span class="built_in">local</span>]<span class="comment"># cat /app/local/php5.5.21/etc/php-fpm.conf |grep -v ";"       </span></span><br><span class="line"></span><br><span class="line">[global]</span><br><span class="line">pid = run/php-fpm.pid</span><br><span class="line">error_<span class="built_in">log</span> = <span class="built_in">log</span>/php-fpm.log</span><br><span class="line"></span><br><span class="line">[www]</span><br><span class="line">user = www</span><br><span class="line">group = www</span><br><span class="line"></span><br><span class="line">listen = run/php.scoket      </span><br><span class="line">;注意若果是监听端口则是 listen = <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">9001</span></span><br><span class="line"></span><br><span class="line">listen.owner = www</span><br><span class="line">listen.group = www</span><br><span class="line"> </span><br><span class="line">pm = static</span><br><span class="line">pm.max_children = <span class="number">250</span></span><br><span class="line">pm.start_servers = <span class="number">2</span></span><br><span class="line">pm.min_spare_servers = <span class="number">1</span></span><br><span class="line">pm.max_spare_servers = <span class="number">3</span></span><br><span class="line">pm.status_path = /php-fpm_status</span><br></pre></td></tr></table></figure>
<p>其他参数根据服务器环境和需求自行定制。</p>
<p>启动php-fpm</p>
<pre><code><span class="regexp">/app/</span>local<span class="regexp">/php5.5.21/</span>sbin<span class="regexp">/php-fpm</span>
</code></pre><h1 id="nginx配置">nginx配置</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen <span class="number">80</span>;</span><br><span class="line">        server_name test.com;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        index index.php index.html index.htm;</span><br><span class="line">        root  /www/<span class="built_in">test</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        error_page   <span class="number">404</span>     /<span class="number">404</span>.html;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        location ~ \.php$ &#123;</span><br><span class="line">            root           /www/<span class="built_in">test</span>;</span><br><span class="line">            fastcgi_pass   unix:/app/<span class="built_in">local</span>/php5.<span class="number">5.21</span>/run/php.scoket;</span><br><span class="line">            <span class="comment">#fastcgi_pass 127.0.0.1:9001; </span></span><br><span class="line">            fastcgi_index  index.php;</span><br><span class="line">            fastcgi_param  SCRIPT_FILENAME  fastcgi_script_name;</span><br><span class="line">            include        fastcgi.conf;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>今天安装好后nginx打开502，google了一下这位大神的文章<a href="http://xuanwobbs.com.cn/archives/2014-05/php5-5-12-502.html" target="_blank" rel="external">php5.5.12产生502错误解决方法</a>解决了</p>
<blockquote>
<ul>
<li><p>如果有更多个php版本安装也是如此，此方法也可以适用于平滑升级php版本</p>
</li>
<li><p>一个版本的php也可以指定相关配置文件来启动多个php的master,启动命令如下</p>
</li>
</ul>
</blockquote>
<pre><code><span class="regexp">/app/</span>local<span class="regexp">/php5.3.28/</span>sbin<span class="regexp">/php-fpm -c /</span>app<span class="regexp">/local/</span>php5.<span class="number">3.28</span><span class="regexp">/etc/</span>php2.ini -y <span class="regexp">/app/</span>local<span class="regexp">/php5.3.28/</span>etc<span class="regexp">/php-fpm2.conf </span>
</code></pre><p>show一下</p>
<pre><code>[root<span class="annotation">@localhost</span> local]# ps -ef |grep php5
root     <span class="number">16756</span>     <span class="number">1</span>  <span class="number">0</span> Jan29 ?        00:<span class="number">00</span>:<span class="number">08</span> php-<span class="string">fpm:</span> master process (<span class="regexp">/app/</span>local<span class="regexp">/php5.3.28/</span>etc/php-fpm2.conf)                                                
root     <span class="number">16782</span>     <span class="number">1</span>  <span class="number">0</span> Jan29 ?        00:<span class="number">00</span>:<span class="number">15</span> php-<span class="string">fpm:</span> master process (<span class="regexp">/app/</span>local<span class="regexp">/php5.3.28/</span>etc/php-fpm.conf)
root     <span class="number">23499</span>     <span class="number">1</span>  <span class="number">0</span> Jan30 ?        00:<span class="number">00</span>:<span class="number">09</span> php-<span class="string">fpm:</span> master process (<span class="regexp">/app/</span>local<span class="regexp">/php5.5.21/</span>etc/php-fpm.conf)
root     <span class="number">44108</span> <span class="number">42716</span>  <span class="number">0</span> <span class="number">16</span>:<span class="number">36</span> pts/<span class="number">0</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> grep php5
[root<span class="annotation">@localhost</span> local]# 
</code></pre>]]></content>
    <summary type="html">
    <![CDATA[<h1 id="应用环境">应用环境</h1><p>LNMP的环境，当前PHP版本5.3.28，遇到一个应用需求只支持PHP 5.5.21，又希望保持现有应用还是用PHP 5.3.28。也就是说需要两个版本的PHP同时存在，供nginx根据需要调用不同版本。</p>
<h1 id="思路">思路</h1><p>Nginx是通过PHP-FastCGI与PHP交互的。而PHP-FastCGI运行后会通过文件、或本地端口两种方式进行监听，]]>
    
    </summary>
    
      <category term="lnmp" scheme="http://linux48.com/tags/lnmp/"/>
    
      <category term="php" scheme="http://linux48.com/tags/php/"/>
    
      <category term="php" scheme="http://linux48.com/categories/php/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[shadowsocks的python和nodejs版搭建]]></title>
    <link href="http://linux48.com//archives/420/"/>
    <id>http://linux48.com//archives/420/</id>
    <published>2015-01-20T16:00:00.000Z</published>
    <updated>2015-05-29T03:23:50.000Z</updated>
    <content type="html"><![CDATA[<p>shadowsocks的nodejs版的不是很稳定，今天又搞了一台香港的机器，果断换成python试试，果然给力<a id="more"></a></p>
<h2 id="nodejs版搭建">nodejs版搭建</h2><p>nodejs环境搭建参见 <a href="https://gist.github.com/koy1619/3479170a3a763ffd8869" target="_blank" rel="external">https://gist.github.com/koy1619/3479170a3a763ffd8869</a></p>
<pre><code>git <span class="built_in">clone</span> https://github.com/shadowsocks/shadowsocks-nodejs.git

<span class="built_in">cd</span> shadowsocks-nodejs

vim config.json

{
<span class="string">"server"</span>:<span class="string">".0.0.0.0"</span>,
<span class="string">"server_port"</span>:<span class="number">8388</span>,
<span class="string">"local_address"</span>:<span class="string">"0.0.0.0"</span>,
<span class="string">"local_port"</span>:<span class="number">1080</span>,
<span class="string">"password"</span>:<span class="string">"barfoo!"</span>,
<span class="string">"timeout"</span>:<span class="number">600</span>,
<span class="string">"method"</span>:<span class="string">"aes-256-cfb"</span>
}
</code></pre><p>启动服务</p>
<pre><code><span class="label">nohup</span> /<span class="preprocessor">opt</span>/shadowsocks-nodejs/<span class="keyword">bin/ssserver </span>&amp;
<span class="label">nohup</span> /<span class="preprocessor">opt</span>/shadowsocks-nodejs/<span class="keyword">bin/sslocal </span>&amp;
</code></pre><p>查看进程</p>
<pre><code><span class="attr_selector">[root@test ~]</span># <span class="tag">ps</span> <span class="tag">-ef</span> |<span class="tag">grep</span>  <span class="tag">node</span>
<span class="tag">root</span>     <span class="tag">12969</span>     <span class="tag">1</span>  <span class="tag">0</span> <span class="tag">Jan16</span> ?        <span class="tag">00</span><span class="pseudo">:02</span><span class="pseudo">:07</span> <span class="tag">node</span> /<span class="tag">opt</span>/<span class="tag">shadowsocks-nodejs</span>/<span class="tag">bin</span>/<span class="tag">ssserver</span>
<span class="tag">root</span>     <span class="tag">12971</span>     <span class="tag">1</span>  <span class="tag">0</span> <span class="tag">Jan16</span> ?        <span class="tag">00</span><span class="pseudo">:02</span><span class="pseudo">:05</span> <span class="tag">node</span> /<span class="tag">opt</span>/<span class="tag">shadowsocks-nodejs</span>/<span class="tag">bin</span>/<span class="tag">sslocal</span>
<span class="tag">root</span>     <span class="tag">15118</span> <span class="tag">15104</span>  <span class="tag">0</span> <span class="tag">15</span><span class="pseudo">:48</span> <span class="tag">pts</span>/<span class="tag">0</span>    <span class="tag">00</span><span class="pseudo">:00</span><span class="pseudo">:00</span> <span class="tag">grep</span> <span class="tag">node</span>
</code></pre><p>nodejs版的不是很稳定，今天又搞了一台香港的机器，果断换成python试试，果然给力</p>
<h2 id="python版搭建">python版搭建</h2><pre><code>yum -y <span class="keyword">install</span> python-setuptools &amp;&amp; easy_install pip
yum -y <span class="keyword">install</span> python-pip libevent python-devel git m2crypto
pip <span class="keyword">install</span> shadowsocks
pip <span class="keyword">install</span> gevent
pip <span class="keyword">install</span> M2Crypto
pip <span class="keyword">install</span> shadowsocks
mkdir -p /etc/shadowsocks

vim /etc/shadowsocks/config.json

{
<span class="string">"server"</span>:<span class="string">"0.0.0.0"</span>,
<span class="string">"server_port"</span>:<span class="number">8388</span>,
<span class="string">"local_address"</span>:<span class="string">"0.0.0.0"</span>,
<span class="string">"local_port"</span>:<span class="number">1080</span>,
<span class="string">"password"</span>:<span class="string">"barfoo!"</span>,
<span class="string">"timeout"</span>:<span class="number">600</span>,
<span class="string">"method"</span>:<span class="string">"table"</span>
}
</code></pre><p>启动服务</p>
<pre><code><span class="built_in">cd</span> /etc/shadowsocks
nohup ssserver &amp;
nohup sslocal &amp;
</code></pre><p>查看进程</p>
<pre><code><span class="attr_selector">[root@10-8-1-5 ~]</span># <span class="tag">ps</span> <span class="tag">-ef</span> |<span class="tag">grep</span> <span class="tag">python</span>  
<span class="tag">root</span>     <span class="tag">22599</span>     <span class="tag">1</span>  <span class="tag">0</span> <span class="tag">12</span><span class="pseudo">:36</span> ?        <span class="tag">00</span><span class="pseudo">:00</span><span class="pseudo">:07</span> /<span class="tag">usr</span>/<span class="tag">bin</span>/<span class="tag">python</span> /<span class="tag">usr</span>/<span class="tag">bin</span>/<span class="tag">ssserver</span>
<span class="tag">root</span>     <span class="tag">22604</span>     <span class="tag">1</span>  <span class="tag">0</span> <span class="tag">12</span><span class="pseudo">:36</span> ?        <span class="tag">00</span><span class="pseudo">:00</span><span class="pseudo">:07</span> /<span class="tag">usr</span>/<span class="tag">bin</span>/<span class="tag">python</span> /<span class="tag">usr</span>/<span class="tag">bin</span>/<span class="tag">sslocal</span>
<span class="tag">root</span>     <span class="tag">22797</span> <span class="tag">22772</span>  <span class="tag">0</span> <span class="tag">15</span><span class="pseudo">:54</span> <span class="tag">pts</span>/<span class="tag">1</span>    <span class="tag">00</span><span class="pseudo">:00</span><span class="pseudo">:00</span> <span class="tag">grep</span> <span class="tag">python</span>
<span class="attr_selector">[root@10-8-1-5 ~]</span># 
</code></pre><p>需要注意防火墙开放<strong>local_port</strong>的端口号</p>
<p>Google Chrome浏览器安装SwitchyOmega插件导入下面的备份修改server地址即可使用。</p>
<ul>
<li><a href="http://pan.baidu.com/s/1pJ8zfv1" title="备份点我" target="_blank" rel="external">备份点我</a></li>
</ul>
]]></content>
    <summary type="html">
    <![CDATA[<p>shadowsocks的nodejs版的不是很稳定，今天又搞了一台香港的机器，果断换成python试试，果然给力]]>
    
    </summary>
    
      <category term="nodejs" scheme="http://linux48.com/tags/nodejs/"/>
    
      <category term="python" scheme="http://linux48.com/tags/python/"/>
    
      <category term="shadowsocks" scheme="http://linux48.com/tags/shadowsocks/"/>
    
      <category term="shadowsocks" scheme="http://linux48.com/categories/shadowsocks/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[linux下删除乱码文件]]></title>
    <link href="http://linux48.com//archives/419/"/>
    <id>http://linux48.com//archives/419/</id>
    <published>2015-01-08T16:00:00.000Z</published>
    <updated>2015-05-29T03:23:50.000Z</updated>
    <content type="html"><![CDATA[<p>根据inode 来修改或删除linux 下乱码的文件<a id="more"></a></p>
<ol>
<li><p>创建测试文件：<br> touch 1?.txt</p>
</li>
<li><p>查询inode ：</p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[oracle@<span class="built_in">test</span>]$ ll -i</span><br><span class="line">total <span class="number">14694452</span></span><br><span class="line"><span class="number">17956913</span> -rw-r--r-- <span class="number">1</span> oracle oinstall          <span class="number">0</span> Jan <span class="number">18</span> <span class="number">20</span>:<span class="number">24</span> <span class="number">1</span>?.txt</span><br></pre></td></tr></table></figure>
<ol>
<li>修改测试文件名：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -inum <span class="number">17956913</span> -exec mv &#123;&#125; file.txt \;</span><br></pre></td></tr></table></figure>
<ol>
<li>检查修改结果</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[oracle@<span class="built_in">test</span>]$ ll</span><br><span class="line">total <span class="number">14694452</span></span><br><span class="line">....</span><br><span class="line">-rw-r--r-- <span class="number">1</span> oracle oinstall          <span class="number">0</span> Jan <span class="number">18</span> <span class="number">20</span>:<span class="number">24</span> file.txt</span><br></pre></td></tr></table></figure>
<p>记录：删除乱码的文件可使用</p>
<pre><code>find . -inum <span class="number">17956913</span> -exec rm {} \<span class="comment">;</span>
</code></pre>]]></content>
    <summary type="html">
    <![CDATA[<p>根据inode 来修改或删除linux 下乱码的文件]]>
    
    </summary>
    
      <category term="os" scheme="http://linux48.com/tags/os/"/>
    
      <category term="rm" scheme="http://linux48.com/tags/rm/"/>
    
      <category term="乱码" scheme="http://linux48.com/tags/%E4%B9%B1%E7%A0%81/"/>
    
      <category term="os" scheme="http://linux48.com/categories/os/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[ruby环境sass编译中文出现 Invalid GBK character]]></title>
    <link href="http://linux48.com//archives/418/"/>
    <id>http://linux48.com//archives/418/</id>
    <published>2015-01-06T16:00:00.000Z</published>
    <updated>2015-05-29T03:23:50.000Z</updated>
    <content type="html"><![CDATA[<p>sass文件编译时候使用ruby环境，无论是界面化的koala工具还是命令行模式的都无法通过，真是令人烦恼。</p>
<p>容易出现中文注释时候无法编译通过，或者出现乱码，找了几天的解决方法终于解决了。</p>
<p>这个问题的奇葩之处在于在xp环境中没有任何问题，只是在windows7环境中才出现的这个。</p>
<p>sass编译时候出现如下错误的解决方法：</p>
<pre><code>Syntax <span class="keyword">error</span>: Invalid GBK <span class="property">character</span> <span class="string">"\xE5"</span>
</code></pre><p>解决办法：</p>
<p>找到ruby的安装目录，里面也有sass模块，<a id="more"></a>如这个路径：</p>
<pre><code>C:<span class="command">\Ruby</span>21-x64<span class="command">\lib</span><span class="command">\ruby</span><span class="command">\gems</span>\2.1.0<span class="command">\gems</span><span class="command">\sass</span>-3.4.8<span class="command">\lib</span><span class="command">\sass</span>.rb
</code></pre><p>在这个文件里面engine.rb，添加一行代码（同方法1）</p>
<pre><code>Encoding<span class="class">.default_external</span> = Encoding.<span class="function"><span class="title">find</span><span class="params">(<span class="string">'utf-8'</span>)</span></span>
</code></pre><p>放在所有的require XXXX 之后即可。</p>
<p>参考： <a href="https://github.com/imathis/octopress/issues/232" target="_blank" rel="external">https://github.com/imathis/octopress/issues/232</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<p>sass文件编译时候使用ruby环境，无论是界面化的koala工具还是命令行模式的都无法通过，真是令人烦恼。</p>
<p>容易出现中文注释时候无法编译通过，或者出现乱码，找了几天的解决方法终于解决了。</p>
<p>这个问题的奇葩之处在于在xp环境中没有任何问题，只是在windows7环境中才出现的这个。</p>
<p>sass编译时候出现如下错误的解决方法：</p>
<pre><code>Syntax <span class="keyword">error</span>: Invalid GBK <span class="property">character</span> <span class="string">"\xE5"</span>
</code></pre><p>解决办法：</p>
<p>找到ruby的安装目录，里面也有sass模块，]]>
    
    </summary>
    
      <category term="ruby" scheme="http://linux48.com/tags/ruby/"/>
    
      <category term="dev" scheme="http://linux48.com/categories/dev/"/>
    
  </entry>
  
</feed>