<!DOCTYPE html><html><head><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta charset="utf-8"><title>MySQL高可用之MHA - linux48</title><meta name="description" content=""><meta name="author" content=""><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1"><link rel="stylesheet" href="assets/css/bulma.min.css"><link rel="stylesheet" href="assets/css/app.css"><!--[if lt IE 9]>
<script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.2/html5shiv.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]--><link rel="shortcut icon" href=""></head><body><nav class="columns navbar"><div class="column logo is-3 is-offset-1"><a class="is-brand" href="index.html">linux48</a></div></nav><div class="columns content"><div class="column is-2-desktop is-3-widescreen is-hidden-touch"></div><div class="column article-container is-11-tablet is-8-desktop is-6-widescreen"><div class="breadcrumb-area"><a href="index.html" class="breadcrumb-item">Home</a><span class="breadcrumb-delimiter"> &gt; </span><a href="2018-12-11-mha.html" class="breadcrumb-item">MySQL高可用之MHA</a></div><h1 class="article-title">MySQL高可用之MHA</h1><p>作者：<a href="http://linux48.com" target="_blank">Chris</a></p><div class="article"><h2 id="mha简介">MHA简介 <a class="markdownIt-Anchor" href="#mha简介">#</a></h2><p><strong>MHA</strong>，即<code>MasterHigh Availability Manager and Tools for MySQL</code>，是日本的一位MySQL专家采用Perl语言编写的一个脚本管理工具，该工具仅适用于MySQLReplication（二层）环境，目的在于维持Master主库的高可用性。</p><p><code>MHA(Master High Availability)</code>是自动的master故障转移和Slave提升的软件包.它是基于标准的MySQL复制(异步/半同步).</p><p>MHA有两部分组成:<strong>MHA Manager(管理节点)</strong>和<strong>MHA Node(数据节点)</strong>.</p><p><strong>MHA Manager</strong>可以单独部署在一台独立机器上管理多个master-slave集群,也可以部署在一台slave上.<strong>MHA Manager</strong>探测集群的node节点,当发现master出现故障的时候,它可以自动将具有最新数据的slave提升为新的master,然后将所有其它的slave导向新的master上.整个故障转移过程对应用程序是透明的。</p><p>MHA node运行在每台MySQL服务器上(master/slave/manager),它通过监控具备解析和清理logs功能的脚本来加快故障转移的。</p><h2 id="工作原理">工作原理 <a class="markdownIt-Anchor" href="#工作原理">#</a></h2><p>其工作原理我个人认为有以下几点：</p><blockquote><ul><li>MHA从代码层面看，就是一套Perl脚本集合</li><li>MHA安装本质其实就是把perl脚本执行文件解压并安装perl依赖包</li><li>通过授权mysql账户和ssh互信来达到通过mha-manager使用perl脚本调用linux mysql命令实时检测控制各个node故障转移</li><li>mha-manager使用perl脚本来动态切换VIP以达到高可用</li><li>......</li></ul></blockquote><p>其详细工作过程网上一大把不在赘述。。。</p><h2 id="install">INSTALL <a class="markdownIt-Anchor" href="#install">#</a></h2><p>废话不多说，开搞！！！</p><p>目前MHA主要支持一主多从的架构，要搭建MHA,要求一个复制集群中必须最少有三台数据库服务器，一主二从，即一台充当master，一台充当备用master，另外一台充当从库，因为至少需要三台服务器</p><p>我们自己使用其实也可以使用1主1从，但是master主机宕机后无法切换，以及无法补全binlog。master的mysqld进程crash后，还是可以切换成功，以及补全binlog的。</p><table><thead><tr><th style="text-align:center">IP</th><th style="text-align:center">OS</th><th style="text-align:center">mysql</th><th style="text-align:center">node</th><th style="text-align:center">MHA</th></tr></thead><tbody><tr><td style="text-align:center">192.168.179.128</td><td style="text-align:center">CentOS 7.3</td><td style="text-align:center">5.7.22</td><td style="text-align:center">master</td><td style="text-align:center">mha-node</td></tr><tr><td style="text-align:center">192.168.179.129</td><td style="text-align:center">CentOS 7.3</td><td style="text-align:center">5.7.22</td><td style="text-align:center">slave</td><td style="text-align:center">mha-manager &amp; mha-node</td></tr></tbody></table><p><strong><code>vip 192.168.179.130</code></strong><br><strong><code>VMware® Workstation 14 Pro</code></strong></p><h3 id="配置主从，vip，ssh互信，授权mysql管理账户">配置主从，VIP，SSH互信，授权mysql管理账户 <a class="markdownIt-Anchor" href="#配置主从，vip，ssh互信，授权mysql管理账户">#</a></h3><pre class="hljs"><code><span class="hljs-comment">-- 128 129(配置mysql复制用户)</span>
<span class="hljs-keyword">grant</span> <span class="hljs-keyword">replication</span> <span class="hljs-keyword">slave</span> <span class="hljs-keyword">on</span> *.* <span class="hljs-keyword">to</span> <span class="hljs-string">'repl'</span>@<span class="hljs-string">'192.168.179.129'</span>  <span class="hljs-keyword">identified</span> <span class="hljs-keyword">by</span> <span class="hljs-string">'repl'</span>;
<span class="hljs-keyword">grant</span> all <span class="hljs-keyword">on</span> *.* <span class="hljs-keyword">to</span> <span class="hljs-string">'root'</span>@<span class="hljs-string">'192.168.179.129'</span>  <span class="hljs-keyword">identified</span> <span class="hljs-keyword">by</span> <span class="hljs-string">'123'</span>;
<span class="hljs-keyword">flush</span> <span class="hljs-keyword">privileges</span>;

<span class="hljs-keyword">grant</span> <span class="hljs-keyword">replication</span> <span class="hljs-keyword">slave</span> <span class="hljs-keyword">on</span> *.* <span class="hljs-keyword">to</span> <span class="hljs-string">'repl'</span>@<span class="hljs-string">'192.168.179.128'</span>  <span class="hljs-keyword">identified</span> <span class="hljs-keyword">by</span> <span class="hljs-string">'repl'</span>;
<span class="hljs-keyword">grant</span> all <span class="hljs-keyword">on</span> *.* <span class="hljs-keyword">to</span> <span class="hljs-string">'root'</span>@<span class="hljs-string">'192.168.179.128'</span>  <span class="hljs-keyword">identified</span> <span class="hljs-keyword">by</span> <span class="hljs-string">'123'</span>;
<span class="hljs-keyword">flush</span> <span class="hljs-keyword">privileges</span>;


<span class="hljs-comment">-- 128 129(配置mysql的mha监控用户)</span>
<span class="hljs-keyword">grant</span> all <span class="hljs-keyword">privileges</span> <span class="hljs-keyword">on</span> *.* <span class="hljs-keyword">to</span> <span class="hljs-string">'view'</span>@<span class="hljs-string">'192.168.179.129'</span> <span class="hljs-keyword">identified</span>  <span class="hljs-keyword">by</span> <span class="hljs-string">'view123'</span>;
<span class="hljs-keyword">flush</span> <span class="hljs-keyword">privileges</span>;

<span class="hljs-keyword">grant</span> all <span class="hljs-keyword">privileges</span> <span class="hljs-keyword">on</span> *.* <span class="hljs-keyword">to</span> <span class="hljs-string">'view'</span>@<span class="hljs-string">'192.168.179.128'</span> <span class="hljs-keyword">identified</span>  <span class="hljs-keyword">by</span> <span class="hljs-string">'view123'</span>;
<span class="hljs-keyword">flush</span> <span class="hljs-keyword">privileges</span>;

<span class="hljs-comment">-- #公钥互信</span>
ssh-keygen
128和129互传公钥

#本机也要加
128# cat ~/.ssh/id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys
129# cat ~/.ssh/id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys

</code></pre><pre class="hljs"><code>-- 128(master)
/sbin/ifconfig ens33:1 192.168.179.130/24
<span class="hljs-comment"># ip addr add 192.168.179.130/24 dev ens33:1</span>
<span class="hljs-comment"># ip addr del 192.168.179.130/24 dev ens33:1</span>
ip addr |grep <span class="hljs-string">'192.168.179.130'</span>
show master status;


-- 129(slave)
CHANGE MASTER TO  MASTER_HOST=<span class="hljs-string">'192.168.179.129'</span>,MASTER_USER=<span class="hljs-string">'repl'</span>,MASTER_PASSWORD=<span class="hljs-string">'repl'</span>,MASTER_LOG_FILE=<span class="hljs-string">'mysql-bin.000005'</span>,MASTER_LOG_POS=3340; 
start slave;
</code></pre><h3 id="install-mha">INSTALL MHA <a class="markdownIt-Anchor" href="#install-mha">#</a></h3><pre class="hljs"><code>-- 129(slave)


rpm -ivh http://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
<span class="hljs-comment"># rpm -ivh http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</span>


yum install perl-DBD-MySQL perl-Config-Tiny perl-Log-Dispatch perl-Parallel-ForkManager perl-Time-HiRes   --skip-broken  -y

yum install -y perl-ExtUtils-CBuilder perl-ExtUtils-MakeMaker

yum -y install perl-CPAN

yum install -y perl-Mail-Sender 

yum install -y perl-Log-Dispatch


tar xf mha4mysql-manager-0.56.tar.gz
<span class="hljs-built_in">cd</span> mha4mysql-manager-0.56
perl Makefile.PL
make &amp;&amp; make install

tar xf mha4mysql-node-0.56.tar.gz 
<span class="hljs-built_in">cd</span> mha4mysql-node-0.56
perl Makefile.PL
make &amp;&amp; make install


-- 128(master) only install mha4mysql-node


cat /usr/<span class="hljs-built_in">local</span>/bin/master_ip_failover
cat /usr/<span class="hljs-built_in">local</span>/bin/master_ip_online_change
cat /usr/<span class="hljs-built_in">local</span>/bin/load_cnf
cat /data/mha/3306/mha.cnf
</code></pre><h2 id="check-mha">CHECK MHA <a class="markdownIt-Anchor" href="#check-mha">#</a></h2><pre class="hljs"><code>-- 129 mha-manager


<span class="hljs-comment"># 检查ssh连接</span>
masterha_check_ssh --conf=/data/mha/3306/mha.cnf

<span class="hljs-comment"># 检查主从</span>
masterha_check_repl --conf=/data/mha/3306/mha.cnf

<span class="hljs-comment"># 手动切换主从</span>
masterha_master_switch --master_state=alive --conf=/data/mha/3306/mha.cnf --new_master_host=192.168.179.129 --new_master_port=3306 --orig_master_is_new_slave

<span class="hljs-comment"># 检查mha状态</span>
masterha_check_status --conf=/data/mha/3306/mha.cnf

<span class="hljs-comment"># 启动mha_manager</span>
nohup /usr/<span class="hljs-built_in">local</span>/bin/masterha_manager --conf=/data/mha/3306/mha.cnf --ignore_last_failover &gt;&gt; /data/mha/3306/<span class="hljs-built_in">log</span>/manager.log 2&gt;&amp;1 &amp;
</code></pre><h2 id="test">TEST... <a class="markdownIt-Anchor" href="#test">#</a></h2><h2 id="修复宕机的master">修复宕机的Master <a class="markdownIt-Anchor" href="#修复宕机的master">#</a></h2><p>如果Master主机修复好了，可以在修复好后的<strong>Master</strong>执行<code>CHANGE MASTER</code>操作，作为新的<strong>slave</strong>库。</p><pre class="hljs"><code>[root@localhost ~]<span class="hljs-comment"># grep -i "All other slaves should start"  /data/mha/3306/log/manager.log </span>
Tue Dec 11 01:31:59 2018 - [info]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST=<span class="hljs-string">'192.168.179.129'</span>, MASTER_PORT=3306, MASTER_LOG_FILE=<span class="hljs-string">'mysql-bin.000009'</span>, MASTER_LOG_POS=498, MASTER_USER=<span class="hljs-string">'repl'</span>, MASTER_PASSWORD=<span class="hljs-string">'xxx'</span>;
</code></pre><hr><p>本着先开搞后研究的套路，搞出来都测试OK，然后在研究代码就很easy了！</p><hr><h2 id="mha组件说明">MHA组件说明 <a class="markdownIt-Anchor" href="#mha组件说明">#</a></h2><p>前面说过<code>MHA</code>就是一套<strong>Perl脚本集合</strong>；所以他的各个文件都是<strong>Perl脚本</strong></p><p>以下列举常用的组件</p><p><strong>Manager</strong>工具包主要包括以下几个工具：</p><pre class="hljs"><code>masterha_check_ssh              <span class="hljs-comment">#检查MHA的SSH配置状况</span>
masterha_check_repl             <span class="hljs-comment">#检查MySQL复制状况</span>
masterha_manger                 <span class="hljs-comment">#启动MHA</span>
masterha_check_status           <span class="hljs-comment">#检测当前MHA运行状态</span>
masterha_master_monitor         <span class="hljs-comment">#检测master是否宕机</span>
masterha_master_switch          <span class="hljs-comment">#控制故障转移（自动或者手动）</span>
masterha_conf_host              <span class="hljs-comment">#添加或删除配置的server信息</span>
master_ip_failover              <span class="hljs-comment">#自动切换vip</span>
master_ip_online_change         <span class="hljs-comment">#在线切换vip</span>
load_cnf                        <span class="hljs-comment">#保存密码</span>
</code></pre><p><strong>Node</strong>工具包（<strong>这些工具通常由MHA Manager的脚本触发，无需人为操作</strong>）主要包括以下几个工具：</p><pre class="hljs"><code>save_binary_logs                <span class="hljs-comment">#保存和复制master的二进制日志</span>
apply_diff_relay_logs           <span class="hljs-comment">#识别差异的中继日志事件并将其差异的事件应用于其他的slave</span>
filter_mysqlbinlog              <span class="hljs-comment">#去除不必要的ROLLBACK事件（MHA已不再使用这个工具）</span>
purge_relay_logs                <span class="hljs-comment">#清除中继日志（不会阻塞SQL线程）**重要**</span>
</code></pre><h2 id="配置文件说明">配置文件说明 <a class="markdownIt-Anchor" href="#配置文件说明">#</a></h2><pre class="hljs"><code>[root@localhost ~]<span class="hljs-comment"># cat /data/mha/3306/mha.cnf </span>
[server default]
client_bindir=/data/mysql-5.7.22-linux-glibc2.12-x86_64/bin/
manager_log=/data/mha/3306/<span class="hljs-built_in">log</span>/manager.log  <span class="hljs-comment">##设置manager的日志</span>
manager_workdir=/data/mha/3306/<span class="hljs-built_in">log</span>  <span class="hljs-comment">##设置manager的工作目录</span>
master_binlog_dir=/data/mysql-5.7.22-linux-glibc2.12-x86_64/data/  <span class="hljs-comment">##设置master保存binlog的位置，以便MHA可以找到master的日志，我这里的也就是mysql的数据目录</span>
master_ip_failover_script=/usr/<span class="hljs-built_in">local</span>/bin/master_ip_failover  <span class="hljs-comment">##设置自动failover时候的切换脚本</span>
master_ip_online_change_script= /usr/<span class="hljs-built_in">local</span>/bin/master_ip_online_change  <span class="hljs-comment">##设置手动切换时候的切换脚本</span>
report_script=/usr/<span class="hljs-built_in">local</span>/bin/send_report  <span class="hljs-comment">##设置发生切换后发送的报警的脚本</span>
init_conf_load_script=/usr/<span class="hljs-built_in">local</span>/bin/load_cnf  <span class="hljs-comment">##保存mysql复制用户和root用户密码</span>
remote_workdir=/tmp  <span class="hljs-comment">##设置远端mysql在发生切换时binlog的保存位置</span>
<span class="hljs-comment">#secondary_check_script= /usr/local/bin/masterha_secondary_check -s 192.168.0.30 -s 192.168.0.40</span>
user=view  <span class="hljs-comment">##mysql的mha监控用户</span>
ping_interval=3  <span class="hljs-comment">##设置监控主库，发送ping包的时间间隔,用来检查master是否正常，默认是3秒，尝试三次没有回应的时候自动进行railover</span>
repl_user=repl  <span class="hljs-comment">##mysql复制帐号，用来在主从机之间同步二进制日志等</span>
ssh_port=22  <span class="hljs-comment">##设置ssh的登录端口</span>
ssh_user=root  <span class="hljs-comment">##设置ssh的登录用户名</span>
max_ping_errors=40  <span class="hljs-comment">##max_ping_errors=40，这个是修改了源码，增加了检测次数的定义，默认是3次，太容易误切换。</span>

[server1]
hostname=192.168.179.128
port=3306

[server2]
candidate_master=1  <span class="hljs-comment">##置为候选master，即master机宕掉后,优先启用这台作为新master，如果设置该参数以后，发生主从切换以后将会将此从库提升为主库，即使这个主库不是集群中事件最新的slave</span>

check_repl_delay=0  <span class="hljs-comment">##默认情况下如果一个slave落后master 100M的relay logs的话，MHA将不会选择该slave作为一个新的master，因为对于这个slave的恢复需要花费很长时间，通过设置check_repl_delay=0,MHA触发切换在选择一个新的master的时候将会忽略复制延时，这个参数对于设置了candidate_master=1的主机非常有用，因为这个候选主在切换的过程中一定是新的master</span>

hostname=192.168.179.129
port=3306
[root@localhost ~]<span class="hljs-comment"># </span>
</code></pre><h2 id="切换vip脚本">切换vip脚本 <a class="markdownIt-Anchor" href="#切换vip脚本">#</a></h2><p>自动切换vip脚本<code>master_ip_failover</code><br>在线切换vip脚本<code>master_ip_online_change</code><br>须根据自行方案修改</p><pre class="hljs"><code>[root@localhost ~]<span class="hljs-comment"># cat /usr/local/bin/master_ip_failover |grep 'my' |awk '(NR&lt;8 &amp;&amp; NR&gt;1)'</span>
<span class="hljs-keyword">my</span> $vip = <span class="hljs-string">'192.168.179.130'</span>;
<span class="hljs-keyword">my</span> $key = <span class="hljs-string">'1'</span>;
<span class="hljs-keyword">my</span> $gateway1 = <span class="hljs-string">'10.69.213.254'</span>;
<span class="hljs-keyword">my</span> $gateway2 = <span class="hljs-string">'10.69.59.254'</span>;
<span class="hljs-keyword">my</span> $ssh_start_vip = <span class="hljs-string">"/sbin/ip addr add  $vip/24 dev ens33:$key"</span>;
<span class="hljs-keyword">my</span> $ssh_stop_vip  = <span class="hljs-string">"/sbin/ip addr del  $vip/24 dev ens33:$key"</span>;






[root@localhost ~]<span class="hljs-comment"># cat /usr/local/bin/master_ip_online_change |grep 'my' |awk '(NR&lt;10 &amp;&amp; NR&gt;3)'</span>
<span class="hljs-keyword">my</span> $vip = <span class="hljs-string">'192.168.179.130'</span>;
<span class="hljs-keyword">my</span> $key = <span class="hljs-string">'1'</span>;
<span class="hljs-keyword">my</span> $gateway1 = <span class="hljs-string">'10.69.213.254'</span>;
<span class="hljs-keyword">my</span> $gateway2 = <span class="hljs-string">'10.69.59.254'</span>;
<span class="hljs-keyword">my</span> $ssh_start_vip = <span class="hljs-string">"/sbin/ip addr add  $vip/24 dev ens33:$key"</span>;
<span class="hljs-keyword">my</span> $ssh_stop_vip  = <span class="hljs-string">"/sbin/ip addr del  $vip/24 dev ens33:$key"</span>;
[root@localhost ~]<span class="hljs-comment"># </span>
</code></pre><h2 id="保存密码脚本">保存密码脚本 <a class="markdownIt-Anchor" href="#保存密码脚本">#</a></h2><pre class="hljs"><code>[root@localhost ~]<span class="hljs-comment"># cat /usr/local/bin/load_cnf</span>
<span class="hljs-comment">#!/usr/bin/perl</span>

<span class="hljs-keyword">eval</span> <span class="hljs-string">'exec /usr/bin/perl  -S $0 ${1+"$@"}'</span>
    <span class="hljs-keyword">if</span> <span class="hljs-number">0</span>; <span class="hljs-comment"># not running under some shell</span>
  
  <span class="hljs-keyword">print</span> <span class="hljs-string">"password=view123\n"</span>;    <span class="hljs-regexp">//mysql</span>的mha监控密码
  <span class="hljs-keyword">print</span> <span class="hljs-string">"repl_password=repl\n"</span>;    <span class="hljs-regexp">//mysql</span>复制密码
[root@zhenru13 <span class="hljs-number">3307</span>]<span class="hljs-comment"># </span>
</code></pre></div><h2>您的评论</h2><div id="disqus_thread"></div><script>var disqus_config=function(){this.page.url=location.origin+location.pathname,this.page.identifier=location.pathname,"/index.html"===this.page.identifier.substr(-11)&&(this.page.identifier=this.page.identifier.substr(0,this.page.identifier.length-10))};!function(){var i=document,e=i.createElement("script");e.src="//linux48.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(i.head||i.body).appendChild(e)}()</script><div class="level article-bar is-mobile"><div class="level-item has-text-centered"><a title="previous page" class="previouse-article-link" href="index.html"><span class="icon icon-previous" data-icon="previous"></span><span class="link-content">&laquo; Previous</span></a></div><div class="level-item has-text-centered"><a title="font size" class="link-item link-item-size"><span class="icon icon-size" data-icon="size"></span></a></div><div class="level-item has-text-centered"><a title="table of content" class="link-item link-item-toc"><span class="icon icon-toc" data-icon="toc"></span></a></div><div class="level-item has-text-centered"><a title="top" href="#"><span class="icon icon-up" data-icon="up"></span> <span class="link-content">⤊ Top</span></a></div><div class="level-item has-text-centered"><a title="next page" class="next-article-link" href="2018-11-22-redis-think.html"><span class="icon icon-next" data-icon="next"></span><span class="link-content">Next &raquo;</span></a></div></div></div><div class="column is-2-widescreen is-hidden"></div></div><div class="columns foot"><div class="column is-3 is-offset-9 build-by">Build by <a href="https://github.com/ruanyf/loppo" target="_blank">Loppo</a> 0.6.14</div></div><div class="book-toc notification is-warning is-hidden"><h3>目录&nbsp;<span class="title-close"><a class="button is-danger"> Close</a></span></h3><ul class="chapter-area"><li class="chapter-item chapter-item-current"><a href="2018-12-11-mha.html">MySQL高可用之MHA</a></li><li class="chapter-item"><a href="2018-11-22-redis-think.html">使用Redis的一些想法和建议</a></li><li class="chapter-item"><a href="2018-11-15-redis-rdb-tools.html">使用redis-rdb-tools分析Redis内存</a></li><li class="chapter-item"><a href="2017-06-12-RDS-recovery-local-mysql.html">RDS备份文件恢复到自建数据库</a></li><li class="chapter-item"><a href="2017-06-08-excel-merge.html">多个EXCEL文件合并成一个EXCEL</a></li><li class="chapter-item"><a href="2017-05-24-redis-twemproxy.html">基于Twemproxy的Redis集群方案</a></li><li class="chapter-item"><a href="2017-02-28-zabbix-redis.html">zabbix使用自动发现规则自动化监控redis多实例</a></li><li class="chapter-item"><a href="2016-09-10-mysqlsla.html">MySQL慢日志分析工具mysqlsla</a></li><li class="chapter-item"><a href="2016-09-15-redis-stat.html">Redis-stat的安装与使用</a></li><li class="chapter-item"><a href="2016-07-06-zabbix3.0-mail.html">zabbix 3.0邮件报警</a></li><li class="chapter-item"><a href="2016-06-30-hive-hdfs.html">hive整合hadoop通过flume+hue收集日志</a></li><li class="chapter-item"><a href="2016-05-27-mysql-duplicate-records.html">MySQL查询表内重复记录</a></li><li class="chapter-item"><a href="2016-05-24-free-ssl.html">Startssl免费SSL证书+Nginx搭建https</a></li><li class="chapter-item"><a href="2016-05-16-flume.html">flume+hdfs构建大数据</a></li><li class="chapter-item"><a href="2016-04-21-notepad.html">数据库维护文本编辑技巧记录</a></li><li class="chapter-item"><a href="2016-04-20-mysql-in-paixu.html">MySQL查询按IN的顺序输出结果</a></li><li class="chapter-item"><a href="2016-04-14-cisco-firewall-ha.html">CISCO ASA5520 HA 配置</a></li><li class="chapter-item"><a href="2016-04-09-centos7-config-bond.html">centos7配置bond和bond跨网段改IP</a></li><li class="chapter-item"><a href="2016-02-03-centos-install-bugzilla.html">CentOS下Nginx配置Perl运行Bugzilla</a></li><li class="chapter-item"><a href="2015-11-12-centos-install-maven.html">CentOS上搭建私有maven仓库(迁移，升级)</a></li><li class="chapter-item"><a href="2015-10-8-mysql-some-question.html">mysql You cant specify target table</a></li><li class="chapter-item"><a href="2015-10-30-mysql-row-usedisk.html">mysql中查看数据库中所有表的记录数</a></li><li class="chapter-item"><a href="2015-10-29-zabbix-proxy-install.html">zabbix的proxy端安装配置</a></li><li class="chapter-item"><a href="2015-10-28-zabbix-agent-install.html">zabbix的agent端安装配置</a></li><li class="chapter-item"><a href="2015-10-27-mysql-AVG-MIN-SUM.html">mysql求平均值、最小和总值</a></li><li class="chapter-item"><a href="2015-10-21-mysql-every-hour.html">mysql取每隔一小时数据</a></li><li class="chapter-item"><a href="2015-08-27-Write-through-back.html">阵列Cache写机制：Write-through与Write-back</a></li><li class="chapter-item"><a href="2015-08-03-win10-cisco-vpn-repair.html">Repair Cisco vpnclient on windows10</a></li><li class="chapter-item"><a href="2015-07-30-sql-concat.html">MYSQL在一个字段值前面加字符串</a></li><li class="chapter-item"><a href="2015-07-22-Primary-key-conflicts.html">mysql双主主键冲突排查修复</a></li><li class="chapter-item"><a href="2015-07-15-mysql-dual-master.html">mysql双主互备设计搭建</a></li><li class="chapter-item"><a href="2015-07-07-svn-admin.html">CentOS6安装subversion 可视化管理工具iF.SVNAdmin</a></li><li class="chapter-item"><a href="2015-07-06-rhel-yum.html">Red Hat Enterprise Linux Server YUM配置</a></li><li class="chapter-item"><a href="2015-06-25-mysql-log.html">mysql全局日志开启</a></li><li class="chapter-item"><a href="2015-06-08-php-fpm-backlog.html">关于PHP-FPM的backlog</a></li><li class="chapter-item"><a href="2015-06-05-mysql-grant.html">MySQL的Grant赋权命令详解</a></li><li class="chapter-item"><a href="2015-06-03-bitnami-gitlab-port.html">bitnami版gitlab修改端口</a></li><li class="chapter-item"><a href="2015-03-13-awstats-install.html">awstats日志分析安装</a></li><li class="chapter-item"><a href="2015-03-07-h3c-vlan.html">H3C划分VLAN命令</a></li><li class="chapter-item"><a href="2015-03-05-redis-easy-install.html">Redis安装及主从配置</a></li><li class="chapter-item"><a href="2015-01-21-shadowsocks-python-node.html">shadowsocks的python和nodejs版搭建</a></li><li class="chapter-item"><a href="2015-01-07-ruby-Syntax-error-Invalid-GBK.html">ruby环境sass编译中文出现 Invalid GBK character</a></li><li class="chapter-item"><a href="2015-01-06-mysql-m-s-s.html">如何搭master-slave-slave</a></li><li class="chapter-item"><a href="2015-01-06-mysql5.1-ms.html">Mysql5.1主从服务设置</a></li><li class="chapter-item"><a href="2015-01-06-linux-rm-luanma.html">linux下删除乱码文件</a></li><li class="chapter-item"><a href="2014-12-17-SVNListParentPath.html">利用SVNListParentPath增加http浏览仓库根目录的功能</a></li><li class="chapter-item"><a href="2014-12-15-Chrome-css-failed.html">Chrome 浏览器加载 css Failed to load resource</a></li><li class="chapter-item"><a href="2014-12-04-centos-gitlab-yijian.html">centos gitlab一键安装备份恢复和迁移</a></li><li class="chapter-item"><a href="2014-12-02-linux-sar.html">linux sar命令</a></li><li class="chapter-item"><a href="2014-11-24-ruby-on-rails-err.html">ruby on rails 报错解决</a></li><li class="chapter-item"><a href="2014-11-18-awk-note.html">AWK统计随笔记录</a></li><li class="chapter-item"><a href="2014-11-12-svn-force-commit.html">SVN强制提交commit</a></li><li class="chapter-item"><a href="2014-11-12-rm-list-too-long.html">rm Argument list too long的解决办法</a></li><li class="chapter-item"><a href="2014-11-12-crontab-linux-lessthan.html">Crontab导致Linux的线程数枯竭</a></li><li class="chapter-item"><a href="2014-11-11-shell-ftp-uplod.html">用二句Shell命令实现FTP批量上传文件夹</a></li><li class="chapter-item"><a href="2014-11-10-redis-disk-memory-err.html">redis 写磁盘出错Cannot allocate memory</a></li><li class="chapter-item"><a href="2014-10-19-Jekyll_Variables.html">Jekyll目录结构与变量</a></li><li class="chapter-item"><a href="2014-10-19-git_common_command.html">Git 常用命令整理</a></li><li class="chapter-item"><a href="2014-10-18-windows_configuration_Jekyll.html">Windows平台配置Jekyll环境并与GitHub连接</a></li><li class="chapter-item"><a href="2014-08-21-centos-kvm-install.html">Redhat/CentOS系统KVM虚拟机安装过程详解</a></li><li class="chapter-item"><a href="2014-08-18-Sublime-add-youjian.html">将sublime text添加到右键菜单中</a></li><li class="chapter-item"><a href="2014-08-13-Sublime-python-build.html">Sublime Text 3设置python编译支持环境设置</a></li><li class="chapter-item"><a href="2014-08-11-shell-syntax-error.html">SHELL syntax error:unexpected end of file 提示错误</a></li><li class="chapter-item"><a href="2014-07-31-mysql-daxiaoxie.html">Windows下MySQL无法区分大小写解决方案</a></li><li class="chapter-item"><a href="2014-07-31-CentOS-NFS-mount.html">CentOS NFS的安装配置、启动及mount挂载方法</a></li><li class="chapter-item"><a href="2014-07-30-tencent-yun-repo.html">腾讯云的YUM repo</a></li><li class="chapter-item"><a href="2014-07-29-mysql-dump-all.html">Mysqldump参数大全</a></li><li class="chapter-item"><a href="2014-07-28-git-del-err-commit.html">git删除错误提交的commit</a></li><li class="chapter-item"><a href="2014-07-25-mysql-instet-other-table.html">MySql中把一个表的数据插入到另一个表中的实现</a></li><li class="chapter-item"><a href="2014-07-25-centos-install-ossec.html">centos安装ossec</a></li><li class="chapter-item"><a href="2014-07-24-phpmyadmin-error.html">访问phpmyadmin错误</a></li><li class="chapter-item"><a href="2014-07-13-black-apple.html">厚黑苹果售后</a></li><li class="chapter-item"><a href="2014-06-25-wordpress-google-css.html">wordpress引用google开放css加载不到解决方法</a></li><li class="chapter-item"><a href="2014-06-25-nginx-https.html">centos下nginx的https配置</a></li><li class="chapter-item"><a href="2014-05-30-rsync.html">rsync同步部署</a></li><li class="chapter-item"><a href="2014-05-15-saltstack1.html">使用saltstack批量管理服务器 （一）</a></li><li class="chapter-item"><a href="2014-04-18-msmtpmutt.html">msmtp+mutt 服务器批量发送邮件</a></li><li class="chapter-item"><a href="2014-04-14-zabbix-server-install.html">zabbix的server端安装配置</a></li><li class="chapter-item"><a href="2014-04-05-wordpress-them-only-one.html">wordpress后台主题只有一个解决方法</a></li><li class="chapter-item"><a href="2014-01-30-many-php-version.html">多版本php共存搭建</a></li><li class="chapter-item"><a href="2013-11-06-linux-memery-cat.html">linux查看内存相关命令</a></li><li class="chapter-item"><a href="2013-07-07-github-easy-install.html">github安装使用</a></li><li class="chapter-item"><a href="2013-06-30-localhost-127.0.0.1.html">localhost 与 127.0.0.1 的区别</a></li><li class="chapter-item"><a href="2013-06-15-rsync-del-hailiang.html">使用rsync删除海量文件</a></li><li class="chapter-item"><a href="2013-06-08-disk-data-recovery.html">记录一次服务器数据恢复</a></li><li class="chapter-item"><a href="2013-06-03-1nginx-502.html">记录一次nginx 502</a></li><li class="chapter-item"><a href="2013-06-02-linux-nohup.html">linux命令后台运行详解</a></li><li class="chapter-item"><a href="2013-06-01-disk-inode.html">深入理解磁盘inode</a></li><li class="chapter-item"><a href="2013-05-09-mysql-error-1064.html">MySQL错误ERROR 1064 (type=myisam出错)</a></li><li class="chapter-item"><a href="2013-01-04-centos-php-oracle.html">centos6.2下php支持oracle</a></li><li class="chapter-item"><a href="2012-12-27-oracle-startup-failure.html">oracle startup failure</a></li><li class="chapter-item"><a href="2012-12-27-oracle-startup.html">oracle startup 故障：ORA-00845: MEMORY_TARGET</a></li><li class="chapter-item"><a href="2012-12-27-ora-01102-cannot-mount-database-in-exclusive-mode.html">ORA-01102: cannot mount database in EXCLUSIVE mode</a></li><li class="chapter-item"><a href="2012-12-20-centos-install-oracle-11g.html">centos install oracle 11g</a></li><li class="chapter-item"><a href="2012-11-14-mysql-slow-log.html">Mysql慢查询设置</a></li><li class="chapter-item"><a href="2012-11-14-mysql-ms-error.html">MYSQL主从同步故障事件</a></li><li class="chapter-item"><a href="2012-08-10-python-mysqldb-install.html">CentOS下python-mysqldb安装事件</a></li><li class="chapter-item"><a href="2012-08-03-sqlite-source-upgrade.html">sqlite3源码升级事件</a></li><li class="chapter-item"><a href="2012-08-01-centos6-pythonsqlite3.html">centos6.2升级python后处理sqlite3库事件</a></li><li class="chapter-item"><a href="2012-07-30-mysql5-5-ms.html">mysql5.5版本主从搭建</a></li><li class="chapter-item"><a href="2012-07-18-repair-yum.html">误卸载python导致yum无法使用修复事件</a></li><li class="chapter-item"><a href="2012-07-18-reload-upgrade-python.html">Centos平滑升级python事件</a></li><li class="chapter-item"><a href="2012-07-18-nginx413.html">Nginx出现“413 Request Entity Too Large”错误解决方法</a></li><li class="chapter-item"><a href="2012-07-06-nginx-apache-mulu-bd.html">Nginx、Apache目录浏览功能</a></li><li class="chapter-item"><a href="2012-06-27-yum-lamp-tomcat.html">CentOS yum安装配置LAMP+tomcat</a></li><li class="chapter-item"><a href="2012-06-11-ios-jiangji.html">ios5.0.1降级4.3.3事件</a></li><li class="chapter-item"><a href="2012-05-17-ocr-Tesseract.html">OCR之Tesseract的linux下安装</a></li><li class="chapter-item"><a href="2012-05-04-memcached-easy-install.html">memcached简易安装</a></li><li class="chapter-item"><a href="2012-04-11-centos-install-snmp.html">centos下snmp客户端安装</a></li><li class="chapter-item"><a href="2012-03-13-iptables-shell.html">一篇很不错的iptables的shell</a></li><li class="chapter-item"><a href="2012-03-07-cisco-fudong-luyou.html">思科静态浮动路由配置</a></li><li class="chapter-item"><a href="markdown.html">Markdown 简明语法手册</a></li><li class="chapter-item"><a href="hello-world.html">Hello World</a></li></ul></div><div class="progress-indicator"></div><!-- SCRIPTS --><script>var LOPPO={current_path:"2018-12-11-mha.md",relative_root_path:"",article_toc:'<ul class="markdownIt-TOC">\n<li><a href="#mha%E7%AE%80%E4%BB%8B">MHA简介</a></li>\n<li><a href="#%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86">工作原理</a></li>\n<li><a href="#install">INSTALL</a>\n<ul>\n<li><a href="#%E9%85%8D%E7%BD%AE%E4%B8%BB%E4%BB%8E%EF%BC%8Cvip%EF%BC%8Cssh%E4%BA%92%E4%BF%A1%EF%BC%8C%E6%8E%88%E6%9D%83mysql%E7%AE%A1%E7%90%86%E8%B4%A6%E6%88%B7">配置主从，VIP，SSH互信，授权mysql管理账户</a></li>\n<li><a href="#install-mha">INSTALL MHA</a></li>\n</ul>\n</li>\n<li><a href="#check-mha">CHECK MHA</a></li>\n<li><a href="#test">TEST...</a></li>\n<li><a href="#%E4%BF%AE%E5%A4%8D%E5%AE%95%E6%9C%BA%E7%9A%84master">修复宕机的Master</a></li>\n<li><a href="#mha%E7%BB%84%E4%BB%B6%E8%AF%B4%E6%98%8E">MHA组件说明</a></li>\n<li><a href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%B4%E6%98%8E">配置文件说明</a></li>\n<li><a href="#%E5%88%87%E6%8D%A2vip%E8%84%9A%E6%9C%AC">切换vip脚本</a></li>\n<li><a href="#%E4%BF%9D%E5%AD%98%E5%AF%86%E7%A0%81%E8%84%9A%E6%9C%AC">保存密码脚本</a></li>\n</ul>\n'}</script><script src="assets/js/app.js"></script></body></html>