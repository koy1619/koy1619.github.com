<!DOCTYPE html>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta charset="utf-8">
<title>Redhat/CentOS系统KVM虚拟机安装过程详解 - linux48</title>
<meta name="description" content="">
<meta name="author" content="">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1">
<link rel="stylesheet" href="assets/css/bulma.min.css">
<link rel="stylesheet" href="assets/css/app.css">
<!--[if lt IE 9]>
<script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.2/html5shiv.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->
<link rel="shortcut icon" href="">
</head>
<body dir="ltr">

<nav class="columns navbar">
  <div class="column logo is-3 is-offset-1">
    <a class="is-brand" href="index.html">
      linux48
    </a>
  </div>
</nav>

<div class="columns content">
  <div class="column is-2-desktop is-3-widescreen is-hidden-touch">
  </div>
  <div class="column article-container is-11-tablet is-8-desktop is-6-widescreen">
    <div class="breadcrumb-area"><a href="index.html" class="breadcrumb-item">Home</a><span class="breadcrumb-delimiter"> &gt; </span><a href="2014-08-21-centos-kvm-install.html" class="breadcrumb-item">Redhat/CentOS系统KVM虚拟机安装过程详解</a></div>
    <h1 class="article-title">Redhat/CentOS系统KVM虚拟机安装过程详解</h1>
    <div class="article">
      <h2 id="什么是-kvm-">什么是 KVM ? <a class="markdownIt-Anchor" href="#什么是-kvm-">#</a></h2>
<p>KVM 是指基于 Linux 内核的虚拟机（Kernel-based Virtual Machine）。 2006 年 10 月，由以色列的Qumranet 组织开发的一种新的“虚拟机”实现方案。 2007 年 2 月发布的 Linux 2.6.20 内核第一次包含了 KVM 。增加 KVM 到 Linux 内核是 Linux 发展的一个重要里程碑，这也是第一个整合到 Linux 主线内核的虚拟化技术。<!-- more --></p>
<p>KVM 在标准的 Linux 内核中增加了虚拟技术，从而我们可以通过优化的内核来使用虚拟技术。在 KVM 模型中，每一个虚拟机都是一个由 Linux 调度程序管理的标准进程，你可以在用户空间启动客户机操作系统。一个普通的 Linux 进程有两种运行模式：内核和用户。 KVM 增加了第三种模式：客户模式（有自己的内核和用户模式）。</p>
<p>一个典型的 KVM 安装包括以下部件：</p>
<blockquote>
<ul>
<li>一个管理虚拟硬件的设备驱动，这个驱动通过一个字符设备 /dev/kvm 导出它的功能。通过 /dev/kvm每一个客户机拥有其自身的地址空间，这个地址空间与内核的地址空间相分离或与任何一个正运行着的客户机相分离。</li>
<li>一个模拟硬件的用户空间部件，它是一个稍微改动过的 QEMU 进程。从客户机操作系统执行 I/O 会拥有QEMU 。 QEMU 是一个平台虚拟化方案，它允许整个 PC 环境（包括磁盘、显示卡（图形卡）、网络设备）的虚拟化。任何客户机操作系统所发出的 I/O 请求都被拦截，并被路由到用户模式用以被 QEMU 过程模拟仿真。</li>
</ul>
</blockquote>
<h2 id="centos上安装kvm功能模块步骤">CentOS上安装KVM功能模块步骤 <a class="markdownIt-Anchor" href="#centos上安装kvm功能模块步骤">#</a></h2>
<p><strong>1.KVM 需要有 CPU 的支持（Intel VT 或 AMD SVM），在安装 KVM 之前检查一下 CPU 是否提供了虚拟技术的支持。</strong></p>
<blockquote>
<ul>
<li>基于 Intel 处理器的系统，运行<code>grep vmx /proc/cpuinfo</code>查找 CPU flags 是否包括 vmx 关键词</li>
<li>基于 AMD 处理器的系统，运行<code>grep svm /proc/cpuinfo</code>查找 CPU flags 是否包括 svm 关键词</li>
<li>检查BIOS，确保BIOS里开启VT选项:</li>
</ul>
</blockquote>
<p>注 : 一些厂商禁止了机器 BIOS 中的 VT 选项 , 这种方式下 VT 不能被重新打开。**</p>
<p>注意：/proc/cpuinfo 仅从 Linux 2.6.15(Intel) 和 Linux 2.6.16(AMD) 开始显示虚拟化方面的信息。请使用 uname -r 命令查询您的内核版本。如有疑问，请联系硬件厂商。</p>
<p><strong>2.iptables设置</strong></p>
<pre class="hljs"><code>[root@localhost qemu]<span class="hljs-comment"># cat /bin/iptables.sh </span>
modprobe ip_conntrack_ftp
iptables -F
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o em1  -j ACCEPT
iptables -A INPUT -s 127.0.0.1 -d 127.0.0.1 -j ACCEPT
/sbin/iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

<span class="hljs-comment">#for ping:</span>
iptables -A INPUT -p icmp --icmp-type <span class="hljs-built_in">echo</span>-reply -j ACCEPT
iptables -A INPUT -p icmp --icmp-type <span class="hljs-built_in">echo</span>-request -j ACCEPT

<span class="hljs-comment">#for kvm</span>
iptables -I FORWARD -m physdev --physdev-is-bridged -j ACCEPT

iptables -A INPUT -p tcp -j REJECT --reject-with tcp-reset
iptables -A INPUT -j DROP
iptables -A FORWARD -j DROP
[root@localhost qemu]<span class="hljs-comment"># </span>
</code></pre>
<p><strong>3.安装与启动</strong></p>
<pre><code>yum install kvm libvirt python-virtinst qemu-kvm virt-viewer bridge-utils

/etc/init.d/libvirtd start
</code></pre>
<p><strong>4.建立虚拟机</strong></p>
<p>划分硬盘</p>
<pre><code>qemu-img create -f qcow2 -o preallocation=metadata /home/kvm/centos65-x64-mysql.qcow2 200G
</code></pre>
<p>安装KVM，下面是两种常见的网络连接方式，默认是default，适用于不同需求的网络环境，后面配置KVM中会详细说明。</p>
<p>bridge网络模式</p>
<pre><code>virt-install --name=gatewat-4 --ram 4096 --vcpus=4 -f /home/kvm/gateway-4.qcow2 --cdrom /home/iso/CentOS-6.5-x86_64-bin-DVD1.iso --graphics vnc,listen=0.0.0.0,port=5920, --network bridge=br0 --force --autostart
</code></pre>
<p>NAT网络模式</p>
<pre><code>virt-install --name=test --ram 512 --vcpus=1 -f /home/kvm/test.qcow2 --cdrom /opt/CentOS-6.5-x86_64-bin-DVD1.iso --graphics vnc,listen=0.0.0.0,port=5988, --network network=default, --force --autostart
</code></pre>
<p><strong>5.启动</strong></p>
<p>使用<code>virsh list --all</code>查看已安装的kvm</p>
<p>使用<code>virsh start test</code>启动虚拟机</p>
<p>使用VNC工具连接KVM来进行初始化配置</p>
<h2 id="配置kvm">配置KVM <a class="markdownIt-Anchor" href="#配置kvm">#</a></h2>
<p>使用<code>virsh-install</code>安装完KVM之后，会自动生成相应配置</p>
<p>KVM的配置文件存储在<code>/etc/libvirt/qemu/</code></p>
<pre class="hljs"><code>[root@localhost ~]<span class="hljs-comment"># cd /etc/libvirt/qemu/</span>
[root@localhost qemu]<span class="hljs-comment"># ll</span>
total 24
drwxr-xr-x. 2 root root 4096 Jul 24 17:30 autostart
drwx------. 3 root root 4096 Jun 20 19:21 networks
-rw-------. 1 root root 2566 Aug 20 18:28 vm_1.xml
-rw-------. 1 root root 2560 Jul  4 02:02 vm_2.xml
-rw-------. 1 root root 2566 Aug 20 18:28 vm_3.xml
</code></pre>
<p>长的大概是这个样子</p>
<pre class="hljs"><code>[root@localhost qemu]<span class="hljs-comment"># cat vm_1.xml </span>
&lt;!--
WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE 
OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:
  virsh edit vm_1
or other application using the libvirt API.
--&gt;

&lt;domain <span class="hljs-built_in">type</span>=<span class="hljs-string">'kvm'</span>&gt;
  &lt;name&gt;vm_1&lt;/name&gt;  //此处为hostname
  &lt;uuid&gt;2f952159-b231-80a4-8086-d49978513fb4&lt;/uuid&gt;  //此处为uuid标识
  &lt;memory unit=<span class="hljs-string">'KiB'</span>&gt;8388608&lt;/memory&gt;  //此处为内存
  &lt;currentMemory unit=<span class="hljs-string">'KiB'</span>&gt;8388608&lt;/currentMemory&gt;
  &lt;vcpu placement=<span class="hljs-string">'static'</span>&gt;6&lt;/vcpu&gt;  //此处为cpu核数
  &lt;os&gt;
    &lt;<span class="hljs-built_in">type</span> arch=<span class="hljs-string">'x86_64'</span> machine=<span class="hljs-string">'rhel6.5.0'</span>&gt;hvm&lt;/<span class="hljs-built_in">type</span>&gt;
    &lt;boot dev=<span class="hljs-string">'hd'</span>/&gt;  //此处为启动项目，若想从光盘启动可设置为&lt;boot dev=<span class="hljs-string">'cdrom'</span>/&gt;
  &lt;/os&gt;
  &lt;features&gt;
    &lt;acpi/&gt;
    &lt;apic/&gt;
    &lt;pae/&gt;
  &lt;/features&gt;
  &lt;clock offset=<span class="hljs-string">'utc'</span>/&gt;
  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;  //此处为关机命令 使用 virsh destroy vm_1 关闭
  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
  &lt;on_crash&gt;restart&lt;/on_crash&gt;
  &lt;devices&gt;
    &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;
    &lt;disk <span class="hljs-built_in">type</span>=<span class="hljs-string">'file'</span> device=<span class="hljs-string">'disk'</span>&gt;  //此处为硬盘信息
      &lt;driver name=<span class="hljs-string">'qemu'</span> <span class="hljs-built_in">type</span>=<span class="hljs-string">'raw'</span> cache=<span class="hljs-string">'none'</span>/&gt;
      &lt;<span class="hljs-built_in">source</span> file=<span class="hljs-string">'/home/kvm/vm_1.qcow2'</span>/&gt;
      &lt;target dev=<span class="hljs-string">'hda'</span> bus=<span class="hljs-string">'ide'</span>/&gt;
      &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">'drive'</span> controller=<span class="hljs-string">'0'</span> bus=<span class="hljs-string">'0'</span> target=<span class="hljs-string">'0'</span> unit=<span class="hljs-string">'0'</span>/&gt;
    &lt;/disk&gt;
    &lt;disk <span class="hljs-built_in">type</span>=<span class="hljs-string">'block'</span> device=<span class="hljs-string">'cdrom'</span>&gt;  //此处为cdrom信息，可修改为iso的路径
      &lt;driver name=<span class="hljs-string">'qemu'</span> <span class="hljs-built_in">type</span>=<span class="hljs-string">'raw'</span>/&gt;
      &lt;target dev=<span class="hljs-string">'hdc'</span> bus=<span class="hljs-string">'ide'</span>/&gt;
      &lt;<span class="hljs-built_in">readonly</span>/&gt;
      &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">'drive'</span> controller=<span class="hljs-string">'0'</span> bus=<span class="hljs-string">'1'</span> target=<span class="hljs-string">'0'</span> unit=<span class="hljs-string">'0'</span>/&gt;
    &lt;/disk&gt;
    &lt;controller <span class="hljs-built_in">type</span>=<span class="hljs-string">'usb'</span> index=<span class="hljs-string">'0'</span>&gt;  //此处为usb接口信息
      &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">'pci'</span> domain=<span class="hljs-string">'0x0000'</span> bus=<span class="hljs-string">'0x00'</span> slot=<span class="hljs-string">'0x01'</span> <span class="hljs-keyword">function</span>=<span class="hljs-string">'0x2'</span>/&gt;
    &lt;/controller&gt;
    &lt;controller <span class="hljs-built_in">type</span>=<span class="hljs-string">'ide'</span> index=<span class="hljs-string">'0'</span>&gt;
      &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">'pci'</span> domain=<span class="hljs-string">'0x0000'</span> bus=<span class="hljs-string">'0x00'</span> slot=<span class="hljs-string">'0x01'</span> <span class="hljs-keyword">function</span>=<span class="hljs-string">'0x1'</span>/&gt;
    &lt;/controller&gt;
    &lt;interface <span class="hljs-built_in">type</span>=<span class="hljs-string">'network'</span>&gt;  //此处为网卡1信息，使用network也就是nat模式连接virbr0联网
      &lt;mac address=<span class="hljs-string">'52:54:00:9a:d7:82'</span>/&gt;
      &lt;<span class="hljs-built_in">source</span> network=<span class="hljs-string">'default'</span>/&gt;
      &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">'pci'</span> domain=<span class="hljs-string">'0x0000'</span> bus=<span class="hljs-string">'0x00'</span> slot=<span class="hljs-string">'0x03'</span> <span class="hljs-keyword">function</span>=<span class="hljs-string">'0x0'</span>/&gt;
    &lt;/interface&gt;
    &lt;interface <span class="hljs-built_in">type</span>=<span class="hljs-string">'bridge'</span>&gt;  //此处为网卡2信息，使用bridge桥接方式到br1
      &lt;mac address=<span class="hljs-string">'52:54:11:fd:39:23'</span>/&gt;
      &lt;<span class="hljs-built_in">source</span> bridge=<span class="hljs-string">'br1'</span>/&gt;
      &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">'pci'</span> domain=<span class="hljs-string">'0x0000'</span> bus=<span class="hljs-string">'0x00'</span> slot=<span class="hljs-string">'0x05'</span> <span class="hljs-keyword">function</span>=<span class="hljs-string">'0x0'</span>/&gt;
    &lt;/interface&gt;
//若要添加网卡可新加配置，注意修改mac地址
    &lt;interface <span class="hljs-built_in">type</span>=<span class="hljs-string">'bridge'</span>&gt;
      &lt;mac address=<span class="hljs-string">'52:54:21:fd:39:23'</span>/&gt;
      &lt;<span class="hljs-built_in">source</span> bridge=<span class="hljs-string">'br0'</span>/&gt;
      &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">'pci'</span> domain=<span class="hljs-string">'0x0000'</span> bus=<span class="hljs-string">'0x00'</span> slot=<span class="hljs-string">'0x08'</span> <span class="hljs-keyword">function</span>=<span class="hljs-string">'0x0'</span>/&gt;
    &lt;/interface&gt;

    &lt;serial <span class="hljs-built_in">type</span>=<span class="hljs-string">'pty'</span>&gt;
      &lt;target port=<span class="hljs-string">'0'</span>/&gt;
    &lt;/serial&gt;
    &lt;console <span class="hljs-built_in">type</span>=<span class="hljs-string">'pty'</span>&gt;
      &lt;target <span class="hljs-built_in">type</span>=<span class="hljs-string">'serial'</span> port=<span class="hljs-string">'0'</span>/&gt;
    &lt;/console&gt;
    &lt;input <span class="hljs-built_in">type</span>=<span class="hljs-string">'mouse'</span> bus=<span class="hljs-string">'ps2'</span>/&gt;
    &lt;graphics <span class="hljs-built_in">type</span>=<span class="hljs-string">'vnc'</span> port=<span class="hljs-string">'5920'</span> autoport=<span class="hljs-string">'no'</span> listen=<span class="hljs-string">'0.0.0.0'</span>&gt;  //此处为VNC连接端口
      &lt;listen <span class="hljs-built_in">type</span>=<span class="hljs-string">'address'</span> address=<span class="hljs-string">'0.0.0.0'</span>/&gt;
    &lt;/graphics&gt;
    &lt;video&gt;
      &lt;model <span class="hljs-built_in">type</span>=<span class="hljs-string">'cirrus'</span> vram=<span class="hljs-string">'9216'</span> heads=<span class="hljs-string">'1'</span>/&gt;
      &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">'pci'</span> domain=<span class="hljs-string">'0x0000'</span> bus=<span class="hljs-string">'0x00'</span> slot=<span class="hljs-string">'0x02'</span> <span class="hljs-keyword">function</span>=<span class="hljs-string">'0x0'</span>/&gt;
    &lt;/video&gt;
    &lt;memballoon model=<span class="hljs-string">'virtio'</span>&gt;
      &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">'pci'</span> domain=<span class="hljs-string">'0x0000'</span> bus=<span class="hljs-string">'0x00'</span> slot=<span class="hljs-string">'0x04'</span> <span class="hljs-keyword">function</span>=<span class="hljs-string">'0x0'</span>/&gt;
    &lt;/memballoon&gt;
  &lt;/devices&gt;
&lt;/domain&gt;
[root@localhost qemu]<span class="hljs-comment"># </span>
</code></pre>
<p>后期可能会因为需求对KVM重新配置，这个时候我们只需要修改对应的<code>xml</code>文件即可</p>
<p>修改配置的时候需要关闭KVM <code>virsh destroy vm_1</code></p>
<p>使用<code>virsh define vm_1.xml</code>使配置生效</p>
<p>使用<code>virsh start vm_1</code>启动虚拟机</p>
<h2 id="配置网路环境">配置网路环境 <a class="markdownIt-Anchor" href="#配置网路环境">#</a></h2>
<p><strong>1.nat模式配置</strong></p>
<p>KVM默认采用nat模式，用户网络（User Networking）：让虚拟机访问主机、互联网或本地网络上的资源的简单方法，但是不能从网络或其他的客户机访问客户机。在公网IP不够使用KVM还需要上网的时候可以使用，大大节省了公网IP！同时这种模式也使得KVM不用暴露在公网之中，也增加了安全性。</p>
<p>下图是虚拟机管理模块产生的接口关系：</p>
<figure><img src="http://segmentfault.com/img/bVcRHo" alt="请输入图片描述"><figcaption>请输入图片描述</figcaption></figure>
<p>其中virbr0是由宿主机虚拟机支持模块安装时产生的虚拟网络接口，也是一个switch和bridge，负责把内容分发到各虚拟机。</p>
<p>从图上可以看出，虚拟接口和物理接口之间没有连接关系，所以虚拟机只能在通过虚拟的网络访问外部世界，无法从网络上定位和访问虚拟主机。</p>
<p>下面是nat的default配置，可以自定义地址池</p>
<pre class="hljs"><code>[root@localhost qemu]<span class="hljs-comment"># cat /etc/libvirt/qemu/networks/default.xml </span>
&lt;network&gt;
  &lt;name&gt;default&lt;/name&gt;
  &lt;uuid&gt;a8e0859c-4761-4d78-bcd6-eaeeceace429&lt;/uuid&gt;
  &lt;bridge name=<span class="hljs-string">"virbr0"</span> /&gt;
  &lt;mac address=<span class="hljs-string">'52:54:00:C9:D5:1E'</span>/&gt;
  &lt;forward/&gt;
  &lt;ip address=<span class="hljs-string">"192.168.122.1"</span> netmask=<span class="hljs-string">"255.255.255.0"</span>&gt;
    &lt;dhcp&gt;
      &lt;range start=<span class="hljs-string">"192.168.122.2"</span> end=<span class="hljs-string">"192.168.122.254"</span> /&gt;
    &lt;/dhcp&gt;
  &lt;/ip&gt;
&lt;/network&gt;
[root@localhost qemu]<span class="hljs-comment"># </span>
</code></pre>
<p>创建方法：</p>
<p>使用<code>virsh net-start default</code>来启动nat网络，同时，虚拟机支持模块会修改iptables规则，通过命令可以查看：</p>
<pre class="hljs"><code><span class="hljs-comment"># iptables -t nat -L -nv</span>
Chain PREROUTING (policy ACCEPT 16924 packets, 2759K bytes)
pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination
Chain POSTROUTING (policy ACCEPT 2009 packets, 125K bytes)
pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination        
 421 31847 MASQUERADE  all  --  *      *       192.168.122.0/24    !192.168.122.0/24   -----------&gt;这条是关键，它配置了NAT功能。
Chain OUTPUT (policy ACCEPT 2011 packets, 125K bytes)
pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination        
</code></pre>
<p>如果你由于不小心将IPTABLE清空或者STOP导致IPTABLE配置丢失，可以通过如下操作来恢复：</p>
<pre><code>virsh net-destroy default

virsh net-start default
</code></pre>
<p>确认路由转发开启</p>
<pre><code>[root@localhost qemu]# more /proc/sys/net/ipv4/ip_forward 
1
</code></pre>
<p>下面是一个KVM的nat模式的范例</p>
<pre class="hljs"><code>[root@vm_1 data]<span class="hljs-comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0</span>

<span class="hljs-comment">#使用dhcp</span>
<span class="hljs-comment">#DEVICE=eth0</span>
<span class="hljs-comment">#ONBOOT=yes</span>
<span class="hljs-comment">#TYPE=Ethernet</span>
<span class="hljs-comment">#BOOTPROTO=dhcp</span>

<span class="hljs-comment">#手动IP</span>
DEVICE=eth0
ONBOOT=yes
IPADDR=192.168.122.3
NETMASK=255.255.255.0
GATEWAY=192.168.122.1
DNS1=192.168.122.1
TYPE=Ethernet
BOOTPROTO=static
IPV6INIT=no
USERCTL=no
[root@vm_web_1_1 data]<span class="hljs-comment"># </span>
</code></pre>
<p><strong>2.Bridge方式</strong></p>
<p>虚拟网桥（Virtual Bridge）：设置好后客户机与互联网，客户机与主机之间都可以通信，试用于需要多个公网IP的环境。</p>
<p>Bridge方式即虚拟网桥的网络连接方式，是客户机和子网里面的机器能够互相通信。可以使虚拟机成为网络中具有独立IP的主机。</p>
<p>桥接网络（也叫物理设备共享）被用作把一个物理设备复制到一台虚拟机。网桥多用作高级设置，特别是主机多个网络接口的情况。</p>
<figure><img src="http://segmentfault.com/img/bVcRIf" alt="请输入图片描述"><figcaption>请输入图片描述</figcaption></figure>
<p>如上图，网桥的基本原理就是创建一个桥接接口br0，在物理网卡和虚拟网络接口之间传递数据。</p>
<p>创建方法：</p>
<p>不用过多命令，只需要修改好网卡的桥接方式，配好IP即可，下面是范例，不用注释仔细读一遍就能看懂了！</p>
<pre class="hljs"><code>========kvm_server==========

[root@localhost network-scripts]<span class="hljs-comment"># cat ifcfg-br0 </span>
DEVICE=br0
BOOTPROTO=none
TYPE=Bridge
IPADDR=114.137.122.233
NETMASK=255.255.255.128
GATEWAY=114.137.102.139
DNS1=202.96.122.83
IPV6INIT=no
NM_CONTROLLED=yes
ONBOOT=yes
USERCTL=no

[root@localhost network-scripts]<span class="hljs-comment"># cat ifcfg-br1</span>
DEVICE=br1
BOOTPROTO=none
TYPE=Bridge
IPADDR=192.168.1.12
NETMASK=255.255.255.0
IPV6INIT=no
ONBOOT=yes
USERCTL=no

[root@localhost network-scripts]<span class="hljs-comment"># cat ifcfg-em1 </span>
DEVICE=em1
ONBOOT=yes
BOOTPROTO=none
BRIDGE=br0
TYPE=Ethernet
IPV6INIT=no
USERCTL=no

[root@localhost network-scripts]<span class="hljs-comment"># cat ifcfg-em2</span>
DEVICE=em2
ONBOOT=yes
BOOTPROTO=none
BRIDGE=br1
TYPE=Ethernet
IPV6INIT=no
USERCTL=no

========kvm==========

[root@gateway-2 network-scripts]<span class="hljs-comment"># cat ifcfg-eth0</span>
DEVICE=eth0
TYPE=Ethernet
ONBOOT=yes
NM_CONTROLLED=yes
IPADDR=114.137.122.222
NETMASK=255.255.255.128
GATEWAY=114.137.102.139
DNS1=202.96.122.83

[root@gateway-2 network-scripts]<span class="hljs-comment"># cat ifcfg-eth0:1</span>
DEVICE=eth0:1
TYPE=Ethernet
ONBOOT=yes
IPADDR=114.137.122.123
NETMASK=255.255.255.128
NM_CONTROLLED=yes
BOOTPROTO=static

[root@gateway-2 network-scripts]<span class="hljs-comment"># cat ifcfg-eth1</span>
DEVICE=eth1
ONBOOT=yes
IPADDR=192.168.1.25
NETMASK=255.255.255.0
TYPE=Ethernet
BOOTPROTO=static
IPV6INIT=no
USERCTL=no
</code></pre>
<p><strong>注意：网络配置可以同时存在nat和Bridge，看最上面的vm_1.xml</strong></p>
<h2 id="---20141029更新---">---2014.10.29更新--- <a class="markdownIt-Anchor" href="#---20141029更新---">#</a></h2>
<p>由于按照上文的NAT方式配置的机器，过了几个月宿主机重启之后死活连接不上外网ping不通<code>virbr0</code>(192.168.122.1)，<code>virsh net-destroy default</code>和 <code>virsh net-start default</code>之后也是不行，尝试了各种方案，最后<code>/etc/init.d/libvirtd restart</code>之后会偶尔联上外网ping通192.168.122.1，但是<code>virsh net-destroy default</code>和 <code>virsh net-start default</code>之后又连不上外网，今天又在测试环境测试都是OK的也没发现问题~~~~</p>
<p>真实匪夷所思~~~</p>
<p>最后抱着尝试一下的心态按照http://www.linuxidc.com/Linux/2012-05/61445.htm这篇文章配置了，果断就OK了！再此记录一下！</p>
<p><strong>宿主机配置</strong></p>
<pre class="hljs"><code>[root@web8 qemu]<span class="hljs-comment"># cp /etc/libvirt/qemu/networks/default.xml /etc/libvirt/qemu/networks/default.xml.bk </span>

[root@web8 qemu]<span class="hljs-comment"># cat /etc/libvirt/qemu/networks/default.xml</span>

&lt;network&gt;
  &lt;name&gt;default&lt;/name&gt;
  &lt;uuid&gt;ea07af3d-fd95-444d-a1d2-a0ae5fce43de&lt;/uuid&gt;
  &lt;forward mode=<span class="hljs-string">'nat'</span>/&gt;   //此处增加mode参数为nat
  &lt;bridge name=<span class="hljs-string">'virbr0'</span> stp=<span class="hljs-string">'on'</span> delay=<span class="hljs-string">'0'</span> /&gt;
  &lt;mac address=<span class="hljs-string">'52:54:00:89:DD:12'</span>/&gt;
  &lt;ip address=<span class="hljs-string">'192.168.122.1'</span> netmask=<span class="hljs-string">'255.255.255.0'</span>&gt;
    &lt;dhcp&gt;
      &lt;range start=<span class="hljs-string">'192.168.122.2'</span> end=<span class="hljs-string">'192.168.122.254'</span> /&gt;
    &lt;/dhcp&gt;
  &lt;/ip&gt;
&lt;/network&gt;

[root@web8 qemu]<span class="hljs-comment"># virsh net-define /etc/libvirt/qemu/networks/default.xml</span>
[root@web8 qemu]<span class="hljs-comment"># virsh net-destroy default</span>
[root@web8 qemu]<span class="hljs-comment"># virsh net-start default</span>

[root@web8 qemu]<span class="hljs-comment"># cat  vm.xml</span>

······
    &lt;interface <span class="hljs-built_in">type</span>=<span class="hljs-string">'network'</span>&gt;
      &lt;mac address=<span class="hljs-string">'52:54:00:66:6e:49'</span>/&gt;
      &lt;<span class="hljs-built_in">source</span> network=<span class="hljs-string">'default'</span>/&gt;
      &lt;model <span class="hljs-built_in">type</span>=<span class="hljs-string">'virtio'</span>/&gt;  //此处为新增参数mode
      &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">'pci'</span> domain=<span class="hljs-string">'0x0000'</span> bus=<span class="hljs-string">'0x00'</span> slot=<span class="hljs-string">'0x03'</span> <span class="hljs-keyword">function</span>=<span class="hljs-string">'0x0'</span>/&gt;
    &lt;/interface&gt;
······

</code></pre>

      
    </div>
    <div  dir="ltr" class="level article-bar is-mobile">
      <div class="level-item has-text-centered">
        <a title="previous page" class="previouse-article-link" href="2014-10-18-windows_configuration_Jekyll.html"><span class="icon icon-previous" data-icon="previous"></span><span class="link-content">&laquo; Previous</span></a>
      </div>
      <div class="level-item has-text-centered">
        <a title="font size" class="link-item link-item-size">
          <span class="icon icon-size" data-icon="size"></span>
        </a>
      </div>
      <div class="level-item has-text-centered">
        <a title="table of content" class="link-item link-item-toc">
          <span class="icon icon-toc" data-icon="toc"></span>
        </a>
      </div>
      <div class="level-item has-text-centered">
        <a title="top" href="#">
          <span class="icon icon-up" data-icon="up"></span>
          <span class="link-content">⤊ Top</span>
        </a>
      </div>
      <div class="level-item has-text-centered">
        <a title="next page" class="next-article-link" href="2014-08-18-Sublime-add-youjian.html"><span class="icon icon-next" data-icon="next"></span><span class="link-content">Next &raquo;</span></a>
      </div>
    </div>
  </div>
  <div class="column is-2-widescreen is-hidden">
  </div>
</div>

<div class="columns foot">
  <div class="column is-3 is-offset-9 build-by">
    Build by <a href="https://github.com/ruanyf/loppo" target="_blank">Loppo</a> 0.5.1
  </div>
</div>

<div class="book-toc notification is-warning is-hidden">
  <h3>Table of chapters &nbsp;<span class="title-close"><a class="button is-danger"> Close </a></span></h3>
  <ul class="chapter-area"><li class="chapter-item "><a href="2017-06-12-RDS-recovery-local-mysql.html">RDS备份文件恢复到自建数据库</a></li><li class="chapter-item "><a href="2017-06-08-excel-merge.html">多个EXCEL文件合并成一个EXCEL</a></li><li class="chapter-item "><a href="2017-05-24-redis-twemproxy.html">基于Twemproxy的Redis集群方案</a></li><li class="chapter-item "><a href="2017-02-28-zabbix-redis.html">zabbix使用自动发现规则自动化监控redis多实例</a></li><li class="chapter-item "><a href="2016-09-10-mysqlsla.html">MySQL慢日志分析工具mysqlsla</a></li><li class="chapter-item "><a href="2016-09-15-redis-stat.html">Redis-stat的安装与使用</a></li><li class="chapter-item "><a href="2016-07-06-zabbix3.0-mail.html">zabbix 3.0邮件报警</a></li><li class="chapter-item "><a href="2016-06-30-hive-hdfs.html">hive整合hadoop通过flume+hue收集日志</a></li><li class="chapter-item "><a href="2016-05-27-mysql-duplicate-records.html">MySQL查询表内重复记录</a></li><li class="chapter-item "><a href="2016-05-24-free-ssl.html">Startssl免费SSL证书+Nginx搭建https</a></li><li class="chapter-item "><a href="2016-05-16-flume.html">flume+hdfs构建大数据</a></li><li class="chapter-item "><a href="2016-04-21-notepad.html">数据库维护文本编辑技巧记录</a></li><li class="chapter-item "><a href="2016-04-20-mysql-in-paixu.html">MySQL查询按IN的顺序输出结果</a></li><li class="chapter-item "><a href="2016-04-14-cisco-firewall-ha.html">CISCO ASA5520 HA 配置</a></li><li class="chapter-item "><a href="2016-04-09-centos7-config-bond.html">centos7配置bond和bond跨网段改IP</a></li><li class="chapter-item "><a href="2016-02-03-centos-install-bugzilla.html">CentOS下Nginx配置Perl运行Bugzilla</a></li><li class="chapter-item "><a href="2015-11-12-centos-install-maven.html">CentOS上搭建私有maven仓库(迁移，升级)</a></li><li class="chapter-item "><a href="2015-10-8-mysql-some-question.html">mysql You cant specify target table</a></li><li class="chapter-item "><a href="2015-10-30-mysql-row-usedisk.html">mysql中查看数据库中所有表的记录数</a></li><li class="chapter-item "><a href="2015-10-29-zabbix-proxy-install.html">zabbix的proxy端安装配置</a></li><li class="chapter-item "><a href="2015-10-28-zabbix-agent-install.html">zabbix的agent端安装配置</a></li><li class="chapter-item "><a href="2015-10-27-mysql-AVG-MIN-SUM.html">mysql求平均值、最小和总值</a></li><li class="chapter-item "><a href="2015-10-21-mysql-every-hour.html">mysql取每隔一小时数据</a></li><li class="chapter-item "><a href="2015-08-27-Write-through-back.html">阵列Cache写机制：Write-through与Write-back</a></li><li class="chapter-item "><a href="2015-08-03-win10-cisco-vpn-repair.html">Repair Cisco vpnclient on windows10</a></li><li class="chapter-item "><a href="2015-07-30-sql-concat.html">MYSQL在一个字段值前面加字符串</a></li><li class="chapter-item "><a href="2015-07-22-Primary-key-conflicts.html">mysql双主主键冲突排查修复</a></li><li class="chapter-item "><a href="2015-07-15-mysql-dual-master.html">mysql双主互备设计搭建</a></li><li class="chapter-item "><a href="2015-07-07-svn-admin.html">CentOS6安装subversion 可视化管理工具iF.SVNAdmin</a></li><li class="chapter-item "><a href="2015-07-06-rhel-yum.html">Red Hat Enterprise Linux Server YUM配置</a></li><li class="chapter-item "><a href="2015-06-25-mysql-log.html">mysql全局日志开启</a></li><li class="chapter-item "><a href="2015-06-08-php-fpm-backlog.html">关于PHP-FPM的backlog</a></li><li class="chapter-item "><a href="2015-06-05-mysql-grant.html">MySQL的Grant赋权命令详解</a></li><li class="chapter-item "><a href="2015-06-03-bitnami-gitlab-port.html">bitnami版gitlab修改端口</a></li><li class="chapter-item "><a href="2015-03-13-awstats-install.html">awstats日志分析安装</a></li><li class="chapter-item "><a href="2015-03-07-h3c-vlan.html">H3C划分VLAN命令</a></li><li class="chapter-item "><a href="2015-03-05-redis-easy-install.html">Redis安装及主从配置</a></li><li class="chapter-item "><a href="2015-01-21-shadowsocks-python-node.html">shadowsocks的python和nodejs版搭建</a></li><li class="chapter-item "><a href="2015-01-07-ruby-Syntax-error-Invalid-GBK.html">ruby环境sass编译中文出现 Invalid GBK character</a></li><li class="chapter-item "><a href="2015-01-06-mysql-m-s-s.html">如何搭master-slave-slave</a></li><li class="chapter-item "><a href="2015-01-06-mysql5.1-ms.html">Mysql5.1主从服务设置</a></li><li class="chapter-item "><a href="2015-01-06-linux-rm-luanma.html">linux下删除乱码文件</a></li><li class="chapter-item "><a href="2014-12-17-SVNListParentPath.html">利用SVNListParentPath增加http浏览仓库根目录的功能</a></li><li class="chapter-item "><a href="2014-12-15-Chrome-css-failed.html">Chrome 浏览器加载 css Failed to load resource</a></li><li class="chapter-item "><a href="2014-12-04-centos-gitlab-yijian.html">centos gitlab一键安装备份恢复和迁移</a></li><li class="chapter-item "><a href="2014-12-02-linux-sar.html">linux sar命令</a></li><li class="chapter-item "><a href="2014-11-24-ruby-on-rails-err.html">ruby on rails 报错解决</a></li><li class="chapter-item "><a href="2014-11-18-awk-note.html">AWK统计随笔记录</a></li><li class="chapter-item "><a href="2014-11-12-svn-force-commit.html">SVN强制提交commit</a></li><li class="chapter-item "><a href="2014-11-12-rm-list-too-long.html">rm Argument list too long的解决办法</a></li><li class="chapter-item "><a href="2014-11-12-crontab-linux-lessthan.html">Crontab导致Linux的线程数枯竭</a></li><li class="chapter-item "><a href="2014-11-11-shell-ftp-uplod.html">用二句Shell命令实现FTP批量上传文件夹</a></li><li class="chapter-item "><a href="2014-11-10-redis-disk-memory-err.html">redis 写磁盘出错Cannot allocate memory</a></li><li class="chapter-item "><a href="2014-10-19-Jekyll_Variables.html">Jekyll目录结构与变量</a></li><li class="chapter-item "><a href="2014-10-19-git_common_command.html">Git 常用命令整理</a></li><li class="chapter-item "><a href="2014-10-18-windows_configuration_Jekyll.html">Windows平台配置Jekyll环境并与GitHub连接</a></li><li class="chapter-item chapter-item-current"><a href="2014-08-21-centos-kvm-install.html">Redhat/CentOS系统KVM虚拟机安装过程详解</a></li><li class="chapter-item "><a href="2014-08-18-Sublime-add-youjian.html">将sublime text添加到右键菜单中</a></li><li class="chapter-item "><a href="2014-08-13-Sublime-python-build.html">Sublime Text 3设置python编译支持环境设置</a></li><li class="chapter-item "><a href="2014-08-11-shell-syntax-error.html">SHELL syntax error:unexpected end of file 提示错误</a></li><li class="chapter-item "><a href="2014-07-31-mysql-daxiaoxie.html">Windows下MySQL无法区分大小写解决方案</a></li><li class="chapter-item "><a href="2014-07-31-CentOS-NFS-mount.html">CentOS NFS的安装配置、启动及mount挂载方法</a></li><li class="chapter-item "><a href="2014-07-30-tencent-yun-repo.html">腾讯云的YUM repo</a></li><li class="chapter-item "><a href="2014-07-29-mysql-dump-all.html">Mysqldump参数大全</a></li><li class="chapter-item "><a href="2014-07-28-git-del-err-commit.html">git删除错误提交的commit</a></li><li class="chapter-item "><a href="2014-07-25-mysql-instet-other-table.html">MySql中把一个表的数据插入到另一个表中的实现</a></li><li class="chapter-item "><a href="2014-07-25-centos-install-ossec.html">centos安装ossec</a></li><li class="chapter-item "><a href="2014-07-24-phpmyadmin-error.html">访问phpmyadmin错误</a></li><li class="chapter-item "><a href="2014-07-13-black-apple.html">厚黑苹果售后</a></li><li class="chapter-item "><a href="2014-06-25-wordpress-google-css.html">wordpress引用google开放css加载不到解决方法</a></li><li class="chapter-item "><a href="2014-06-25-nginx-https.html">centos下nginx的https配置</a></li><li class="chapter-item "><a href="2014-05-30-rsync.html">rsync同步部署</a></li><li class="chapter-item "><a href="2014-05-15-saltstack1.html">使用saltstack批量管理服务器 （一）</a></li><li class="chapter-item "><a href="2014-04-18-msmtpmutt.html">msmtp+mutt 服务器批量发送邮件</a></li><li class="chapter-item "><a href="2014-04-14-zabbix-server-install.html">zabbix的server端安装配置</a></li><li class="chapter-item "><a href="2014-04-05-wordpress-them-only-one.html">wordpress后台主题只有一个解决方法</a></li><li class="chapter-item "><a href="2014-01-30-many-php-version.html">多版本php共存搭建</a></li><li class="chapter-item "><a href="2013-11-06-linux-memery-cat.html">linux查看内存相关命令</a></li><li class="chapter-item "><a href="2013-07-07-github-easy-install.html">github安装使用</a></li><li class="chapter-item "><a href="2013-06-30-localhost-127.0.0.1.html">localhost 与 127.0.0.1 的区别</a></li><li class="chapter-item "><a href="2013-06-15-rsync-del-hailiang.html">使用rsync删除海量文件</a></li><li class="chapter-item "><a href="2013-06-08-disk-data-recovery.html">记录一次服务器数据恢复</a></li><li class="chapter-item "><a href="2013-06-03-1nginx-502.html">记录一次nginx 502</a></li><li class="chapter-item "><a href="2013-06-02-linux-nohup.html">linux命令后台运行详解</a></li><li class="chapter-item "><a href="2013-06-01-disk-inode.html">深入理解磁盘inode</a></li><li class="chapter-item "><a href="2013-05-09-mysql-error-1064.html">MySQL错误ERROR 1064 (type=myisam出错)</a></li><li class="chapter-item "><a href="2013-01-04-centos-php-oracle.html">centos6.2下php支持oracle</a></li><li class="chapter-item "><a href="2012-12-27-oracle-startup-failure.html">oracle startup failure</a></li><li class="chapter-item "><a href="2012-12-27-oracle-startup.html">oracle startup 故障：ORA-00845: MEMORY_TARGET</a></li><li class="chapter-item "><a href="2012-12-27-ora-01102-cannot-mount-database-in-exclusive-mode.html">ORA-01102: cannot mount database in EXCLUSIVE mode</a></li><li class="chapter-item "><a href="2012-12-20-centos-install-oracle-11g.html">centos install oracle 11g</a></li><li class="chapter-item "><a href="2012-11-14-mysql-slow-log.html">Mysql慢查询设置</a></li><li class="chapter-item "><a href="2012-11-14-mysql-ms-error.html">MYSQL主从同步故障事件</a></li><li class="chapter-item "><a href="2012-08-10-python-mysqldb-install.html">CentOS下python-mysqldb安装事件</a></li><li class="chapter-item "><a href="2012-08-03-sqlite-source-upgrade.html">sqlite3源码升级事件</a></li><li class="chapter-item "><a href="2012-08-01-centos6-pythonsqlite3.html">centos6.2升级python后处理sqlite3库事件</a></li><li class="chapter-item "><a href="2012-07-30-mysql5-5-ms.html">mysql5.5版本主从搭建</a></li><li class="chapter-item "><a href="2012-07-18-repair-yum.html">误卸载python导致yum无法使用修复事件</a></li><li class="chapter-item "><a href="2012-07-18-reload-upgrade-python.html">Centos平滑升级python事件</a></li><li class="chapter-item "><a href="2012-07-18-nginx413.html">Nginx出现“413 Request Entity Too Large”错误解决方法</a></li><li class="chapter-item "><a href="2012-07-06-nginx-apache-mulu-bd.html">Nginx、Apache目录浏览功能</a></li><li class="chapter-item "><a href="2012-06-27-yum-lamp-tomcat.html">CentOS yum安装配置LAMP+tomcat</a></li><li class="chapter-item "><a href="2012-06-11-ios-jiangji.html">ios5.0.1降级4.3.3事件</a></li><li class="chapter-item "><a href="2012-05-17-ocr-Tesseract.html">OCR之Tesseract的linux下安装</a></li><li class="chapter-item "><a href="2012-05-04-memcached-easy-install.html">memcached简易安装</a></li><li class="chapter-item "><a href="2012-04-11-centos-install-snmp.html">centos下snmp客户端安装</a></li><li class="chapter-item "><a href="2012-03-13-iptables-shell.html">一篇很不错的iptables的shell</a></li><li class="chapter-item "><a href="2012-03-07-cisco-fudong-luyou.html">思科静态浮动路由配置</a></li><li class="chapter-item "><a href="markdown.html">Markdown 简明语法手册</a></li><li class="chapter-item "><a href="hello-world.html">Hello World</a></li></ul>
</div>

<div class="progress-indicator"></div>

<!-- SCRIPTS -->
<script>
  var LOPPO = {};
  LOPPO.current_path = '2014-08-21-centos-kvm-install.md';
  LOPPO.relative_root_path = '';
  LOPPO.article_toc = "<ul class=\"markdownIt-TOC\">\n<li><a href=\"#%E4%BB%80%E4%B9%88%E6%98%AF-kvm-\">什么是 KVM ?</a></li>\n<li><a href=\"#centos%E4%B8%8A%E5%AE%89%E8%A3%85kvm%E5%8A%9F%E8%83%BD%E6%A8%A1%E5%9D%97%E6%AD%A5%E9%AA%A4\">CentOS上安装KVM功能模块步骤</a></li>\n<li><a href=\"#%E9%85%8D%E7%BD%AEkvm\">配置KVM</a></li>\n<li><a href=\"#%E9%85%8D%E7%BD%AE%E7%BD%91%E8%B7%AF%E7%8E%AF%E5%A2%83\">配置网路环境</a></li>\n<li><a href=\"#---20141029%E6%9B%B4%E6%96%B0---\">---2014.10.29更新---</a></li>\n</ul>\n";
</script>
<script src="assets/js/app.js"></script>

</body>
</html>

