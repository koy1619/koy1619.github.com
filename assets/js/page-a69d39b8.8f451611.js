(window.webpackJsonp=window.webpackJsonp||[]).push([[112],{429:function(t,s,a){"use strict";a.r(s);var n=a(1),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"crontab导致linux的线程数枯竭"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#crontab导致linux的线程数枯竭","aria-hidden":"true"}},[t._v("#")]),t._v(" Crontab导致Linux的线程数枯竭")]),t._v(" "),a("h2",{attrs:{id:"症状描述："}},[a("a",{staticClass:"header-anchor",attrs:{href:"#症状描述：","aria-hidden":"true"}},[t._v("#")]),t._v(" 症状描述：")]),t._v(" "),a("pre",[a("code",[t._v("ps -ef |grep sendmail 满屏\nps -ef |grep postdrop 满屏\n")])]),t._v(" "),a("p",[t._v("查看log疯狂刷屏\n")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@10-10-11-141 runtime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# tail -f /var/log/maillog")]),t._v("\nNov "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("18")]),t._v(":00:24 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("-10-11-141 postfix/postdrop"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3804")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(": warning: mail_queue_enter: create "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v(" maildrop/634461.3804: No such "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v(" or directory\nNov "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("18")]),t._v(":00:24 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("-10-11-141 postfix/postdrop"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4147")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(": warning: mail_queue_enter: create "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v(" maildrop/634601.4147: No such "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v(" or directory\nNov "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("18")]),t._v(":00:24 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("-10-11-141 postfix/postdrop"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1741")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(": warning: mail_queue_enter: create "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v(" maildrop/634604.1741: No such "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v(" or directory\nNov "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("18")]),t._v(":00:24 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("-10-11-141 postfix/postdrop"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1967")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(": warning: mail_queue_enter: create "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v(" maildrop/843229.1967: No such "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v(" or directory\nNov "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("18")]),t._v(":00:25 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("-10-11-141 postfix/postdrop"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3244")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(": warning: mail_queue_enter: create "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v(" maildrop/135131.3244: No such "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v(" or directory\nNov "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("18")]),t._v(":00:25 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("-10-11-141 postfix/postdrop"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2514")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(": warning: mail_queue_enter: create "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v(" maildrop/135247.2514: No such "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v(" or directory\n")])])]),a("p",[t._v("同时"),a("code",[t._v("/var/spool/postfix/maildrop/")]),t._v("文件夹下出现大量簇文件")]),t._v(" "),a("h2",{attrs:{id:"解决"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解决","aria-hidden":"true"}},[t._v("#")]),t._v(" 解决")]),t._v(" "),a("p",[t._v("使用"),a("code",[t._v("pstree|grep crond")]),t._v("，结果如下：")]),t._v(" "),a("pre",[a("code",[t._v(" |-crond---125*[crond---sendmail---postdrop]  \n")])]),t._v(" "),a("p",[t._v("可见crond守护进程启动了sendmail，进而启动了postdrop。查看crond的配置， crontab -e，都没有发现几秒就启动的程序，所以可能是sendmail自己一旦邮件发送不成功，就持续重新发送而导致持续启动postdrop，而postdrop总是执行失败，导致持续写入日志到日志文件。日志文件增大的速率超过了logrotate的删除频率，所以占据了100%的磁盘空间。并且线程数也不断的增加。")]),t._v(" "),a("p",[t._v("首先停掉posfix "),a("code",[t._v("/etc/init.d/posfix stop")]),t._v("并删除"),a("code",[t._v("/var/spool/postfix/maildrop/")]),t._v("下面的全部簇文件，释放磁盘inode！")]),t._v(" "),a("p",[t._v("然后就是手起刀落干掉sendmail和postdrop的进程，注意先干掉postdrop子进程")]),t._v(" "),a("pre",[a("code",[t._v("kill -9 $(ps -auwx | grep postdrop | gawk -F' ' '{print $2}')\nkill -9 $(ps -auwx | grep sendmail | gawk -F' ' '{print $2}')\n")])]),t._v(" "),a("p",[t._v("之后还要设置crond的MAILTO为空")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@10-10-11-141 runtime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat /etc/cron.d/0hourly ")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("MAILTO")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("SHELL")])]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/bin/bash\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("PATH")])]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/sbin:/bin:/usr/sbin:/usr/bin\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("HOME")])]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/\n01 * * * * root run-parts /etc/cron.hourly\n")])])]),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@10-10-11-141 runtime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat /etc/crontab ")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("MAILTO")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("SHELL")])]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/bin/bash\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("PATH")])]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/sbin:/bin:/usr/sbin:/usr/bin\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("HOME")])]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# For details see man 4 crontabs")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Example of job definition:")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# .---------------- minute (0 - 59)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# |  .------------- hour (0 - 23)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# |  |  .---------- day of month (1 - 31)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# |  |  |  |  |")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# *  *  *  *  * user-name command to be executed")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@10-10-11-141 runtime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# service crond restart")]),t._v("\n")])])]),a("p",[t._v("最后整个世界都清静了！")])])}),[],!1,null,null,null);s.default=e.exports}}]);