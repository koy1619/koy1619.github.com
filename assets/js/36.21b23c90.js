(window.webpackJsonp=window.webpackJsonp||[]).push([[36],{342:function(t,s,a){"use strict";a.r(s);var e=a(2),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"基于twemproxy的redis集群方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#基于twemproxy的redis集群方案","aria-hidden":"true"}},[t._v("#")]),t._v(" 基于Twemproxy的Redis集群方案")]),t._v(" "),a("p",[t._v("Twemproxy是一种代理分片机制，由Twitter开源。Twemproxy作为代理，可接受来自多个程序的访问，按照路由规则，转发给后台的各个Redis服务器，分片存储到多个redis实例中；再原路返回。")]),t._v(" "),a("p",[t._v("玩过nginx反向代理的就懂了。")]),t._v(" "),a("h2",{attrs:{id:"编译安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#编译安装","aria-hidden":"true"}},[t._v("#")]),t._v(" 编译安装")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("wget")]),t._v(" http://ftp.gnu.org/gnu/autoconf/autoconf-2.69.tar.gz\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("wget")]),t._v(" https://codeload.github.com/twitter/twemproxy/zip/master\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#查找旧版本autoconf，并且卸载")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("rpm")]),t._v(" -qf /usr/bin/autoconf\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("rpm")]),t._v(" -e --nodeps autoconf-2.63\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#安装最新版本")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("tar")]),t._v(" zxvf autoconf-2.69.tar.gz \n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" autoconf-2.69 \n./configure --prefix"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/usr \n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#编译安装 twemproxy")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("unzip")]),t._v(" twemproxy-master.zip\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" twemproxy-master\nautoreconf -fvi\n./configure --prefix"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/usr/local/twemproxy\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v(" -j "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#设置环境变量：")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"PATH='),a("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("$PATH")]),t._v(':/usr/local/twemproxy/sbin/"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" /etc/profile\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("source")]),t._v(" /etc/profile\n")])])]),a("h2",{attrs:{id:"创建相关目录"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建相关目录","aria-hidden":"true"}},[t._v("#")]),t._v(" 创建相关目录")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" /usr/local/twemproxy\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" run conf\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#存放配置文件和pid文件")]),t._v("\n")])])]),a("h2",{attrs:{id:"配置文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置文件","aria-hidden":"true"}},[t._v("#")]),t._v(" 配置文件")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" /usr/local/twemproxy/conf/nutcracker.yml\nalpha:\n  listen: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),t._v(".0.1:22121\n  hash: fnv1a_64\n  distribution: ketama\n  auto_eject_hosts: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n  redis: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n  server_retry_timeout: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2000")]),t._v("\n  server_failure_limit: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n  servers:\n   - "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),t._v(".0.1:7000:1\n   - "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),t._v(".0.1:7001:1\n")])])]),a("p",[t._v("本地安装了2个redis实例并启动")]),t._v(" "),a("h2",{attrs:{id:"启动twemproxy服务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#启动twemproxy服务","aria-hidden":"true"}},[t._v("#")]),t._v(" 启动Twemproxy服务")]),t._v(" "),a("p",[t._v("测试配置文件")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("nutcracker -t\nnutcracker: configuration "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'conf/nutcracker.yml'")]),t._v(" syntax is ok\n")])])]),a("p",[t._v("启动命令：")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("nutcracker -d -c /usr/local/twemproxy/conf/nutcracker.yml -p /usr/local/twemproxy/run/redisproxy.pid -o /usr/local/twemproxy/run/redisproxy.log\n")])])]),a("p",[t._v("nutcracker用法与命令选项")]),t._v(" "),a("p",[a("strong",[t._v("Options:")])]),t._v(" "),a("blockquote",[a("ul",[a("li",[t._v("-h, –help                        : 查看帮助文档，显示命令选项")]),t._v(" "),a("li",[t._v("-V, –version                     : 查看nutcracker版本")]),t._v(" "),a("li",[t._v("-t, –test-conf                   : 测试配置脚本的正确性")]),t._v(" "),a("li",[t._v("-d, –daemonize                   : 以守护进程运行")]),t._v(" "),a("li",[t._v("-D, –describe-stats              : 打印状态描述")]),t._v(" "),a("li",[t._v("-v, –verbosity=N                 : 设置日志级别 (default: 5, min: 0, max: 11)")]),t._v(" "),a("li",[t._v("-o, –output=S                    : 设置日志输出路径，默认为标准错误输出 (default: stderr)")]),t._v(" "),a("li",[t._v("-c, –conf-file=S                 : 指定配置文件路径 (default: conf/nutcracker.yml)")]),t._v(" "),a("li",[t._v("-s, –stats-port=N                : 设置状态监控端口，默认22222 (default: 22222)")]),t._v(" "),a("li",[t._v("-a, –stats-addr=S                : 设置状态监控IP，默认0.0.0.0 (default: 0.0.0.0)")]),t._v(" "),a("li",[t._v("-i, –stats-interval=N            : 设置状态聚合间隔 (default: 30000 msec)")]),t._v(" "),a("li",[t._v("-p, –pid-file=S                  : 指定进程pid文件路径，默认关闭 (default: off)")]),t._v(" "),a("li",[t._v("-m, –mbuf-size=N                 : 设置mbuf块大小，以bytes单位 (default: 16384 bytes)")])])]),t._v(" "),a("h2",{attrs:{id:"测试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#测试","aria-hidden":"true"}},[t._v("#")]),t._v(" 测试")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),t._v(".0.1:2212"),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[t._v("1")]),t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v(" name linux48\nOK\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),t._v(".0.1:2212"),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[t._v("1")]),t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v(" name2 linux482\nOK\n\n\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),t._v(".0.1:700"),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[t._v("0")]),t._v(">")]),t._v(" KEYS *\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"name"')]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),t._v(".0.1:700"),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[t._v("1")]),t._v(">")]),t._v(" KEYS *\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"name2"')]),t._v("\n")])])]),a("p",[t._v("发现我们的测试数据分片到了两个redis实例中。")]),t._v(" "),a("h2",{attrs:{id:"生产环境"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#生产环境","aria-hidden":"true"}},[t._v("#")]),t._v(" 生产环境")]),t._v(" "),a("p",[t._v("haproxy+keepalived+Redis-Sentinel+redis-master-slave")])])}),[],!1,null,null,null);s.default=n.exports}}]);