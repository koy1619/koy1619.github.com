(window.webpackJsonp=window.webpackJsonp||[]).push([[112],{400:function(s,n,a){"use strict";a.r(n);var t=a(2),e=Object(t.a)({},(function(){var s=this,n=s.$createElement,a=s._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("div",{staticClass:"custom-block tip"},[a("p",[s._v("架构为")]),s._v(" "),a("p",[s._v("pod <== nginx-ingress <== haproxy <== Internet")])]),s._v(" "),a("p",[s._v("操作方式")]),s._v(" "),a("p",[s._v("kubectl edit cm nginx-configuration -n ingress-nginx")]),s._v(" "),a("p",[s._v("也可以修改nginx-ingress.yaml")]),s._v(" "),a("p",[s._v("以下为配置方法")]),s._v(" "),a("p",[s._v("默认情况下")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://wx1.sbimg.cn/2020/06/04/1.md.png",alt:"1.png"}}),s._v("\n或者\n"),a("img",{attrs:{src:"https://wx2.sbimg.cn/2020/06/04/29aeaa22d3d61b2cf.md.png",alt:"29aeaa22d3d61b2cf.png"}})]),s._v(" "),a("p",[s._v("增加标记参数 重新apply nginx-ingress.yaml")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br")]),a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("apiVersion: v1\nkind: Service\nmetadata:\n  name: ingress-nginx\n  namespace: ingress-nginx\n  labels:\n    app.kubernetes.io/name: ingress-nginx\n    app.kubernetes.io/part-of: ingress-nginx\nspec:\n  type: NodePort\n  externalTrafficPolicy: Local\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[a("img",{attrs:{src:"https://wx1.sbimg.cn/2020/06/04/3.md.png",alt:"3.png"}})]),s._v(" "),a("p",[s._v("可见获取了客户端真实IP，但是是前端的代理haproxy的IP地址。。。")]),s._v(" "),a("p",[s._v("继续增加标记参数 重新apply nginx-ingress.yaml")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br")]),a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kind: ConfigMap\napiVersion: v1\nmetadata:\n  name: nginx-configuration\n  namespace: ingress-nginx\n  labels:\n    app.kubernetes.io/name: ingress-nginx\n    app.kubernetes.io/part-of: ingress-nginx\ndata:\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 获取真实IP地址")]),s._v("\n  compute-full-forwarded-for: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),s._v("\n  forwarded-for-header: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"X-Forwarded-For"')]),s._v("\n  use-forwarded-headers: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),s._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# nginx-ingress前端还有代理,后端获取真实IP")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# proxy-real-ip-cidr: 10.127.0.10")]),s._v("\n  use-proxy-protocol: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),s._v("\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("p",[s._v("前置haproxy配置 须增加send-proxy参数")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("listen nginx_gress_http\n     mode http\n     balance roundrobin\n     "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("bind")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0:80\n     "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" client 30s\n     "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" server 30s\n     "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" connect 30s\n     server k8s_node_1 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.127")]),s._v(".0.17:32080 weight "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" check inter "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),s._v(" rise "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" fall "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" send-proxy\n     server k8s_node_2 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.127")]),s._v(".0.18:32080 weight "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" check inter "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),s._v(" rise "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" fall "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" send-proxy\n\n\n\nlisten nginx_gress_https\n     mode tcp\n     balance roundrobin\n     "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("bind")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0:443\n     "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" client 30s\n     "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" server 30s\n     "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" connect 30s\n     server k8s_node_1 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.127")]),s._v(".0.17:32443 weight "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" check inter "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),s._v(" rise "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" fall "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" send-proxy\n     server k8s_node_2 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.127")]),s._v(".0.18:32443 weight "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" check inter "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),s._v(" rise "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" fall "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" send-proxy\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br")])]),a("p",[a("img",{attrs:{src:"https://wx2.sbimg.cn/2020/06/04/4.md.png",alt:"4.png"}})]),s._v(" "),a("p",[s._v("收工！！！")]),s._v(" "),a("p",[s._v("如果前端代理为nginx, 需注意加到nginx.conf主配里面")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("stream "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    upstream name "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        server "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.127")]),s._v(".0.17:32443 "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("max_fails")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("fail_timeout")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("30s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        server "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.127")]),s._v(".0.18:32443 "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("max_fails")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("fail_timeout")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("30s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    server "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        listen "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            proxy_connect_timeout 1s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            proxy_timeout 3s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            proxy_pass name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            proxy_protocol on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("p",[s._v("实现原理不再赘述，网上一大推")]),s._v(" "),a("p",[s._v("参考文档如下:")]),s._v(" "),a("p",[s._v("https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#use-proxy-protocol")]),s._v(" "),a("p",[s._v("https://chanjarster.github.io/chanjarster.github.io/post/k8s/pass-client-ip-to-backend/")]),s._v(" "),a("p",[s._v("https://blog.csdn.net/weixin_30817749/article/details/99336992")])])}),[],!1,null,null,null);n.default=e.exports}}]);