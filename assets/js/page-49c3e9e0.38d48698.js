(window.webpackJsonp=window.webpackJsonp||[]).push([[70],{361:function(s,a,t){"use strict";t.r(a);var e=t(1),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"mysql高可用之mha"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mysql高可用之mha","aria-hidden":"true"}},[s._v("#")]),s._v(" MySQL高可用之MHA")]),s._v(" "),t("h2",{attrs:{id:"mha简介"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mha简介","aria-hidden":"true"}},[s._v("#")]),s._v(" MHA简介")]),s._v(" "),t("p",[t("strong",[s._v("MHA")]),s._v("，即"),t("code",[s._v("MasterHigh Availability Manager and Tools for MySQL")]),s._v("，是日本的一位MySQL专家采用Perl语言编写的一个脚本管理工具，该工具仅适用于MySQLReplication（二层）环境，目的在于维持Master主库的高可用性。")]),s._v(" "),t("p",[t("code",[s._v("MHA(Master High Availability)")]),s._v("是自动的master故障转移和Slave提升的软件包.它是基于标准的MySQL复制(异步/半同步).")]),s._v(" "),t("p",[s._v("MHA有两部分组成:"),t("strong",[s._v("MHA Manager(管理节点)"),t("strong",[s._v("和")]),s._v("MHA Node(数据节点)")]),s._v(".")]),s._v(" "),t("p",[t("strong",[s._v("MHA Manager")]),s._v("可以单独部署在一台独立机器上管理多个master-slave集群,也可以部署在一台slave上."),t("strong",[s._v("MHA Manager")]),s._v("探测集群的node节点,当发现master出现故障的时候,它可以自动将具有最新数据的slave提升为新的master,然后将所有其它的slave导向新的master上.整个故障转移过程对应用程序是透明的。")]),s._v(" "),t("p",[s._v("MHA node运行在每台MySQL服务器上(master/slave/manager),它通过监控具备解析和清理logs功能的脚本来加快故障转移的。")]),s._v(" "),t("h2",{attrs:{id:"工作原理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#工作原理","aria-hidden":"true"}},[s._v("#")]),s._v(" 工作原理")]),s._v(" "),t("p",[s._v("其工作原理我个人认为有以下几点：")]),s._v(" "),t("blockquote",[t("ul",[t("li",[s._v("MHA从代码层面看，就是一套Perl脚本集合")]),s._v(" "),t("li",[s._v("MHA安装本质其实就是把perl脚本执行文件解压并安装perl依赖包")]),s._v(" "),t("li",[s._v("通过授权mysql账户和ssh互信来达到通过mha-manager使用perl脚本调用linux mysql命令实时检测控制各个node故障转移")]),s._v(" "),t("li",[s._v("mha-manager使用perl脚本来动态切换VIP以达到高可用")]),s._v(" "),t("li",[s._v("......")])])]),s._v(" "),t("p",[s._v("其详细工作过程网上一大把不在赘述。。。")]),s._v(" "),t("h2",{attrs:{id:"install"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#install","aria-hidden":"true"}},[s._v("#")]),s._v(" INSTALL")]),s._v(" "),t("p",[s._v("废话不多说，开搞！！！")]),s._v(" "),t("p",[s._v("目前MHA主要支持一主多从的架构，要搭建MHA,要求一个复制集群中必须最少有三台数据库服务器，一主二从，即一台充当master，一台充当备用master，另外一台充当从库，因为至少需要三台服务器")]),s._v(" "),t("p",[s._v("我们自己使用其实也可以使用1主1从，但是master主机宕机后无法切换，以及无法补全binlog。master的mysqld进程crash后，还是可以切换成功，以及补全binlog的。")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",{staticStyle:{"text-align":"center"}},[s._v("IP")]),s._v(" "),t("th",{staticStyle:{"text-align":"center"}},[s._v("OS")]),s._v(" "),t("th",{staticStyle:{"text-align":"center"}},[s._v("mysql")]),s._v(" "),t("th",{staticStyle:{"text-align":"center"}},[s._v("node")]),s._v(" "),t("th",{staticStyle:{"text-align":"center"}},[s._v("MHA")])])]),s._v(" "),t("tbody",[t("tr",[t("td",{staticStyle:{"text-align":"center"}},[s._v("192.168.179.128")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("CentOS 7.3")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("5.7.22")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("master")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("mha-node")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"center"}},[s._v("192.168.179.129")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("CentOS 7.3")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("5.7.22")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("slave")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("mha-manager & mha-node")])])])]),s._v(" "),t("p",[t("strong",[t("code",[s._v("vip 192.168.179.130")])]),s._v(" "),t("strong",[t("code",[s._v("VMware® Workstation 14 Pro")])])]),s._v(" "),t("h3",{attrs:{id:"配置主从，vip，ssh互信，授权mysql管理账户"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置主从，vip，ssh互信，授权mysql管理账户","aria-hidden":"true"}},[s._v("#")]),s._v(" 配置主从，VIP，SSH互信，授权mysql管理账户")]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 128 129(配置mysql复制用户)")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("grant")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("replication")]),s._v(" slave "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'repl'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'192.168.179.129'")]),s._v("  identified "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'repl'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nflush "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("privileges")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("grant")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("replication")]),s._v(" slave "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'repl'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'192.168.179.128'")]),s._v("  identified "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'repl'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nflush "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("privileges")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 128 129(配置mysql的mha监控用户)")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("grant")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("all")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("privileges")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'view'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'192.168.179.129'")]),s._v(" identified  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'view123'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nflush "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("privileges")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("grant")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("all")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("privileges")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'view'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'192.168.179.128'")]),s._v(" identified  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'view123'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nflush "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("privileges")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- #公钥互信")]),s._v("\nssh"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("keygen\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("128")]),s._v("和"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("129")]),s._v("互传公钥\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#本机也要加")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("128")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("129")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys")]),s._v("\n\n")])])]),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("128")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("master"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n/sbin/ifconfig ens33:1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".179.130/24\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ip addr add 192.168.179.130/24 dev ens33:1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ip addr del 192.168.179.130/24 dev ens33:1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" addr "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'192.168.179.130'")]),s._v("\nshow master status"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n\n-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("129")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("slave"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nCHANGE MASTER TO  "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MASTER_HOST")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'192.168.179.129'")]),s._v(",MASTER_USER"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'repl'")]),s._v(",MASTER_PASSWORD"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'repl'")]),s._v(",MASTER_LOG_FILE"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mysql-bin.000005'")]),s._v(",MASTER_LOG_POS"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3340")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \nstart slave"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("h3",{attrs:{id:"install-mha"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#install-mha","aria-hidden":"true"}},[s._v("#")]),s._v(" INSTALL MHA")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("129")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("slave"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rpm")]),s._v(" -ivh http://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rpm -ivh http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm")]),s._v("\n\n\nyum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" perl-DBD-MySQL perl-Config-Tiny perl-Log-Dispatch perl-Parallel-ForkManager perl-Time-HiRes   --skip-broken  -y\n\nyum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y perl-ExtUtils-CBuilder perl-ExtUtils-MakeMaker\n\nyum -y "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" perl-CPAN\n\nyum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y perl-Mail-Sender \n\nyum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y perl-Log-Dispatch\n\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" xf mha4mysql-manager-0.56.tar.gz\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" mha4mysql-manager-0.56\nperl Makefile.PL\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" xf mha4mysql-node-0.56.tar.gz \n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" mha4mysql-node-0.56\nperl Makefile.PL\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v("\n\n\n-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("128")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("master"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" only "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" mha4mysql-node\n\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /usr/local/bin/master_ip_failover\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /usr/local/bin/master_ip_online_change\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /usr/local/bin/load_cnf\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /data/mha/3306/mha.cnf\n")])])]),t("h2",{attrs:{id:"check-mha"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#check-mha","aria-hidden":"true"}},[s._v("#")]),s._v(" CHECK MHA")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("129")]),s._v(" mha-manager\n\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 检查ssh连接")]),s._v("\nmasterha_check_ssh --conf"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/data/mha/3306/mha.cnf\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 检查主从")]),s._v("\nmasterha_check_repl --conf"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/data/mha/3306/mha.cnf\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 手动切换主从")]),s._v("\nmasterha_master_switch --master_state"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("alive --conf"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/data/mha/3306/mha.cnf --new_master_host"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".179.129 --new_master_port"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3306")]),s._v(" --orig_master_is_new_slave\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 检查mha状态")]),s._v("\nmasterha_check_status --conf"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/data/mha/3306/mha.cnf\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动mha_manager")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("nohup")]),s._v(" /usr/local/bin/masterha_manager --conf"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/data/mha/3306/mha.cnf --ignore_last_failover "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /data/mha/3306/log/manager.log "),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("&1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("\n")])])]),t("h2",{attrs:{id:"test"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#test","aria-hidden":"true"}},[s._v("#")]),s._v(" TEST...")]),s._v(" "),t("h2",{attrs:{id:"修复宕机的master"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#修复宕机的master","aria-hidden":"true"}},[s._v("#")]),s._v(" 修复宕机的Master")]),s._v(" "),t("p",[s._v("如果Master主机修复好了，可以在修复好后的"),t("strong",[s._v("Master")]),s._v("执行"),t("code",[s._v("CHANGE MASTER")]),s._v("操作，作为新的"),t("strong",[s._v("slave")]),s._v("库。")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@localhost ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# grep -i "All other slaves should start"  /data/mha/3306/log/manager.log ')]),s._v("\nTue Dec "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" 01:31:59 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2018")]),s._v(" - "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("info"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MASTER_HOST")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'192.168.179.129'")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MASTER_PORT")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3306")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MASTER_LOG_FILE")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mysql-bin.000009'")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MASTER_LOG_POS")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("498")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MASTER_USER")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'repl'")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MASTER_PASSWORD")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'xxx'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("hr"),s._v(" "),t("p",[s._v("本着先开搞后研究的套路，搞出来都测试OK，然后在研究代码就很easy了！")]),s._v(" "),t("hr"),s._v(" "),t("h2",{attrs:{id:"mha组件说明"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mha组件说明","aria-hidden":"true"}},[s._v("#")]),s._v(" MHA组件说明")]),s._v(" "),t("p",[s._v("前面说过"),t("code",[s._v("MHA")]),s._v("就是一套"),t("strong",[s._v("Perl脚本集合")]),s._v("；所以他的各个文件都是"),t("strong",[s._v("Perl脚本")])]),s._v(" "),t("p",[s._v("以下列举常用的组件")]),s._v(" "),t("p",[t("strong",[s._v("Manager")]),s._v("工具包主要包括以下几个工具：")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("masterha_check_ssh              "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#检查MHA的SSH配置状况")]),s._v("\nmasterha_check_repl             "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#检查MySQL复制状况")]),s._v("\nmasterha_manger                 "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#启动MHA")]),s._v("\nmasterha_check_status           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#检测当前MHA运行状态")]),s._v("\nmasterha_master_monitor         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#检测master是否宕机")]),s._v("\nmasterha_master_switch          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#控制故障转移（自动或者手动）")]),s._v("\nmasterha_conf_host              "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#添加或删除配置的server信息")]),s._v("\nmaster_ip_failover              "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#自动切换vip")]),s._v("\nmaster_ip_online_change         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#在线切换vip")]),s._v("\nload_cnf                        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#保存密码")]),s._v("\n")])])]),t("p",[t("strong",[s._v("Node")]),s._v("工具包（"),t("strong",[s._v("这些工具通常由MHA Manager的脚本触发，无需人为操作")]),s._v("）主要包括以下几个工具：")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("save_binary_logs                "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#保存和复制master的二进制日志")]),s._v("\napply_diff_relay_logs           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#识别差异的中继日志事件并将其差异的事件应用于其他的slave")]),s._v("\nfilter_mysqlbinlog              "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#去除不必要的ROLLBACK事件（MHA已不再使用这个工具）")]),s._v("\npurge_relay_logs                "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#清除中继日志（不会阻塞SQL线程）**重要**")]),s._v("\n")])])]),t("h2",{attrs:{id:"配置文件说明"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置文件说明","aria-hidden":"true"}},[s._v("#")]),s._v(" 配置文件说明")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@localhost ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /data/mha/3306/mha.cnf ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("server default"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("client_bindir")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/data/mysql-5.7.22-linux-glibc2.12-x86_64/bin/\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("manager_log")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/data/mha/3306/log/manager.log  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##设置manager的日志")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("manager_workdir")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/data/mha/3306/log  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##设置manager的工作目录")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("master_binlog_dir")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/data/mysql-5.7.22-linux-glibc2.12-x86_64/data/  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##设置master保存binlog的位置，以便MHA可以找到master的日志，我这里的也就是mysql的数据目录")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("master_ip_failover_script")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/local/bin/master_ip_failover  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##设置自动failover时候的切换脚本")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("master_ip_online_change_script")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" /usr/local/bin/master_ip_online_change  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##设置手动切换时候的切换脚本")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("report_script")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/local/bin/send_report  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##设置发生切换后发送的报警的脚本")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("init_conf_load_script")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/local/bin/load_cnf  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##保存mysql复制用户和root用户密码")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("remote_workdir")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/tmp  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##设置远端mysql在发生切换时binlog的保存位置")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#secondary_check_script= /usr/local/bin/masterha_secondary_check -s 192.168.0.30 -s 192.168.0.40")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("user")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("view  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##mysql的mha监控用户")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ping_interval")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##设置监控主库，发送ping包的时间间隔,用来检查master是否正常，默认是3秒，尝试三次没有回应的时候自动进行railover")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("repl_user")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("repl  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##mysql复制帐号，用来在主从机之间同步二进制日志等")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ssh_port")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##设置ssh的登录端口")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ssh_user")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("root  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##设置ssh的登录用户名")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("max_ping_errors")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("40")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##max_ping_errors=40，这个是修改了源码，增加了检测次数的定义，默认是3次，太容易误切换。")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("server1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("hostname")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".179.128\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("port")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3306")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("server2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("candidate_master")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##置为候选master，即master机宕掉后,优先启用这台作为新master，如果设置该参数以后，发生主从切换以后将会将此从库提升为主库，即使这个主库不是集群中事件最新的slave")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("check_repl_delay")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##默认情况下如果一个slave落后master 100M的relay logs的话，MHA将不会选择该slave作为一个新的master，因为对于这个slave的恢复需要花费很长时间，通过设置check_repl_delay=0,MHA触发切换在选择一个新的master的时候将会忽略复制延时，这个参数对于设置了candidate_master=1的主机非常有用，因为这个候选主在切换的过程中一定是新的master")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("hostname")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".179.129\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("port")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3306")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@localhost ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\n")])])]),t("h2",{attrs:{id:"切换vip脚本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#切换vip脚本","aria-hidden":"true"}},[s._v("#")]),s._v(" 切换vip脚本")]),s._v(" "),t("p",[s._v("自动切换vip脚本"),t("code",[s._v("master_ip_failover")]),s._v("\n在线切换vip脚本"),t("code",[s._v("master_ip_online_change")]),s._v("\n须根据自行方案修改")]),s._v(" "),t("div",{staticClass:"language-perl extra-class"},[t("pre",{pre:!0,attrs:{class:"language-perl"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@localhost")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("~")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /usr/local/bin/master_ip_failover |grep 'my' |awk '(NR<8 && NR>1)'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("my")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$vip")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'192.168.179.130'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("my")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$key")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("my")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$gateway1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'10.69.213.254'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("my")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$gateway2")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'10.69.59.254'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("my")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$ssh_start_vip")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/sbin/ip addr add  $vip/24 dev ens33:$key"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("my")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$ssh_stop_vip")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/sbin/ip addr del  $vip/24 dev ens33:$key"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n\n\n\n\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@localhost")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("~")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /usr/local/bin/master_ip_online_change |grep 'my' |awk '(NR<10 && NR>3)'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("my")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$vip")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'192.168.179.130'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("my")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$key")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("my")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$gateway1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'10.69.213.254'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("my")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$gateway2")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'10.69.59.254'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("my")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$ssh_start_vip")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/sbin/ip addr add  $vip/24 dev ens33:$key"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("my")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$ssh_stop_vip")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/sbin/ip addr del  $vip/24 dev ens33:$key"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@localhost")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("~")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\n")])])]),t("h2",{attrs:{id:"保存密码脚本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#保存密码脚本","aria-hidden":"true"}},[s._v("#")]),s._v(" 保存密码脚本")]),s._v(" "),t("div",{staticClass:"language-perl extra-class"},[t("pre",{pre:!0,attrs:{class:"language-perl"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@localhost")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("~")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /usr/local/bin/load_cnf")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#!/usr/bin/perl")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("eval")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'exec /usr/bin/perl  -S $0 ${1+\"$@\"}'")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# not running under some shell")]),s._v("\n  \n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"password=view123\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),s._v("mysql的mha监控密码\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"repl_password=repl\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),s._v("mysql复制密码\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@zhenru13")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3307")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\n")])])]),t("h2",{attrs:{id:"解决跨路由arp问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#解决跨路由arp问题","aria-hidden":"true"}},[s._v("#")]),s._v(" 解决跨路由arp问题")]),s._v(" "),t("div",{staticClass:"language-perl extra-class"},[t("pre",{pre:!0,attrs:{class:"language-perl"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@localhost")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("~")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /usr/local/bin/master_ip_failover |grep 'ssh_Bcast_arp'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("my")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$ssh_Bcast_arp")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/usr/sbin/arping -q -A -c 1 -I ens33 192.168.179.130"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('`ssh -o StrictHostKeyChecking=no -o GSSAPIAuthentication=no -p$new_master_ssh_port $ssh_user\\@$new_master_host \\" $ssh_Bcast_arp \\"`')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@localhost")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("~")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /usr/local/bin/master_ip_online_change |grep 'ssh_Bcast_arp'        ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("my")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$ssh_Bcast_arp")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/usr/sbin/arping -q -A -c 1 -I ens33 192.168.179.130"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('`ssh -o StrictHostKeyChecking=no -o GSSAPIAuthentication=no -p$new_master_ssh_port $new_master_ssh_user\\@$new_master_host \\" $ssh_Bcast_arp \\"`')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])])])}),[],!1,null,null,null);a.default=n.exports}}]);