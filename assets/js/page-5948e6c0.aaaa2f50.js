(window.webpackJsonp=window.webpackJsonp||[]).push([[114],{358:function(s,n,a){s.exports=a.p+"assets/img/1.md.f4df807e.png"},359:function(s,n,a){s.exports=a.p+"assets/img/29aeaa22d3d61b2cf.md.c573ab80.png"},360:function(s,n,a){s.exports=a.p+"assets/img/3.md.89e8e484.png"},361:function(s,n,a){s.exports=a.p+"assets/img/4.md.654b4c0f.png"},447:function(s,n,a){"use strict";a.r(n);var t=a(2),e=Object(t.a)({},(function(){var s=this,n=s.$createElement,t=s._self._c||n;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("div",{staticClass:"custom-block tip"},[t("p",[s._v("架构为")]),s._v(" "),t("p",[s._v("pod <== nginx-ingress <== haproxy <== Internet")])]),s._v(" "),t("p",[s._v("操作方式")]),s._v(" "),t("p",[s._v("kubectl edit cm nginx-configuration -n ingress-nginx")]),s._v(" "),t("p",[s._v("也可以修改nginx-ingress.yaml")]),s._v(" "),t("p",[s._v("以下为配置方法")]),s._v(" "),t("p",[s._v("默认情况下")]),s._v(" "),t("p",[t("img",{attrs:{src:a(358),alt:"1.png"}}),s._v("\n或者\n"),t("img",{attrs:{src:a(359),alt:"29aeaa22d3d61b2cf.png"}})]),s._v(" "),t("p",[s._v("增加标记参数 重新apply nginx-ingress.yaml")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("div",{staticClass:"highlight-lines"},[t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("div",{staticClass:"highlighted"},[s._v(" ")]),t("br")]),t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("apiVersion: v1\nkind: Service\nmetadata:\n  name: ingress-nginx\n  namespace: ingress-nginx\n  labels:\n    app.kubernetes.io/name: ingress-nginx\n    app.kubernetes.io/part-of: ingress-nginx\nspec:\n  type: NodePort\n  externalTrafficPolicy: Local\n")])]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("p",[t("img",{attrs:{src:a(360),alt:"3.png"}})]),s._v(" "),t("p",[s._v("可见获取了客户端真实IP，但是是前端的代理haproxy的IP地址。。。")]),s._v(" "),t("p",[s._v("继续增加标记参数 重新apply nginx-ingress.yaml")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("div",{staticClass:"highlight-lines"},[t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("div",{staticClass:"highlighted"},[s._v(" ")]),t("div",{staticClass:"highlighted"},[s._v(" ")]),t("div",{staticClass:"highlighted"},[s._v(" ")]),t("div",{staticClass:"highlighted"},[s._v(" ")]),t("div",{staticClass:"highlighted"},[s._v(" ")]),t("div",{staticClass:"highlighted"},[s._v(" ")]),t("div",{staticClass:"highlighted"},[s._v(" ")]),t("div",{staticClass:"highlighted"},[s._v(" ")]),t("br")]),t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("kind: ConfigMap\napiVersion: v1\nmetadata:\n  name: nginx-configuration\n  namespace: ingress-nginx\n  labels:\n    app.kubernetes.io/name: ingress-nginx\n    app.kubernetes.io/part-of: ingress-nginx\ndata:\n\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 获取真实IP地址")]),s._v("\n  compute-full-forwarded-for: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),s._v("\n  forwarded-for-header: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"X-Forwarded-For"')]),s._v("\n  use-forwarded-headers: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),s._v("\n\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# nginx-ingress前端还有代理,后端获取真实IP")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# proxy-real-ip-cidr: 10.127.0.10")]),s._v("\n  use-proxy-protocol: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),s._v("\n")])]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br")])]),t("p",[s._v("前置haproxy配置 须增加send-proxy参数")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("listen nginx_gress_http\n     mode http\n     balance roundrobin\n     "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("bind")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0:80\n     "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" client 30s\n     "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" server 30s\n     "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" connect 30s\n     server k8s_node_1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.127")]),s._v(".0.17:32080 weight "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" check inter "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),s._v(" rise "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" fall "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" send-proxy\n     server k8s_node_2 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.127")]),s._v(".0.18:32080 weight "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" check inter "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),s._v(" rise "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" fall "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" send-proxy\n\n\n\nlisten nginx_gress_https\n     mode tcp\n     balance roundrobin\n     "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("bind")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0:443\n     "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" client 30s\n     "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" server 30s\n     "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" connect 30s\n     server k8s_node_1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.127")]),s._v(".0.17:32443 weight "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" check inter "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),s._v(" rise "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" fall "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" send-proxy\n     server k8s_node_2 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.127")]),s._v(".0.18:32443 weight "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" check inter "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),s._v(" rise "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" fall "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" send-proxy\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br")])]),t("p",[t("img",{attrs:{src:a(361),alt:"4.png"}})]),s._v(" "),t("p",[s._v("收工！！！")]),s._v(" "),t("p",[s._v("如果前端代理为nginx, 需注意加到nginx.conf主配http外部")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("div",{staticClass:"highlight-lines"},[t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("div",{staticClass:"highlighted"},[s._v(" ")]),t("br"),t("br")]),t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("stream "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    upstream name "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        server "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.127")]),s._v(".0.17:32443 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("max_fails")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("fail_timeout")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("30s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        server "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.127")]),s._v(".0.18:32443 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("max_fails")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("fail_timeout")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("30s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    server "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        listen "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            proxy_connect_timeout 1s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            proxy_timeout 3s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            proxy_pass name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            proxy_protocol on"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("p",[s._v("实现原理不再赘述，网上一大推")]),s._v(" "),t("p",[s._v("参考文档如下:")]),s._v(" "),t("p",[s._v("https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#use-proxy-protocol")]),s._v(" "),t("p",[s._v("https://chanjarster.github.io/chanjarster.github.io/post/k8s/pass-client-ip-to-backend/")]),s._v(" "),t("p",[s._v("https://blog.csdn.net/weixin_30817749/article/details/99336992")])])}),[],!1,null,null,null);n.default=e.exports}}]);