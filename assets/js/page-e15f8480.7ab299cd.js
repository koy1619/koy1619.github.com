(window.webpackJsonp=window.webpackJsonp||[]).push([[189],{437:function(s,e,t){"use strict";t.r(e);var a=t(2),n=Object(a.a)({},(function(){var s=this,e=s.$createElement,t=s._self._c||e;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("集群部署好后，如果我们想知道集群中每个节点及节点上的"),t("code",[s._v("pod")]),s._v("资源使用情况，命令行下可以直接使用"),t("code",[s._v("kubectl top node/pod")]),s._v("来查看资源使用情况，默认此命令不能正常使用，需要我们部署对应"),t("code",[s._v("api")]),s._v("资源才可以使用此命令。从 "),t("code",[s._v("Kubernetes 1.8")]),s._v(" 开始，资源使用指标（如容器 "),t("code",[s._v("CPU")]),s._v(" 和内存使用率）通过 "),t("code",[s._v("Metrics API")]),s._v(" 在 "),t("code",[s._v("Kubernetes")]),s._v(" 中获取, "),t("code",[s._v("metrics-server")]),s._v(" 替代了"),t("s",[s._v("heapster")]),s._v("。"),t("code",[s._v("Metrics Server")]),s._v(" 实现了"),t("code",[s._v("Resource Metrics API")]),s._v("，"),t("code",[s._v("Metrics Server")]),s._v(" 是集群范围资源使用数据的聚合器。 "),t("code",[s._v("Metrics Server")]),s._v(" 从每个节点上的 "),t("code",[s._v("Kubelet")]),s._v(" 公开的 "),t("code",[s._v("Summary API")]),s._v(" 中采集指标信息。"),t("code",[s._v("heapster")]),s._v("从"),t("code",[s._v("1.13")]),s._v("版本开始被废弃，官方推荐使用"),t("code",[s._v("Metrics Server+Prometheus")]),s._v("方案进行集群监控")]),s._v(" "),t("p",[t("strong",[s._v("开启"),t("code",[s._v("apiserver")]),s._v("聚合服务")])]),s._v(" "),t("p",[s._v("要安装mertics-server必须先开启聚合服务的参数，如果已经添加，请跳过这一步")]),s._v(" "),t("p",[s._v("二进制部署安装，需要手动修改"),t("code",[s._v("apiserver")]),s._v("添加开启")]),s._v(" "),t("p",[s._v("kube-apiserver配置文件修改，增加标记黑色的行数")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("div",{staticClass:"highlight-lines"},[t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("div",{staticClass:"highlighted"},[s._v(" ")]),t("div",{staticClass:"highlighted"},[s._v(" ")]),t("div",{staticClass:"highlighted"},[s._v(" ")]),t("div",{staticClass:"highlighted"},[s._v(" ")]),t("div",{staticClass:"highlighted"},[s._v(" ")]),t("div",{staticClass:"highlighted"},[s._v(" ")]),t("div",{staticClass:"highlighted"},[s._v(" ")]),t("div",{staticClass:"highlighted"},[s._v(" ")]),t("br"),t("br"),t("br")]),t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.8")]),s._v("+"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /k8s/kubernetes/cfg/kube-apiserver ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("KUBE_APISERVER_OPTS")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"--logtostderr=true \\\n--v=4 \\\n--etcd-servers=https://k8s-master:2379,https://k8s-node-1:2379,https://k8s-node-2:2379 \\\n--bind-address=0.0.0.0 \\\n--insecure-bind-address=0.0.0.0 \\\n--secure-port=6443 \\\n--advertise-address=0.0.0.0 \\\n--allow-privileged=true \\\n--service-cluster-ip-range=10.254.0.0/16 \\\n--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \\\n--authorization-mode=RBAC,Node \\\n--enable-bootstrap-token-auth \\\n--token-auth-file=/k8s/kubernetes/cfg/token.csv \\\n--service-node-port-range=30000-50000 \\\n--tls-cert-file=/k8s/kubernetes/ssl/server.pem  \\\n--tls-private-key-file=/k8s/kubernetes/ssl/server-key.pem \\\n--client-ca-file=/k8s/kubernetes/ssl/ca.pem \\\n--service-account-key-file=/k8s/kubernetes/ssl/ca-key.pem \\\n--etcd-cafile=/k8s/etcd/ssl/ca.pem \\\n--etcd-certfile=/k8s/etcd/ssl/server.pem \\\n--etcd-keyfile=/k8s/etcd/ssl/server-key.pem \\\n--runtime-config=api/all=true \\\n--proxy-client-cert-file=/k8s/kubernetes/ssl/kube-proxy.pem \\\n--proxy-client-key-file=/k8s/kubernetes/ssl/kube-proxy-key.pem \\\n--requestheader-client-ca-file=/k8s/kubernetes/ssl/ca.pem \\\n--requestheader-allowed-names= \\\n--requestheader-extra-headers-prefix=X-Remote-Extra- \\\n--requestheader-group-headers=X-Remote-Group \\\n--requestheader-username-headers=X-Remote-User"')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.8")]),s._v("+"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\n")])]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br")])]),t("p",[t("strong",[s._v("部署metrics-server")])]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.8")]),s._v("+"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# git clone https://github.com/kubernetes-sigs/metrics-server.git")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.8")]),s._v("+"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /app/yaml/metrics-server/deploy/1.8+")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 metrics"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim metrics-server-deployment.yaml ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("### mertics-server修改启动参数镜像地址，增加command")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\ncontainers:\n      - name: metrics-server\n        image: registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-server-amd64:v0.3.6\n        command:\n        - /metrics-server\n        - --metric-resolution"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("30s\n        - --kubelet-insecure-tls\n        - --kubelet-preferred-address-types"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("InternalIP,Hostname,InternalDNS,ExternalDNS,ExternalIP\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("### 创建metrics-server")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.8")]),s._v("+"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl  apply -f .")]),s._v("\nclusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader created\nclusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator created\nrolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader created\napiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io created\nserviceaccount/metrics-server created\ndeployment.extensions/metrics-server created\nservice/metrics-server created\nclusterrole.rbac.authorization.k8s.io/system:metrics-server created\nclusterrolebinding.rbac.authorization.k8s.io/system:metrics-server created\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.8")]),s._v("+"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.8")]),s._v("+"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pods -n kube-system |grep metrics-server")]),s._v("\nmetrics-server-599f4f9874-w6vnx         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("          5h39m\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.8")]),s._v("+"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.8")]),s._v("+"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.8")]),s._v("+"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl -n kube-system logs -l k8s-app=metrics-server  -f")]),s._v("\nI1114 08:49:48.802857       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" serving.go:312"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Generated self-signed cert "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("/tmp/apiserver.crt, /tmp/apiserver.key"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nI1114 08:49:49.717666       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" secure_serving.go:116"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Serving securely on "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("::"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(":4443\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br")])]),t("p",[t("strong",[t("code",[s._v("kubectl top")]),s._v("查看")])]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.8")]),s._v("+"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl  top node")]),s._v("\nNAME         CPU"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cores"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("   CPU%   MEMORY"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bytes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("   MEMORY%   \nk8s-master   94m          "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("%     5119Mi          "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("66")]),s._v("%       \nk8s-node-1   108m         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("%     4877Mi          "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("63")]),s._v("%       \nk8s-node-2   75m          "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("%     3182Mi          "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("41")]),s._v("%       \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.8")]),s._v("+"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl  top pod")]),s._v("\nNAME                                    CPU"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cores"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("   MEMORY"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bytes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("   \napp-test-54fb88d9b-2jf6m                0m           2Mi             \nnfs-client-provisioner-6f5d588-mq6l2    1m           6Mi             \nnfs-web-0                               0m           2Mi             \nnfs-web-1                               0m           2Mi             \nnginx-6dbd5b5bd-f4fkg                   0m           2Mi             \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("hr"),s._v(" "),t("p",[s._v("ps")]),s._v(" "),t("p",[t("strong",[s._v("碰到的问题")])]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("$ kubectl "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("top")]),s._v(" pods\nError from server "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ServiceUnavailable"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": the server is currently unable to handle the request "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("get pods.metrics.k8s.io"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n$ kubectl api-resources\nerror: unable to retrieve the complete list of server APIs: metrics.k8s.io/v1beta1: the server is currently unable to handle the request\n\n$ kubectl get apiservices "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" metrics\nv1beta1.metrics.k8s.io                 kube-system/metrics-server   False "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("FailedDiscoveryCheck"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("   2m21s\n\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master yarm"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get apiservices v1beta1.metrics.k8s.io -o yaml")]),s._v("\napiVersion: apiregistration.k8s.io/v1\nkind: APIService\nmetadata:\n  creationTimestamp: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2019-11-13T09:51:00Z"')]),s._v("\n  name: v1beta1.metrics.k8s.io\n  resourceVersion: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5866720"')]),s._v("\n  selfLink: /apis/apiregistration.k8s.io/v1/apiservices/v1beta1.metrics.k8s.io\n  uid: 8132b60e-ef07-4af0-baaf-aaadf355a852\nspec:\n  group: metrics.k8s.io\n  groupPriorityMinimum: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\n  insecureSkipTLSVerify: "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n  service:\n    name: metrics-server\n    namespace: kube-system\n    port: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v("\n  version: v1beta1\n  versionPriority: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\nstatus:\n  conditions:\n  - lastTransitionTime: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2019-11-13T16:03:47Z"')]),s._v("\n    message: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'failing or missing response from https://10.152.183.90:443/apis/metrics.k8s.io/v1beta1:\n      bad status from https://10.152.183.90:443/apis/metrics.k8s.io/v1beta1: 403'")]),s._v("\n    reason: FailedDiscoveryCheck\n    status: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"False"')]),s._v("\n    type: Available\n\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.8")]),s._v("+"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl -n kube-system logs -l k8s-app=metrics-server  -f")]),s._v("\nW1113 09:59:50.576292       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" x509.go:172"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" x509: subject with "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("cn")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("system:kube-proxy is not "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" the allowed list: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("aggregator"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nW1113 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":00:01.714599       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" x509.go:172"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" x509: subject with "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("cn")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("system:kube-proxy is not "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" the allowed list: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("aggregator"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nW1113 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":00:01.714629       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" x509.go:172"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" x509: subject with "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("cn")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("system:kube-proxy is not "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" the allowed list: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("aggregator"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nW1113 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":00:01.714657       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" x509.go:172"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" x509: subject with "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("cn")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("system:kube-proxy is not "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" the allowed list: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("aggregator"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nW1113 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":00:01.714693       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" x509.go:172"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" x509: subject with "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("cn")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("system:kube-proxy is not "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" the allowed list: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("aggregator"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br")])]),t("p",[t("strong",[s._v("原因")])]),s._v(" "),t("p",[s._v("该问题与"),t("code",[s._v("kube-apiservrer")]),s._v("的"),t("code",[s._v("--requestheader-allowed-names")]),s._v("配置项有关。")]),s._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",[s._v("--requestheader-allowed-names strings")]),s._v(" "),t("p",[s._v("List of client certificate common names to allow to provide usernames in headers specified by --requestheader-username-headers. If empty, any client certificate validated by the authorities in --requestheader-client-ca-file is allowed.")])]),s._v(" "),t("p",[s._v("原错误配置为"),t("code",[s._v("--requestheader-allowed-names=aggregator")]),s._v("。也就是说只有以"),t("code",[s._v("aggregator")]),s._v("开头的"),t("code",[s._v("Role")]),s._v("才能通过认证，导致各个节点（角色名为"),t("code",[s._v("cn=system:node:[节点IP]")]),s._v("）被决绝访问。")]),s._v(" "),t("p",[s._v("另外，"),t("code",[s._v("kube-aggregator")]),s._v("访问"),t("code",[s._v("kubelet")]),s._v("所用证书原为"),t("code",[s._v("aggregator")]),s._v("，有可能会因权限不够而被拒绝。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("  - --proxy-client-cert-file"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/var/lib/kubernetes/aggregator.pem\n  - --proxy-client-key-file"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/var/lib/kubernetes/aggregator-key.pem\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[t("strong",[s._v("解决方案")])]),s._v(" "),t("p",[s._v("首先，将"),t("code",[s._v("--requestheader-allowed-names=aggregator")]),s._v("配置改为："),t("code",[s._v("--requestheader-allowed-names=")])]),s._v(" "),t("p",[s._v("即不验证证书中角色名字，直接验证角色权限。")]),s._v(" "),t("p",[s._v("其次，将访问kubelet所用的证书改为admin证书，让kube-aggregator获取最高权限，保证能够正常访问kubelet。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("  --proxy-client-cert-file"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/k8s/kubernetes/ssl/kube-proxy.pem "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  --proxy-client-key-file"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/k8s/kubernetes/ssl/kube-proxy-key.pem "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("至此，上述log消失。问题解决。")]),s._v(" "),t("p",[s._v("参考")]),s._v(" "),t("p",[s._v("https://www.cnblogs.com/tchua/p/10855001.html")]),s._v(" "),t("p",[s._v("http://blog.allen-mo.com/2018/08/26/kubernetes_cluster_troubleshooting/")])])}),[],!1,null,null,null);e.default=n.exports}}]);